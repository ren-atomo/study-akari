<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Tracker</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --black: #0a0a0a;
      --gray-900: #171717;
      --gray-800: #262626;
      --gray-700: #404040;
      --gray-600: #525252;
      --gray-500: #737373;
      --gray-400: #a3a3a3;
      --gray-300: #d4d4d4;
      --gray-200: #e5e5e5;
      --gray-100: #f5f5f5;
      --gray-50: #fafafa;
      --white: #ffffff;
      --primary: #5E81AC;
      --primary-dark: #4C6A8E;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 15px;
    }

    body {
      font-family: 'DM Sans', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--white);
      color: var(--gray-900);
      min-height: 100vh;
      line-height: 1.5;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--gray-100);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.125rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--black);
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      font-family: inherit;
      letter-spacing: -0.01em;
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray-600);
    }

    .btn-ghost:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .btn-primary {
      background: var(--black);
      color: var(--white);
    }

    .btn-primary:hover {
      background: var(--gray-800);
    }

    .btn-outline {
      background: var(--white);
      color: var(--gray-900);
      border: 1px solid var(--gray-200);
    }

    .btn-outline:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    /* Main */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.5rem 2rem 6rem;
    }

    /* Hero Section - Compact */
    .hero {
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .hero-countdown {
      display: inline-flex;
      align-items: baseline;
      gap: 0.375rem;
      margin-bottom: 0.25rem;
    }

    .hero-days {
      font-size: 3.5rem;
      font-weight: 700;
      letter-spacing: -0.04em;
      line-height: 1;
      color: var(--black);
    }

    .hero-unit {
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--gray-500);
    }

    .hero-label {
      font-size: 0.8125rem;
      color: var(--gray-400);
    }

    @media (max-width: 640px) {
      .hero {
        margin-bottom: 1.25rem;
      }
      .hero-days {
        font-size: 2.75rem;
      }
    }

    /* Stats Row - Redesigned */
    .stats-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 2.5rem;
    }

    .stat-hero {
      background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-800) 100%);
      border-radius: 16px;
      padding: 1.75rem;
      color: var(--white);
      text-align: center;
    }

    .stat-hero .stat-value {
      font-size: 3.5rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      color: var(--white);
      line-height: 1;
      margin-bottom: 0.5rem;
    }

    .stat-hero .stat-label {
      font-size: 0.875rem;
      color: var(--gray-400);
      font-weight: 500;
    }

    .stat-hero .stat-sub {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 0.5rem;
    }

    .stat-actions {
      display: flex;
      gap: 0.625rem;
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid var(--gray-700);
      justify-content: center;
    }

    .stat-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.625rem 1rem;
      background: var(--white);
      color: var(--gray-900);
      border: none;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .stat-action-btn:hover {
      background: var(--gray-100);
      transform: translateY(-1px);
    }

    .stat-action-btn:active {
      transform: translateY(0);
    }

    .stat-action-btn.secondary {
      background: transparent;
      color: var(--white);
      border: 1px solid var(--gray-600);
    }

    .stat-action-btn.secondary:hover {
      background: var(--gray-800);
      border-color: var(--gray-500);
    }

    .stat-action-icon {
      font-size: 0.875rem;
    }

    @media (max-width: 640px) {
      .stat-actions {
        flex-direction: row;
      }
      .stat-action-btn {
        flex: 1;
        justify-content: center;
        padding: 0.75rem 0.875rem;
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    .stats-grid.stats-grid-5 {
      grid-template-columns: repeat(5, 1fr);
    }

    .stat-item {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all 0.2s ease;
    }

    .stat-item:hover {
      border-color: var(--gray-300);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--black);
      margin-bottom: 0.125rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    @media (max-width: 640px) {
      .stat-hero .stat-value {
        font-size: 3rem;
      }
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
      }
      .stats-grid.stats-grid-5 {
        grid-template-columns: repeat(5, 1fr);
      }
      .stat-item {
        padding: 0.75rem 0.5rem;
      }
      .stat-value {
        font-size: 1.25rem;
      }
      .stats-grid.stats-grid-5 .stat-value {
        font-size: 1rem;
      }
      .stats-grid.stats-grid-5 .stat-label {
        font-size: 0.625rem;
      }
    }

    /* Week Overview - Calendar + Chart */
    .week-overview {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .week-calendar-card,
    .week-chart-card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 16px;
      padding: 1.25rem;
    }

    .week-card-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 1rem;
    }

    .week-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .week-day {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.375rem;
    }

    .week-day-label {
      font-size: 0.625rem;
      font-weight: 500;
      color: var(--gray-400);
      text-transform: uppercase;
    }

    .week-day-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--gray-100);
      color: var(--gray-400);
      transition: all 0.2s ease;
    }

    .week-day-circle.studied {
      background: var(--primary);
      color: var(--white);
    }

    .week-day-circle.today {
      border: 2px solid var(--primary);
    }

    .week-day-circle.today.studied {
      border-color: var(--primary-dark);
    }

    .week-day-minutes {
      font-size: 0.625rem;
      color: var(--gray-500);
    }

    .week-chart-container {
      height: 140px;
    }

    @media (max-width: 768px) {
      .week-overview {
        grid-template-columns: 1fr;
      }
      .week-chart-container {
        height: 120px;
      }
    }

    /* Progress Section - Card Style */
    .progress-section {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 2.5rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.875rem;
    }

    .section-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title-icon {
      font-size: 1.125rem;
    }

    .section-value {
      font-size: 0.875rem;
      color: var(--gray-600);
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .progress-track {
      height: 8px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #A3BE8C, #8FBCBB);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Card Title - Enhanced */
    .card-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-title-icon {
      font-size: 1rem;
      opacity: 0.8;
    }

    /* Grid Layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* Card */
    .card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.5rem;
    }

    /* Chart */
    .chart-container {
      position: relative;
      height: 240px;
    }

    /* Goals */
    .goals-list {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .goal-item {
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
    }

    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .goal-name {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--gray-900);
    }

    .goal-values {
      font-size: 0.8125rem;
      color: var(--gray-500);
      font-variant-numeric: tabular-nums;
    }

    .goal-bar {
      height: 6px;
      background: var(--gray-100);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .goal-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .goal-fill.kokugo { background: #EBCB8B; }
    .goal-fill.sugaku { background: #A3BE8C; }
    .goal-fill.eigo { background: #5E81AC; }
    .goal-fill.rika { background: #B48EAD; }
    .goal-fill.shakai { background: #D08770; }

    /* Records - Card Style */
    .records-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .record-item {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      padding: 0.875rem;
      background: var(--gray-50);
      border-radius: 10px;
      transition: background 0.15s ease;
    }

    .record-item:hover {
      background: var(--gray-100);
    }

    .record-main {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
    }

    .record-details {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed var(--gray-200);
    }

    .record-sub-info {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.75rem;
    }

    .record-textbook {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-memo {
      font-size: 0.8125rem;
      color: var(--gray-700);
      background: #FFFBEB;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      border-left: 3px solid #F59E0B;
      line-height: 1.45;
    }

    .record-date {
      font-size: 0.75rem;
      color: var(--gray-400);
      min-width: 50px;
      font-variant-numeric: tabular-nums;
    }

    .record-subject {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--gray-800);
      padding: 0.25rem 0.625rem;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
    }

    .record-subject-small {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-type {
      font-size: 0.6875rem;
      color: var(--gray-500);
      padding: 0.125rem 0.5rem;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 3px;
    }

    .record-time {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .record-time-small {
      font-size: 0.6875rem;
      color: var(--gray-400);
      font-variant-numeric: tabular-nums;
    }

    .record-mood {
      font-size: 1rem;
      opacity: 0.8;
    }

    .record-score {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .record-score.high { color: var(--success); }
    .record-score.mid { color: var(--warning); }
    .record-score.low { color: var(--danger); }

    .record-unit {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    .record-section {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    .record-weak {
      font-size: 0.75rem;
      color: var(--danger);
      background: #FEF2F2;
      padding: 0.375rem 0.5rem;
      border-radius: 4px;
    }

    /* Empty State - Enhanced */
    .empty-state {
      padding: 2rem 1.5rem;
      text-align: center;
      background: var(--gray-50);
      border-radius: 12px;
      border: 1px dashed var(--gray-200);
    }

    .empty-state-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.7;
    }

    .empty-state-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.375rem;
    }

    .empty-state-desc {
      font-size: 0.8125rem;
      color: var(--gray-500);
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .empty-state-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.625rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      background: var(--white);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }

    .empty-state-btn:hover {
      border-color: var(--black);
      background: var(--gray-100);
    }

    .empty-state-simple {
      padding: 1.5rem 1rem;
      text-align: center;
      color: var(--gray-400);
      font-size: 0.8125rem;
    }
      background: var(--gray-50);
    }

    /* ÂøÖÈ†à„Éû„Éº„ÇØ */
    .required::after {
      content: ' *';
      color: #BF616A;
    }

    /* „Éá„Éº„ÇøÁÆ°ÁêÜÁîªÈù¢ */
    .manager-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.875rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      background: var(--white);
    }

    .manager-item:hover {
      background: var(--gray-50);
    }

    .manager-item-info {
      flex: 1;
      min-width: 0;
    }

    .manager-item-main {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      font-size: 0.875rem;
    }

    .manager-item-date {
      color: var(--gray-500);
      font-size: 0.75rem;
    }

    .manager-item-subject {
      font-weight: 600;
      color: var(--gray-700);
    }

    .manager-item-detail {
      color: var(--gray-500);
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    .manager-delete-btn {
      flex-shrink: 0;
      width: 36px;
      height: 36px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      background: var(--white);
      color: var(--gray-400);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      margin-left: 0.75rem;
    }

    .manager-delete-btn:hover {
      background: #fef2f2;
      border-color: #fecaca;
      color: #BF616A;
    }

    .manager-empty {
      text-align: center;
      padding: 2rem;
      color: var(--gray-400);
    }

    /* „ÉÅ„É£„ÉÉ„Éà„Éú„Çø„É≥Ôºà„Éò„ÉÉ„ÉÄ„ÉºÔºâ */
    .chat-header-btn {
      position: relative;
      font-size: 1.25rem;
      padding: 0.5rem 0.75rem;
    }

    .chat-header-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #BF616A;
      color: white;
      font-size: 0.625rem;
      font-weight: 600;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    /* „ÉÅ„É£„ÉÉ„Éà„É¢„Éº„ÉÄ„É´ - Enhanced */
    .chat-modal .modal {
      max-width: 480px;
      height: 70vh;
      max-height: 600px;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 640px) {
      .chat-modal .modal {
        width: 100%;
        max-width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
      }
    }

    .chat-modal .modal-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--gray-100);
      flex-shrink: 0;
    }

    .chat-modal .modal-body {
      flex: 1;
      padding: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: var(--gray-50);
    }

    .chat-message {
      max-width: 85%;
      padding: 0.625rem 0.875rem;
      border-radius: 16px;
      font-size: 0.9375rem;
      line-height: 1.45;
      word-wrap: break-word;
    }

    .chat-message.student {
      align-self: flex-end;
      background: var(--black);
      color: var(--white);
      border-bottom-right-radius: 4px;
    }

    .chat-message.admin {
      align-self: flex-start;
      background: var(--white);
      color: var(--gray-800);
      border: 1px solid var(--gray-200);
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    .chat-message-time {
      font-size: 0.6875rem;
      color: var(--gray-400);
      margin-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chat-message.student .chat-message-time {
      color: rgba(255, 255, 255, 0.6);
      justify-content: flex-end;
    }

    .chat-read-status {
      font-size: 0.625rem;
      opacity: 0.8;
    }

    .chat-input-area {
      padding: 0.75rem 1rem;
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 0.5rem;
      background: var(--white);
      flex-shrink: 0;
    }

    .chat-input {
      flex: 1;
      padding: 0.625rem 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 20px;
      font-size: 0.9375rem;
      resize: none;
      max-height: 80px;
      font-family: inherit;
      background: var(--gray-50);
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--gray-400);
      background: var(--white);
    }

    .chat-send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--black);
      color: var(--white);
      border: none;
      font-size: 1.125rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .chat-send-btn:hover {
      background: var(--gray-700);
      transform: scale(1.05);
    }

    .chat-send-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      transform: none;
    }

    .chat-empty {
      text-align: center;
      color: var(--gray-400);
      padding: 3rem 1.5rem;
      font-size: 0.875rem;
    }

    .chat-empty-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.6;
    }

    .chat-date-divider {
      text-align: center;
      font-size: 0.6875rem;
      color: var(--gray-400);
      padding: 0.75rem 0 0.25rem;
      font-weight: 500;
    }
    }

    /* ÂøúÊè¥„Éê„Éä„Éº - Softer Design */
    .cheer-banner {
      background: var(--gray-900);
      color: white;
      padding: 0.75rem 1rem;
      margin-bottom: 1.25rem;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      animation: bannerFadeIn 0.4s ease;
    }

    @keyframes bannerFadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .cheer-banner-content {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 0.625rem;
    }

    .cheer-banner-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    .cheer-banner-text {
      flex: 1;
      min-width: 0;
    }

    .cheer-banner-message {
      font-size: 0.875rem;
      font-weight: 500;
      line-height: 1.4;
    }

    .cheer-banner-close {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
      flex-shrink: 0;
    }

    .cheer-banner-close:hover {
      background: rgba(255,255,255,0.25);
    }

    /* ÈÄ£Á∂öÊó•Êï∞„Éê„ÉÉ„Ç∏ */
    .streak-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: var(--gray-100);
      border-radius: 4px;
      font-size: 0.6875rem;
      color: var(--gray-600);
      margin-top: 0.25rem;
    }

    .streak-badge.hot {
      background: #fff7ed;
      color: #D08770;
    }

    .streak-badge.fire {
      background: #fef2f2;
      color: #BF616A;
    }

    /* ÁõÆÊ®ôÈÅîÊàê„Éê„ÉÉ„Ç∏ */
    .goal-achieved {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.375rem;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 4px;
      font-size: 0.6875rem;
      color: #16a34a;
      margin-left: 0.5rem;
    }

    /* ÈÄ±ÈñìÁõÆÊ®ôÈÅîÊàê */
    .progress-section.achieved .progress-fill {
      background: linear-gradient(90deg, #A3BE8C, #8FBCBB);
    }

    .progress-celebration {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 8px;
      margin-top: 0.75rem;
      font-size: 0.875rem;
      color: #16a34a;
    }

    /* „Ç´„Çπ„Çø„É†ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ */
    .custom-input-wrapper {
      display: none;
      margin-top: 0.5rem;
    }

    .custom-input-wrapper.show {
      display: block;
    }

    /* ÂâçÂõû„ÅÆË®òÈå≤„Éí„É≥„Éà */
    .previous-record-hint {
      margin-top: 0.75rem;
      padding: 0.875rem;
      background: linear-gradient(135deg, #FEF9E7 0%, #FEF3C7 100%);
      border: 1px solid #F59E0B;
      border-radius: 10px;
      font-size: 0.8125rem;
    }

    .previous-record-header {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #92400E;
    }

    .previous-record-icon {
      font-size: 1rem;
    }

    .previous-record-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .previous-record-content {
      color: #78350F;
      line-height: 1.5;
    }

    .previous-record-date {
      font-weight: 600;
      color: #92400E;
    }

    .previous-record-score {
      font-weight: 600;
    }

    .previous-record-memo {
      margin-top: 0.375rem;
      padding-top: 0.375rem;
      border-top: 1px dashed #D97706;
      font-style: italic;
    }

    /* Insights Section */
    .insights-section {
      margin-bottom: 1.5rem;
    }

    .insights-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .insights-grid {
        grid-template-columns: 1fr;
      }
    }

    .insight-card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1rem;
    }

    .insight-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray-100);
    }

    .insight-icon {
      font-size: 1.125rem;
    }

    .insight-title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--gray-700);
    }

    .insight-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .insight-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.8125rem;
      line-height: 1.4;
      color: var(--gray-700);
      padding: 0.375rem 0;
    }

    .insight-item-icon {
      flex-shrink: 0;
      width: 1.25rem;
      text-align: center;
    }

    .insight-item.positive { color: #059669; }
    .insight-item.warning { color: #D97706; }
    .insight-item.info { color: #2563EB; }

    .recommendation-card {
      background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
      border-color: #86EFAC;
    }

    .recommendation-section {
      margin-bottom: 1.5rem;
    }

    .recommendation-card-solo {
      background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
      border: 1px solid #86EFAC;
      border-radius: 12px;
      padding: 1rem;
    }

    .recommendation-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(34, 197, 94, 0.2);
    }

    .recommendation-header-icon {
      font-size: 1.125rem;
    }

    .recommendation-header-title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--gray-700);
    }

    .recommendation-list {
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
    }

    .recommendation-item {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.625rem 0.75rem;
      background: var(--white);
      border-radius: 8px;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }

    .recommendation-item:hover {
      border-color: #22C55E;
      transform: translateX(2px);
    }

    .recommendation-item-icon {
      font-size: 1rem;
    }

    .recommendation-item-text {
      flex: 1;
      color: var(--gray-700);
    }

    .recommendation-item-reason {
      font-size: 0.6875rem;
      color: var(--gray-500);
    }

    .recommendation-item-arrow {
      color: var(--gray-400);
      font-size: 0.75rem;
    }

    /* Growth Chart */
    .growth-chart-container {
      margin-top: 1rem;
    }

    .growth-summary {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      padding: 0.75rem;
      background: var(--gray-50);
      border-radius: 8px;
      font-size: 0.8125rem;
    }

    .growth-summary-item {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .growth-summary-label {
      font-size: 0.6875rem;
      color: var(--gray-500);
    }

    .growth-summary-value {
      font-weight: 600;
      color: var(--gray-800);
    }

    .growth-summary-value.positive {
      color: #059669;
    }

    .growth-summary-value.negative {
      color: #DC2626;
    }

    .growth-empty {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--gray-400);
      font-size: 0.875rem;
    }

    /* Dashboard Growth Chart */
    .growth-select-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .growth-select-row .form-select {
      flex: 1;
      padding: 0.5rem 0.625rem;
      font-size: 0.8125rem;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      padding: 1rem;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--white);
      border-radius: 16px;
      width: 100%;
      max-width: 440px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px) scale(0.98);
      transition: all 0.2s ease;
    }

    .modal-overlay.active .modal {
      transform: translateY(0) scale(1);
    }

    .modal-header {
      padding: 1.5rem 1.5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--gray-100);
      color: var(--gray-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      font-size: 1rem;
    }

    .modal-close:hover {
      background: var(--gray-200);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 0 1.5rem 1.5rem;
      display: flex;
      gap: 0.75rem;
    }

    .modal-footer .btn {
      flex: 1;
      padding: 0.75rem;
    }

    /* Form */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.9375rem;
      font-family: inherit;
      transition: all 0.15s ease;
      background: var(--white);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--gray-400);
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23737373'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Button Group */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .btn-option {
      padding: 0.5rem 0.875rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      background: var(--white);
      font-size: 0.8125rem;
      font-family: inherit;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-option:hover {
      border-color: var(--gray-300);
      background: var(--gray-50);
    }

    .btn-option.active {
      border-color: var(--black);
      background: var(--black);
      color: var(--white);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transform: scale(1.02);
    }

    /* Mood Buttons */
    .mood-group {
      display: flex;
      gap: 0.5rem;
    }

    .mood-btn {
      width: 44px;
      height: 44px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: var(--white);
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .mood-btn:hover {
      border-color: var(--gray-300);
      transform: scale(1.05);
    }

    .mood-btn.active {
      border-color: var(--black);
      border-width: 2px;
      background: var(--gray-100);
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background: var(--gray-100);
    }

    /* AI Modal */
    .ai-question {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .ai-main-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .ai-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      background: var(--white);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .ai-card:hover {
      border-color: var(--gray-400);
      background: var(--gray-50);
    }
    
    .ai-card.active {
      border-color: var(--black);
      background: var(--gray-100);
    }
    
    .ai-card-icon {
      font-size: 1.75rem;
      flex-shrink: 0;
    }
    
    .ai-card-content {
      flex: 1;
    }
    
    .ai-card-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 0.25rem;
    }
    
    .ai-card-desc {
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    
    .ai-more-toggle {
      text-align: center;
      padding: 0.75rem;
      color: var(--gray-500);
      font-size: 0.875rem;
      cursor: pointer;
      transition: color 0.15s;
    }
    
    .ai-more-toggle:hover {
      color: var(--gray-700);
    }
    
    .ai-more-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.75rem;
      background: var(--gray-50);
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    
    .ai-option-small {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-200);
      border-radius: 20px;
      background: var(--white);
      font-size: 0.8125rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .ai-option-small:hover {
      border-color: var(--gray-400);
      background: var(--gray-100);
    }
    
    .ai-option-small.active {
      border-color: var(--black);
      background: var(--gray-900);
      color: var(--white);
    }
    
    .ai-option-small-icon {
      font-size: 1rem;
    }

    .prompt-preview {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1rem;
      font-size: 0.75rem;
      font-family: 'SF Mono', 'Consolas', monospace;
      white-space: pre-wrap;
      max-height: 280px;
      overflow-y: auto;
      line-height: 1.6;
      color: var(--gray-700);
    }

    /* Score Input */
    .score-input-container {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 1rem;
    }

    .score-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .score-row.score-total {
      background: var(--white);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      border: 1px solid var(--gray-200);
    }

    .score-label {
      min-width: 50px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .section-name {
      width: 70px !important;
      min-width: 70px;
      padding: 0.5rem !important;
      font-size: 0.875rem;
      text-align: center;
    }

    .score-inputs {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
    }

    .score-box {
      width: 70px !important;
      text-align: center;
      padding: 0.5rem !important;
    }

    .score-box:read-only {
      background: var(--gray-100);
      font-weight: 600;
    }

    .score-divider {
      color: var(--gray-400);
      font-weight: 500;
    }

    .score-percent {
      font-size: 0.875rem;
      color: var(--gray-600);
      min-width: 60px;
    }

    .version-info {
      text-align: center;
      padding-top: 1rem;
      margin-top: 1rem;
      border-top: 1px solid var(--gray-200);
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    /* Tab Menu - Bottom Nav on Mobile */
    .tab-menu {
      display: flex;
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 60px;
      z-index: 100;
      padding: 0 1rem;
    }

    @media (max-width: 640px) {
      .tab-menu {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        border-bottom: none;
        border-top: 1px solid var(--gray-200);
        padding: 0;
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
    }

    .tab-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.75rem 0.5rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    @media (max-width: 640px) {
      .tab-btn {
        border-bottom: none;
        padding: 0.625rem 0.5rem;
      }
      .tab-btn.active {
        color: var(--black);
        background: var(--gray-50);
      }
    }

    .tab-btn:hover {
      color: var(--gray-700);
      background: var(--gray-50);
    }

    .tab-btn.active {
      color: var(--black);
      border-bottom-color: var(--black);
    }

    .tab-icon {
      font-size: 1.25rem;
    }

    @media (max-width: 640px) {
      .tab-icon {
        font-size: 1.375rem;
      }
    }

    .tab-label {
      font-size: 0.75rem;
      font-weight: 500;
    }

    @media (max-width: 640px) {
      .tab-label {
        font-size: 0.625rem;
      }
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Analysis Header */
    .analysis-header {
      text-align: center;
      padding: 1.5rem 0;
    }

    .analysis-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .analysis-subtitle {
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    /* Four column stats (for analysis tabs) */
    .stats-row.four-cols {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }

    .stats-row.four-cols .stat-item {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
    }

    @media (max-width: 600px) {
      .stats-row.four-cols {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Breakdown List */
    .breakdown-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .breakdown-item {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .breakdown-label {
      min-width: 80px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .breakdown-bar-container {
      flex: 1;
      height: 24px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .breakdown-bar {
      height: 100%;
      background: var(--gray-800);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .breakdown-value {
      min-width: 70px;
      text-align: right;
      font-size: 0.875rem;
      font-weight: 600;
    }

    /* Filter Row */
    .filter-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .filter-select {
      flex: 1;
      max-width: 200px;
    }

    /* Full Height Records */
    .records-list.full-height {
      max-height: 400px;
      overflow-y: auto;
    }

    /* Mood Grid */
    .mood-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.75rem;
    }

    .mood-item {
      text-align: center;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 8px;
    }

    .mood-emoji {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }

    .mood-count {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .mood-percent {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    @media (max-width: 600px) {
      .mood-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Weak Areas */
    .weak-areas-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .weak-area-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: var(--gray-50);
      border-radius: 6px;
      border-left: 3px solid var(--gray-400);
    }

    .weak-area-item.high {
      border-left-color: #ef4444;
      background: #fef2f2;
    }

    .weak-area-item.medium {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }

    .weak-area-name {
      font-weight: 500;
    }

    .weak-area-count {
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    /* Time Input Toggle */
    .time-input-toggle {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .time-toggle-btn {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      background: var(--white);
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-toggle-btn.active {
      background: var(--black);
      color: var(--white);
      border-color: var(--black);
    }

    .section-time-input {
      width: 60px !important;
      text-align: center;
      padding: 0.375rem !important;
      font-size: 0.8rem;
    }

    .record-score {
      font-weight: 700;
      color: var(--black);
    }

    .record-detail {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 0.25rem;
      padding-top: 0.25rem;
      border-top: 1px dashed var(--gray-200);
    }

    .score-buttons {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--gray-200);
    }

    .btn-sm {
      padding: 0.375rem 1rem;
      font-size: 1.25rem;
      min-width: 44px;
    }

    #sectionScoresContainer {
      max-height: 200px;
      overflow-y: auto;
    }

    /* Loading */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--gray-200);
      border-top-color: var(--black);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 6rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 4000;
    }

    .toast {
      padding: 0.75rem 1.25rem;
      background: var(--gray-900);
      color: var(--white);
      border-radius: 8px;
      font-size: 0.875rem;
      animation: fadeUp 0.2s ease;
    }

    .toast.error {
      background: var(--danger);
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 640px) {
      html {
        font-size: 14px;
      }

      .header-content {
        padding: 0.875rem 1rem;
      }

      .main {
        padding: 1.5rem 1rem calc(5rem + env(safe-area-inset-bottom));
      }

      .hero-days {
        font-size: 3rem;
      }

      .grid-2 {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .ai-options {
        grid-template-columns: repeat(2, 1fr);
      }

      /* „É¢„Éº„ÉÄ„É´„ÅÆ„É¢„Éê„Ç§„É´ÂØæÂøú */
      .modal {
        width: 100%;
        max-width: 100%;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
        margin: 0;
      }

      .modal-body {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
        padding-bottom: 100px;
      }

      .modal-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--white);
        border-top: 1px solid var(--gray-200);
        padding: 1rem;
        z-index: 10;
      }

      /* „Éú„Çø„É≥„Ç∞„É´„Éº„Éó„ÅÆ„É¨„Çπ„Éù„É≥„Ç∑„Éñ */
      .btn-group {
        gap: 0.5rem;
      }

      .btn-option {
        padding: 0.625rem 0.75rem;
        font-size: 0.75rem;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">Study Tracker</div>
      <div class="header-actions">
        <button class="btn btn-ghost" onclick="openAIModal()" title="AI„Å´Áõ∏Ë´á">ü§ñ</button>
        <button class="btn btn-ghost chat-header-btn" onclick="openChat()" id="chatHeaderBtn" style="display: none;">
          üí¨
          <span class="chat-header-badge" id="chatHeaderBadge" style="display: none;">0</span>
        </button>
        <button class="btn btn-ghost" onclick="openSettingsModal()">Ë®≠ÂÆö</button>
        <button class="btn btn-ghost" onclick="refreshData()">Êõ¥Êñ∞</button>
      </div>
    </div>
  </header>

  <!-- Tab Menu -->
  <nav class="tab-menu">
    <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">
      <span class="tab-icon">üìä</span>
      <span class="tab-label">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
    </button>
    <button class="tab-btn" data-tab="study" onclick="switchTab('study')">
      <span class="tab-icon">üìö</span>
      <span class="tab-label">Â≠¶ÁøíÂàÜÊûê</span>
    </button>
    <button class="tab-btn" data-tab="redbook" onclick="switchTab('redbook')">
      <span class="tab-icon">üìï</span>
      <span class="tab-label">ÈÅéÂéªÂïèÂàÜÊûê</span>
    </button>
  </nav>

  <!-- Main -->
  <main class="main">
    <!-- ==================== Dashboard Tab ==================== -->
    <div class="tab-content active" id="tab-dashboard">
    
    <!-- ÂøúÊè¥„Éê„Éä„Éº -->
    <div id="cheerBanner" style="display: none;"></div>
    
    <!-- Hero -->
    <section class="hero">
      <div class="hero-countdown">
        <span class="hero-days" id="mainCountdown">--</span>
        <span class="hero-unit">Êó•</span>
      </div>
      <p class="hero-label">ÂÖ±ÈÄö„ÉÜ„Çπ„Éà„Åæ„Åß</p>
    </section>

    <!-- Stats - Redesigned -->
    <section class="stats-row">
      <div class="stat-hero">
        <div class="stat-value" id="todayMinutes">0ÂàÜ</div>
        <div class="stat-label">‰ªäÊó•„ÅÆÂ≠¶ÁøíÊôÇÈñì</div>
        <div class="stat-sub" id="todayGoalStatus">ÁõÆÊ®ô„Åæ„Åß„ÅÇ„Å® --ÂàÜ</div>
        <div class="stat-actions">
          <button class="stat-action-btn" onclick="openStudyModal()">
            <span class="stat-action-icon">üìñ</span>
            <span>Â≠¶Áøí„ÇíË®òÈå≤</span>
          </button>
          <button class="stat-action-btn secondary" onclick="openRedbookModal()">
            <span class="stat-action-icon">üìï</span>
            <span>Ëµ§Êú¨„ÇíË®òÈå≤</span>
          </button>
        </div>
      </div>
      <div class="stats-grid stats-grid-5">
        <div class="stat-item">
          <div class="stat-value" id="weekMinutes">0h</div>
          <div class="stat-label">‰ªäÈÄ±</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalHours">0h</div>
          <div class="stat-label">Á¥ØË®à</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="avgMinutes">0ÂàÜ</div>
          <div class="stat-label">Âπ≥Âùá/Êó•</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="streakDays">0</div>
          <div class="stat-label">ÈÄ£Á∂öÊó•Êï∞</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalSessions">0</div>
          <div class="stat-label">Â≠¶ÁøíÂõûÊï∞</div>
        </div>
      </div>
    </section>

    <!-- A: Weekly Calendar + B: Daily Chart -->
    <section class="week-overview">
      <div class="week-calendar-card">
        <h4 class="week-card-title">üìÖ ‰ªäÈÄ±„ÅÆÂ≠¶Áøí</h4>
        <div class="week-calendar" id="weekCalendar">
          <!-- Rendered by JS -->
        </div>
      </div>
      <div class="week-chart-card">
        <h4 class="week-card-title">üìä Êó•Âà•Â≠¶ÁøíÊôÇÈñì</h4>
        <div class="week-chart-container">
          <canvas id="dashDailyChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Recommendations Only -->
    <section class="recommendation-section" id="recommendationSection" style="display: none;">
      <div class="recommendation-card-solo">
        <div class="recommendation-header">
          <span class="recommendation-header-icon">üí™</span>
          <span class="recommendation-header-title">‰ªäÊó•„ÅÆ„Åä„Åô„Åô„ÇÅ</span>
        </div>
        <div class="recommendation-list" id="recommendationList">
          <!-- Rendered by JS -->
        </div>
      </div>
    </section>

    <!-- Progress -->
    <section class="progress-section" id="progressSection">
      <div class="section-header">
        <span class="section-title"><span class="section-title-icon">üéØ</span> ÈÄ±ÈñìÁõÆÊ®ô</span>
        <span class="section-value" id="progressValue">0 / 1800 ÂàÜ</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div id="progressCelebration"></div>
    </section>

    <!-- Goals -->
    <section class="card" style="margin-bottom: 1.5rem;">
      <h3 class="card-title"><span class="card-title-icon">üèÜ</span> ÁõÆÊ®ôÈÄ≤Êçó</h3>
      <div class="goals-list" id="goalsSection">
        <!-- Goals rendered here -->
      </div>
    </section>

    <!-- Records -->
    <section class="grid-2">
      <div class="card">
        <h3 class="card-title"><span class="card-title-icon">üìñ</span> ÊúÄËøë„ÅÆÂ≠¶ÁøíË®òÈå≤</h3>
        <div class="records-list" id="studyRecordsList">
          <div class="empty-state">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title"><span class="card-title-icon">üìï</span> Ëµ§Êú¨ÊºîÁøíÂ±•Ê≠¥</h3>
        <div class="records-list" id="redbookRecordsList">
          <div class="empty-state">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        </div>
      </div>
    </section>
    </div><!-- End Dashboard Tab -->

    <!-- ==================== Study Analysis Tab ==================== -->
    <div class="tab-content" id="tab-study">
      <section class="analysis-header">
        <h2 class="analysis-title">üìö Â≠¶ÁøíÂàÜÊûê</h2>
        <p class="analysis-subtitle">Â≠¶ÁøíË®òÈå≤„Éá„Éº„Çø„ÅÆË©≥Á¥∞ÂàÜÊûê</p>
      </section>

      <!-- Study Stats -->
      <section class="stats-row four-cols">
        <div class="stat-item">
          <div class="stat-value" id="studyTotalHours">0</div>
          <div class="stat-label">Á¥ØË®àÔºàÊôÇÈñìÔºâ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="studyAvgDaily">0</div>
          <div class="stat-label">1Êó•Âπ≥ÂùáÔºàÂàÜÔºâ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="studyTotalDays">0</div>
          <div class="stat-label">Â≠¶ÁøíÊó•Êï∞</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="studyMaxStreak">0</div>
          <div class="stat-label">ÊúÄÈï∑ÈÄ£Á∂ö</div>
        </div>
      </section>

      <!-- Insights (moved from dashboard) -->
      <section class="card" id="insightsCard" style="display: none;">
        <h3 class="card-title"><span class="card-title-icon">üí°</span> „Ç§„É≥„Çµ„Ç§„Éà</h3>
        <div class="insight-list" id="insightsListStudy">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Weekly Charts -->
      <section class="grid-2">
        <div class="card">
          <h3 class="card-title"><span class="card-title-icon">üìà</span> Êó•Âà•Â≠¶ÁøíÊôÇÈñì</h3>
          <div class="chart-container">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title"><span class="card-title-icon">üìä</span> ÁßëÁõÆÂà•Ââ≤Âêà</h3>
          <div class="chart-container">
            <canvas id="subjectChart"></canvas>
          </div>
        </div>
      </section>

      <!-- Subject Breakdown -->
      <section class="card">
        <h3 class="card-title">ÁßëÁõÆÂà•Â≠¶ÁøíÊôÇÈñì</h3>
        <div id="subjectBreakdown" class="breakdown-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Day of Week Analysis -->
      <section class="card">
        <h3 class="card-title">ÊõúÊó•Âà•Â≠¶Áøí„Éë„Çø„Éº„É≥</h3>
        <div class="chart-container">
          <canvas id="dayOfWeekChart"></canvas>
        </div>
      </section>

      <!-- Study Type Analysis -->
      <section class="card">
        <h3 class="card-title">Â≠¶Áøí„Çø„Ç§„ÉóÂà•Ââ≤Âêà</h3>
        <div id="studyTypeBreakdown" class="breakdown-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Mood Analysis -->
      <section class="card">
        <h3 class="card-title">ÊâãÂøú„ÅàÂàÜÊûê</h3>
        <div id="moodAnalysis" class="mood-grid">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- All Study Records -->
      <section class="card">
        <h3 class="card-title">ÂÖ®Â≠¶ÁøíË®òÈå≤</h3>
        <div class="filter-row">
          <select class="form-input form-select filter-select" id="studyFilterSubject" onchange="filterStudyRecords()">
            <option value="">ÂÖ®ÁßëÁõÆ</option>
          </select>
          <select class="form-input form-select filter-select" id="studyFilterPeriod" onchange="filterStudyRecords()">
            <option value="all">ÂÖ®ÊúüÈñì</option>
            <option value="7">ÈÅéÂéª7Êó•</option>
            <option value="30">ÈÅéÂéª30Êó•</option>
            <option value="90">ÈÅéÂéª90Êó•</option>
          </select>
        </div>
        <div class="records-list full-height" id="allStudyRecords">
          <div class="empty-state">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        </div>
      </section>
    </div><!-- End Study Tab -->

    <!-- ==================== Redbook Analysis Tab ==================== -->
    <div class="tab-content" id="tab-redbook">
      <section class="analysis-header">
        <h2 class="analysis-title">üìï ÈÅéÂéªÂïèÂàÜÊûê</h2>
        <p class="analysis-subtitle">Ëµ§Êú¨„ÉªÊ®°Ë©¶„ÅÆÊºîÁøí„Éá„Éº„ÇøÂàÜÊûê</p>
      </section>

      <!-- Redbook Stats -->
      <section class="stats-row four-cols">
        <div class="stat-item">
          <div class="stat-value" id="redbookTotalCount">0</div>
          <div class="stat-label">ÊºîÁøíÂõûÊï∞</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="redbookAvgScore">0%</div>
          <div class="stat-label">Âπ≥ÂùáÂæóÁÇπÁéá</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="redbookHighScore">0%</div>
          <div class="stat-label">ÊúÄÈ´òÂæóÁÇπ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="redbookTrend">‚Äï</div>
          <div class="stat-label">ÂÇæÂêë</div>
        </div>
      </section>

      <!-- Score Trend Chart -->
      <section class="card">
        <h3 class="card-title">ÂæóÁÇπÁéáÊé®Áßª</h3>
        <div class="filter-row">
          <select class="form-input form-select filter-select" id="scoreTrendSubject" onchange="updateScoreTrendChart()">
            <option value="">ÂÖ®ÁßëÁõÆ</option>
          </select>
        </div>
        <div class="chart-container">
          <canvas id="scoreTrendChart"></canvas>
        </div>
      </section>

      <!-- Subject Scores -->
      <section class="card">
        <h3 class="card-title">ÁßëÁõÆÂà•Âπ≥ÂùáÂæóÁÇπÁéá</h3>
        <div id="subjectScores" class="breakdown-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- University Scores -->
      <section class="card">
        <h3 class="card-title">Â§ßÂ≠¶Âà•Âπ≥ÂùáÂæóÁÇπÁéá</h3>
        <div id="universityScores" class="breakdown-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Weak Areas -->
      <section class="card">
        <h3 class="card-title">‚ö†Ô∏è È†ªÂá∫„ÅÆËã¶ÊâãÂàÜÈáé</h3>
        <div id="weakAreasList" class="weak-areas-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Growth Progress by University -->
      <section class="card">
        <h3 class="card-title"><span class="card-title-icon">üìà</span> ÊàêÈï∑„Ç∞„É©„Éï</h3>
        <div class="filter-row">
          <select class="form-input form-select filter-select" id="growthUnivSelect" onchange="updateGrowthSubjects(); renderGrowthChart()">
            <option value="">Â§ßÂ≠¶„ÇíÈÅ∏Êäû</option>
          </select>
          <select class="form-input form-select filter-select" id="growthSubjectSelect" onchange="renderGrowthChart()">
            <option value="">ÁßëÁõÆ„ÇíÈÅ∏Êäû</option>
          </select>
        </div>
        <div class="growth-chart-container" id="growthChartContainer" style="display: none;">
          <canvas id="growthChart"></canvas>
          <div class="growth-summary" id="growthSummary"></div>
        </div>
        <div class="growth-empty" id="growthEmpty">
          <p>Â§ßÂ≠¶„Å®ÁßëÁõÆ„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅÂæóÁÇπ„ÅÆÊé®Áßª„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
        </div>
      </section>

      <!-- All Redbook Records -->
      <section class="card">
        <h3 class="card-title">ÂÖ®ÊºîÁøíË®òÈå≤</h3>
        <div class="filter-row">
          <select class="form-input form-select filter-select" id="redbookFilterSubject" onchange="filterRedbookRecords()">
            <option value="">ÂÖ®ÁßëÁõÆ</option>
          </select>
          <select class="form-input form-select filter-select" id="redbookFilterUniv" onchange="filterRedbookRecords()">
            <option value="">ÂÖ®Â§ßÂ≠¶</option>
          </select>
        </div>
        <div class="records-list full-height" id="allRedbookRecords">
          <div class="empty-state">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        </div>
      </section>
    </div><!-- End Redbook Tab -->
  </main>

  <!-- Study Log Modal -->
  <div class="modal-overlay" id="studyModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Â≠¶ÁøíË®òÈå≤„ÇíËøΩÂä†</h2>
        <button class="modal-close" onclick="closeStudyModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">Êó•‰ªò</label>
          <input type="date" class="form-input" id="studyDate">
        </div>
        <div class="form-group">
          <label class="form-label required">ÁßëÁõÆ</label>
          <div class="btn-group" id="subjectButtons">
            <button class="btn-option" data-value="Áèæ‰ª£Êñá">Áèæ‰ª£Êñá</button>
            <button class="btn-option" data-value="Âè§Êñá">Âè§Êñá</button>
            <button class="btn-option" data-value="Êº¢Êñá">Êº¢Êñá</button>
            <button class="btn-option" data-value="Êï∞Â≠¶1A">Êï∞Â≠¶1A</button>
            <button class="btn-option" data-value="Êï∞Â≠¶2B">Êï∞Â≠¶2B</button>
            <button class="btn-option" data-value="ÂçòË™û">ÂçòË™û</button>
            <button class="btn-option" data-value="ÊñáÊ≥ï">ÊñáÊ≥ï</button>
            <button class="btn-option" data-value="Èï∑Êñá">Èï∑Êñá</button>
            <button class="btn-option" data-value="Èü≥Ë™≠">Èü≥Ë™≠</button>
            <button class="btn-option" data-value="„É™„Çπ„Éã„É≥„Ç∞">„É™„Çπ„Éã„É≥„Ç∞</button>
            <button class="btn-option" data-value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">üéØ Â≠¶Áøí„Çø„Ç§„Éó</label>
          <div class="btn-group" id="studyTypeButtons">
            <button class="btn-option" data-value="Êñ∞Ë¶è">Êñ∞Ë¶è</button>
            <button class="btn-option" data-value="Âæ©Áøí">Âæ©Áøí</button>
            <button class="btn-option" data-value="ÊºîÁøí">ÊºîÁøí</button>
            <button class="btn-option" data-value="ÊöóË®ò">ÊöóË®ò</button>
            <button class="btn-option" data-value="ÈÅéÂéªÂïè">ÈÅéÂéªÂïè</button>
            <button class="btn-option" data-value="Ê®°Ë©¶">Ê®°Ë©¶</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label required">Â≠¶ÁøíÊôÇÈñì</label>
          <div class="btn-group" id="timeButtons">
            <button class="btn-option" data-value="15">15ÂàÜ</button>
            <button class="btn-option" data-value="30">30ÂàÜ</button>
            <button class="btn-option" data-value="45">45ÂàÜ</button>
            <button class="btn-option" data-value="50">50ÂàÜ</button>
            <button class="btn-option" data-value="60">1ÊôÇÈñì</button>
            <button class="btn-option" data-value="90">1.5ÊôÇÈñì</button>
            <button class="btn-option" data-value="120">2ÊôÇÈñì</button>
            <button class="btn-option" data-value="150">2ÊôÇÈñìË∂Ö</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ÊâãÂøú„Åà</label>
          <div class="mood-group" id="moodButtons">
            <button class="mood-btn" data-value="üò´">üò´</button>
            <button class="mood-btn" data-value="üòï">üòï</button>
            <button class="mood-btn" data-value="üòê">üòê</button>
            <button class="mood-btn" data-value="üôÇ">üôÇ</button>
            <button class="mood-btn" data-value="üòä">üòä</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">üìö ÂçòÂÖÉ„ÉªÁ´†Ôºà‰ªªÊÑèÔºâ</label>
          <input type="text" class="form-input" id="studyUnit" placeholder="‰æã: Á¨¨3Á´† ‰∫åÊ¨°Èñ¢Êï∞„ÄÅUnit15-16">
        </div>
        <div class="form-group">
          <label class="form-label">ÂèÇËÄÉÊõ∏ÂêçÔºà‰ªªÊÑèÔºâ</label>
          <input type="text" class="form-input" id="studyTextbook" placeholder="‰æã: ÈÄüË™≠Ëã±ÂçòË™û">
        </div>
        <div class="form-group">
          <label class="form-label">„É°„É¢Ôºà‰ªªÊÑèÔºâ</label>
          <textarea class="form-input form-textarea" id="studyMemo" placeholder="Â≠¶ÁøíÂÜÖÂÆπ„ÇÑÊ∞ó„Å•„Åç„Å™„Å©"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeStudyModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn btn-primary" onclick="submitStudyLog()">Ë®òÈå≤„Åô„Çã</button>
      </div>
    </div>
  </div>

  <!-- Redbook Modal -->
  <div class="modal-overlay" id="redbookModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Ëµ§Êú¨Ë®òÈå≤„ÇíËøΩÂä†</h2>
        <button class="modal-close" onclick="closeRedbookModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">Êó•‰ªò</label>
          <input type="date" class="form-input" id="redbookDate">
        </div>
        <div class="form-group">
          <label class="form-label required">Â§ßÂ≠¶Âêç</label>
          <select class="form-input form-select" id="redbookUniversity" onchange="toggleCustomUniversity(); showPreviousRedbookRecord()">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            <option value="Á´ãÊïôÂ§ßÂ≠¶">Á´ãÊïôÂ§ßÂ≠¶</option>
            <option value="ÈùíÂ±±Â≠¶Èô¢Â§ßÂ≠¶">ÈùíÂ±±Â≠¶Èô¢Â§ßÂ≠¶</option>
            <option value="Ê≥ïÊîøÂ§ßÂ≠¶">Ê≥ïÊîøÂ§ßÂ≠¶</option>
            <option value="‰∏≠Â§ÆÂ§ßÂ≠¶">‰∏≠Â§ÆÂ§ßÂ≠¶</option>
            <option value="ÊòéÊ≤ªÂ≠¶Èô¢Â§ßÂ≠¶">ÊòéÊ≤ªÂ≠¶Èô¢Â§ßÂ≠¶</option>
            <option value="ÊàêÂüéÂ§ßÂ≠¶">ÊàêÂüéÂ§ßÂ≠¶</option>
            <option value="Êù±Ê¥ãÂ§ßÂ≠¶">Êù±Ê¥ãÂ§ßÂ≠¶</option>
            <option value="ÈßíÊæ§Â§ßÂ≠¶">ÈßíÊæ§Â§ßÂ≠¶</option>
            <option value="Êó•Êú¨Â§ßÂ≠¶">Êó•Êú¨Â§ßÂ≠¶</option>
            <option value="Â∞Ç‰øÆÂ§ßÂ≠¶">Â∞Ç‰øÆÂ§ßÂ≠¶</option>
            <option value="ÂÖ±ÈÄö„ÉÜ„Çπ„Éà">ÂÖ±ÈÄö„ÉÜ„Çπ„Éà</option>
            <option value="__custom__">„Åù„ÅÆ‰ªñÔºàÂÖ•Âäõ„Åô„ÇãÔºâ</option>
          </select>
          <div class="custom-input-wrapper" id="customUniversityWrapper">
            <input type="text" class="form-input" id="customUniversity" placeholder="Â§ßÂ≠¶Âêç„ÇíÂÖ•Âäõ">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label required">ÁßëÁõÆ</label>
          <select class="form-input form-select" id="redbookSubject" onchange="showPreviousRedbookRecord()">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            <optgroup label="Ëã±Ë™û">
              <option value="Ëã±Ë™ûR">Ëã±Ë™ûRÔºà„É™„Éº„Éá„Ç£„É≥„Ç∞Ôºâ</option>
              <option value="Ëã±Ë™ûL">Ëã±Ë™ûLÔºà„É™„Çπ„Éã„É≥„Ç∞Ôºâ</option>
              <option value="Ëã±Ë™û">Ëã±Ë™ûÔºàÁ∑èÂêàÔºâ</option>
            </optgroup>
            <optgroup label="ÂõΩË™û">
              <option value="Áèæ‰ª£Êñá">Áèæ‰ª£Êñá</option>
              <option value="Âè§Êñá">Âè§Êñá</option>
              <option value="Êº¢Êñá">Êº¢Êñá</option>
              <option value="ÂõΩË™û">ÂõΩË™ûÔºàÁ∑èÂêàÔºâ</option>
            </optgroup>
            <optgroup label="Êï∞Â≠¶">
              <option value="Êï∞Â≠¶IA">Êï∞Â≠¶IA</option>
              <option value="Êï∞Â≠¶IIB">Êï∞Â≠¶IIB</option>
              <option value="Êï∞Â≠¶IIIC">Êï∞Â≠¶IIIC</option>
              <option value="Êï∞Â≠¶">Êï∞Â≠¶ÔºàÁ∑èÂêàÔºâ</option>
            </optgroup>
          </select>
          <!-- ÂâçÂõû„ÅÆË®òÈå≤Ë°®Á§∫„Ç®„É™„Ç¢ -->
          <div class="previous-record-hint" id="previousRedbookRecord" style="display: none;">
            <div class="previous-record-header">
              <span class="previous-record-icon">üí°</span>
              <span class="previous-record-title">ÂâçÂõû„ÅÆË®òÈå≤</span>
            </div>
            <div class="previous-record-content" id="previousRedbookContent"></div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label required">Âπ¥Â∫¶</label>
          <select class="form-input form-select" id="redbookYear">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            <option value="2025">2025Âπ¥</option>
            <option value="2024">2024Âπ¥</option>
            <option value="2023">2023Âπ¥</option>
            <option value="2022">2022Âπ¥</option>
            <option value="2021">2021Âπ¥</option>
            <option value="2020">2020Âπ¥</option>
            <option value="2019">2019Âπ¥</option>
            <option value="2018">2018Âπ¥</option>
            <option value="2017">2017Âπ¥</option>
            <option value="2016">2016Âπ¥</option>
            <option value="2015">2015Âπ¥</option>
            <option value="2014‰ª•Ââç">2014Âπ¥‰ª•Ââç</option>
            <option value="„Ç™„É™„Ç∏„Éä„É´">„Ç™„É™„Ç∏„Éä„É´ÂïèÈ°å</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label required">ÂæóÁÇπ</label>
          <div class="score-input-container">
            <div class="score-row score-total">
              <span class="score-label">Á∑èÂêà</span>
              <div class="score-inputs">
                <input type="number" class="form-input score-box" id="totalScoreGot" readonly placeholder="0">
                <span class="score-divider">/</span>
                <input type="number" class="form-input score-box" id="totalScoreMax" readonly placeholder="0">
                <span class="score-percent" id="totalScorePercent">Ôºà0%Ôºâ</span>
              </div>
            </div>
            <div id="sectionScoresContainer">
              <div class="score-row" data-section="1">
                <input type="text" class="form-input section-name" value="Â§ßÂïè1" placeholder="Â§ßÂïè1">
                <div class="score-inputs">
                  <input type="number" class="form-input score-box section-got" min="0" placeholder="0" oninput="calculateTotalScore()">
                  <span class="score-divider">/</span>
                  <input type="number" class="form-input score-box section-max" min="0" placeholder="0" oninput="calculateTotalScore()">
                </div>
              </div>
              <div class="score-row" data-section="2">
                <input type="text" class="form-input section-name" value="Â§ßÂïè2" placeholder="Â§ßÂïè2">
                <div class="score-inputs">
                  <input type="number" class="form-input score-box section-got" min="0" placeholder="0" oninput="calculateTotalScore()">
                  <span class="score-divider">/</span>
                  <input type="number" class="form-input score-box section-max" min="0" placeholder="0" oninput="calculateTotalScore()">
                </div>
              </div>
            </div>
            <div class="score-buttons">
              <button type="button" class="btn btn-sm btn-outline" onclick="removeSection()">‚àí</button>
              <button type="button" class="btn btn-sm btn-outline" onclick="addSection()">Ôºã</button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">‚è±Ô∏è Ëß£Á≠îÊôÇÈñìÔºàÂàÜÔºâ</label>
          <div class="time-input-toggle">
            <button type="button" class="time-toggle-btn active" onclick="toggleTimeInputMode('total')">Á∑èÂêà„ÅÆ„Åø</button>
            <button type="button" class="time-toggle-btn" onclick="toggleTimeInputMode('section')">Â§ßÂïè„Åî„Å®</button>
          </div>
          <div id="totalTimeInput">
            <input type="number" class="form-input" id="redbookTime" min="0" placeholder="‰æã: 80">
          </div>
          <div id="sectionTimeInput" style="display: none;">
            <div class="score-input-container" style="padding: 0.75rem;">
              <div class="score-row" style="margin-bottom: 0.5rem;">
                <span class="score-label" style="font-weight: 600;">Á∑èÂêà</span>
                <div class="score-inputs">
                  <input type="number" class="form-input score-box" id="totalTimeCalc" readonly placeholder="0">
                  <span style="color: var(--gray-500); font-size: 0.875rem;">ÂàÜÔºàËá™ÂãïË®àÁÆóÔºâ</span>
                </div>
              </div>
              <div id="sectionTimesContainer">
                <!-- Generated by JS based on score sections -->
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">üìã ÈñìÈÅï„Åà„ÅüÂàÜÈáéÔºà‰ªªÊÑèÔºâ</label>
          <input type="text" class="form-input" id="redbookWeakAreas" placeholder="‰æã: Èñ¢‰øÇË©û„ÄÅÈï∑ÊñáË™≠Ëß£„ÄÅÁ¢∫Áéá">
        </div>
        <div class="form-group">
          <label class="form-label">„É°„É¢Ôºà‰ªªÊÑèÔºâ</label>
          <textarea class="form-input form-textarea" id="redbookMemo" placeholder="ÂèçÁúÅÁÇπ„ÇÑÊ¨°Âõû„ÅÆË™≤È°å„Å™„Å©"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeRedbookModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn btn-primary" onclick="submitRedbookLog()">Ë®òÈå≤„Åô„Çã</button>
      </div>
    </div>
  </div>

  <!-- AI Modal -->
  <div class="modal-overlay" id="aiModal">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header">
        <h2 class="modal-title">AI„Å´Áõ∏Ë´á</h2>
        <button class="modal-close" onclick="closeAIModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="ai-question">‰Ωï„Å´„Å§„ÅÑ„Å¶Áõ∏Ë´á„Åó„Åæ„Åô„ÅãÔºü</p>
        
        <!-- „É°„Ç§„É≥„ÅÆ4„Å§ -->
        <div class="ai-main-options" id="aiMainOptions">
          <div class="ai-card active" data-type="weekly">
            <div class="ai-card-icon">üìÖ</div>
            <div class="ai-card-content">
              <div class="ai-card-title">Êù•ÈÄ±„ÅÆË®àÁîª„ÇíÁ´ã„Å¶„Åü„ÅÑ</div>
              <div class="ai-card-desc">Â≠¶Áøí„Éá„Éº„Çø„ÇíÂÖÉ„Å´ÊúÄÈÅ©„Å™„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÊèêÊ°à</div>
            </div>
          </div>
          <div class="ai-card" data-type="weakness">
            <div class="ai-card-icon">üéØ</div>
            <div class="ai-card-content">
              <div class="ai-card-title">Ëã¶Êâã„ÇíÂÖãÊúç„Åó„Åü„ÅÑ</div>
              <div class="ai-card-desc">Âº±ÁÇπÂàÜÊûê„Å®ÂÖ∑‰ΩìÁöÑ„Å™ÂØæÁ≠ñÊñπÊ≥ï</div>
            </div>
          </div>
          <div class="ai-card" data-type="redbook">
            <div class="ai-card-icon">üìï</div>
            <div class="ai-card-content">
              <div class="ai-card-title">ÈÅéÂéªÂïè„ÅÆÊà¶Áï•„ÇíÁ´ã„Å¶„Åü„ÅÑ</div>
              <div class="ai-card-desc">ÊºîÁøí„Éá„Éº„Çø„Åã„ÇâÊúÄÈÅ©„Å™ÈÅéÂéªÂïèÊ¥ªÁî®Ê≥ï„ÇíÊèêÊ°à</div>
            </div>
          </div>
          <div class="ai-card" data-type="motivation">
            <div class="ai-card-icon">üí™</div>
            <div class="ai-card-content">
              <div class="ai-card-title">„ÇÑ„ÇãÊ∞ó„ÇíÂá∫„Åó„Åü„ÅÑ</div>
              <div class="ai-card-desc">Âä™Âäõ„ÇíË™ç„ÇÅ„Å¶Âä±„Åæ„Åó„Å¶„ÇÇ„Çâ„ÅÜ</div>
            </div>
          </div>
        </div>
        
        <!-- „Åù„ÅÆ‰ªñ„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥ÔºàÊäò„Çä„Åü„Åü„ÅøÔºâ -->
        <div class="ai-more-toggle" onclick="toggleMoreOptions()">
          <span id="moreToggleText">„Åù„ÅÆ‰ªñ„ÅÆÁõ∏Ë´á ‚ñº</span>
        </div>
        <div class="ai-more-options" id="aiMoreOptions" style="display: none;">
          <div class="ai-option-small" data-type="daily">
            <span class="ai-option-small-icon">üìù</span>
            <span>‰ªäÊó•„ÅÆÊåØ„ÇäËøî„Çä</span>
          </div>
          <div class="ai-option-small" data-type="section">
            <span class="ai-option-small-icon">üß©</span>
            <span>Â§ßÂïèÂà•ÊîªÁï•</span>
          </div>
          <div class="ai-option-small" data-type="university">
            <span class="ai-option-small-icon">üè´</span>
            <span>Â§ßÂ≠¶Âà•ÂØæÁ≠ñ</span>
          </div>
          <div class="ai-option-small" data-type="efficiency">
            <span class="ai-option-small-icon">‚è±Ô∏è</span>
            <span>ÊôÇÈñìÂäπÁéáÂàÜÊûê</span>
          </div>
          <div class="ai-option-small" data-type="prediction">
            <span class="ai-option-small-icon">üìä</span>
            <span>ÂæóÁÇπ‰∫àÊ∏¨</span>
          </div>
          <div class="ai-option-small" data-type="subject">
            <span class="ai-option-small-icon">üìö</span>
            <span>ÁßëÁõÆÂà•Áõ∏Ë´á</span>
          </div>
          <div class="ai-option-small" data-type="lastspurt">
            <span class="ai-option-small-icon">üî•</span>
            <span>Áõ¥ÂâçÊúüÂØæÁ≠ñ</span>
          </div>
        </div>
        
        <!-- ÁßëÁõÆÈÅ∏ÊäûÔºàÁßëÁõÆÂà•Áõ∏Ë´áÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
        <div class="form-group" id="subjectSelectGroup" style="display: none;">
          <label class="form-label">Áõ∏Ë´á„Åó„Åü„ÅÑÁßëÁõÆ</label>
          <select class="form-select" id="aiSubjectSelect" onchange="generatePrompt()">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            <option value="Ëã±Ë™û">Ëã±Ë™û</option>
            <option value="Êï∞Â≠¶">Êï∞Â≠¶</option>
            <option value="ÂõΩË™û">ÂõΩË™û</option>
          </select>
        </div>
        
        <!-- Â§ßÂ≠¶ÈÅ∏ÊäûÔºàÂ§ßÂ≠¶Âà•ÂØæÁ≠ñÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
        <div class="form-group" id="universitySelectGroup" style="display: none;">
          <label class="form-label">ÂØæÁ≠ñ„Åó„Åü„ÅÑÂ§ßÂ≠¶</label>
          <select class="form-select" id="aiUniversitySelect" onchange="generatePrompt()">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            <!-- ÈÅéÂéªÂïè„Éá„Éº„Çø„Åã„ÇâÂãïÁöÑ„Å´ÁîüÊàê -->
          </select>
        </div>
        
        <label class="form-label">ÁîüÊàê„Åï„Çå„Åü„Éó„É≠„É≥„Éó„Éà</label>
        <div class="prompt-preview" id="promptPreview">ÁîüÊàê‰∏≠...</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeAIModal()">Èñâ„Åò„Çã</button>
        <button class="btn btn-primary" onclick="copyPrompt()">„Ç≥„Éî„Éº„Åó„Å¶AI„Å∏</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Ë®≠ÂÆö</h2>
        <button class="modal-close" onclick="closeSettingsModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Apps Script URL</label>
          <input type="text" class="form-input" id="settingsApiUrl" placeholder="https://script.google.com/...">
        </div>
        <div class="form-group">
          <label class="form-label">ÈÄ±ÈñìÁõÆÊ®ôÔºàÂàÜÔºâ</label>
          <input type="number" class="form-input" id="settingsWeeklyGoal" value="1800" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">ÂÖ±ÈÄö„ÉÜ„Çπ„ÉàÊó•</label>
          <input type="date" class="form-input" id="settingsExamDate">
        </div>
        <div class="form-group">
          <label class="form-label">„ÉÅ„É£„ÉÉ„ÉàURLÔºà‰ªªÊÑèÔºâ</label>
          <input type="text" class="form-input" id="settingsChatUrl" placeholder="https://script.google.com/...">
          <p style="font-size: 0.75rem; color: var(--gray-400); margin-top: 0.25rem;">
            „É°„ÉÉ„Çª„Éº„Ç∏Ê©üËÉΩ„ÇíÊúâÂäπ„Å´„Åó„Åæ„Åô
          </p>
        </div>
        
        <!-- „Éá„Éº„ÇøÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
          <label class="form-label">„Éá„Éº„ÇøÁÆ°ÁêÜ</label>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-outline" onclick="openDataManager('study')" style="flex: 1; min-width: 120px;">
              üìñ Â≠¶ÁøíË®òÈå≤
            </button>
            <button class="btn btn-outline" onclick="openDataManager('redbook')" style="flex: 1; min-width: 120px;">
              üìï ÈÅéÂéªÂïèË®òÈå≤
            </button>
          </div>
          <p style="font-size: 0.75rem; color: var(--gray-400); margin-top: 0.5rem;">
            Ë®òÈå≤„ÅÆÁ¢∫Ë™ç„ÉªÂâäÈô§„Åå„Åß„Åç„Åæ„Åô
          </p>
        </div>
        
        <div class="version-info">
          <span id="appVersionDisplay">v1.7.7</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeSettingsModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn btn-primary" onclick="saveSettings()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- „Éá„Éº„ÇøÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay" id="dataManagerModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="dataManagerTitle">„Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
        <button class="modal-close" onclick="closeDataManager()">√ó</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div id="dataManagerContent">
          <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeDataManager()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <!-- „ÉÅ„É£„ÉÉ„Éà„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay chat-modal" id="chatModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üí¨ „É°„ÉÉ„Çª„Éº„Ç∏</h2>
        <button class="modal-close" onclick="closeChat()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="chat-empty">
              <div class="chat-empty-icon">üí¨</div>
              „É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
            </div>
          </div>
          <div class="chat-input-area">
            <textarea class="chat-input" id="chatInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
            <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">‚û§</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // „Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜ & „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢
    // ==========================================
    const APP_VERSION = '2.0.0';
    const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbygSI6dft0E2d_D0isU4lAlWuuQgWRMlizHOdMTDqt8w1Igpud6nvpvN1Gy1t2AyLGpBw/exec';
    const DEFAULT_CHAT_URL = 'https://script.google.com/macros/s/AKfycbxppU_VWeV9IwVl-5tY7o0vuMCqRURoH0fltq_mo7JSegCv5VI-X1QjG7khcATLlj7vGQ/exec';
    
    // „É≠„Éº„Ç´„É´ÊôÇÂàª„ÅßÊó•‰ªòÊñáÂ≠óÂàó„Çí‰ΩúÊàêÔºà„Çø„Ç§„É†„Çæ„Éº„É≥ÂïèÈ°å„ÇíÂõûÈÅøÔºâ
    function formatDateLocal(date) {
      const d = date instanceof Date ? date : new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    function getTodayStr() {
      return formatDateLocal(new Date());
    }
    
    (function checkVersion() {
      const storedVersion = localStorage.getItem('appVersion');
      
      if (storedVersion !== APP_VERSION) {
        console.log(`App updated: ${storedVersion || 'none'} ‚Üí ${APP_VERSION}`);
        
        // URL„ÇíÊúÄÊñ∞„ÅÆ„Éá„Éï„Ç©„É´„Éà„Å´Êõ¥Êñ∞
        localStorage.setItem('apiUrl', DEFAULT_API_URL);
        localStorage.setItem('chatUrl', DEFAULT_CHAT_URL);
        
        // „Éê„Éº„Ç∏„Éß„É≥„Çí‰øùÂ≠ò
        localStorage.setItem('appVersion', APP_VERSION);
        
        // Êõ¥Êñ∞ÈÄöÁü•ÔºàÂàùÂõû‰ª•Â§ñÔºâ
        if (storedVersion) {
          setTimeout(() => {
            showToast(`„Ç¢„Éó„É™„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü (v${APP_VERSION})`, 'success');
          }, 1000);
        }
      }
    })();
    
    // ==========================================
    // „É°„Ç§„É≥
    // ==========================================
    let API_URL = localStorage.getItem('apiUrl') || DEFAULT_API_URL;
    let CHAT_URL = localStorage.getItem('chatUrl') || DEFAULT_CHAT_URL;
    let appData = {
      studyLogs: [],
      redbookLogs: [],
      goals: [],
      profile: {},
      settings: { weeklyGoalMinutes: 1800 }
    };
    
    let selectedSubject = '';
    let selectedTime = 0;
    let selectedMood = '';
    let selectedStudyType = '';
    let selectedAIType = 'weekly';
    
    let dailyChart = null;
    let subjectChart = null;
    let dayOfWeekChart = null;
    let scoreTrendChart = null;
    let timeInputMode = 'total';
    
    document.addEventListener('DOMContentLoaded', () => {
      initializeDateInputs();
      initializeButtonGroups();
      initializeAIOptions();
      loadSettingsFromStorage();
      initChat(); // „ÉÅ„É£„ÉÉ„ÉàÂàùÊúüÂåñ
      
      if (API_URL) {
        refreshData();
        loadCheerMessages(); // ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË™≠„ÅøËæº„Åø
      } else {
        hideLoading();
      }
    });
    
    // ==========================================
    // „Çø„ÉñÂàá„ÇäÊõø„Åà
    // ==========================================
    function switchTab(tabName) {
      // „Çø„Éñ„Éú„Çø„É≥„ÅÆÂàá„ÇäÊõø„Åà
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      
      // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÂàá„ÇäÊõø„Åà
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
      });
      
      // ÂàÜÊûê„Çø„Éñ„Å´Âàá„ÇäÊõø„Åà„ÅüÊôÇ„Å´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
      if (tabName === 'study') {
        renderStudyAnalysis();
      } else if (tabName === 'redbook') {
        renderRedbookAnalysis();
      }
    }
    
    // ==========================================
    // ÊôÇÈñìÂÖ•Âäõ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
    // ==========================================
    function toggleTimeInputMode(mode) {
      timeInputMode = mode;
      
      document.querySelectorAll('.time-toggle-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      if (mode === 'total') {
        document.getElementById('totalTimeInput').style.display = 'block';
        document.getElementById('sectionTimeInput').style.display = 'none';
      } else {
        document.getElementById('totalTimeInput').style.display = 'none';
        document.getElementById('sectionTimeInput').style.display = 'block';
        syncSectionTimesWithScores();
      }
    }
    
    function syncSectionTimesWithScores() {
      const scoreContainer = document.getElementById('sectionScoresContainer');
      const timeContainer = document.getElementById('sectionTimesContainer');
      const scoreRows = scoreContainer.querySelectorAll('.score-row');
      
      timeContainer.innerHTML = '';
      
      scoreRows.forEach((row, index) => {
        const sectionName = row.querySelector('.section-name').value || `Â§ßÂïè${index + 1}`;
        const timeRow = document.createElement('div');
        timeRow.className = 'score-row';
        timeRow.style.marginBottom = '0.5rem';
        timeRow.innerHTML = `
          <span class="score-label">${sectionName}</span>
          <div class="score-inputs">
            <input type="number" class="form-input section-time-input" min="0" placeholder="0" oninput="calculateTotalTime()">
            <span style="color: var(--gray-500); font-size: 0.875rem;">ÂàÜ</span>
          </div>
        `;
        timeContainer.appendChild(timeRow);
      });
    }
    
    function calculateTotalTime() {
      const timeInputs = document.querySelectorAll('#sectionTimesContainer .section-time-input');
      let total = 0;
      timeInputs.forEach(input => {
        total += parseInt(input.value) || 0;
      });
      document.getElementById('totalTimeCalc').value = total;
    }
    
    function initializeDateInputs() {
      const today = getTodayStr();
      document.getElementById('studyDate').value = today;
      document.getElementById('redbookDate').value = today;
    }
    
    function initializeButtonGroups() {
      document.querySelectorAll('#subjectButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#subjectButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedSubject = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#timeButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#timeButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedTime = parseInt(btn.dataset.value);
        });
      });
      
      document.querySelectorAll('#moodButtons .mood-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#moodButtons .mood-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedMood = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#studyTypeButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#studyTypeButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedStudyType = btn.dataset.value;
        });
      });
    }
    
    function initializeAIOptions() {
      // „É°„Ç§„É≥„Ç´„Éº„Éâ„ÅÆ„Ç§„Éô„É≥„Éà
      document.querySelectorAll('.ai-card').forEach(card => {
        card.addEventListener('click', () => {
          selectAIOption(card);
        });
      });
      
      // „Åù„ÅÆ‰ªñ„Ç™„Éó„Ç∑„Éß„É≥„ÅÆ„Ç§„Éô„É≥„Éà
      document.querySelectorAll('.ai-option-small').forEach(option => {
        option.addEventListener('click', () => {
          selectAIOption(option);
        });
      });
    }
    
    function selectAIOption(element) {
      // „Åô„Åπ„Å¶„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
      document.querySelectorAll('.ai-card').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.ai-option-small').forEach(o => o.classList.remove('active'));
      
      // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíË®≠ÂÆö
      element.classList.add('active');
      selectedAIType = element.dataset.type;
      
      // ÁßëÁõÆÂà•Áõ∏Ë´á„ÅÆÂ†¥Âêà„ÅÆ„ÅøÁßëÁõÆÈÅ∏Êäû„ÇíË°®Á§∫
      const subjectSelectGroup = document.getElementById('subjectSelectGroup');
      const universitySelectGroup = document.getElementById('universitySelectGroup');
      
      subjectSelectGroup.style.display = selectedAIType === 'subject' ? 'block' : 'none';
      universitySelectGroup.style.display = selectedAIType === 'university' ? 'block' : 'none';
      
      // Â§ßÂ≠¶ÈÅ∏ÊäûÊôÇ„ÅØÈÅ∏ÊäûËÇ¢„ÇíÂãïÁöÑ„Å´ÁîüÊàê
      if (selectedAIType === 'university') {
        populateUniversitySelect();
      }
      
      generatePrompt();
    }
    
    function toggleMoreOptions() {
      const moreOptions = document.getElementById('aiMoreOptions');
      const toggleText = document.getElementById('moreToggleText');
      
      if (moreOptions.style.display === 'none') {
        moreOptions.style.display = 'flex';
        toggleText.textContent = '„Åù„ÅÆ‰ªñ„ÅÆÁõ∏Ë´á ‚ñ≤';
      } else {
        moreOptions.style.display = 'none';
        toggleText.textContent = '„Åù„ÅÆ‰ªñ„ÅÆÁõ∏Ë´á ‚ñº';
      }
    }
    
    function populateUniversitySelect() {
      const select = document.getElementById('aiUniversitySelect');
      const redbookLogs = appData.redbookLogs || [];
      
      // ÈÅéÂéªÂïè„Éá„Éº„Çø„Åã„ÇâÂ§ßÂ≠¶‰∏ÄË¶ß„ÇíÂèñÂæó
      const universities = [...new Set(redbookLogs.map(l => l.university))].filter(Boolean);
      
      select.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
      universities.forEach(uni => {
        const option = document.createElement('option');
        option.value = uni;
        option.textContent = uni;
        select.appendChild(option);
      });
      
      if (universities.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "ÔºàÈÅéÂéªÂïè„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºâ";
        select.appendChild(option);
      }
    }
    
    function loadSettingsFromStorage() {
      const apiUrl = localStorage.getItem('apiUrl');
      const weeklyGoal = localStorage.getItem('weeklyGoal');
      const examDate = localStorage.getItem('examDate');
      
      if (apiUrl) {
        API_URL = apiUrl;
        document.getElementById('settingsApiUrl').value = apiUrl;
      }
      if (weeklyGoal) {
        appData.settings.weeklyGoalMinutes = parseInt(weeklyGoal);
        document.getElementById('settingsWeeklyGoal').value = weeklyGoal;
      }
      if (examDate) {
        document.getElementById('settingsExamDate').value = examDate;
      }
    }
    
    async function fetchData() {
      if (!API_URL) throw new Error('API URL not set');
      
      console.log('Fetching from:', API_URL);
      
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = (data) => {
          console.log('JSONP callback received:', data);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          resolve(data);
        };
        
        const fullUrl = `${API_URL}?action=getData&callback=${callbackName}`;
        console.log('Full URL:', fullUrl);
        script.src = fullUrl;
        
        script.onerror = (e) => {
          console.error('Script load error:', e);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('„Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº„ÄÇApps Script„ÅÆ„Éá„Éó„É≠„Ç§Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            console.error('JSONP timeout - callback not called');
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('„Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÄÇApps Script„ÅåÊ≠£„Åó„ÅèÂøúÁ≠î„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ'));
          }
        }, 15000);
      });
    }
    
    async function postData(data) {
      if (!API_URL) throw new Error('API URL not set');
      
      console.log('Posting data:', data);
      
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpPostCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = (response) => {
          console.log('POST callback received:', response);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          if (response.error) {
            reject(new Error(response.error));
          } else {
            resolve(response);
          }
        };
        
        // „Éá„Éº„Çø„ÇíURL„Éë„É©„É°„Éº„Çø„Å®„Åó„Å¶„Ç®„É≥„Ç≥„Éº„Éâ
        const params = new URLSearchParams();
        params.append('action', data.action);
        params.append('data', JSON.stringify(data));
        params.append('callback', callbackName);
        
        const fullUrl = `${API_URL}?${params.toString()}`;
        console.log('POST URL:', fullUrl);
        script.src = fullUrl;
        
        script.onerror = (e) => {
          console.error('POST script error:', e);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('„Éá„Éº„ÇøÈÄÅ‰ø°„Ç®„É©„Éº'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('„Çø„Ç§„É†„Ç¢„Ç¶„Éà'));
          }
        }, 15000);
      });
    }
    
    async function refreshData() {
      showLoading();
      try {
        const data = await fetchData();
        if (data.error) throw new Error(data.error);
        appData = data;
        renderDashboard();
        showToast('„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
      } catch (error) {
        console.error('Error:', error);
        showToast(error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function renderDashboard() {
      renderCheerBanner();
      renderCountdown();
      renderStats();
      renderProgress();
      renderCharts();
      renderGoals();
      renderStudyRecords();
      renderRedbookRecords();
    }
    
    // ==========================================
    // ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏
    // ==========================================
    let cheerMessages = [];
    let cheerDismissed = {};
    
    async function loadCheerMessages() {
      try {
        const response = await fetch(`${API_URL}?action=getActiveCheerMessages&callback=?`);
        const text = await response.text();
        const json = text.replace(/^\?\(/, '').replace(/\);?$/, '');
        const data = JSON.parse(json);
        
        if (data.messages) {
          cheerMessages = data.messages;
          // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÈùûË°®Á§∫Ê∏à„Åø„ÇíÂèñÂæó
          const dismissed = localStorage.getItem('cheerDismissed');
          if (dismissed) {
            cheerDismissed = JSON.parse(dismissed);
          }
          renderCheerBanner();
        }
      } catch (error) {
        console.log('Cheer messages not available');
      }
    }
    
    function renderCheerBanner() {
      const container = document.getElementById('cheerBanner');
      if (!container) return;
      
      // Ë°®Á§∫ÂèØËÉΩ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Éï„Ç£„É´„Çø
      const now = new Date();
      const activeMessages = cheerMessages.filter(msg => {
        // ÈùûË°®Á§∫Ê∏à„Åø„ÉÅ„Çß„ÉÉ„ÇØ
        if (cheerDismissed[msg.id]) return false;
        
        const start = new Date(msg.startTime);
        const end = new Date(msg.endTime);
        return now >= start && now <= end;
      });
      
      if (activeMessages.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      // „É©„É≥„ÉÄ„É†„Å´1„Å§ÈÅ∏ÊäûÔºà„Åæ„Åü„ÅØÊúÄÊñ∞„ÅÆ„ÇÇ„ÅÆÔºâ
      const msg = activeMessages[0];
      
      container.style.display = 'block';
      container.innerHTML = `
        <div class="cheer-banner">
          <button class="cheer-banner-close" onclick="dismissCheer('${msg.id}')" title="Èñâ„Åò„Çã">√ó</button>
          <div class="cheer-banner-content">
            <span class="cheer-banner-icon">üì£</span>
            <div class="cheer-banner-text">
              <div class="cheer-banner-message">${escapeHtml(msg.message)}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    function dismissCheer(id) {
      cheerDismissed[id] = true;
      localStorage.setItem('cheerDismissed', JSON.stringify(cheerDismissed));
      renderCheerBanner();
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }
    
    function renderCountdown() {
      const examDate = localStorage.getItem('examDate') || '2026-01-17';
      const mainExam = new Date(examDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const daysUntil = Math.ceil((mainExam - today) / (1000 * 60 * 60 * 24));
      document.getElementById('mainCountdown').textContent = Math.max(0, daysUntil);
    }
    
    function renderStats() {
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      const today = getTodayStr();
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      // Â≠¶ÁøíË®òÈå≤„ÅÆÊôÇÈñì
      const studyTodayMinutes = logs
        .filter(log => log.date === today)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      // Ëµ§Êú¨Ë®òÈå≤„ÅÆÊôÇÈñì
      const redbookTodayMinutes = redbookLogs
        .filter(log => log.date === today)
        .reduce((sum, log) => sum + (log.time || 0), 0);
      
      const todayMinutes = studyTodayMinutes + redbookTodayMinutes;
      
      // ‰ªäÊó•„ÅÆÂ≠¶ÁøíÊôÇÈñì„ÇíÊôÇÈñì/ÂàÜ„ÅßË°®Á§∫
      if (todayMinutes >= 60) {
        const hours = Math.floor(todayMinutes / 60);
        const mins = todayMinutes % 60;
        document.getElementById('todayMinutes').textContent = mins > 0 ? `${hours}ÊôÇÈñì${mins}ÂàÜ` : `${hours}ÊôÇÈñì`;
      } else {
        document.getElementById('todayMinutes').textContent = todayMinutes + 'ÂàÜ';
      }
      
      // ‰ªäÊó•„ÅÆÁõÆÊ®ô„Çπ„ÉÜ„Éº„Çø„ÇπÔºà1Êó•„ÅÆÁõÆÊ®ô„ÇíÈÄ±ÈñìÁõÆÊ®ô√∑7„ÅßË®àÁÆóÔºâ
      const weeklyGoal = appData.settings?.weeklyGoal || 1800;
      const dailyGoal = Math.round(weeklyGoal / 7);
      const todayGoalStatus = document.getElementById('todayGoalStatus');
      if (todayGoalStatus) {
        if (todayMinutes >= dailyGoal) {
          todayGoalStatus.textContent = 'üéâ ‰ªäÊó•„ÅÆÁõÆÊ®ôÈÅîÊàêÔºÅ';
          todayGoalStatus.style.color = '#A3BE8C';
        } else {
          const remaining = dailyGoal - todayMinutes;
          todayGoalStatus.textContent = `ÁõÆÊ®ô„Åæ„Åß„ÅÇ„Å® ${remaining}ÂàÜ`;
          todayGoalStatus.style.color = '';
        }
      }
      
      // ÈÄ±Èñì„ÅÆÂ≠¶ÁøíÊôÇÈñì
      const studyWeekMinutes = logs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      const redbookWeekMinutes = redbookLogs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.time || 0), 0);
      
      const weekMinutes = studyWeekMinutes + redbookWeekMinutes;
      const weekHours = Math.round(weekMinutes / 60);
      document.getElementById('weekMinutes').textContent = weekHours + 'h';
      
      // ÈÄ£Á∂öÊó•Êï∞ÔºàÂ≠¶ÁøíË®òÈå≤„Å®Ëµ§Êú¨Ë®òÈå≤„ÅÆ‰∏°Êñπ„ÇíËÄÉÊÖÆÔºâ
      const allDates = [
        ...logs.map(log => log.date),
        ...redbookLogs.map(log => log.date)
      ];
      const streakDays = calculateStreak({ dates: allDates });
      document.getElementById('streakDays').textContent = streakDays;
      
      // Â≠¶ÁøíÂõûÊï∞ÔºàÂ≠¶ÁøíË®òÈå≤ + Ëµ§Êú¨Ë®òÈå≤Ôºâ
      const monthStudySessions = logs.filter(log => new Date(log.date) >= monthAgo).length;
      const monthRedbookSessions = redbookLogs.filter(log => new Date(log.date) >= monthAgo).length;
      document.getElementById('totalSessions').textContent = monthStudySessions + monthRedbookSessions;
      
      // C: Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì
      const totalStudyMinutes = logs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const totalRedbookMinutes = redbookLogs.reduce((sum, log) => sum + (log.time || 0), 0);
      const totalMinutes = totalStudyMinutes + totalRedbookMinutes;
      const totalHours = Math.round(totalMinutes / 60);
      document.getElementById('totalHours').textContent = totalHours + 'h';
      
      // C: Âπ≥ÂùáÂ≠¶ÁøíÊôÇÈñìÔºàÂ≠¶ÁøíÊó•„ÅÆ„ÅøÔºâ
      const allDatesSet = new Set([
        ...logs.map(log => log.date),
        ...redbookLogs.map(log => log.date)
      ]);
      const studyDays = allDatesSet.size || 1;
      const avgMinutes = Math.round(totalMinutes / studyDays);
      document.getElementById('avgMinutes').textContent = avgMinutes + 'ÂàÜ';
      
      // A: ÈÄ±Èñì„Ç´„É¨„É≥„ÉÄ„Éº„ÇíÊèèÁîª
      renderWeekCalendar(logs, redbookLogs);
      
      // B: Êó•Âà•„ÉÅ„É£„Éº„Éà„ÇíÊèèÁîª
      renderDashDailyChart(logs, redbookLogs);
      
      // „Åä„Åô„Åô„ÇÅ„ÇíË°®Á§∫
      renderInsights();
    }
    
    // A: ÈÄ±Èñì„Ç´„É¨„É≥„ÉÄ„ÉºÊèèÁîª
    function renderWeekCalendar(logs, redbookLogs) {
      const container = document.getElementById('weekCalendar');
      if (!container) return;
      
      const today = new Date();
      const dayOfWeek = today.getDay(); // 0=Êó•, 1=Êúà...
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - dayOfWeek); // ÈÄ±„ÅÆÂßã„Åæ„ÇäÔºàÊó•ÊõúÔºâ
      
      const dayLabels = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      let html = '';
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        const isToday = dateStr === getTodayStr();
        
        // „Åù„ÅÆÊó•„ÅÆÂ≠¶ÁøíÊôÇÈñì„ÇíË®àÁÆó
        const studyMins = logs.filter(l => l.date === dateStr).reduce((sum, l) => sum + (l.minutes || 0), 0);
        const redbookMins = redbookLogs.filter(l => l.date === dateStr).reduce((sum, l) => sum + (l.time || 0), 0);
        const totalMins = studyMins + redbookMins;
        const studied = totalMins > 0;
        
        html += `
          <div class="week-day">
            <span class="week-day-label">${dayLabels[i]}</span>
            <div class="week-day-circle ${studied ? 'studied' : ''} ${isToday ? 'today' : ''}">
              ${date.getDate()}
            </div>
            <span class="week-day-minutes">${totalMins > 0 ? totalMins + 'ÂàÜ' : '-'}</span>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    // B: „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊó•Âà•„ÉÅ„É£„Éº„Éà
    let dashDailyChartInstance = null;
    
    function renderDashDailyChart(logs, redbookLogs) {
      const canvas = document.getElementById('dashDailyChart');
      if (!canvas) return;
      
      const today = new Date();
      const dayOfWeek = today.getDay();
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - dayOfWeek);
      
      const labels = [];
      const data = [];
      const dayLabels = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        
        const studyMins = logs.filter(l => l.date === dateStr).reduce((sum, l) => sum + (l.minutes || 0), 0);
        const redbookMins = redbookLogs.filter(l => l.date === dateStr).reduce((sum, l) => sum + (l.time || 0), 0);
        
        labels.push(dayLabels[i]);
        data.push(studyMins + redbookMins);
      }
      
      if (dashDailyChartInstance) {
        dashDailyChartInstance.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      dashDailyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: data.map((v, i) => {
              const date = new Date(startOfWeek);
              date.setDate(startOfWeek.getDate() + i);
              const isToday = date.toISOString().split('T')[0] === getTodayStr();
              return isToday ? '#5E81AC' : 'rgba(94, 129, 172, 0.5)';
            }),
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => ctx.parsed.y + 'ÂàÜ'
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { size: 11 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: {
                callback: v => v + 'ÂàÜ',
                font: { size: 10 }
              }
            }
          }
        }
      });
    }
    
    // ==========================================
    // „Ç§„É≥„Çµ„Ç§„Éà & „Åä„Åô„Åô„ÇÅÂ≠¶Áøí
    // ==========================================
    
    function renderInsights() {
      // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÅÆ„Åä„Åô„Åô„ÇÅ„Çª„ÇØ„Ç∑„Éß„É≥
      const recSection = document.getElementById('recommendationSection');
      const recommendationList = document.getElementById('recommendationList');
      
      // Â≠¶ÁøíÂàÜÊûê„Çø„Éñ„ÅÆ„Ç§„É≥„Çµ„Ç§„Éà„Ç´„Éº„Éâ
      const insightsCard = document.getElementById('insightsCard');
      const insightsListStudy = document.getElementById('insightsListStudy');
      
      const studyLogs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      
      const insights = generateInsights(studyLogs, redbookLogs);
      const recommendations = generateRecommendations(studyLogs, redbookLogs);
      
      // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ: „Åä„Åô„Åô„ÇÅË°®Á§∫
      if (recommendations.length > 0) {
        recommendationList.innerHTML = recommendations.slice(0, 3).map(rec => `
          <div class="recommendation-item" onclick="${rec.action}">
            <span class="recommendation-item-icon">${rec.icon}</span>
            <div class="recommendation-item-text">
              <div>${rec.text}</div>
              <div class="recommendation-item-reason">${rec.reason}</div>
            </div>
            <span class="recommendation-item-arrow">‚Üí</span>
          </div>
        `).join('');
        recSection.style.display = 'block';
      } else {
        recSection.style.display = 'none';
      }
      
      // Â≠¶ÁøíÂàÜÊûê„Çø„Éñ: „Ç§„É≥„Çµ„Ç§„ÉàË°®Á§∫
      if (insights.length > 0) {
        insightsListStudy.innerHTML = insights.slice(0, 5).map(insight => `
          <div class="insight-item ${insight.type}">
            <span class="insight-item-icon">${insight.icon}</span>
            <span>${insight.text}</span>
          </div>
        `).join('');
        insightsCard.style.display = 'block';
      } else {
        insightsCard.style.display = 'none';
      }
    }
    
    function generateInsights(studyLogs, redbookLogs) {
      const insights = [];
      const today = new Date();
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      const twoWeeksAgo = new Date(today);
      twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
      
      // ‰ªäÈÄ±„Å®ÂÖàÈÄ±„ÅÆ„Éá„Éº„Çø
      const thisWeekStudy = studyLogs.filter(l => new Date(l.date) >= weekAgo);
      const lastWeekStudy = studyLogs.filter(l => new Date(l.date) >= twoWeeksAgo && new Date(l.date) < weekAgo);
      
      // 1. ÁßëÁõÆÂà•„ÅÆÂ≠¶ÁøíÊôÇÈñìÂ§âÂåñ
      const thisWeekBySubject = {};
      const lastWeekBySubject = {};
      
      thisWeekStudy.forEach(l => {
        const subj = categorizeSubject(l.subject);
        thisWeekBySubject[subj] = (thisWeekBySubject[subj] || 0) + (l.minutes || 0);
      });
      
      lastWeekStudy.forEach(l => {
        const subj = categorizeSubject(l.subject);
        lastWeekBySubject[subj] = (lastWeekBySubject[subj] || 0) + (l.minutes || 0);
      });
      
      // Â§ßÂπÖ„Å´Â¢ó„Åà„ÅüÁßëÁõÆ
      Object.keys(thisWeekBySubject).forEach(subj => {
        const thisWeek = thisWeekBySubject[subj] || 0;
        const lastWeek = lastWeekBySubject[subj] || 0;
        if (lastWeek > 0 && thisWeek > lastWeek * 1.3 && thisWeek - lastWeek >= 60) {
          const increase = Math.round((thisWeek / lastWeek - 1) * 100);
          insights.push({
            type: 'positive',
            icon: 'üìà',
            text: `${subj}„ÅÆÂ≠¶ÁøíÊôÇÈñì„ÅåÂÖàÈÄ±ÊØî +${increase}%`
          });
        }
      });
      
      // 2. Ëß¶„Çå„Å¶„ÅÑ„Å™„ÅÑÁßëÁõÆ
      const allSubjects = [...new Set(studyLogs.map(l => categorizeSubject(l.subject)))];
      const threeDaysAgo = new Date(today);
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      
      allSubjects.forEach(subj => {
        const recentLogs = studyLogs.filter(l => 
          categorizeSubject(l.subject) === subj && new Date(l.date) >= threeDaysAgo
        );
        if (recentLogs.length === 0) {
          const lastLog = studyLogs
            .filter(l => categorizeSubject(l.subject) === subj)
            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
          if (lastLog) {
            const daysSince = Math.floor((today - new Date(lastLog.date)) / (1000 * 60 * 60 * 24));
            if (daysSince >= 3) {
              insights.push({
                type: 'warning',
                icon: '‚ö†Ô∏è',
                text: `${subj}„ÅØ${daysSince}Êó•ÈñìËß¶„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì`
              });
            }
          }
        }
      });
      
      // 3. ÊõúÊó•„Éë„Çø„Éº„É≥
      const dayOfWeekMinutes = [0, 0, 0, 0, 0, 0, 0];
      const dayOfWeekCount = [0, 0, 0, 0, 0, 0, 0];
      
      studyLogs.forEach(l => {
        const day = new Date(l.date).getDay();
        dayOfWeekMinutes[day] += l.minutes || 0;
        dayOfWeekCount[day]++;
      });
      
      const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      let maxDay = 0;
      let maxAvg = 0;
      for (let i = 0; i < 7; i++) {
        const avg = dayOfWeekCount[i] > 0 ? dayOfWeekMinutes[i] / dayOfWeekCount[i] : 0;
        if (avg > maxAvg) {
          maxAvg = avg;
          maxDay = i;
        }
      }
      
      if (maxAvg >= 60) {
        insights.push({
          type: 'info',
          icon: 'üî•',
          text: `${dayNames[maxDay]}ÊõúÊó•„ÅåÊúÄ„ÇÇÈõÜ‰∏≠„Åß„Åç„Å¶„ÅÑ„Åæ„Åô`
        });
      }
      
      // 4. ÈÅéÂéªÂïè„ÅÆÈÄ£Á∂ö‰∏äÊòá
      const univSubjectGroups = {};
      redbookLogs.forEach(l => {
        const key = `${l.university}|${l.subject}`;
        if (!univSubjectGroups[key]) univSubjectGroups[key] = [];
        univSubjectGroups[key].push(l);
      });
      
      Object.entries(univSubjectGroups).forEach(([key, logs]) => {
        if (logs.length >= 3) {
          const sorted = logs.sort((a, b) => new Date(a.date) - new Date(b.date));
          const recent = sorted.slice(-3);
          if (recent[0].score < recent[1].score && recent[1].score < recent[2].score) {
            const [univ, subj] = key.split('|');
            insights.push({
              type: 'positive',
              icon: 'üéØ',
              text: `${univ} ${subj}„Åå3ÂõûÈÄ£Á∂ö„Åß‰∏äÊòá‰∏≠ÔºÅ`
            });
          }
        }
      });
      
      // 5. Ê∞óÂàÜ„Éë„Çø„Éº„É≥ÂàÜÊûê
      if (studyLogs.length >= 5) {
        const subjectMoods = {};
        studyLogs.forEach(log => {
          const subj = categorizeSubject(log.subject);
          if (!subjectMoods[subj]) subjectMoods[subj] = { good: 0, bad: 0, total: 0 };
          const mood = log.mood || '';
          if (mood.includes('üòä') || mood.includes('üî•') || mood.includes('‚ú®')) {
            subjectMoods[subj].good++;
          } else if (mood.includes('üò¥') || mood.includes('üòµ') || mood.includes('üò¢')) {
            subjectMoods[subj].bad++;
          }
          subjectMoods[subj].total++;
        });
        
        // Áâπ„Å´Ê∞óÂàÜ„ÅåËâØ„ÅÑÁßëÁõÆ
        Object.entries(subjectMoods).forEach(([subj, data]) => {
          if (data.total >= 3 && data.good / data.total >= 0.7) {
            insights.push({
              type: 'positive',
              icon: 'üòä',
              text: `${subj}„ÅØÊ∞óÂàÜËâØ„ÅèÂèñ„ÇäÁµÑ„ÇÅ„Å¶„ÅÑ„Åæ„Åô`
            });
          }
        });
      }
      
      return insights;
    }
    
    function generateRecommendations(studyLogs, redbookLogs) {
      const recommendations = [];
      const today = new Date();
      const todayStr = getTodayStr();
      
      // ‰ªäÊó•„ÇÑ„Å£„ÅüÁßëÁõÆ
      const todaySubjects = new Set(
        studyLogs.filter(l => l.date === todayStr).map(l => categorizeSubject(l.subject))
      );
      
      // 1. Ëß¶„Çå„Å¶„ÅÑ„Å™„ÅÑÁßëÁõÆ„Çí„Åä„Åô„Åô„ÇÅ
      const allSubjects = [...new Set(studyLogs.map(l => categorizeSubject(l.subject)))];
      const subjectLastDate = {};
      
      studyLogs.forEach(l => {
        const subj = categorizeSubject(l.subject);
        if (!subjectLastDate[subj] || l.date > subjectLastDate[subj]) {
          subjectLastDate[subj] = l.date;
        }
      });
      
      allSubjects
        .filter(subj => !todaySubjects.has(subj))
        .sort((a, b) => (subjectLastDate[a] || '') < (subjectLastDate[b] || '') ? -1 : 1)
        .slice(0, 2)
        .forEach(subj => {
          const lastDate = subjectLastDate[subj];
          const daysSince = lastDate ? Math.floor((today - new Date(lastDate)) / (1000 * 60 * 60 * 24)) : 999;
          if (daysSince >= 2) {
            recommendations.push({
              icon: 'üìñ',
              text: subj,
              reason: `${daysSince}Êó•Èñì„ÇÑ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì`,
              action: `openStudyModal()`
            });
          }
        });
      
      // 2. ‰πÖ„Åó„Å∂„Çä„ÅÆÈÅéÂéªÂïè„Çí„Åä„Åô„Åô„ÇÅ
      const redbookLastDate = {};
      redbookLogs.forEach(l => {
        const key = `${l.university}|${l.subject}`;
        if (!redbookLastDate[key] || l.date > redbookLastDate[key].date) {
          redbookLastDate[key] = l;
        }
      });
      
      Object.entries(redbookLastDate)
        .sort((a, b) => (a[1].date || '') < (b[1].date || '') ? -1 : 1)
        .slice(0, 2)
        .forEach(([key, lastLog]) => {
          const daysSince = Math.floor((today - new Date(lastLog.date)) / (1000 * 60 * 60 * 24));
          if (daysSince >= 7) {
            const [univ, subj] = key.split('|');
            recommendations.push({
              icon: 'üìï',
              text: `${univ} ${subj}`,
              reason: `ÂâçÂõû„Åã„Çâ${daysSince}Êó•ÁµåÈÅé`,
              action: `openRedbookModal()`
            });
          }
        });
      
      return recommendations;
    }
    
    // ==========================================
    // ÊàêÈï∑„Ç∞„É©„ÉïÔºàÈÅéÂéªÂïèÂàÜÊûê„Çø„ÉñÔºâ
    // ==========================================
    
    let growthChartInstance = null;
    
    function populateGrowthSelects() {
      const redbookLogs = appData.redbookLogs || [];
      const univSelect = document.getElementById('growthUnivSelect');
      const subjectSelect = document.getElementById('growthSubjectSelect');
      
      // Â§ßÂ≠¶‰∏ÄË¶ß
      const universities = [...new Set(redbookLogs.map(l => l.university))].filter(Boolean);
      univSelect.innerHTML = '<option value="">Â§ßÂ≠¶„ÇíÈÅ∏Êäû</option>' + 
        universities.map(u => `<option value="${u}">${u}</option>`).join('');
      
      // ÁßëÁõÆ‰∏ÄË¶ßÔºàÂàùÊúü„ÅØÁ©∫Ôºâ
      subjectSelect.innerHTML = '<option value="">ÂÖà„Å´Â§ßÂ≠¶„ÇíÈÅ∏Êäû</option>';
    }
    
    function updateGrowthSubjects() {
      const redbookLogs = appData.redbookLogs || [];
      const univ = document.getElementById('growthUnivSelect').value;
      const subjectSelect = document.getElementById('growthSubjectSelect');
      
      if (!univ) {
        subjectSelect.innerHTML = '<option value="">ÂÖà„Å´Â§ßÂ≠¶„ÇíÈÅ∏Êäû</option>';
        return;
      }
      
      // ÈÅ∏Êäû„Åó„ÅüÂ§ßÂ≠¶„ÅÆÁßëÁõÆ„Å†„Åë„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
      const subjects = [...new Set(
        redbookLogs.filter(l => l.university === univ).map(l => l.subject)
      )].filter(Boolean);
      
      subjectSelect.innerHTML = '<option value="">ÁßëÁõÆ„ÇíÈÅ∏Êäû</option>' +
        subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    }
    
    function renderGrowthChart() {
      const redbookLogs = appData.redbookLogs || [];
      const univ = document.getElementById('growthUnivSelect').value;
      const subject = document.getElementById('growthSubjectSelect').value;
      
      const container = document.getElementById('growthChartContainer');
      const empty = document.getElementById('growthEmpty');
      const summary = document.getElementById('growthSummary');
      
      if (!univ || !subject) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      
      // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºÜÊó•‰ªòÈ†Ü„ÇΩ„Éº„Éà
      const filtered = redbookLogs
        .filter(l => l.university === univ && l.subject === subject)
        .map(l => ({
          ...l,
          dateObj: new Date(l.date + 'T00:00:00') // Êó•‰ªò„ÇíÁ¢∫ÂÆü„Å´„Éë„Éº„Çπ
        }))
        .sort((a, b) => a.dateObj - b.dateObj);
      
      if (filtered.length < 1) {
        container.style.display = 'none';
        empty.innerHTML = '<p>„Åì„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      container.style.display = 'block';
      
      // „Ç∞„É©„Éï„Éá„Éº„ÇøÊ∫ñÂÇô
      const labels = filtered.map(l => {
        const d = new Date(l.date);
        return `${d.getMonth()+1}/${d.getDate()}`;
      });
      const scores = filtered.map(l => l.score || 0);
      
      // „Ç∞„É©„ÉïÊèèÁîª
      const ctx = document.getElementById('growthChart').getContext('2d');
      
      if (growthChartInstance) {
        growthChartInstance.destroy();
      }
      
      growthChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ÂæóÁÇπÁéá',
            data: scores,
            borderColor: '#22C55E',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 6,
            pointBackgroundColor: '#22C55E',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2,
          scales: {
            y: {
              min: 0,
              max: 100,
              ticks: {
                callback: v => v + '%'
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.parsed.y}%`
              }
            }
          }
        }
      });
      
      // „Çµ„Éû„É™„ÉºË°®Á§∫
      const first = scores[0];
      const last = scores[scores.length - 1];
      const avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
      const max = Math.max(...scores);
      const growth = last - first;
      
      summary.innerHTML = `
        <div class="growth-summary-item">
          <span class="growth-summary-label">ÂàùÂõû</span>
          <span class="growth-summary-value">${first}%</span>
        </div>
        <div class="growth-summary-item">
          <span class="growth-summary-label">ÊúÄÊñ∞</span>
          <span class="growth-summary-value">${last}%</span>
        </div>
        <div class="growth-summary-item">
          <span class="growth-summary-label">ÊàêÈï∑</span>
          <span class="growth-summary-value ${growth >= 0 ? 'positive' : 'negative'}">${growth >= 0 ? '+' : ''}${growth}%</span>
        </div>
        <div class="growth-summary-item">
          <span class="growth-summary-label">Âπ≥Âùá</span>
          <span class="growth-summary-value">${avg}%</span>
        </div>
        <div class="growth-summary-item">
          <span class="growth-summary-label">ÊúÄÈ´ò</span>
          <span class="growth-summary-value">${max}%</span>
        </div>
      `;
    }
    
    function calculateStreak(input) {
      // ÈÖçÂàó„Åæ„Åü„ÅØ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂΩ¢Âºè„Å´ÂØæÂøú
      let dates;
      if (Array.isArray(input)) {
        dates = [...new Set(input.map(log => log.date))].sort().reverse();
      } else if (input.dates) {
        dates = [...new Set(input.dates)].filter(Boolean).sort().reverse();
      } else {
        return 0;
      }
      
      if (dates.length === 0) return 0;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let streak = 0;
      let currentDate = new Date(today);
      
      const todayStr = formatDateLocal(today);
      if (!dates.includes(todayStr)) {
        currentDate.setDate(currentDate.getDate() - 1);
      }
      
      for (let i = 0; i < 365; i++) {
        const dateStr = formatDateLocal(currentDate);
        if (dates.includes(dateStr)) {
          streak++;
          currentDate.setDate(currentDate.getDate() - 1);
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    function renderProgress() {
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      
      // Â≠¶ÁøíË®òÈå≤„ÅÆÈÄ±ÈñìÊôÇÈñì
      const studyWeekMinutes = logs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      // Ëµ§Êú¨Ë®òÈå≤„ÅÆÈÄ±ÈñìÊôÇÈñì
      const redbookWeekMinutes = redbookLogs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.time || 0), 0);
      
      const weekMinutes = studyWeekMinutes + redbookWeekMinutes;
      
      const goal = appData.settings?.weeklyGoalMinutes || 1800;
      const percent = Math.min(100, Math.round((weekMinutes / goal) * 100));
      
      document.getElementById('progressValue').textContent = `${weekMinutes} / ${goal} ÂàÜ`;
      document.getElementById('progressFill').style.width = `${percent}%`;
      
      // ÁõÆÊ®ôÈÅîÊàêÊôÇ„ÅÆ„ÅäÁ•ù„ÅÑË°®Á§∫
      const progressSection = document.getElementById('progressSection');
      const celebration = document.getElementById('progressCelebration');
      
      if (percent >= 100) {
        progressSection.classList.add('achieved');
        celebration.innerHTML = `
          <div class="progress-celebration">
            üéâ ÈÄ±ÈñìÁõÆÊ®ôÈÅîÊàêÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ
          </div>
        `;
      } else if (percent >= 80) {
        progressSection.classList.remove('achieved');
        celebration.innerHTML = `
          <div class="progress-celebration" style="background: #fffbeb; border-color: #fde68a; color: #d97706;">
            üí™ „ÅÇ„Å®Â∞ë„ÅóÔºÅÊÆã„Çä ${goal - weekMinutes} ÂàÜ
          </div>
        `;
      } else {
        progressSection.classList.remove('achieved');
        celebration.innerHTML = '';
      }
    }
    
    function renderCharts() {
      renderDailyChart();
      renderSubjectChart();
    }
    
    function renderDailyChart() {
      const ctx = document.getElementById('dailyChart').getContext('2d');
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      
      const days = [];
      const subjectData = {};
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = formatDateLocal(date);
        const dayLabel = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][date.getDay()];
        days.push(dayLabel);
        
        // Â≠¶ÁøíË®òÈå≤
        const dayLogs = logs.filter(log => log.date === dateStr);
        dayLogs.forEach(log => {
          const subject = categorizeSubject(log.subject);
          if (!subjectData[subject]) {
            subjectData[subject] = Array(7).fill(0);
          }
          subjectData[subject][6 - i] += log.minutes || 0;
        });
        
        // Ëµ§Êú¨Ë®òÈå≤
        const dayRedbookLogs = redbookLogs.filter(log => log.date === dateStr);
        dayRedbookLogs.forEach(log => {
          if (!subjectData['ÈÅéÂéªÂïè']) {
            subjectData['ÈÅéÂéªÂïè'] = Array(7).fill(0);
          }
          subjectData['ÈÅéÂéªÂïè'][6 - i] += log.time || 0;
        });
      }
      
      // „Éü„Éã„Éû„É´„ÅßËêΩ„Å°ÁùÄ„ÅÑ„ÅüË¶ã„ÇÑ„Åô„ÅÑ„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà
      const colors = {
        'Ëã±Ë™û': '#5E81AC',    // ËêΩ„Å°ÁùÄ„ÅÑ„Åü„Éñ„É´„Éº
        'Êï∞Â≠¶': '#A3BE8C',    // ËêΩ„Å°ÁùÄ„ÅÑ„Åü„Ç∞„É™„Éº„É≥
        'ÂõΩË™û': '#EBCB8B',    // ËêΩ„Å°ÁùÄ„ÅÑ„Åü„Ç§„Ç®„É≠„Éº
        'ÁêÜÁßë': '#B48EAD',    // ËêΩ„Å°ÁùÄ„ÅÑ„Åü„Éë„Éº„Éó„É´
        'Á§æ‰ºö': '#D08770',    // ËêΩ„Å°ÁùÄ„ÅÑ„Åü„Ç™„É¨„É≥„Ç∏
        'ÈÅéÂéªÂïè': '#BF616A',  // ËêΩ„Å°ÁùÄ„ÅÑ„Åü„É¨„ÉÉ„Éâ
        '„Åù„ÅÆ‰ªñ': '#4C566A'   // „ÉÄ„Éº„ÇØ„Ç∞„É¨„Éº
      };
      
      const datasets = Object.entries(subjectData).map(([subject, data]) => ({
        label: subject,
        data: data,
        backgroundColor: colors[subject] || '#d4d4d4',
        borderRadius: 2,
        barThickness: 16
      }));
      
      if (dailyChart) dailyChart.destroy();
      
      dailyChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: days, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              stacked: true,
              grid: { display: false },
              border: { display: false },
              ticks: { color: '#a3a3a3', font: { size: 11 } }
            },
            y: { 
              stacked: true,
              beginAtZero: true,
              grid: { color: '#f5f5f5' },
              border: { display: false },
              ticks: { color: '#a3a3a3', font: { size: 11 } }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 16,
                color: '#525252',
                font: { size: 11 }
              }
            }
          }
        }
      });
    }
    
    function renderSubjectChart() {
      const ctx = document.getElementById('subjectChart').getContext('2d');
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      const subjectMinutes = {};
      
      // Â≠¶ÁøíË®òÈå≤
      logs
        .filter(log => new Date(log.date) >= monthAgo)
        .forEach(log => {
          const subject = log.subject || '„Åù„ÅÆ‰ªñ';
          subjectMinutes[subject] = (subjectMinutes[subject] || 0) + (log.minutes || 0);
        });
      
      // Ëµ§Êú¨Ë®òÈå≤
      const redbookTime = redbookLogs
        .filter(log => new Date(log.date) >= monthAgo)
        .reduce((sum, log) => sum + (log.time || 0), 0);
      
      if (redbookTime > 0) {
        subjectMinutes['ÈÅéÂéªÂïèÊºîÁøí'] = redbookTime;
      }
      
      const sortedSubjects = Object.entries(subjectMinutes).sort((a, b) => b[1] - a[1]);
      
      // ÁßëÁõÆ„Åî„Å®„Å´Âõ∫ÂÆöËâ≤„ÇíÂâ≤„ÇäÂΩì„Å¶
      const subjectColors = {
        'Ëã±Ë™û': '#5E81AC',
        'Êï∞Â≠¶': '#A3BE8C',
        'ÂõΩË™û': '#EBCB8B',
        'ÁêÜÁßë': '#B48EAD',
        'Á§æ‰ºö': '#D08770',
        'ÈÅéÂéªÂïèÊºîÁøí': '#BF616A',
        '„Åù„ÅÆ‰ªñ': '#4C566A'
      };
      
      // Ëâ≤„ÅÆÈÖçÂàó„ÇíÁîüÊàêÔºàÁßëÁõÆ„Å´ÂØæÂøú„Åó„ÅüËâ≤„ÄÅ„Å™„Åë„Çå„Å∞„Éá„Éï„Ç©„É´„Éà„Ç´„É©„ÉºÈÖçÂàó„Åã„ÇâÔºâ
      const defaultColors = ['#5E81AC', '#A3BE8C', '#EBCB8B', '#B48EAD', '#D08770', '#BF616A', '#88C0D0', '#81A1C1'];
      const chartColors = sortedSubjects.map((s, i) => subjectColors[s[0]] || defaultColors[i % defaultColors.length]);
      
      if (subjectChart) subjectChart.destroy();
      
      subjectChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sortedSubjects.map(s => s[0]),
          datasets: [{
            data: sortedSubjects.map(s => s[1]),
            backgroundColor: chartColors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 12,
                color: '#525252',
                font: { size: 11 }
              }
            }
          },
          cutout: '65%'
        }
      });
    }
    
    function categorizeSubject(subject) {
      // Ëã±Ë™ûÁ≥ª
      const english = ['ÂçòË™û', 'ÊñáÊ≥ï', 'Èï∑Êñá', 'Èü≥Ë™≠', '„É™„Çπ„Éã„É≥„Ç∞', 'Ëã±Ë™û', 'Ëã±Ë™ûR', 'Ëã±Ë™ûL'];
      // Êï∞Â≠¶Á≥ª
      const math = ['Êï∞Â≠¶1A', 'Êï∞Â≠¶2B', 'Êï∞Â≠¶', 'Êï∞Â≠¶IA', 'Êï∞Â≠¶IIB', 'Êï∞Â≠¶IIIC'];
      // ÂõΩË™ûÁ≥ª
      const japanese = ['Áèæ‰ª£Êñá', 'Âè§Êñá', 'Êº¢Êñá', 'ÂõΩË™û'];
      // ÁêÜÁßëÁ≥ª
      const science = ['Áâ©ÁêÜ', 'Áâ©ÁêÜÂü∫Á§é', 'ÂåñÂ≠¶', 'ÂåñÂ≠¶Âü∫Á§é', 'ÁîüÁâ©', 'ÁîüÁâ©Âü∫Á§é', 'Âú∞Â≠¶', 'Âú∞Â≠¶Âü∫Á§é'];
      // Á§æ‰ºöÁ≥ª
      const social = ['Êó•Êú¨Âè≤', '‰∏ñÁïåÂè≤', 'Âú∞ÁêÜ', 'ÊîøÊ≤ªÁµåÊ∏à', 'ÂÄ´ÁêÜ', 'ÂÄ´ÁêÜÊîøÁµå', 'Áèæ‰ª£Á§æ‰ºö', 'ÂÖ¨ÂÖ±'];
      
      if (english.includes(subject)) return 'Ëã±Ë™û';
      if (math.includes(subject)) return 'Êï∞Â≠¶';
      if (japanese.includes(subject)) return 'ÂõΩË™û';
      if (science.includes(subject)) return 'ÁêÜÁßë';
      if (social.includes(subject)) return 'Á§æ‰ºö';
      return '„Åù„ÅÆ‰ªñ';
    }
    
    function renderGoals() {
      const section = document.getElementById('goalsSection');
      const goals = appData.goals || [];
      
      if (goals.length === 0) {
        section.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üéØ</div>
            <div class="empty-state-title">ÁõÆÊ®ô„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
            <div class="empty-state-desc">„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÅÆ„ÄåÁõÆÊ®ô„Äç„Ç∑„Éº„Éà„Åß<br>ÁßëÁõÆ„Åî„Å®„ÅÆÁõÆÊ®ô„ÇíË®≠ÂÆö„Åß„Åç„Åæ„Åô</div>
          </div>
        `;
        return;
      }
      
      const classes = { 'ÂõΩË™û': 'kokugo', 'Êï∞Â≠¶': 'sugaku', 'Ëã±Ë™û': 'eigo', 'ÁêÜÁßë': 'rika', 'Á§æ‰ºö': 'shakai' };
      
      section.innerHTML = goals.map(goal => {
        const progress = Math.min(100, Math.round(((goal.current) / (goal.target)) * 100));
        const cls = classes[goal.subject] || 'kokugo';
        const isAchieved = goal.current >= goal.target;
        
        return `
          <div class="goal-item">
            <div class="goal-header">
              <span class="goal-name">${escapeHtml(goal.subject || '')}${isAchieved ? '<span class="goal-achieved">üèÜ ÈÅîÊàêÔºÅ</span>' : ''}</span>
              <span class="goal-values">${goal.current}% ‚Üí ${goal.target}%</span>
            </div>
            <div class="goal-bar">
              <div class="goal-fill ${cls}" style="width: ${progress}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderStudyRecords() {
      const container = document.getElementById('studyRecordsList');
      const logs = (appData.studyLogs || []).slice(0, 8);
      
      if (logs.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìñ</div>
            <div class="empty-state-title">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
            <div class="empty-state-desc">Â≠¶Áøí„ÇíË®òÈå≤„Åó„Å¶„ÄÅ<br>ÊØéÊó•„ÅÆÈ†ëÂºµ„Çä„ÇíË¶ã„Åà„ÇãÂåñ„Åó„Çà„ÅÜÔºÅ</div>
            <button class="empty-state-btn" onclick="openStudyModal()">
              Ôºã ÊúÄÂàù„ÅÆË®òÈå≤„Çí„Å§„Åë„Çã
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = logs.map((log, index) => {
        const hasSubDetails = log.textbook || log.unit;
        return `
        <div class="record-item">
          <div class="record-main">
            <span class="record-date">${formatDateShort(log.date)}</span>
            <span class="record-subject">${escapeHtml(log.subject || '')}</span>
            ${log.studyType ? `<span class="record-type">${escapeHtml(log.studyType)}</span>` : ''}
            <span class="record-time">${log.minutes}ÂàÜ</span>
            <span class="record-mood">${escapeHtml(log.mood || '')}</span>
          </div>
          ${log.memo || hasSubDetails ? `
            <div class="record-details">
              ${hasSubDetails ? `
                <div class="record-sub-info">
                  ${log.unit ? `<span class="record-unit">üìñ ${escapeHtml(log.unit)}</span>` : ''}
                  ${log.textbook ? `<span class="record-textbook">üìö ${escapeHtml(log.textbook)}</span>` : ''}
                </div>
              ` : ''}
              ${log.memo ? `<div class="record-memo">üìù ${escapeHtml(log.memo)}</div>` : ''}
            </div>
          ` : ''}
        </div>
      `}).join('');
    }
    
    function renderRedbookRecords() {
      const container = document.getElementById('redbookRecordsList');
      const logs = (appData.redbookLogs || []).slice(0, 8);
      
      if (logs.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìï</div>
            <div class="empty-state-title">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
            <div class="empty-state-desc">ÈÅéÂéªÂïè„ÇíËß£„ÅÑ„Åü„ÇâË®òÈå≤„Åó„Å¶„ÄÅ<br>ÊàêÁ∏æ„ÅÆÊé®Áßª„ÇíÁ¢∫Ë™ç„Åó„Çà„ÅÜÔºÅ</div>
            <button class="empty-state-btn" onclick="openRedbookModal()">
              Ôºã ÊúÄÂàù„ÅÆË®òÈå≤„Çí„Å§„Åë„Çã
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = logs.map((log, index) => {
        const scoreClass = log.score >= 70 ? 'high' : log.score >= 50 ? 'mid' : 'low';
        const hasSubDetails = log.sectionScores || log.weakAreas;
        return `
          <div class="record-item">
            <div class="record-main">
              <span class="record-date">${formatDateShort(log.date)}</span>
              <span>${escapeHtml(log.university || '')}</span>
              <span class="record-subject-small">${escapeHtml(log.subject || '')}</span>
              ${log.time ? `<span class="record-time-small">‚è±${log.time}ÂàÜ</span>` : ''}
              <span class="record-score ${scoreClass}">${log.score}%</span>
            </div>
            ${log.memo || hasSubDetails ? `
              <div class="record-details">
                ${hasSubDetails ? `
                  <div class="record-sub-info">
                    ${log.sectionScores ? `<span class="record-section">üìä ${escapeHtml(log.sectionScores)}</span>` : ''}
                    ${log.weakAreas ? `<span class="record-weak">‚ö†Ô∏è ${escapeHtml(log.weakAreas)}</span>` : ''}
                  </div>
                ` : ''}
                ${log.memo ? `<div class="record-memo">üìù ${escapeHtml(log.memo)}</div>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function openStudyModal() {
      resetStudyForm();
      document.getElementById('studyModal').classList.add('active');
    }
    
    function closeStudyModal() {
      document.getElementById('studyModal').classList.remove('active');
    }
    
    function resetStudyForm() {
      document.getElementById('studyDate').value = getTodayStr();
      document.querySelectorAll('#subjectButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#studyTypeButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#timeButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#moodButtons .mood-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('studyUnit').value = '';
      document.getElementById('studyTextbook').value = '';
      document.getElementById('studyMemo').value = '';
      selectedSubject = '';
      selectedStudyType = '';
      selectedTime = 0;
      selectedMood = '';
    }
    
    function openRedbookModal() {
      resetRedbookForm();
      document.getElementById('redbookModal').classList.add('active');
      // „Ç´„Çπ„Çø„É†ÂÖ•Âäõ„ÇíÈö†„Åô
      document.getElementById('customUniversityWrapper').classList.remove('show');
    }
    
    function closeRedbookModal() {
      document.getElementById('redbookModal').classList.remove('active');
    }
    
    // „Ç´„Çπ„Çø„É†Â§ßÂ≠¶ÂÖ•Âäõ„ÅÆË°®Á§∫ÂàáÊõø
    function toggleCustomUniversity() {
      const select = document.getElementById('redbookUniversity');
      const wrapper = document.getElementById('customUniversityWrapper');
      
      if (select.value === '__custom__') {
        wrapper.classList.add('show');
        document.getElementById('customUniversity').focus();
      } else {
        wrapper.classList.remove('show');
      }
    }
    
    // ÂâçÂõû„ÅÆËµ§Êú¨Ë®òÈå≤„ÇíË°®Á§∫
    function showPreviousRedbookRecord() {
      const container = document.getElementById('previousRedbookRecord');
      const content = document.getElementById('previousRedbookContent');
      
      let university = document.getElementById('redbookUniversity').value;
      if (university === '__custom__') {
        university = document.getElementById('customUniversity').value;
      }
      const subject = document.getElementById('redbookSubject').value;
      
      // Â§ßÂ≠¶„Å®ÁßëÁõÆ„Åå‰∏°ÊñπÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÈùûË°®Á§∫
      if (!university || !subject) {
        container.style.display = 'none';
        return;
      }
      
      // Âêå„ÅòÂ§ßÂ≠¶„ÉªÁßëÁõÆ„ÅÆÈÅéÂéª„ÅÆË®òÈå≤„ÇíÊ§úÁ¥¢
      const redbookLogs = appData.redbookLogs || [];
      const previousRecords = redbookLogs
        .filter(log => log.university === university && log.subject === subject)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (previousRecords.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      const lastRecord = previousRecords[0];
      const date = new Date(lastRecord.date);
      const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
      
      let html = `<span class="previous-record-date">${dateStr}</span>`;
      
      if (lastRecord.year) {
        html += ` (${lastRecord.year}Âπ¥Â∫¶)`;
      }
      
      if (lastRecord.totalScore !== undefined && lastRecord.maxScore) {
        const percent = Math.round((lastRecord.totalScore / lastRecord.maxScore) * 100);
        html += ` - <span class="previous-record-score">${lastRecord.totalScore}/${lastRecord.maxScore}ÁÇπ (${percent}%)</span>`;
      }
      
      if (lastRecord.memo) {
        html += `<div class="previous-record-memo">„Äå${lastRecord.memo}„Äç</div>`;
      }
      
      content.innerHTML = html;
      container.style.display = 'block';
    }
    
    // ==========================================
    // „Éá„Éº„ÇøÁÆ°ÁêÜ
    // ==========================================
    let currentManagerType = '';
    
    function openDataManager(type) {
      currentManagerType = type;
      const modal = document.getElementById('dataManagerModal');
      const title = document.getElementById('dataManagerTitle');
      
      if (type === 'study') {
        title.textContent = 'üìñ Â≠¶ÁøíË®òÈå≤„ÅÆÁÆ°ÁêÜ';
        renderStudyManager();
      } else {
        title.textContent = 'üìï ÈÅéÂéªÂïèË®òÈå≤„ÅÆÁÆ°ÁêÜ';
        renderRedbookManager();
      }
      
      modal.classList.add('active');
    }
    
    function closeDataManager() {
      document.getElementById('dataManagerModal').classList.remove('active');
      currentManagerType = '';
    }
    
    function renderStudyManager() {
      const container = document.getElementById('dataManagerContent');
      const logs = appData.studyLogs || [];
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="manager-empty">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }
      
      container.innerHTML = logs.map((log, index) => `
        <div class="manager-item">
          <div class="manager-item-info">
            <div class="manager-item-main">
              <span class="manager-item-date">${formatDateShort(log.date)}</span>
              <span class="manager-item-subject">${escapeHtml(log.subject || '')}</span>
              <span>${log.minutes}ÂàÜ</span>
              <span>${escapeHtml(log.mood || '')}</span>
            </div>
            ${log.studyType || log.unit || log.memo ? `
              <div class="manager-item-detail">
                ${log.studyType ? escapeHtml(log.studyType) : ''}
                ${log.unit ? ' / ' + escapeHtml(log.unit) : ''}
                ${log.memo ? ' / ' + escapeHtml(log.memo) : ''}
              </div>
            ` : ''}
          </div>
          <button class="manager-delete-btn" onclick="deleteStudyLog(${index})" title="ÂâäÈô§">üóë</button>
        </div>
      `).join('');
    }
    
    function renderRedbookManager() {
      const container = document.getElementById('dataManagerContent');
      const logs = appData.redbookLogs || [];
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="manager-empty">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }
      
      container.innerHTML = logs.map((log, index) => `
        <div class="manager-item">
          <div class="manager-item-info">
            <div class="manager-item-main">
              <span class="manager-item-date">${formatDateShort(log.date)}</span>
              <span class="manager-item-subject">${escapeHtml(log.university || '')}</span>
              <span>${escapeHtml(log.subject || '')}</span>
              <span>${log.score}%</span>
            </div>
            ${log.year || log.memo ? `
              <div class="manager-item-detail">
                ${log.year ? escapeHtml(String(log.year)) + 'Âπ¥Â∫¶' : ''}
                ${log.memo ? ' / ' + escapeHtml(log.memo) : ''}
              </div>
            ` : ''}
          </div>
          <button class="manager-delete-btn" onclick="deleteRedbookLog(${index})" title="ÂâäÈô§">üóë</button>
        </div>
      `).join('');
    }
    
    // Ë®òÈå≤ÂâäÈô§
    async function deleteStudyLog(index) {
      if (!confirm('„Åì„ÅÆÂ≠¶ÁøíË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      
      showLoading();
      try {
        await postData({
          action: 'deleteStudyLog',
          index: index
        });
        showToast('Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        await refreshData();
        // ÁÆ°ÁêÜÁîªÈù¢„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Åü„ÇâÂÜçÊèèÁîª
        if (currentManagerType === 'study') {
          renderStudyManager();
        }
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    async function deleteRedbookLog(index) {
      if (!confirm('„Åì„ÅÆÈÅéÂéªÂïèË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      
      showLoading();
      try {
        await postData({
          action: 'deleteRedbookLog',
          index: index
        });
        showToast('Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        await refreshData();
        // ÁÆ°ÁêÜÁîªÈù¢„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Åü„ÇâÂÜçÊèèÁîª
        if (currentManagerType === 'redbook') {
          renderRedbookManager();
        }
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    // ÂæóÁÇπË®àÁÆó
    function calculateTotalScore() {
      const container = document.getElementById('sectionScoresContainer');
      const rows = container.querySelectorAll('.score-row');
      
      let totalGot = 0;
      let totalMax = 0;
      
      rows.forEach(row => {
        const got = parseInt(row.querySelector('.section-got').value) || 0;
        const max = parseInt(row.querySelector('.section-max').value) || 0;
        totalGot += got;
        totalMax += max;
      });
      
      document.getElementById('totalScoreGot').value = totalGot;
      document.getElementById('totalScoreMax').value = totalMax;
      
      const percent = totalMax > 0 ? Math.round((totalGot / totalMax) * 100) : 0;
      document.getElementById('totalScorePercent').textContent = `Ôºà${percent}%Ôºâ`;
    }
    
    // Â§ßÂïèËøΩÂä†
    function addSection() {
      const container = document.getElementById('sectionScoresContainer');
      const currentCount = container.querySelectorAll('.score-row').length;
      const newSection = currentCount + 1;
      
      const row = document.createElement('div');
      row.className = 'score-row';
      row.dataset.section = newSection;
      row.innerHTML = `
        <input type="text" class="form-input section-name" value="Â§ßÂïè${newSection}" placeholder="Â§ßÂïè${newSection}">
        <div class="score-inputs">
          <input type="number" class="form-input score-box section-got" min="0" placeholder="0" oninput="calculateTotalScore()">
          <span class="score-divider">/</span>
          <input type="number" class="form-input score-box section-max" min="0" placeholder="0" oninput="calculateTotalScore()">
        </div>
      `;
      
      container.appendChild(row);
      
      // ÊôÇÈñìÂÖ•Âäõ„É¢„Éº„Éâ„ÅåÂ§ßÂïè„Åî„Å®„ÅÆÂ†¥Âêà„ÅØÂêåÊúü
      if (timeInputMode === 'section') {
        syncSectionTimesWithScores();
      }
    }
    
    // Â§ßÂïèÂâäÈô§
    function removeSection() {
      const container = document.getElementById('sectionScoresContainer');
      const rows = container.querySelectorAll('.score-row');
      
      if (rows.length > 1) {
        rows[rows.length - 1].remove();
        calculateTotalScore();
        
        // ÊôÇÈñìÂÖ•Âäõ„É¢„Éº„Éâ„ÅåÂ§ßÂïè„Åî„Å®„ÅÆÂ†¥Âêà„ÅØÂêåÊúü
        if (timeInputMode === 'section') {
          syncSectionTimesWithScores();
        }
      }
    }
    
    // Â§ßÂïèÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„ÉàÔºà„Éá„Éï„Ç©„É´„Éà2Âïè„Å´Êàª„ÅôÔºâ
    function resetSectionScores() {
      const container = document.getElementById('sectionScoresContainer');
      container.innerHTML = `
        <div class="score-row" data-section="1">
          <input type="text" class="form-input section-name" value="Â§ßÂïè1" placeholder="Â§ßÂïè1">
          <div class="score-inputs">
            <input type="number" class="form-input score-box section-got" min="0" placeholder="0" oninput="calculateTotalScore()">
            <span class="score-divider">/</span>
            <input type="number" class="form-input score-box section-max" min="0" placeholder="0" oninput="calculateTotalScore()">
          </div>
        </div>
        <div class="score-row" data-section="2">
          <input type="text" class="form-input section-name" value="Â§ßÂïè2" placeholder="Â§ßÂïè2">
          <div class="score-inputs">
            <input type="number" class="form-input score-box section-got" min="0" placeholder="0" oninput="calculateTotalScore()">
            <span class="score-divider">/</span>
            <input type="number" class="form-input score-box section-max" min="0" placeholder="0" oninput="calculateTotalScore()">
          </div>
        </div>
      `;
      document.getElementById('totalScoreGot').value = '';
      document.getElementById('totalScoreMax').value = '';
      document.getElementById('totalScorePercent').textContent = 'Ôºà0%Ôºâ';
    }
    
    function resetRedbookForm() {
      document.getElementById('redbookDate').value = getTodayStr();
      document.getElementById('redbookUniversity').value = '';
      document.getElementById('redbookSubject').value = '';
      document.getElementById('redbookYear').value = '';
      document.getElementById('redbookTime').value = '';
      document.getElementById('redbookWeakAreas').value = '';
      document.getElementById('redbookMemo').value = '';
      resetSectionScores();
      
      // ÂâçÂõûË®òÈå≤Ë°®Á§∫„ÇíÈùûË°®Á§∫
      document.getElementById('previousRedbookRecord').style.display = 'none';
      
      // ÊôÇÈñìÂÖ•Âäõ„É¢„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà
      timeInputMode = 'total';
      document.querySelectorAll('.time-toggle-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === 0);
      });
      document.getElementById('totalTimeInput').style.display = 'block';
      document.getElementById('sectionTimeInput').style.display = 'none';
      document.getElementById('sectionTimesContainer').innerHTML = '';
      document.getElementById('totalTimeCalc').value = '';
    }
    
    function openAIModal() {
      document.getElementById('aiModal').classList.add('active');
      
      // „Äå„Åù„ÅÆ‰ªñ„Äç„ÇíÈñâ„Åò„ÅüÁä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà
      document.getElementById('aiMoreOptions').style.display = 'none';
      document.getElementById('moreToggleText').textContent = '„Åù„ÅÆ‰ªñ„ÅÆÁõ∏Ë´á ‚ñº';
      
      // „Çµ„ÉñÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
      document.getElementById('subjectSelectGroup').style.display = 'none';
      document.getElementById('universitySelectGroup').style.display = 'none';
      
      generatePrompt();
    }
    
    function closeAIModal() {
      document.getElementById('aiModal').classList.remove('active');
    }
    
    function openSettingsModal() {
      document.getElementById('settingsApiUrl').value = API_URL;
      document.getElementById('settingsWeeklyGoal').value = appData.settings?.weeklyGoalMinutes || 1800;
      document.getElementById('settingsExamDate').value = localStorage.getItem('examDate') || '2026-01-17';
      document.getElementById('settingsChatUrl').value = CHAT_URL;
      document.getElementById('appVersionDisplay').textContent = `v${APP_VERSION}`;
      document.getElementById('settingsModal').classList.add('active');
    }
    
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('active');
    }
    
    async function submitStudyLog() {
      if (!selectedSubject) { showToast('ÁßëÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      if (!selectedTime) { showToast('Â≠¶ÁøíÊôÇÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      
      showLoading();
      
      try {
        await postData({
          action: 'addStudyLog',
          date: document.getElementById('studyDate').value,
          subject: selectedSubject,
          studyType: selectedStudyType,
          minutes: selectedTime,
          mood: selectedMood,
          unit: document.getElementById('studyUnit').value,
          textbook: document.getElementById('studyTextbook').value,
          memo: document.getElementById('studyMemo').value
        });
        
        closeStudyModal();
        showToast('Â≠¶ÁøíË®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        setTimeout(() => refreshData(), 1500);
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    async function submitRedbookLog() {
      let university = document.getElementById('redbookUniversity').value;
      const subject = document.getElementById('redbookSubject').value;
      const year = document.getElementById('redbookYear').value;
      
      // „Ç´„Çπ„Çø„É†Â§ßÂ≠¶„ÅÆÂá¶ÁêÜ
      if (university === '__custom__') {
        university = document.getElementById('customUniversity').value.trim();
        if (!university) {
          showToast('Â§ßÂ≠¶Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
          return;
        }
      }
      
      // Á∑èÂêàÂæóÁÇπ„ÇíÂèñÂæó
      const totalGot = parseInt(document.getElementById('totalScoreGot').value) || 0;
      const totalMax = parseInt(document.getElementById('totalScoreMax').value) || 0;
      
      if (!university) { showToast('Â§ßÂ≠¶„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      if (!subject) { showToast('ÁßëÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      if (!year) { showToast('Âπ¥Â∫¶„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      if (totalMax === 0) { showToast('ÂæóÁÇπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      
      // ÂæóÁÇπÁéá„ÇíË®àÁÆó
      const score = Math.round((totalGot / totalMax) * 100);
      
      // Â§ßÂïè„Åî„Å®„ÅÆÂæóÁÇπ„ÇíÊñáÂ≠óÂàóÂΩ¢Âºè„Åß‰ΩúÊàê
      const container = document.getElementById('sectionScoresContainer');
      const rows = container.querySelectorAll('.score-row');
      const sectionScoresArray = [];
      
      // Â§ßÂïè„Åî„Å®„ÅÆÊôÇÈñì„ÇÇÂèñÂæó
      const timeContainer = document.getElementById('sectionTimesContainer');
      const timeInputs = timeContainer.querySelectorAll('.section-time-input');
      
      rows.forEach((row, index) => {
        const name = row.querySelector('.section-name').value || 'Â§ßÂïè';
        const got = row.querySelector('.section-got').value || '0';
        const max = row.querySelector('.section-max').value || '0';
        if (parseInt(max) > 0) {
          let sectionData = `${name}:${got}/${max}`;
          // ÊôÇÈñìÂÖ•Âäõ„É¢„Éº„Éâ„ÅåÂ§ßÂïè„Åî„Å®„ÅÆÂ†¥Âêà„ÄÅÊôÇÈñì„ÇÇËøΩÂä†
          if (timeInputMode === 'section' && timeInputs[index]) {
            const sectionTime = timeInputs[index].value || '';
            if (sectionTime) {
              sectionData += `(${sectionTime}ÂàÜ)`;
            }
          }
          sectionScoresArray.push(sectionData);
        }
      });
      const sectionScores = sectionScoresArray.join(', ');
      
      // Á∑èÂêàÊôÇÈñì„ÇíÂèñÂæó
      let totalTime = '';
      if (timeInputMode === 'total') {
        totalTime = document.getElementById('redbookTime').value ? parseInt(document.getElementById('redbookTime').value) : '';
      } else {
        totalTime = document.getElementById('totalTimeCalc').value ? parseInt(document.getElementById('totalTimeCalc').value) : '';
      }
      
      showLoading();
      
      try {
        await postData({
          action: 'addRedbookLog',
          date: document.getElementById('redbookDate').value,
          university,
          subject,
          year,
          score,
          time: totalTime,
          sectionScores,
          weakAreas: document.getElementById('redbookWeakAreas').value,
          memo: document.getElementById('redbookMemo').value
        });
        
        closeRedbookModal();
        showToast('Ëµ§Êú¨Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        setTimeout(() => refreshData(), 1500);
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    // ==========================================
    // „ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ
    // ==========================================
    let chatMessages = [];
    
    function initChat() {
      if (CHAT_URL) {
        document.getElementById('chatHeaderBtn').style.display = 'flex';
        loadChatMessages();
        // 30Áßí„Åî„Å®„Å´Êñ∞ÁùÄ„ÉÅ„Çß„ÉÉ„ÇØ
        setInterval(checkNewMessages, 30000);
      } else {
        document.getElementById('chatHeaderBtn').style.display = 'none';
      }
    }
    
    // „ÉÅ„É£„ÉÉ„ÉàÁî®JSONPÈñ¢Êï∞
    function chatJsonp(url) {
      return new Promise((resolve, reject) => {
        const callbackName = 'chatCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        
        script.onerror = function() {
          delete window[callbackName];
          document.body.removeChild(script);
          reject(new Error('JSONP request failed'));
        };
        
        const separator = url.includes('?') ? '&' : '?';
        script.src = `${url}${separator}callback=${callbackName}`;
        document.body.appendChild(script);
        
        // „Çø„Ç§„É†„Ç¢„Ç¶„Éà
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script.parentNode) document.body.removeChild(script);
            reject(new Error('JSONP timeout'));
          }
        }, 10000);
      });
    }
    
    async function loadChatMessages() {
      if (!CHAT_URL) return;
      
      try {
        const data = await chatJsonp(`${CHAT_URL}?action=getMessages`);
        
        if (data.error) throw new Error(data.error);
        
        chatMessages = data.messages || [];
        renderChatMessages();
        updateChatBadge();
        
      } catch (error) {
        console.error('Chat load error:', error);
      }
    }
    
    async function checkNewMessages() {
      if (!CHAT_URL) return;
      
      try {
        const data = await chatJsonp(`${CHAT_URL}?action=getMessages`);
        
        if (data.messages) {
          chatMessages = data.messages;
          renderChatMessages();
        }
        updateChatBadge();
      } catch (error) {
        console.error('Chat check error:', error);
      }
    }
    
    async function markChatAsRead() {
      if (!CHAT_URL) return;
      
      // Êú™Ë™≠„ÅÆadmin„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆID„ÇíÂèéÈõÜ
      const unreadIds = chatMessages
        .filter(m => m.sender === 'admin' && !m.readByStudent)
        .map(m => m.id);
      
      if (unreadIds.length === 0) return;
      
      try {
        await chatJsonp(`${CHAT_URL}?action=markAsRead&role=student&ids=${unreadIds.join(',')}`);
        // „É≠„Éº„Ç´„É´„ÅÆÊó¢Ë™≠Áä∂ÊÖã„ÇÇÊõ¥Êñ∞
        chatMessages.forEach(m => {
          if (m.sender === 'admin') m.readByStudent = true;
        });
        renderChatMessages();
        updateChatBadge();
      } catch (error) {
        console.error('Mark as read error:', error);
      }
    }
    
    function updateChatBadge() {
      const badge = document.getElementById('chatHeaderBadge');
      
      // Êú™Ë™≠„ÅÆadmin„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Ç´„Ç¶„É≥„ÉàÔºàreadByStudent === falseÔºâ
      const unreadCount = chatMessages.filter(m => 
        m.sender === 'admin' && !m.readByStudent
      ).length;
      
      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      
      if (chatMessages.length === 0) {
        container.innerHTML = '<div class="chat-empty"><div class="chat-empty-icon">üí¨</div>„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }
      
      let lastDate = '';
      container.innerHTML = chatMessages.map(msg => {
        const date = new Date(msg.timestamp);
        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
        const timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        let dateDivider = '';
        if (dateStr !== lastDate) {
          dateDivider = `<div class="chat-date-divider">${dateStr}</div>`;
          lastDate = dateStr;
        }
        
        // Ëá™ÂàÜÔºàstudentÔºâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÁõ∏ÊâãÔºàadminÔºâ„Å´Ë™≠„Åæ„Çå„Åü„Åã
        let readStatus = '';
        if (msg.sender === 'student' && msg.readByAdmin) {
          readStatus = '<span class="chat-read-status">Êó¢Ë™≠</span>';
        }
        
        return `
          ${dateDivider}
          <div class="chat-message ${msg.sender}">
            <div>${escapeHtml(msg.message)}</div>
            <div class="chat-message-time">${timeStr}${readStatus}</div>
          </div>
        `;
      }).join('');
      
      // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏ãÈÉ®„Å∏
      container.scrollTop = container.scrollHeight;
    }
    
    function openChat() {
      document.getElementById('chatModal').classList.add('active');
      document.getElementById('chatHeaderBadge').style.display = 'none';
      loadChatMessages();
      
      // Êó¢Ë™≠„Éû„Éº„ÇØ„ÇíÈÄÅ‰ø°
      markChatAsRead();
      
      // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏ãÈÉ®„Å∏
      setTimeout(() => {
        const container = document.getElementById('chatMessages');
        container.scrollTop = container.scrollHeight;
      }, 100);
    }
    
    function closeChat() {
      document.getElementById('chatModal').classList.remove('active');
    }
    
    function handleChatKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
      }
    }
    
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || !CHAT_URL) return;
      
      const sendBtn = document.getElementById('chatSendBtn');
      sendBtn.disabled = true;
      
      try {
        // JSONP„Çí‰ΩøÁî®ÔºàCORSÂõûÈÅøÔºâ
        const params = new URLSearchParams({
          action: 'sendMessage',
          sender: 'student',
          message: message
        });
        
        const data = await chatJsonp(`${CHAT_URL}?${params.toString()}`);
        
        if (data.error) throw new Error(data.error);
        
        input.value = '';
        await loadChatMessages();
        
      } catch (error) {
        showToast('ÈÄÅ‰ø°„Ç®„É©„Éº: ' + error.message, 'error');
      } finally {
        sendBtn.disabled = false;
      }
    }
    
    function saveSettings() {
      const apiUrl = document.getElementById('settingsApiUrl').value.trim();
      const weeklyGoal = document.getElementById('settingsWeeklyGoal').value;
      const examDate = document.getElementById('settingsExamDate').value;
      const chatUrl = document.getElementById('settingsChatUrl').value.trim();
      
      localStorage.setItem('apiUrl', apiUrl);
      localStorage.setItem('weeklyGoal', weeklyGoal);
      localStorage.setItem('examDate', examDate);
      localStorage.setItem('chatUrl', chatUrl);
      
      API_URL = apiUrl;
      CHAT_URL = chatUrl;
      appData.settings.weeklyGoalMinutes = parseInt(weeklyGoal);
      
      closeSettingsModal();
      showToast('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
      
      initChat();
      if (apiUrl) refreshData();
    }
    
    // ==========================================
    // È´òÂ∫¶„Å™ÂàÜÊûê„Ç®„É≥„Ç∏„É≥
    // ==========================================
    
    function analyzeStudyData(logs, redbookLogs, goals, profile) {
      const today = new Date();
      const examDate = new Date(localStorage.getItem('examDate') || '2026-01-17');
      const daysUntil = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
      
      // ÊúüÈñìÂà•„É≠„Ç∞
      const getLogsInRange = (days) => {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        return logs.filter(log => new Date(log.date) >= cutoff);
      };
      
      const getRedbookLogsInRange = (days) => {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        return redbookLogs.filter(log => new Date(log.date) >= cutoff);
      };
      
      const weekLogs = getLogsInRange(7);
      const twoWeekLogs = getLogsInRange(14);
      const monthLogs = getLogsInRange(30);
      
      const weekRedbookLogs = getRedbookLogsInRange(7);
      const twoWeekRedbookLogs = getRedbookLogsInRange(14);
      
      // ========== Âü∫Êú¨Áµ±Ë®àÔºàËµ§Êú¨ÊôÇÈñì„ÇíÂê´„ÇÄÔºâ ==========
      const studyMinutes = logs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const redbookMinutes = redbookLogs.reduce((sum, log) => sum + (log.time || 0), 0);
      const totalMinutes = studyMinutes + redbookMinutes;
      
      const studyWeekMinutes = weekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const redbookWeekMinutes = weekRedbookLogs.reduce((sum, log) => sum + (log.time || 0), 0);
      const weekMinutes = studyWeekMinutes + redbookWeekMinutes;
      
      const studyPrevWeekMinutes = twoWeekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0) - studyWeekMinutes;
      const redbookPrevWeekMinutes = twoWeekRedbookLogs.reduce((sum, log) => sum + (log.time || 0), 0) - redbookWeekMinutes;
      const prevWeekMinutes = studyPrevWeekMinutes + redbookPrevWeekMinutes;
      
      // Â≠¶ÁøíÊó•Êï∞ÔºàÂ≠¶ÁøíË®òÈå≤„Å®Ëµ§Êú¨Ë®òÈå≤„ÅÆ‰∏°Êñπ„ÇíËÄÉÊÖÆÔºâ
      const allDates = [...new Set([
        ...logs.map(l => l.date),
        ...redbookLogs.map(l => l.date)
      ])];
      const studyDays = allDates.length;
      const streak = calculateStreak({ dates: allDates });
      
      // ========== ÊõúÊó•Âà•„Éë„Çø„Éº„É≥ ==========
      const dayOfWeekStats = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
      const dayOfWeekCount = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
      logs.forEach(log => {
        const dow = new Date(log.date).getDay();
        dayOfWeekStats[dow] += log.minutes || 0;
        dayOfWeekCount[dow]++;
      });
      // Ëµ§Êú¨ÊôÇÈñì„ÇÇÊõúÊó•Âà•„Å´ËøΩÂä†
      redbookLogs.forEach(log => {
        const dow = new Date(log.date).getDay();
        dayOfWeekStats[dow] += log.time || 0;
        dayOfWeekCount[dow]++;
      });
      const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      const dayOfWeekAvg = {};
      for (let i = 0; i < 7; i++) {
        dayOfWeekAvg[dayNames[i]] = dayOfWeekCount[i] > 0 
          ? Math.round(dayOfWeekStats[i] / dayOfWeekCount[i]) 
          : 0;
      }
      
      // ÊúÄ„ÇÇÂãâÂº∑„Åô„ÇãÊõúÊó•„Éª„Åó„Å™„ÅÑÊõúÊó•
      const sortedDays = Object.entries(dayOfWeekAvg).sort((a, b) => b[1] - a[1]);
      const strongDays = sortedDays.filter(d => d[1] > 0).slice(0, 2).map(d => d[0]);
      const weakDays = sortedDays.filter(d => d[1] >= 0).slice(-2).map(d => d[0]);
      
      // ========== ÁßëÁõÆÂà•Ë©≥Á¥∞ÂàÜÊûê ==========
      const subjectAnalysis = {};
      const categories = ['Ëã±Ë™û', 'Êï∞Â≠¶', 'ÂõΩË™û', '„Åù„ÅÆ‰ªñ'];
      
      categories.forEach(cat => {
        const catLogs = logs.filter(log => categorizeSubject(log.subject) === cat);
        const catWeekLogs = weekLogs.filter(log => categorizeSubject(log.subject) === cat);
        const catPrevWeekLogs = twoWeekLogs.filter(log => categorizeSubject(log.subject) === cat && !catWeekLogs.includes(log));
        
        const weekMin = catWeekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
        const prevWeekMin = catPrevWeekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
        const totalMin = catLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
        
        // Â≠¶Áøí„Çø„Ç§„ÉóÂà•
        const typeBreakdown = {};
        catWeekLogs.forEach(log => {
          if (log.studyType) {
            typeBreakdown[log.studyType] = (typeBreakdown[log.studyType] || 0) + (log.minutes || 0);
          }
        });
        
        // ÊâãÂøú„ÅàÂàÜÊûê
        const moodBreakdown = { excellent: 0, good: 0, neutral: 0, bad: 0, terrible: 0 };
        catLogs.forEach(log => {
          if (log.mood === 'üòä') moodBreakdown.excellent++;
          else if (log.mood === 'üôÇ') moodBreakdown.good++;
          else if (log.mood === 'üòê') moodBreakdown.neutral++;
          else if (log.mood === 'üòï') moodBreakdown.bad++;
          else if (log.mood === 'üò´') moodBreakdown.terrible++;
        });
        
        // ‰ΩøÁî®ÊïôÊùê
        const textbooks = {};
        catLogs.forEach(log => {
          if (log.textbook) {
            textbooks[log.textbook] = (textbooks[log.textbook] || 0) + (log.minutes || 0);
          }
        });
        
        // Â≠¶Áøí„Åó„ÅüÂçòÂÖÉ
        const units = catWeekLogs.filter(l => l.unit).map(l => l.unit);
        
        // ÂÇæÂêëÂà§ÂÆö
        let trend = 'stable';
        if (weekMin > prevWeekMin * 1.2) trend = 'increasing';
        else if (weekMin < prevWeekMin * 0.8) trend = 'decreasing';
        
        subjectAnalysis[cat] = {
          totalMinutes: totalMin,
          weekMinutes: weekMin,
          prevWeekMinutes: prevWeekMin,
          trend,
          typeBreakdown,
          moodBreakdown,
          textbooks,
          recentUnits: units,
          sessionCount: catLogs.length
        };
      });
      
      // ========== Â≠¶Áøí„Çø„Ç§„Éó„Éê„É©„É≥„Çπ ==========
      const typeBalance = { Êñ∞Ë¶è: 0, Âæ©Áøí: 0, ÊºîÁøí: 0, ÊöóË®ò: 0, ÈÅéÂéªÂïè: 0, Ê®°Ë©¶: 0 };
      weekLogs.forEach(log => {
        if (log.studyType && typeBalance.hasOwnProperty(log.studyType)) {
          typeBalance[log.studyType] += log.minutes || 0;
        }
      });
      const typeTotal = Object.values(typeBalance).reduce((a, b) => a + b, 0);
      const typePercentage = {};
      Object.entries(typeBalance).forEach(([type, min]) => {
        typePercentage[type] = typeTotal > 0 ? Math.round(min / typeTotal * 100) : 0;
      });
      
      // „Çø„Ç§„Éó„Éê„É©„É≥„Çπ„ÅÆË©ï‰æ°
      let typeBalanceAssessment = [];
      if (typePercentage['Âæ©Áøí'] < 20) typeBalanceAssessment.push('Âæ©Áøí„ÅåÂ∞ë„Å™„ÇÅÔºàÂÆöÁùÄ„Å´‰∏çÂÆâÔºâ');
      if (typePercentage['ÊºîÁøí'] < 15) typeBalanceAssessment.push('ÊºîÁøíÈáè„Åå‰∏çË∂≥ÔºàÂÆüÊà¶Âäõ„Å´Ë™≤È°åÔºâ');
      if (typePercentage['Êñ∞Ë¶è'] > 50) typeBalanceAssessment.push('Êñ∞Ë¶èÂ≠¶Áøí„Å´ÂÅèÈáçÔºàÊ∂àÂåñ‰∏çËâØ„ÅÆÊÅê„ÇåÔºâ');
      
      // ========== ÈÅéÂéªÂïèÂàÜÊûêÔºàÂ§ßÂπÖÊã°ÂºµÔºâ ==========
      const redbookAnalysis = {
        totalAttempts: redbookLogs.length,
        totalTime: 0,
        avgScore: 0,
        scoresBySubject: {},
        scoreTrend: 'stable',
        weakAreasSummary: {},
        timeManagement: { adequate: 0, rushed: 0, overtime: 0, unknown: 0 },
        // Êñ∞Ë¶èËøΩÂä†
        universityAnalysis: {},
        sectionAnalysis: {},
        recentPerformance: [],
        monthlyProgress: {}
      };
      
      if (redbookLogs.length > 0) {
        // Á∑èÊºîÁøíÊôÇÈñì
        redbookAnalysis.totalTime = redbookLogs.reduce((sum, l) => sum + (l.time || 0), 0);
        
        redbookAnalysis.avgScore = Math.round(
          redbookLogs.reduce((sum, l) => sum + l.score, 0) / redbookLogs.length
        );
        
        // ÁßëÁõÆÂà•Âπ≥Âùá
        const subjectScores = {};
        const subjectCounts = {};
        redbookLogs.forEach(log => {
          const cat = categorizeSubject(log.subject);
          if (!subjectScores[cat]) {
            subjectScores[cat] = 0;
            subjectCounts[cat] = 0;
          }
          subjectScores[cat] += log.score;
          subjectCounts[cat]++;
        });
        Object.keys(subjectScores).forEach(cat => {
          redbookAnalysis.scoresBySubject[cat] = Math.round(subjectScores[cat] / subjectCounts[cat]);
        });
        
        // ÂæóÁÇπ„Éà„É¨„É≥„ÉâÔºàÁõ¥Ëøë5Âõû vs „Åù„Çå‰ª•ÂâçÔºâ
        if (redbookLogs.length >= 4) {
          const sorted = [...redbookLogs].sort((a, b) => new Date(a.date) - new Date(b.date));
          const half = Math.floor(sorted.length / 2);
          const older = sorted.slice(0, half);
          const recent = sorted.slice(half);
          const olderAvg = older.reduce((s, l) => s + l.score, 0) / older.length;
          const recentAvg = recent.reduce((s, l) => s + l.score, 0) / recent.length;
          if (recentAvg > olderAvg + 5) redbookAnalysis.scoreTrend = 'improving';
          else if (recentAvg < olderAvg - 5) redbookAnalysis.scoreTrend = 'declining';
        }
        
        // Ëã¶ÊâãÂàÜÈáéÈõÜË®à
        redbookLogs.forEach(log => {
          if (log.weakAreas) {
            log.weakAreas.split(/[,„ÄÅ]/).forEach(area => {
              const trimmed = area.trim();
              if (trimmed) {
                redbookAnalysis.weakAreasSummary[trimmed] = 
                  (redbookAnalysis.weakAreasSummary[trimmed] || 0) + 1;
              }
            });
          }
        });
        
        // ========== Â§ßÂ≠¶Âà•Ë©≥Á¥∞ÂàÜÊûê ==========
        const uniGroups = {};
        redbookLogs.forEach(log => {
          const uni = log.university || '‰∏çÊòé';
          if (!uniGroups[uni]) {
            uniGroups[uni] = [];
          }
          uniGroups[uni].push(log);
        });
        
        Object.entries(uniGroups).forEach(([uni, logs]) => {
          const sorted = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
          const avgScore = Math.round(logs.reduce((s, l) => s + l.score, 0) / logs.length);
          const avgTime = logs.filter(l => l.time).length > 0
            ? Math.round(logs.filter(l => l.time).reduce((s, l) => s + l.time, 0) / logs.filter(l => l.time).length)
            : 0;
          
          // ÁßëÁõÆÂà•
          const bySubject = {};
          logs.forEach(l => {
            const subj = l.subject || '‰∏çÊòé';
            if (!bySubject[subj]) {
              bySubject[subj] = { scores: [], times: [], weakAreas: [] };
            }
            bySubject[subj].scores.push(l.score);
            if (l.time) bySubject[subj].times.push(l.time);
            if (l.weakAreas) {
              l.weakAreas.split(/[,„ÄÅ]/).forEach(a => {
                if (a.trim()) bySubject[subj].weakAreas.push(a.trim());
              });
            }
          });
          
          const subjectSummary = {};
          Object.entries(bySubject).forEach(([subj, data]) => {
            subjectSummary[subj] = {
              avgScore: Math.round(data.scores.reduce((a, b) => a + b, 0) / data.scores.length),
              attempts: data.scores.length,
              avgTime: data.times.length > 0 ? Math.round(data.times.reduce((a, b) => a + b, 0) / data.times.length) : null,
              weakAreas: [...new Set(data.weakAreas)].slice(0, 5)
            };
          });
          
          // „Éà„É¨„É≥„Éâ
          let trend = 'stable';
          if (sorted.length >= 3) {
            const half = Math.floor(sorted.length / 2);
            const firstHalf = sorted.slice(0, half);
            const secondHalf = sorted.slice(half);
            const firstAvg = firstHalf.reduce((s, l) => s + l.score, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((s, l) => s + l.score, 0) / secondHalf.length;
            if (secondAvg > firstAvg + 3) trend = 'improving';
            else if (secondAvg < firstAvg - 3) trend = 'declining';
          }
          
          redbookAnalysis.universityAnalysis[uni] = {
            attempts: logs.length,
            avgScore,
            avgTime,
            highScore: Math.max(...logs.map(l => l.score)),
            lowScore: Math.min(...logs.map(l => l.score)),
            trend,
            bySubject: subjectSummary,
            recentLogs: sorted.slice(-3).reverse()
          };
        });
        
        // ========== Â§ßÂïèÂà•ÂàÜÊûê ==========
        const sectionData = {};
        redbookLogs.forEach(log => {
          if (log.sectionScores) {
            // ÂΩ¢Âºè: "Â§ßÂïè1:15/20, Â§ßÂïè2:30/40" „Åæ„Åü„ÅØ "1A:15/30(25ÂàÜ), 1B:10/20(15ÂàÜ)"
            log.sectionScores.split(',').forEach(section => {
              const match = section.trim().match(/(.+?):(\d+)\/(\d+)(?:\((\d+)ÂàÜ\))?/);
              if (match) {
                const [, name, got, max, time] = match;
                const key = name.trim();
                const rate = max > 0 ? Math.round((parseInt(got) / parseInt(max)) * 100) : 0;
                
                if (!sectionData[key]) {
                  sectionData[key] = { scores: [], times: [], subjects: [] };
                }
                sectionData[key].scores.push(rate);
                if (time) sectionData[key].times.push(parseInt(time));
                sectionData[key].subjects.push(log.subject || '‰∏çÊòé');
              }
            });
          }
        });
        
        Object.entries(sectionData).forEach(([name, data]) => {
          redbookAnalysis.sectionAnalysis[name] = {
            avgScore: Math.round(data.scores.reduce((a, b) => a + b, 0) / data.scores.length),
            attempts: data.scores.length,
            avgTime: data.times.length > 0 ? Math.round(data.times.reduce((a, b) => a + b, 0) / data.times.length) : null,
            subjects: [...new Set(data.subjects)]
          };
        });
        
        // ========== Áõ¥Ëøë„ÅÆ„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ ==========
        redbookAnalysis.recentPerformance = [...redbookLogs]
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 5)
          .map(l => ({
            date: l.date,
            university: l.university,
            subject: l.subject,
            score: l.score,
            time: l.time,
            weakAreas: l.weakAreas
          }));
        
        // ========== ÊúàÂà•ÈÄ≤Êçó ==========
        redbookLogs.forEach(log => {
          const month = log.date.substring(0, 7); // YYYY-MM
          if (!redbookAnalysis.monthlyProgress[month]) {
            redbookAnalysis.monthlyProgress[month] = { attempts: 0, totalScore: 0, totalTime: 0 };
          }
          redbookAnalysis.monthlyProgress[month].attempts++;
          redbookAnalysis.monthlyProgress[month].totalScore += log.score;
          redbookAnalysis.monthlyProgress[month].totalTime += log.time || 0;
        });
        
        Object.keys(redbookAnalysis.monthlyProgress).forEach(month => {
          const data = redbookAnalysis.monthlyProgress[month];
          data.avgScore = Math.round(data.totalScore / data.attempts);
        });
      }
      
      // ========== ÁõÆÊ®ôÈÅîÊàêÂàÜÊûê ==========
      const goalAnalysis = goals.map(goal => {
        const gap = goal.target - goal.current;
        const mustGap = (goal.must || goal.target) - goal.current;
        const subjectRedbook = redbookLogs.filter(l => categorizeSubject(l.subject) === goal.subject);
        const recentScore = subjectRedbook.length > 0 ? subjectRedbook[0].score : goal.current;
        
        // ÈÅîÊàêÂèØËÉΩÊÄßÂà§ÂÆö
        let feasibility = 'possible';
        if (gap > 30 && daysUntil < 30) feasibility = 'challenging';
        else if (gap > 20 && daysUntil < 14) feasibility = 'difficult';
        else if (gap <= 10) feasibility = 'likely';
        
        // ÂøÖË¶Å„Å™ÈÄ±ÈñìÂ≠¶ÁøíÊôÇÈñì„ÅÆÊé®ÂÆöÔºàÁ∞°ÊòìÔºâ
        const neededWeeklyHours = Math.max(1, Math.ceil(gap / 5));
        
        return {
          subject: goal.subject,
          current: goal.current,
          target: goal.target,
          must: goal.must || goal.target,
          gap,
          mustGap,
          recentScore,
          feasibility,
          neededWeeklyHours
        };
      });
      
      // ========== „É™„Çπ„ÇØÂàÜÊûê ==========
      const risks = [];
      
      // Â≠¶ÁøíÈáè„É™„Çπ„ÇØ
      if (weekMinutes < 600) {
        risks.push({ type: 'study_volume', severity: 'high', message: 'ÈÄ±ÈñìÂ≠¶ÁøíÊôÇÈñì„Åå10ÊôÇÈñìÊú™Ê∫Ä„ÅßÂ∞ë„Å™„ÇÅ' });
      } else if (weekMinutes < 900) {
        risks.push({ type: 'study_volume', severity: 'medium', message: 'ÈÄ±ÈñìÂ≠¶ÁøíÊôÇÈñì„Åå15ÊôÇÈñìÊú™Ê∫Ä' });
      }
      
      // ÁßëÁõÆ„Éê„É©„É≥„Çπ„É™„Çπ„ÇØ
      const subjectMinutes = Object.values(subjectAnalysis).map(s => s.weekMinutes);
      const maxSubject = Math.max(...subjectMinutes);
      const minSubject = Math.min(...subjectMinutes.filter(m => m > 0));
      if (maxSubject > minSubject * 3) {
        risks.push({ type: 'balance', severity: 'medium', message: 'ÁßëÁõÆÈñì„ÅÆÂ≠¶ÁøíÊôÇÈñì„Å´Â§ß„Åç„Å™ÂÅè„Çä' });
      }
      
      // ÈÅéÂéªÂïè„Çπ„Ç≥„Ç¢„É™„Çπ„ÇØ
      if (redbookAnalysis.avgScore > 0 && redbookAnalysis.avgScore < 50) {
        risks.push({ type: 'score', severity: 'high', message: 'ÈÅéÂéªÂïè„ÅÆÂπ≥ÂùáÂæóÁÇπÁéá„Åå50%Êú™Ê∫Ä' });
      }
      
      // Âæ©Áøí‰∏çË∂≥„É™„Çπ„ÇØ
      if (typePercentage['Âæ©Áøí'] < 15) {
        risks.push({ type: 'review', severity: 'medium', message: 'Âæ©Áøí„ÅÆÂâ≤Âêà„ÅåÂ∞ë„Å™„ÅèÂÆöÁùÄ„Å´‰∏çÂÆâ' });
      }
      
      // Á∂ôÁ∂öÊÄß„É™„Çπ„ÇØ
      if (streak < 3 && studyDays > 7) {
        risks.push({ type: 'consistency', severity: 'low', message: 'ÈÄ£Á∂öÂ≠¶Áøí„ÅåÈÄîÂàá„Çå„Åå„Å°' });
      }
      
      // ========== Âº∑„Åø„ÅÆÁâπÂÆö ==========
      const strengths = [];
      
      if (streak >= 7) {
        strengths.push({ type: 'consistency', message: `${streak}Êó•ÈÄ£Á∂öÂ≠¶Áøí„ÇíÁ∂ôÁ∂ö‰∏≠` });
      }
      if (weekMinutes >= 1500) {
        strengths.push({ type: 'volume', message: 'ÂçÅÂàÜ„Å™Â≠¶ÁøíÈáè„ÇíÁ¢∫‰øù' });
      }
      if (redbookAnalysis.scoreTrend === 'improving') {
        strengths.push({ type: 'progress', message: 'ÈÅéÂéªÂïè„ÅÆÂæóÁÇπ„Åå‰∏äÊòáÂÇæÂêë' });
      }
      
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        const goodMood = data.moodBreakdown.excellent + data.moodBreakdown.good;
        const badMood = data.moodBreakdown.bad + data.moodBreakdown.terrible;
        if (goodMood > badMood * 2 && goodMood >= 3) {
          strengths.push({ type: 'confidence', message: `${cat}„ÅÆÂ≠¶Áøí„ÅßÂ•ΩË™ø` });
        }
      });
      
      // ========== ÊàêÈï∑ÂàÜÊûêÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ ==========
      const growthAnalysis = {
        // Â≠¶ÁøíÈáè„ÅÆÊé®Áßª
        volumeGrowth: prevWeekMinutes > 0 ? Math.round((weekMinutes - prevWeekMinutes) / prevWeekMinutes * 100) : 0,
        
        // Â≠¶ÁøíÁøíÊÖ£„Çπ„Ç≥„Ç¢Ôºà100ÁÇπÊ∫ÄÁÇπÔºâ
        habitScore: 0,
        habitFactors: [],
        
        // ÊâãÂøú„Åà„ÅÆÊé®Áßª
        moodTrend: { improving: 0, stable: 0, declining: 0 },
        
        // ÁßëÁõÆÂà•„ÅÆÊàêÈï∑
        subjectGrowth: {},
        
        // ÈÄ±Èñì„ÅÆÂ≠¶Áøí„Éë„Çø„Éº„É≥
        weekPattern: {
          mostProductiveDay: strongDays[0] || '‰∏çÊòé',
          leastProductiveDay: weakDays[0] || '‰∏çÊòé',
          avgDailyMinutes: studyDays > 0 ? Math.round(totalMinutes / studyDays) : 0,
          consistency: 0 // Â≠¶ÁøíÊó•„ÅÆÈÄ£Á∂öÊÄß
        }
      };
      
      // Â≠¶ÁøíÁøíÊÖ£„Çπ„Ç≥„Ç¢„ÅÆË®àÁÆó
      let habitScore = 0;
      
      // 1. Á∂ôÁ∂öÊÄßÔºà30ÁÇπÊ∫ÄÁÇπÔºâ
      if (streak >= 14) { habitScore += 30; growthAnalysis.habitFactors.push('ÂÑ™ÁßÄ„Å™Á∂ôÁ∂öÂäõ'); }
      else if (streak >= 7) { habitScore += 25; growthAnalysis.habitFactors.push('ËâØÂ•Ω„Å™Á∂ôÁ∂öÂäõ'); }
      else if (streak >= 3) { habitScore += 15; growthAnalysis.habitFactors.push('Á∂ôÁ∂öÂäõÂêë‰∏ä‰∏≠'); }
      else { habitScore += 5; }
      
      // 2. Â≠¶ÁøíÈáèÔºà25ÁÇπÊ∫ÄÁÇπÔºâ
      const weeklyHours = weekMinutes / 60;
      if (weeklyHours >= 30) { habitScore += 25; growthAnalysis.habitFactors.push('ÂçÅÂàÜ„Å™Â≠¶ÁøíÈáè'); }
      else if (weeklyHours >= 20) { habitScore += 20; growthAnalysis.habitFactors.push('ÈÅ©Âàá„Å™Â≠¶ÁøíÈáè'); }
      else if (weeklyHours >= 10) { habitScore += 15; }
      else { habitScore += 5; }
      
      // 3. „Éê„É©„É≥„ÇπÔºà20ÁÇπÊ∫ÄÁÇπÔºâ
      const activeSubjects = Object.values(subjectAnalysis).filter(s => s.weekMinutes > 0).length;
      if (activeSubjects >= 3) { habitScore += 20; growthAnalysis.habitFactors.push('„Éê„É©„É≥„ÇπËâØ„ÅÑÂ≠¶Áøí'); }
      else if (activeSubjects >= 2) { habitScore += 15; }
      else { habitScore += 5; }
      
      // 4. Âæ©Áøí„ÉªÊºîÁøí„ÅÆÂÆüÊñΩÔºà15ÁÇπÊ∫ÄÁÇπÔºâ
      if (typePercentage['Âæ©Áøí'] >= 20 && typePercentage['ÊºîÁøí'] >= 15) {
        habitScore += 15;
        growthAnalysis.habitFactors.push('ÂÆöÁùÄÈáçË¶ñ„ÅÆÂ≠¶Áøí');
      } else if (typePercentage['Âæ©Áøí'] >= 15 || typePercentage['ÊºîÁøí'] >= 10) {
        habitScore += 10;
      } else {
        habitScore += 5;
      }
      
      // 5. ÈÅéÂéªÂïèÊºîÁøíÔºà10ÁÇπÊ∫ÄÁÇπÔºâ
      if (redbookAnalysis.totalAttempts > 0) {
        const recentRedbook = weekRedbookLogs.length;
        if (recentRedbook >= 3) { habitScore += 10; growthAnalysis.habitFactors.push('Á©çÊ•µÁöÑ„Å™ÈÅéÂéªÂïèÊºîÁøí'); }
        else if (recentRedbook >= 1) { habitScore += 7; }
        else { habitScore += 3; }
      }
      
      growthAnalysis.habitScore = habitScore;
      
      // ÁßëÁõÆÂà•„ÅÆÊàêÈï∑ÂàÜÊûê
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        let growth = 'stable';
        if (data.weekMinutes > data.prevWeekMinutes * 1.2) growth = 'increasing';
        else if (data.weekMinutes < data.prevWeekMinutes * 0.8) growth = 'decreasing';
        
        // ÊâãÂøú„Åà„ÅÆÈõÜË®à
        const totalMood = Object.values(data.moodBreakdown).reduce((a, b) => a + b, 0);
        const goodRate = totalMood > 0 ? (data.moodBreakdown.excellent + data.moodBreakdown.good) / totalMood * 100 : 0;
        
        growthAnalysis.subjectGrowth[cat] = {
          growth,
          weekMinutes: data.weekMinutes,
          prevWeekMinutes: data.prevWeekMinutes,
          changePercent: data.prevWeekMinutes > 0 ? Math.round((data.weekMinutes - data.prevWeekMinutes) / data.prevWeekMinutes * 100) : 0,
          goodMoodRate: Math.round(goodRate),
          recentUnits: data.recentUnits.slice(0, 5)
        };
      });
      
      // Â≠¶Áøí„Éë„Çø„Éº„É≥„ÅÆ‰∏ÄË≤´ÊÄßÔºàÊ®ôÊ∫ñÂÅèÂ∑Æ„Çí‰ΩøÁî®Ôºâ
      const dayValues = Object.values(dayOfWeekAvg);
      const avgOfDays = dayValues.reduce((a, b) => a + b, 0) / 7;
      const variance = dayValues.reduce((sum, val) => sum + Math.pow(val - avgOfDays, 2), 0) / 7;
      const stdDev = Math.sqrt(variance);
      // ‰∏ÄË≤´ÊÄß„Çπ„Ç≥„Ç¢: Ê®ôÊ∫ñÂÅèÂ∑Æ„ÅåÂ∞è„Åï„ÅÑ„Åª„Å©È´ò„ÅÑÔºà100ÁÇπÊ∫ÄÁÇπÔºâ
      growthAnalysis.weekPattern.consistency = avgOfDays > 0 ? Math.max(0, Math.round(100 - (stdDev / avgOfDays * 100))) : 0;
      
      // ========== Á∑èÂêàË©ï‰æ°ÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ ==========
      const comprehensiveScore = {
        total: 0,
        breakdown: {},
        grade: 'C',
        summary: ''
      };
      
      // Â≠¶ÁøíÈáè„Çπ„Ç≥„Ç¢Ôºà25ÁÇπÔºâ
      let volumeScore = 0;
      if (weekMinutes >= 1800) volumeScore = 25;
      else if (weekMinutes >= 1200) volumeScore = 20;
      else if (weekMinutes >= 600) volumeScore = 15;
      else volumeScore = Math.round(weekMinutes / 600 * 15);
      comprehensiveScore.breakdown['Â≠¶ÁøíÈáè'] = volumeScore;
      
      // Á∂ôÁ∂öÊÄß„Çπ„Ç≥„Ç¢Ôºà25ÁÇπÔºâ
      let consistencyScore = Math.min(25, Math.round(streak / 14 * 25));
      comprehensiveScore.breakdown['Á∂ôÁ∂öÊÄß'] = consistencyScore;
      
      // ÈÅéÂéªÂïèÊàêÁ∏æ„Çπ„Ç≥„Ç¢Ôºà25ÁÇπÔºâ
      let examScore = 0;
      if (redbookAnalysis.avgScore >= 80) examScore = 25;
      else if (redbookAnalysis.avgScore >= 60) examScore = 20;
      else if (redbookAnalysis.avgScore >= 40) examScore = 15;
      else if (redbookAnalysis.avgScore > 0) examScore = 10;
      comprehensiveScore.breakdown['ÈÅéÂéªÂïèÊàêÁ∏æ'] = examScore;
      
      // „Éê„É©„É≥„Çπ„Çπ„Ç≥„Ç¢Ôºà25ÁÇπÔºâ
      let balanceScore = Math.round(activeSubjects / 3 * 15);
      if (typeBalanceAssessment.length === 0) balanceScore += 10;
      else balanceScore += Math.max(0, 10 - typeBalanceAssessment.length * 3);
      comprehensiveScore.breakdown['Â≠¶Áøí„Éê„É©„É≥„Çπ'] = Math.min(25, balanceScore);
      
      comprehensiveScore.total = Object.values(comprehensiveScore.breakdown).reduce((a, b) => a + b, 0);
      
      // „Ç∞„É¨„Éº„ÉâÂà§ÂÆö
      if (comprehensiveScore.total >= 90) comprehensiveScore.grade = 'S';
      else if (comprehensiveScore.total >= 80) comprehensiveScore.grade = 'A';
      else if (comprehensiveScore.total >= 65) comprehensiveScore.grade = 'B';
      else if (comprehensiveScore.total >= 50) comprehensiveScore.grade = 'C';
      else comprehensiveScore.grade = 'D';
      
      return {
        // Âü∫Êú¨ÊÉÖÂ†±
        daysUntil,
        totalMinutes,
        weekMinutes,
        prevWeekMinutes,
        studyDays,
        streak,
        weekTrend: weekMinutes > prevWeekMinutes ? 'up' : weekMinutes < prevWeekMinutes ? 'down' : 'stable',
        
        // „Éë„Çø„Éº„É≥
        dayOfWeekAvg,
        strongDays,
        weakDays,
        
        // ÁßëÁõÆÂà•
        subjectAnalysis,
        
        // „Çø„Ç§„Éó„Éê„É©„É≥„Çπ
        typeBalance,
        typePercentage,
        typeBalanceAssessment,
        
        // ÈÅéÂéªÂïè
        redbookAnalysis,
        
        // ÁõÆÊ®ô
        goalAnalysis,
        
        // Ë©ï‰æ°
        risks,
        strengths,
        
        // ÊàêÈï∑ÂàÜÊûêÔºàÊñ∞Ë¶èÔºâ
        growthAnalysis,
        
        // Á∑èÂêàË©ï‰æ°ÔºàÊñ∞Ë¶èÔºâ
        comprehensiveScore,
        
        // Áîü„Éá„Éº„Çø
        weekLogs,
        redbookLogs,
        profile
      };
    }
    
    // ==========================================
    // Â≠¶ÁøíÂàÜÊûê„Çø„Éñ
    // ==========================================
    
    function renderStudyAnalysis() {
      const logs = appData.studyLogs || [];
      if (logs.length === 0) return;
      
      // Âü∫Êú¨Áµ±Ë®à
      const totalMinutes = logs.reduce((sum, l) => sum + (l.minutes || 0), 0);
      const studyDates = [...new Set(logs.map(l => l.date))];
      const avgDaily = Math.round(totalMinutes / studyDates.length);
      
      document.getElementById('studyTotalHours').textContent = Math.round(totalMinutes / 60);
      document.getElementById('studyAvgDaily').textContent = avgDaily;
      document.getElementById('studyTotalDays').textContent = studyDates.length;
      
      // ÊúÄÈï∑ÈÄ£Á∂öÊó•Êï∞„ÇíË®àÁÆó
      const sortedDates = studyDates.sort();
      let maxStreak = 1, currentStreak = 1;
      for (let i = 1; i < sortedDates.length; i++) {
        const prev = new Date(sortedDates[i-1]);
        const curr = new Date(sortedDates[i]);
        const diff = (curr - prev) / (1000 * 60 * 60 * 24);
        if (diff === 1) {
          currentStreak++;
          maxStreak = Math.max(maxStreak, currentStreak);
        } else {
          currentStreak = 1;
        }
      }
      document.getElementById('studyMaxStreak').textContent = maxStreak;
      
      // ÁßëÁõÆÂà•Â≠¶ÁøíÊôÇÈñì
      const subjectTotals = {};
      logs.forEach(l => {
        const cat = categorizeSubject(l.subject);
        subjectTotals[cat] = (subjectTotals[cat] || 0) + (l.minutes || 0);
      });
      
      const maxSubjectTime = Math.max(...Object.values(subjectTotals));
      const subjectBreakdown = document.getElementById('subjectBreakdown');
      subjectBreakdown.innerHTML = Object.entries(subjectTotals)
        .sort((a, b) => b[1] - a[1])
        .map(([subject, minutes]) => `
          <div class="breakdown-item">
            <span class="breakdown-label">${subject}</span>
            <div class="breakdown-bar-container">
              <div class="breakdown-bar" style="width: ${(minutes / maxSubjectTime) * 100}%"></div>
            </div>
            <span class="breakdown-value">${Math.round(minutes / 60)}ÊôÇÈñì</span>
          </div>
        `).join('');
      
      // ÊõúÊó•Âà•„ÉÅ„É£„Éº„Éà
      renderDayOfWeekChart(logs);
      
      // Â≠¶Áøí„Çø„Ç§„ÉóÂà•
      const typeTotals = {};
      logs.forEach(l => {
        const type = l.studyType || 'Êú™ÂàÜÈ°û';
        typeTotals[type] = (typeTotals[type] || 0) + (l.minutes || 0);
      });
      
      const maxTypeTime = Math.max(...Object.values(typeTotals));
      const typeBreakdown = document.getElementById('studyTypeBreakdown');
      typeBreakdown.innerHTML = Object.entries(typeTotals)
        .sort((a, b) => b[1] - a[1])
        .map(([type, minutes]) => {
          const percent = Math.round((minutes / totalMinutes) * 100);
          return `
            <div class="breakdown-item">
              <span class="breakdown-label">${type}</span>
              <div class="breakdown-bar-container">
                <div class="breakdown-bar" style="width: ${(minutes / maxTypeTime) * 100}%"></div>
              </div>
              <span class="breakdown-value">${percent}%</span>
            </div>
          `;
        }).join('');
      
      // ÊâãÂøú„ÅàÂàÜÊûê
      const moodCounts = {};
      const moods = ['üòä', 'üôÇ', 'üòê', 'üò£', 'üò´'];
      moods.forEach(m => moodCounts[m] = 0);
      logs.forEach(l => {
        if (l.mood && moodCounts.hasOwnProperty(l.mood)) {
          moodCounts[l.mood]++;
        }
      });
      
      const totalMoods = Object.values(moodCounts).reduce((a, b) => a + b, 0);
      const moodAnalysis = document.getElementById('moodAnalysis');
      moodAnalysis.innerHTML = moods.map(mood => {
        const count = moodCounts[mood];
        const percent = totalMoods > 0 ? Math.round((count / totalMoods) * 100) : 0;
        return `
          <div class="mood-item">
            <div class="mood-emoji">${mood}</div>
            <div class="mood-count">${count}</div>
            <div class="mood-percent">${percent}%</div>
          </div>
        `;
      }).join('');
      
      // „Éï„Ç£„É´„Çø„Éº„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
      updateStudyFilterOptions();
      
      // ÂÖ®Ë®òÈå≤Ë°®Á§∫
      filterStudyRecords();
    }
    
    function renderDayOfWeekChart(logs) {
      const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      const dayTotals = [0, 0, 0, 0, 0, 0, 0];
      const dayCounts = [0, 0, 0, 0, 0, 0, 0];
      
      logs.forEach(l => {
        const date = new Date(l.date);
        const day = date.getDay();
        dayTotals[day] += l.minutes || 0;
        dayCounts[day]++;
      });
      
      const dayAvgs = dayTotals.map((total, i) => dayCounts[i] > 0 ? Math.round(total / dayCounts[i]) : 0);
      
      const ctx = document.getElementById('dayOfWeekChart');
      if (!ctx) return;
      
      if (dayOfWeekChart) dayOfWeekChart.destroy();
      
      dayOfWeekChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dayNames,
          datasets: [{
            label: 'Âπ≥ÂùáÂ≠¶ÁøíÊôÇÈñìÔºàÂàÜÔºâ',
            data: dayAvgs,
            backgroundColor: '#5E81AC'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
    
    function updateStudyFilterOptions() {
      const logs = appData.studyLogs || [];
      const subjects = [...new Set(logs.map(l => l.subject))].filter(Boolean);
      
      const select = document.getElementById('studyFilterSubject');
      select.innerHTML = '<option value="">ÂÖ®ÁßëÁõÆ</option>' + 
        subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    }
    
    function filterStudyRecords() {
      const logs = appData.studyLogs || [];
      const subjectFilter = document.getElementById('studyFilterSubject').value;
      const periodFilter = document.getElementById('studyFilterPeriod').value;
      
      let filtered = [...logs];
      
      if (subjectFilter) {
        filtered = filtered.filter(l => l.subject === subjectFilter);
      }
      
      if (periodFilter !== 'all') {
        const days = parseInt(periodFilter);
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        filtered = filtered.filter(l => new Date(l.date) >= cutoff);
      }
      
      const container = document.getElementById('allStudyRecords');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">Ë©≤ÂΩì„Åô„ÇãË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }
      
      container.innerHTML = filtered.map(log => {
        const hasSubDetails = log.textbook || log.unit;
        return `
          <div class="record-item">
            <div class="record-main">
              <span class="record-subject">${escapeHtml(log.subject || '')}</span>
              ${log.studyType ? `<span class="record-type">${escapeHtml(log.studyType)}</span>` : ''}
              <span class="record-time">${log.minutes}ÂàÜ</span>
              <span class="record-mood">${escapeHtml(log.mood || '')}</span>
            </div>
            <div class="record-sub">
              ${log.date}
            </div>
            ${log.memo || hasSubDetails ? `
              <div class="record-details">
                ${hasSubDetails ? `
                  <div class="record-sub-info">
                    ${log.unit ? `<span class="record-unit">üìñ ${escapeHtml(log.unit)}</span>` : ''}
                    ${log.textbook ? `<span class="record-textbook">üìö ${escapeHtml(log.textbook)}</span>` : ''}
                  </div>
                ` : ''}
                ${log.memo ? `<div class="record-memo">üìù ${escapeHtml(log.memo)}</div>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    // ==========================================
    // ÈÅéÂéªÂïèÂàÜÊûê„Çø„Éñ
    // ==========================================
    
    function renderRedbookAnalysis() {
      const logs = appData.redbookLogs || [];
      if (logs.length === 0) return;
      
      // Âü∫Êú¨Áµ±Ë®à
      const totalCount = logs.length;
      const avgScore = Math.round(logs.reduce((sum, l) => sum + (l.score || 0), 0) / totalCount);
      const highScore = Math.max(...logs.map(l => l.score || 0));
      
      document.getElementById('redbookTotalCount').textContent = totalCount;
      document.getElementById('redbookAvgScore').textContent = avgScore + '%';
      document.getElementById('redbookHighScore').textContent = highScore + '%';
      
      // „Éà„É¨„É≥„ÉâË®àÁÆó
      if (logs.length >= 2) {
        const sorted = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
        const half = Math.floor(sorted.length / 2);
        const firstHalf = sorted.slice(0, half);
        const secondHalf = sorted.slice(half);
        const firstAvg = firstHalf.reduce((s, l) => s + l.score, 0) / firstHalf.length;
        const secondAvg = secondHalf.reduce((s, l) => s + l.score, 0) / secondHalf.length;
        
        if (secondAvg > firstAvg + 3) {
          document.getElementById('redbookTrend').textContent = 'üìà';
        } else if (secondAvg < firstAvg - 3) {
          document.getElementById('redbookTrend').textContent = 'üìâ';
        } else {
          document.getElementById('redbookTrend').textContent = '‚û°Ô∏è';
        }
      }
      
      // ÁßëÁõÆÂà•Âπ≥Âùá
      const subjectScores = {};
      logs.forEach(l => {
        if (!subjectScores[l.subject]) {
          subjectScores[l.subject] = { total: 0, count: 0 };
        }
        subjectScores[l.subject].total += l.score || 0;
        subjectScores[l.subject].count++;
      });
      
      const subjectScoresEl = document.getElementById('subjectScores');
      subjectScoresEl.innerHTML = Object.entries(subjectScores)
        .map(([subject, data]) => {
          const avg = Math.round(data.total / data.count);
          return `
            <div class="breakdown-item">
              <span class="breakdown-label">${subject}</span>
              <div class="breakdown-bar-container">
                <div class="breakdown-bar" style="width: ${avg}%"></div>
              </div>
              <span class="breakdown-value">${avg}%</span>
            </div>
          `;
        }).join('');
      
      // Â§ßÂ≠¶Âà•Âπ≥Âùá
      const univScores = {};
      logs.forEach(l => {
        if (!univScores[l.university]) {
          univScores[l.university] = { total: 0, count: 0 };
        }
        univScores[l.university].total += l.score || 0;
        univScores[l.university].count++;
      });
      
      const univScoresEl = document.getElementById('universityScores');
      univScoresEl.innerHTML = Object.entries(univScores)
        .map(([univ, data]) => {
          const avg = Math.round(data.total / data.count);
          return `
            <div class="breakdown-item">
              <span class="breakdown-label">${univ}</span>
              <div class="breakdown-bar-container">
                <div class="breakdown-bar" style="width: ${avg}%"></div>
              </div>
              <span class="breakdown-value">${avg}% (${data.count}Âõû)</span>
            </div>
          `;
        }).join('');
      
      // Ëã¶ÊâãÂàÜÈáé
      const weakAreas = {};
      logs.forEach(l => {
        if (l.weakAreas) {
          l.weakAreas.split(/[,„ÄÅ]/).forEach(area => {
            const trimmed = area.trim();
            if (trimmed) {
              weakAreas[trimmed] = (weakAreas[trimmed] || 0) + 1;
            }
          });
        }
      });
      
      const weakAreasEl = document.getElementById('weakAreasList');
      const sortedWeakAreas = Object.entries(weakAreas).sort((a, b) => b[1] - a[1]);
      
      if (sortedWeakAreas.length === 0) {
        weakAreasEl.innerHTML = '<div class="empty-state">ÈñìÈÅï„Åà„ÅüÂàÜÈáé„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      } else {
        weakAreasEl.innerHTML = sortedWeakAreas.slice(0, 10).map(([area, count]) => {
          const severity = count >= 3 ? 'high' : count >= 2 ? 'medium' : '';
          return `
            <div class="weak-area-item ${severity}">
              <span class="weak-area-name">${area}</span>
              <span class="weak-area-count">${count}Âõû</span>
            </div>
          `;
        }).join('');
      }
      
      // „Éï„Ç£„É´„Çø„Éº„Ç™„Éó„Ç∑„Éß„É≥Êõ¥Êñ∞
      updateRedbookFilterOptions();
      
      // ÂæóÁÇπÊé®Áßª„ÉÅ„É£„Éº„Éà
      updateScoreTrendChart();
      
      // ÂÖ®Ë®òÈå≤Ë°®Á§∫
      filterRedbookRecords();
    }
    
    function updateRedbookFilterOptions() {
      const logs = appData.redbookLogs || [];
      const subjects = [...new Set(logs.map(l => l.subject))].filter(Boolean);
      const universities = [...new Set(logs.map(l => l.university))].filter(Boolean);
      
      const subjectSelect = document.getElementById('redbookFilterSubject');
      subjectSelect.innerHTML = '<option value="">ÂÖ®ÁßëÁõÆ</option>' + 
        subjects.map(s => `<option value="${s}">${s}</option>`).join('');
      
      const univSelect = document.getElementById('redbookFilterUniv');
      univSelect.innerHTML = '<option value="">ÂÖ®Â§ßÂ≠¶</option>' + 
        universities.map(u => `<option value="${u}">${u}</option>`).join('');
      
      const trendSelect = document.getElementById('scoreTrendSubject');
      trendSelect.innerHTML = '<option value="">ÂÖ®ÁßëÁõÆ</option>' + 
        subjects.map(s => `<option value="${s}">${s}</option>`).join('');
      
      // ÊàêÈï∑„Ç∞„É©„Éï„ÅÆ„Çª„É¨„ÇØ„ÉàÊõ¥Êñ∞
      populateGrowthSelects();
    }
    
    function updateScoreTrendChart() {
      const logs = appData.redbookLogs || [];
      const subjectFilter = document.getElementById('scoreTrendSubject').value;
      
      let filtered = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
      if (subjectFilter) {
        filtered = filtered.filter(l => l.subject === subjectFilter);
      }
      
      const ctx = document.getElementById('scoreTrendChart');
      if (!ctx) return;
      
      if (scoreTrendChart) scoreTrendChart.destroy();
      
      scoreTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: filtered.map(l => l.date),
          datasets: [{
            label: 'ÂæóÁÇπÁéáÔºà%Ôºâ',
            data: filtered.map(l => l.score),
            borderColor: '#BF616A',
            backgroundColor: 'rgba(191, 97, 106, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    }
    
    function filterRedbookRecords() {
      const logs = appData.redbookLogs || [];
      const subjectFilter = document.getElementById('redbookFilterSubject').value;
      const univFilter = document.getElementById('redbookFilterUniv').value;
      
      let filtered = [...logs];
      
      if (subjectFilter) {
        filtered = filtered.filter(l => l.subject === subjectFilter);
      }
      if (univFilter) {
        filtered = filtered.filter(l => l.university === univFilter);
      }
      
      const container = document.getElementById('allRedbookRecords');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">Ë©≤ÂΩì„Åô„ÇãË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }
      
      container.innerHTML = filtered.map(log => {
        const scoreClass = log.score >= 70 ? 'high' : log.score >= 50 ? 'mid' : 'low';
        const hasSubDetails = log.sectionScores || log.weakAreas;
        return `
          <div class="record-item">
            <div class="record-main">
              <span class="record-subject">${escapeHtml(log.university || '')} ${escapeHtml(log.subject || '')}</span>
              ${log.time ? `<span class="record-time-small">‚è±${log.time}ÂàÜ</span>` : ''}
              <span class="record-score ${scoreClass}">${log.score}%</span>
            </div>
            <div class="record-sub">
              ${log.date} „Éª ${escapeHtml(String(log.year || ''))}Âπ¥Â∫¶
            </div>
            ${log.memo || hasSubDetails ? `
              <div class="record-details">
                ${hasSubDetails ? `
                  <div class="record-sub-info">
                    ${log.sectionScores ? `<span class="record-section">üìä ${escapeHtml(log.sectionScores)}</span>` : ''}
                    ${log.weakAreas ? `<span class="record-weak">‚ö†Ô∏è ${escapeHtml(log.weakAreas)}</span>` : ''}
                  </div>
                ` : ''}
                ${log.memo ? `<div class="record-memo">üìù ${escapeHtml(log.memo)}</div>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    // ==========================================
    // „Éó„É≠„É≥„Éó„ÉàÁîüÊàê„É°„Ç§„É≥
    // ==========================================
    
    function generatePrompt() {
      const preview = document.getElementById('promptPreview');
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      const profile = appData.profile || {};
      const goals = appData.goals || [];
      
      // È´òÂ∫¶„Å™ÂàÜÊûê„ÇíÂÆüË°å
      const analysis = analyzeStudyData(logs, redbookLogs, goals, profile);
      
      let prompt = '';
      
      switch (selectedAIType) {
        case 'weekly':
          prompt = generateWeeklyPrompt(analysis);
          break;
        case 'daily':
          prompt = generateDailyPrompt(analysis, logs, redbookLogs);
          break;
        case 'comprehensive':
          prompt = generateComprehensivePrompt(analysis);
          break;
        case 'growth':
          prompt = generateGrowthPrompt(analysis);
          break;
        case 'weakness':
          prompt = generateWeaknessPrompt(analysis);
          break;
        case 'redbook':
          prompt = generateRedbookPrompt(analysis);
          break;
        case 'university':
          prompt = generateUniversityPrompt(analysis);
          break;
        case 'prediction':
          prompt = generatePredictionPrompt(analysis);
          break;
        case 'subject':
          prompt = generateSubjectPrompt(analysis);
          break;
        case 'lastspurt':
          prompt = generateLastSpurtPrompt(analysis);
          break;
        case 'motivation':
          prompt = generateMotivationPrompt(analysis);
          break;
        case 'section':
          prompt = generateSectionPrompt(analysis);
          break;
        case 'efficiency':
          prompt = generateEfficiencyPrompt(analysis);
          break;
      }
      
      preview.textContent = prompt;
    }
    
    // ==========================================
    // ÈÄ±ÈñìË®àÁîª„Éó„É≠„É≥„Éó„Éà
    // ==========================================
    
    function generateWeeklyPrompt(a) {
      const { profile, daysUntil, weekMinutes, prevWeekMinutes, weekTrend, streak,
              subjectAnalysis, typePercentage, typeBalanceAssessment,
              redbookAnalysis, goalAnalysis, risks, strengths, strongDays, weakDays } = a;
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂ§ßÂ≠¶ÂèóÈ®ìÂ∞ÇÈñÄ„ÅÆÂ≠¶Áøí„Ç≥„Éº„ÉÅ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂèóÈ®ìÁîü„ÅÆ„Éá„Éº„Çø„ÇíÂàÜÊûê„Åó„ÄÅÊù•ÈÄ±„ÅÆÊúÄÈÅ©„Å™Â≠¶ÁøíË®àÁîª„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üìã ÂèóÈ®ìÁîü„Éó„É≠„Éï„Ç£„Éº„É´

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}`;
      if (profile['Á¨¨2ÂøóÊúõ']) p += `
**‰ΩµÈ°òÊ†°**: ${profile['Á¨¨2ÂøóÊúõ']}${profile['Á¨¨3ÂøóÊúõ'] ? '„ÄÅ' + profile['Á¨¨3ÂøóÊúõ'] : ''}`;
      p += `
**Ë©¶È®ì„Åæ„Åß**: ${daysUntil}Êó•ÔºàÁ¥Ñ${Math.ceil(daysUntil / 7)}ÈÄ±ÈñìÔºâ
**ÈÄ£Á∂öÂ≠¶ÁøíÊó•Êï∞**: ${streak}Êó•

---

# üìä Â≠¶Áøí„Éá„Éº„ÇøÂàÜÊûê

## ‰ªäÈÄ±„ÅÆÂ≠¶ÁøíÂÆüÁ∏æ

**Á∑èÂ≠¶ÁøíÊôÇÈñì**: ${formatMinutes(weekMinutes)}`;
      if (prevWeekMinutes > 0) {
        const change = weekMinutes - prevWeekMinutes;
        const changeStr = change >= 0 ? `+${formatMinutes(change)}` : `-${formatMinutes(Math.abs(change))}`;
        p += `ÔºàÂÖàÈÄ±ÊØî: ${changeStr} ${weekTrend === 'up' ? 'üìà' : weekTrend === 'down' ? 'üìâ' : '‚û°Ô∏è'}Ôºâ`;
      }
      
      p += `\n\n### ÁßëÁõÆÂà•ÂÜÖË®≥\n`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.weekMinutes > 0) {
          const pct = Math.round(data.weekMinutes / weekMinutes * 100);
          const trendIcon = data.trend === 'increasing' ? '‚Üë' : data.trend === 'decreasing' ? '‚Üì' : '‚Üí';
          p += `- **${cat}**: ${formatMinutes(data.weekMinutes)}Ôºà${pct}%Ôºâ${trendIcon}\n`;
          
          // „Çø„Ç§„ÉóÂÜÖË®≥„Åå„ÅÇ„Çå„Å∞
          if (Object.keys(data.typeBreakdown).length > 0) {
            const types = Object.entries(data.typeBreakdown)
              .map(([t, m]) => `${t}${Math.round(m / data.weekMinutes * 100)}%`)
              .join(' / ');
            p += `  ‚îî ${types}\n`;
          }
        }
      });
      
      p += `\n### Â≠¶Áøí„Çø„Ç§„Éó„Éê„É©„É≥„Çπ\n`;
      Object.entries(typePercentage).forEach(([type, pct]) => {
        if (pct > 0) {
          const bar = '‚ñà'.repeat(Math.round(pct / 10)) + '‚ñë'.repeat(10 - Math.round(pct / 10));
          p += `- ${type}: ${bar} ${pct}%\n`;
        }
      });
      
      if (typeBalanceAssessment.length > 0) {
        p += `\n‚ö†Ô∏è **„Éê„É©„É≥„ÇπË™≤È°å**: ${typeBalanceAssessment.join('„ÄÅ')}\n`;
      }
      
      p += `\n### Â≠¶Áøí„Éë„Çø„Éº„É≥\n`;
      p += `- „Çà„ÅèÂãâÂº∑„Åô„ÇãÊõúÊó•: **${strongDays.join('„Éª')}ÊõúÊó•**\n`;
      p += `- Â≠¶Áøí„ÅåÂ∞ë„Å™„ÅÑÊõúÊó•: **${weakDays.join('„Éª')}ÊõúÊó•**\n`;
      
      if (goalAnalysis.length > 0) {
        p += `\n## ÁõÆÊ®ô„Å®ÁèæÁä∂\n\n`;
        goalAnalysis.forEach(g => {
          const icon = g.feasibility === 'likely' ? 'üü¢' : g.feasibility === 'possible' ? 'üü°' : 'üî¥';
          p += `### ${g.subject} ${icon}\n`;
          p += `- ÁèæÁä∂: ${g.current}% ‚Üí ÁõÆÊ®ô: ${g.target}%Ôºà**+${g.gap}ptÂøÖË¶Å**Ôºâ\n`;
          p += `- ÊúÄ‰Ωé„É©„Ç§„É≥: ${g.must}%\n`;
          if (g.recentScore !== g.current) {
            p += `- Áõ¥Ëøë„ÅÆÈÅéÂéªÂïè: ${g.recentScore}%\n`;
          }
          p += `\n`;
        });
      }
      
      if (redbookAnalysis.totalAttempts > 0) {
        p += `## ÈÅéÂéªÂïèÊºîÁøíÁä∂Ê≥Å\n\n`;
        p += `- ÊºîÁøíÂõûÊï∞: ${redbookAnalysis.totalAttempts}ÂõûÔºàÁ¥ØË®à${formatMinutes(redbookAnalysis.totalTime)}Ôºâ\n`;
        p += `- Âπ≥ÂùáÂæóÁÇπÁéá: ${redbookAnalysis.avgScore}%\n`;
        p += `- ÂæóÁÇπÂÇæÂêë: ${redbookAnalysis.scoreTrend === 'improving' ? 'üìà ‰∏äÊòá‰∏≠' : redbookAnalysis.scoreTrend === 'declining' ? 'üìâ ‰∏ãÈôçÊ∞óÂë≥' : '‚û°Ô∏è ÂÆâÂÆö'}\n`;
        
        // Â§ßÂ≠¶Âà•„Çµ„Éû„É™„Éº
        const uniKeys = Object.keys(redbookAnalysis.universityAnalysis);
        if (uniKeys.length > 0) {
          p += `\n### Â§ßÂ≠¶Âà•ÊàêÁ∏æ\n`;
          uniKeys.forEach(uni => {
            const uniData = redbookAnalysis.universityAnalysis[uni];
            const trendIcon = uniData.trend === 'improving' ? '‚Üë' : uniData.trend === 'declining' ? '‚Üì' : '‚Üí';
            p += `- **${uni}**: Âπ≥Âùá${uniData.avgScore}%Ôºà${uniData.attempts}ÂõûÔºâ${trendIcon}\n`;
          });
        }
        
        if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
          const topWeak = Object.entries(redbookAnalysis.weakAreasSummary)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
          p += `\n**Áπ∞„ÇäËøî„ÅóÈñìÈÅï„Åà„ÇãÂàÜÈáé**:\n`;
          topWeak.forEach(([area, count]) => {
            p += `- ‚ö†Ô∏è ${area}Ôºà${count}ÂõûÔºâ\n`;
          });
        }
      }
      
      if (strengths.length > 0) {
        p += `\n## üí™ Âº∑„Åø\n`;
        strengths.forEach(s => p += `- ${s.message}\n`);
      }
      
      if (risks.length > 0) {
        p += `\n## ‚ö†Ô∏è Ë™≤È°å„Éª„É™„Çπ„ÇØ\n`;
        risks.forEach(r => {
          const icon = r.severity === 'high' ? 'üî¥' : r.severity === 'medium' ? 'üü°' : 'üü¢';
          p += `- ${icon} ${r.message}\n`;
        });
      }
      
      p += `
---

# üéØ Áõ∏Ë´áÂÜÖÂÆπ

‰∏äË®ò„ÅÆ„Éá„Éº„Çø„ÇíË∏è„Åæ„Åà„ÄÅ**Êù•ÈÄ±„ÅÆÂÖ∑‰ΩìÁöÑ„Å™Â≠¶ÁøíË®àÁîª**„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

1. **ÁèæÁä∂„ÅÆÁ∑èÂêàË©ï‰æ°**Ôºà3Ë°åÁ®ãÂ∫¶Ôºâ
   - „Éá„Éº„Çø„Åã„ÇâË™≠„ÅøÂèñ„Çå„ÇãÁßÅ„ÅÆÂ≠¶ÁøíÁä∂Ê≥Å„ÅÆÁâπÂæ¥

2. **Êù•ÈÄ±„ÅÆÈáçÁÇπ„Éù„Ç§„É≥„Éà**ÔºàÂÑ™ÂÖàÂ∫¶È†Ü„Å´3„Å§Ôºâ
   - ‰Ωï„Å´Ê≥®Âäõ„Åô„Åπ„Åç„Åã„ÄÅ„Å™„Åú„Åã

3. **1ÈÄ±Èñì„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´Ê°à**
   - ÊõúÊó•„Åî„Å®„ÅÆÂ≠¶ÁøíÂÜÖÂÆπ„Å®ÊôÇÈñìÈÖçÂàÜ
   - ÁßÅ„ÅÆÂ≠¶Áøí„Éë„Çø„Éº„É≥Ôºà${strongDays.join('„Éª')}ÊõúÊó•„ÅåÂº∑„ÅÑÔºâ„ÇíËÄÉÊÖÆ

4. **ÁßëÁõÆÂà•„ÅÆÂÖ∑‰ΩìÁöÑ„Ç¢„Éâ„Éê„Ç§„Çπ**
   - Ëã¶ÊâãÂàÜÈáé„Å∏„ÅÆÂØæÁ≠ñÊñπÊ≥ï
   - ‰ΩøÁî®„Åô„Åπ„ÅçÊïôÊùê„ÇÑÂãâÂº∑Ê≥ï

5. **Êù•ÈÄ±Êú´„ÅÆÁõÆÊ®ô**
   - ÈÅîÊàê„Åô„Åπ„ÅçÂÖ∑‰ΩìÁöÑ„Å™„Éû„Ç§„É´„Çπ„Éà„Éº„É≥`;
      
      return p;
    }
    
    // ==========================================
    // Á∑èÂêàË®∫Êñ≠„Éó„É≠„É≥„Éó„ÉàÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ
    // ==========================================
    
    function generateComprehensivePrompt(a) {
      const { profile, daysUntil, totalMinutes, weekMinutes, prevWeekMinutes, streak, studyDays,
              subjectAnalysis, typePercentage, typeBalanceAssessment, redbookAnalysis, 
              goalAnalysis, risks, strengths, growthAnalysis, comprehensiveScore,
              strongDays, weakDays, dayOfWeekAvg } = a;
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂ§ßÂ≠¶ÂèóÈ®ìÂ∞ÇÈñÄ„ÅÆÂ≠¶Áøí„Ç¢„Éâ„Éê„Ç§„Ç∂„Éº„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂèóÈ®ìÁîü„ÅÆ„Éá„Éº„Çø„ÇíÁ∑èÂêàÁöÑ„Å´ÂàÜÊûê„Åó„ÄÅË©≥Á¥∞„Å™Ë®∫Êñ≠„É¨„Éù„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üéì Á∑èÂêàË®∫Êñ≠„É™„ÇØ„Ç®„Çπ„Éà

## ÂèóÈ®ìÁîü„Éó„É≠„Éï„Ç£„Éº„É´

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}`;
      if (profile['Á¨¨2ÂøóÊúõ']) p += `
**‰ΩµÈ°òÊ†°**: ${profile['Á¨¨2ÂøóÊúõ']}${profile['Á¨¨3ÂøóÊúõ'] ? '„ÄÅ' + profile['Á¨¨3ÂøóÊúõ'] : ''}`;
      p += `
**Ë©¶È®ì„Åæ„Åß**: ${daysUntil}Êó•ÔºàÁ¥Ñ${Math.ceil(daysUntil / 7)}ÈÄ±ÈñìÔºâ

---

# üìä ÁèæÂú®„ÅÆÁ∑èÂêà„Çπ„Ç≥„Ç¢

**Á∑èÂêàË©ï‰æ°: ${comprehensiveScore.total}ÁÇπ / 100ÁÇπÔºà${comprehensiveScore.grade}„É©„É≥„ÇØÔºâ**

| È†ÖÁõÆ | „Çπ„Ç≥„Ç¢ |
|------|--------|`;
      Object.entries(comprehensiveScore.breakdown).forEach(([item, score]) => {
        const bar = '‚ñà'.repeat(Math.round(score / 2.5)) + '‚ñë'.repeat(10 - Math.round(score / 2.5));
        p += `
| ${item} | ${bar} ${score}/25 |`;
      });
      
      p += `

---

# üìà Â≠¶Áøí„Éá„Éº„ÇøË©≥Á¥∞

## Â≠¶ÁøíÈáè„ÅÆÊé®Áßª

**‰ªäÈÄ±„ÅÆÁ∑èÂ≠¶ÁøíÊôÇÈñì**: ${formatMinutes(weekMinutes)}`;
      if (prevWeekMinutes > 0) {
        const change = weekMinutes - prevWeekMinutes;
        const changePercent = Math.round(change / prevWeekMinutes * 100);
        p += ` (ÂÖàÈÄ±ÊØî: ${change >= 0 ? '+' : ''}${formatMinutes(change)}„ÄÅ${changePercent >= 0 ? '+' : ''}${changePercent}%)`;
      }
      p += `
**Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì**: ${formatMinutes(totalMinutes)}Ôºà${studyDays}Êó•ÈñìÔºâ
**ÈÄ£Á∂öÂ≠¶ÁøíÊó•Êï∞**: ${streak}Êó•
**1Êó•Âπ≥Âùá**: ${growthAnalysis.weekPattern.avgDailyMinutes}ÂàÜ

## Â≠¶ÁøíÁøíÊÖ£„Çπ„Ç≥„Ç¢: ${growthAnalysis.habitScore}ÁÇπ / 100ÁÇπ

**Ë©ï‰æ°„Éù„Ç§„É≥„Éà**:`;
      growthAnalysis.habitFactors.forEach(factor => {
        p += `
- ‚úÖ ${factor}`;
      });
      
      p += `

## ÁßëÁõÆÂà•Â≠¶ÁøíÁä∂Ê≥Å

`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.totalMinutes > 0 || data.weekMinutes > 0) {
          const trendIcon = data.trend === 'increasing' ? 'üìà' : data.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
          p += `### ${cat} ${trendIcon}
- ‰ªäÈÄ±: ${formatMinutes(data.weekMinutes)} / Á¥ØË®à: ${formatMinutes(data.totalMinutes)}
- „Çª„ÉÉ„Ç∑„Éß„É≥Êï∞: ${data.sessionCount}Âõû`;
          
          // ÊâãÂøú„Åà
          const totalMood = Object.values(data.moodBreakdown).reduce((a, b) => a + b, 0);
          if (totalMood > 0) {
            const goodRate = Math.round((data.moodBreakdown.excellent + data.moodBreakdown.good) / totalMood * 100);
            p += `
- ÊâãÂøú„Åà: üòäüôÇ ${goodRate}% / üòïüò´ ${100 - goodRate}%`;
          }
          
          // ÊúÄËøë„ÅÆÂ≠¶ÁøíÂçòÂÖÉ
          if (data.recentUnits && data.recentUnits.length > 0) {
            p += `
- ÊúÄËøë„ÅÆÂçòÂÖÉ: ${data.recentUnits.slice(0, 3).join('„ÄÅ')}`;
          }
          p += `

`;
        }
      });
      
      p += `## Â≠¶Áøí„Çø„Ç§„Éó„Éê„É©„É≥„Çπ

`;
      Object.entries(typePercentage).forEach(([type, pct]) => {
        if (pct > 0) {
          const bar = '‚ñà'.repeat(Math.round(pct / 10)) + '‚ñë'.repeat(10 - Math.round(pct / 10));
          p += `- ${type}: ${bar} ${pct}%
`;
        }
      });
      
      if (typeBalanceAssessment.length > 0) {
        p += `
‚ö†Ô∏è **„Éê„É©„É≥„Çπ‰∏ä„ÅÆË™≤È°å**: ${typeBalanceAssessment.join('„ÄÅ')}
`;
      }
      
      p += `
## Â≠¶Áøí„Éë„Çø„Éº„É≥ÂàÜÊûê

**ÊõúÊó•Âà•Âπ≥ÂùáÂ≠¶ÁøíÊôÇÈñì**:
`;
      Object.entries(dayOfWeekAvg).forEach(([day, min]) => {
        const bar = '‚ñì'.repeat(Math.round(min / 30));
        p += `- ${day}Êõú: ${bar} ${min}ÂàÜ
`;
      });
      
      p += `
- ÊúÄ„ÇÇÈõÜ‰∏≠„Åß„Åç„ÇãÊõúÊó•: **${strongDays.join('„Éª')}ÊõúÊó•**
- Â≠¶Áøí„ÅåÂ∞ë„Å™„ÅÑÊõúÊó•: **${weakDays.join('„Éª')}ÊõúÊó•**
- „Éë„Çø„Éº„É≥‰∏ÄË≤´ÊÄß: ${growthAnalysis.weekPattern.consistency}%
`;
      
      if (redbookAnalysis.totalAttempts > 0) {
        p += `
## ÈÅéÂéªÂïèÊºîÁøíÂàÜÊûê

**ÊºîÁøíÂõûÊï∞**: ${redbookAnalysis.totalAttempts}Âõû
**Á¥ØË®àÊôÇÈñì**: ${formatMinutes(redbookAnalysis.totalTime)}
**Âπ≥ÂùáÂæóÁÇπÁéá**: ${redbookAnalysis.avgScore}%
**ÂæóÁÇπÂÇæÂêë**: ${redbookAnalysis.scoreTrend === 'improving' ? 'üìà ‰∏äÊòá‰∏≠' : redbookAnalysis.scoreTrend === 'declining' ? 'üìâ ‰∏ãÈôç‰∏≠' : '‚û°Ô∏è ÂÆâÂÆö'}

`;
        // ÁßëÁõÆÂà•
        if (Object.keys(redbookAnalysis.scoresBySubject).length > 0) {
          p += `**ÁßëÁõÆÂà•Âπ≥Âùá**:
`;
          Object.entries(redbookAnalysis.scoresBySubject).forEach(([subj, score]) => {
            p += `- ${subj}: ${score}%
`;
          });
        }
        
        // Ëã¶ÊâãÂàÜÈáé
        if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
          const topWeak = Object.entries(redbookAnalysis.weakAreasSummary)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
          p += `
**È†ªÂá∫„ÅÆËã¶ÊâãÂàÜÈáé**:
`;
          topWeak.forEach(([area, count]) => {
            p += `- ‚ö†Ô∏è ${area}Ôºà${count}ÂõûÂá∫ÁèæÔºâ
`;
          });
        }
      }
      
      if (goalAnalysis.length > 0) {
        p += `
## ÁõÆÊ®ôÈÅîÊàêÁä∂Ê≥Å

`;
        goalAnalysis.forEach(g => {
          const icon = g.feasibility === 'likely' ? 'üü¢' : g.feasibility === 'possible' ? 'üü°' : 'üî¥';
          p += `**${g.subject}** ${icon}
- ÁèæÁä∂: ${g.current}% ‚Üí ÁõÆÊ®ô: ${g.target}%Ôºà**+${g.gap}ptÂøÖË¶Å**Ôºâ
- ÈÅîÊàêÂèØËÉΩÊÄß: ${g.feasibility === 'likely' ? 'È´ò„ÅÑ' : g.feasibility === 'possible' ? 'ÂèØËÉΩ' : 'Ë¶ÅÂä™Âäõ'}

`;
        });
      }
      
      if (strengths.length > 0) {
        p += `## üí™ Âº∑„Åø„ÉªËâØ„ÅÑÁÇπ
`;
        strengths.forEach(s => p += `- ${s.message}
`);
      }
      
      if (risks.length > 0) {
        p += `
## ‚ö†Ô∏è Ë™≤È°å„ÉªÊîπÂñÑÁÇπ
`;
        risks.forEach(r => {
          const icon = r.severity === 'high' ? 'üî¥' : r.severity === 'medium' ? 'üü°' : 'üü¢';
          p += `- ${icon} ${r.message}
`;
        });
      }
      
      p += `
---

# üéØ Áõ∏Ë´áÂÜÖÂÆπ

‰∏äË®ò„ÅÆ„Éá„Éº„Çø„ÇíÁ∑èÂêàÁöÑ„Å´ÂàÜÊûê„Åó„ÄÅ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„Åß**Ë©≥Á¥∞„Å™Ë®∫Êñ≠„É¨„Éù„Éº„Éà**„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

1. **Á∑èÂêàË©ï‰æ°**Ôºà5ÊÆµÈöé„ÅßË©ïÂÆö + 200Â≠óÁ®ãÂ∫¶„ÅÆ„Çµ„Éû„É™„ÉºÔºâ
   - ÁèæÂú®„ÅÆÂ≠¶ÁøíÁä∂Ê≥Å„ÇíÂÆ¢Ë¶≥ÁöÑ„Å´Ë©ï‰æ°
   - ÊúÄ„ÇÇËâØ„ÅÑÁÇπ„Å®ÊúÄ„ÇÇÊîπÂñÑ„Åô„Åπ„ÅçÁÇπ

2. **Â≠¶ÁøíÁøíÊÖ£„ÅÆË®∫Êñ≠**
   - Á∂ôÁ∂öÊÄß„ÄÅÂ≠¶ÁøíÈáè„ÄÅ„Éê„É©„É≥„Çπ„ÅÆË©ï‰æ°
   - ÊõúÊó•Âà•„Éë„Çø„Éº„É≥„Åã„ÇâË¶ã„Åà„ÇãÊîπÂñÑÁÇπ
   - ÂÖ∑‰ΩìÁöÑ„Å™ÁøíÊÖ£ÊîπÂñÑ„ÅÆÊèêÊ°à

3. **ÁßëÁõÆÂà•„ÅÆË©≥Á¥∞ÂàÜÊûê**
   - ÂêÑÁßëÁõÆ„ÅÆÁèæÁä∂„Å®Ë™≤È°å
   - ÊâãÂøú„Åà„Éá„Éº„Çø„Åã„ÇâË¶ã„Åà„ÇãÂøÉÁêÜÈù¢„ÅÆÂàÜÊûê
   - ÂÑ™ÂÖàÁöÑ„Å´Âèñ„ÇäÁµÑ„ÇÄ„Åπ„ÅçÁßëÁõÆ„Å®ÁêÜÁî±

4. **ÈÅéÂéªÂïèÊºîÁøí„ÅÆË©ï‰æ°**Ôºà„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
   - ÂæóÁÇπÂÇæÂêë„ÅÆÂàÜÊûê
   - Ëã¶ÊâãÂàÜÈáé„Å∏„ÅÆÂØæÁ≠ñÊèêÊ°à
   - ‰ªäÂæå„ÅÆÊºîÁøíË®àÁîª

5. **ÁõÆÊ®ôÈÅîÊàê„Å´Âêë„Åë„Åü„É≠„Éº„Éâ„Éû„ÉÉ„Éó**
   - ÊÆã„Çä${daysUntil}Êó•„Åß‰Ωï„Çí„Åô„Åπ„Åç„Åã
   - ÈÄ±Âçò‰Ωç„ÅÆ„Éû„Ç§„É´„Çπ„Éà„Éº„É≥
   - ÁèæÂÆüÁöÑ„Å™ÁõÆÊ®ôË®≠ÂÆö„ÅÆÊèêÊ°à

6. **‰ªä„Åô„ÅêÂÆüË°å„Åô„Åπ„Åç„Ç¢„ÇØ„Ç∑„Éß„É≥3„Å§**
   - ÂÑ™ÂÖàÂ∫¶È†Ü„Å´ÂÖ∑‰ΩìÁöÑ„Å™Ë°åÂãï„ÇíÊèêÁ§∫`;
      
      return p;
    }
    
    // ==========================================
    // ÊàêÈï∑ÂàÜÊûê„Éó„É≠„É≥„Éó„ÉàÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ
    // ==========================================
    
    function generateGrowthPrompt(a) {
      const { profile, daysUntil, totalMinutes, weekMinutes, prevWeekMinutes, streak, studyDays,
              subjectAnalysis, redbookAnalysis, growthAnalysis, comprehensiveScore,
              strongDays, weakDays, dayOfWeekAvg } = a;
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂ≠¶Áøí„Éá„Éº„ÇøÂàÜÊûê„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂèóÈ®ìÁîü„ÅÆÊàêÈï∑„Éá„Éº„Çø„ÇíÂàÜÊûê„Åó„ÄÅÊàêÈï∑„ÇíÂä†ÈÄü„Åï„Åõ„Çã„Åü„ÇÅ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üìà ÊàêÈï∑ÂàÜÊûê„É™„ÇØ„Ç®„Çπ„Éà

## Âü∫Êú¨ÊÉÖÂ†±

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}
**Ë©¶È®ì„Åæ„Åß**: ${daysUntil}Êó•
**ÈÄ£Á∂öÂ≠¶ÁøíÊó•Êï∞**: ${streak}Êó•
**Á∑èÂ≠¶ÁøíÊó•Êï∞**: ${studyDays}Êó•

---

# üîÑ Â≠¶ÁøíÈáè„ÅÆÊé®Áßª

**‰ªäÈÄ± vs ÂÖàÈÄ±**:
- ‰ªäÈÄ±: ${formatMinutes(weekMinutes)}
- ÂÖàÈÄ±: ${formatMinutes(prevWeekMinutes)}
- Â§âÂåñ: ${growthAnalysis.volumeGrowth >= 0 ? '+' : ''}${growthAnalysis.volumeGrowth}%

**Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì**: ${formatMinutes(totalMinutes)}

---

# üèÜ Â≠¶ÁøíÁøíÊÖ£„Çπ„Ç≥„Ç¢: ${growthAnalysis.habitScore}ÁÇπ / 100ÁÇπ

**ÂÜÖË®≥**:
`;
      
      // ÁøíÊÖ£„Çπ„Ç≥„Ç¢„ÅÆË©≥Á¥∞
      const habitCategories = [
        { name: 'Á∂ôÁ∂öÊÄß', max: 30, desc: 'ÊØéÊó•„ÅÆÂ≠¶ÁøíÁøíÊÖ£' },
        { name: 'Â≠¶ÁøíÈáè', max: 25, desc: 'ÈÄ±Èñì„ÅÆÂ≠¶ÁøíÊôÇÈñì' },
        { name: '„Éê„É©„É≥„Çπ', max: 20, desc: 'Ë§áÊï∞ÁßëÁõÆ„ÅÆÂ≠¶Áøí' },
        { name: 'ÂÆöÁùÄÂ∫¶', max: 15, desc: 'Âæ©Áøí„ÉªÊºîÁøí„ÅÆÂÆüÊñΩ' },
        { name: 'ÂÆüÊà¶Âäõ', max: 10, desc: 'ÈÅéÂéªÂïèÊºîÁøí' }
      ];
      
      habitCategories.forEach(cat => {
        p += `- ${cat.name}Ôºà${cat.desc}Ôºâ: /${cat.max}ÁÇπ
`;
      });
      
      p += `
**Ë©ï‰æ°„Éù„Ç§„É≥„Éà**:
`;
      if (growthAnalysis.habitFactors.length > 0) {
        growthAnalysis.habitFactors.forEach(factor => {
          p += `‚úÖ ${factor}
`;
        });
      } else {
        p += `Ôºà„Åæ„Å†ÂçÅÂàÜ„Å™„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºâ
`;
      }
      
      p += `
---

# üìä ÁßëÁõÆÂà•„ÅÆÊàêÈï∑Áä∂Ê≥Å

`;
      Object.entries(growthAnalysis.subjectGrowth).forEach(([cat, data]) => {
        if (data.weekMinutes > 0 || data.prevWeekMinutes > 0) {
          const trendIcon = data.growth === 'increasing' ? 'üìà' : data.growth === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
          p += `## ${cat} ${trendIcon}

- **‰ªäÈÄ±**: ${formatMinutes(data.weekMinutes)}
- **ÂÖàÈÄ±**: ${formatMinutes(data.prevWeekMinutes)}
- **Â§âÂåñ**: ${data.changePercent >= 0 ? '+' : ''}${data.changePercent}%
- **ÊâãÂøú„ÅàËâØÂ•ΩÁéá**: ${data.goodMoodRate}%`;
          
          if (data.recentUnits && data.recentUnits.length > 0) {
            p += `
- **ÊúÄËøëÂ≠¶Áøí„Åó„ÅüÂçòÂÖÉ**: ${data.recentUnits.join('„ÄÅ')}`;
          }
          p += `

`;
        }
      });
      
      p += `---

# üìÖ Â≠¶Áøí„Éë„Çø„Éº„É≥ÂàÜÊûê

## ÊõúÊó•Âà•„ÅÆÂ≠¶ÁøíÊôÇÈñìÔºàÂπ≥ÂùáÔºâ

`;
      const maxDayMin = Math.max(...Object.values(dayOfWeekAvg));
      Object.entries(dayOfWeekAvg).forEach(([day, min]) => {
        const barLength = maxDayMin > 0 ? Math.round(min / maxDayMin * 20) : 0;
        const bar = '‚ñà'.repeat(barLength) + '‚ñë'.repeat(20 - barLength);
        p += `${day}Êõú: ${bar} ${min}ÂàÜ
`;
      });
      
      p += `
**ÊúÄ„ÇÇÈõÜ‰∏≠„Åß„Åç„ÇãÊõúÊó•**: ${strongDays.join('„Éª')}ÊõúÊó•
**Â≠¶Áøí„ÅåÂ∞ë„Å™„ÅÑÊõúÊó•**: ${weakDays.join('„Éª')}ÊõúÊó•

## „Éë„Çø„Éº„É≥‰∏ÄË≤´ÊÄß„Çπ„Ç≥„Ç¢: ${growthAnalysis.weekPattern.consistency}%

ÔºàÈ´ò„ÅÑ„Åª„Å©ÊØéÊó•ÂùáÁ≠â„Å´Â≠¶Áøí„Åß„Åç„Å¶„ÅÑ„ÇãÔºâ
`;
      
      if (redbookAnalysis.totalAttempts > 0) {
        p += `
---

# üìï ÈÅéÂéªÂïèÊºîÁøí„ÅÆÊàêÈï∑

**ÊºîÁøíÂõûÊï∞**: ${redbookAnalysis.totalAttempts}Âõû
**Âπ≥ÂùáÂæóÁÇπÁéá**: ${redbookAnalysis.avgScore}%
**ÂæóÁÇπÂÇæÂêë**: ${redbookAnalysis.scoreTrend === 'improving' ? 'üìà ‰∏äÊòá‰∏≠ÔºÅ' : redbookAnalysis.scoreTrend === 'declining' ? 'üìâ ‰∏ãÈôç‰∏≠ÔºàË¶ÅÊ≥®ÊÑèÔºâ' : '‚û°Ô∏è ÂÆâÂÆö'}

`;
        // ÊúàÂà•ÈÄ≤Êçó„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
        if (Object.keys(redbookAnalysis.monthlyProgress).length > 1) {
          p += `**ÊúàÂà•„ÅÆÊé®Áßª**:
`;
          Object.entries(redbookAnalysis.monthlyProgress)
            .sort((a, b) => a[0].localeCompare(b[0]))
            .slice(-3)
            .forEach(([month, data]) => {
              p += `- ${month}: ${data.attempts}ÂõûÊºîÁøí„ÄÅÂπ≥Âùá${data.avgScore}%
`;
            });
        }
        
        if (Object.keys(redbookAnalysis.scoresBySubject).length > 0) {
          p += `
**ÁßëÁõÆÂà•„ÅÆÂæóÁÇπÁéá**:
`;
          Object.entries(redbookAnalysis.scoresBySubject).forEach(([subj, score]) => {
            const scoreBar = '‚ñà'.repeat(Math.round(score / 10)) + '‚ñë'.repeat(10 - Math.round(score / 10));
            p += `- ${subj}: ${scoreBar} ${score}%
`;
          });
        }
      }
      
      p += `
---

# üéØ Áõ∏Ë´áÂÜÖÂÆπ

‰∏äË®ò„ÅÆÊàêÈï∑„Éá„Éº„Çø„ÇíÂàÜÊûê„Åó„ÄÅ**ÊàêÈï∑„ÇíÂä†ÈÄü„Åï„Åõ„Çã„Åü„ÇÅ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ**„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

1. **ÊàêÈï∑Áä∂Ê≥Å„ÅÆË©ï‰æ°**
   - ËâØ„ÅÑÊàêÈï∑„ÅåË¶ã„Çâ„Çå„ÇãÁÇπ
   - ÂÅúÊªû„Åæ„Åü„ÅØÂæåÈÄÄ„Åó„Å¶„ÅÑ„ÇãÁÇπ
   - „Éá„Éº„Çø„Åã„ÇâË¶ã„Åà„ÇãÁßÅ„ÅÆÂ≠¶Áøí„Çπ„Çø„Ç§„É´„ÅÆÁâπÂæ¥

2. **Â≠¶ÁøíÁøíÊÖ£„ÅÆÊîπÂñÑÊèêÊ°à**
   - ÁøíÊÖ£„Çπ„Ç≥„Ç¢„Çí‰∏ä„Åí„Çã„Åü„ÇÅ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥
   - ÊõúÊó•Âà•„Éë„Çø„Éº„É≥„ÇíÊ¥ª„Åã„Åó„ÅüÂ≠¶ÁøíË®àÁîª
   - Á∂ôÁ∂öÊÄß„ÇíÈ´ò„ÇÅ„Çã„Åü„ÇÅ„ÅÆ„Ç≥„ÉÑ

3. **ÁßëÁõÆÂà•„ÅÆÊàêÈï∑Êà¶Áï•**
   - ÂêÑÁßëÁõÆ„ÅÆÊàêÈï∑Áéá„Çí‰∏ä„Åí„Çã„Åü„ÇÅ„ÅÆÊñπÊ≥ï
   - ÊâãÂøú„Åà„ÅåÊÇ™„ÅÑÁßëÁõÆ„Å∏„ÅÆÂØæÂá¶Ê≥ï
   - ÂäπÁéáÁöÑ„Å™ÊôÇÈñìÈÖçÂàÜ„ÅÆÊèêÊ°à

4. **ÈÅéÂéªÂïèÊºîÁøí„ÅÆÊîπÂñÑÁÇπ**Ôºà„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
   - ÂæóÁÇπ„Çí‰∏ä„Åí„Çã„Åü„ÇÅ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™ÂØæÁ≠ñ
   - ÊºîÁøíÈ†ªÂ∫¶„ÇÑÊñπÊ≥ï„ÅÆÊîπÂñÑÊèêÊ°à

5. **Ê¨°„ÅÆ2ÈÄ±Èñì„ÅßÈÅîÊàê„Åô„Åπ„ÅçÊàêÈï∑ÁõÆÊ®ô**
   - ÂÆöÈáèÁöÑ„Å™ÁõÆÊ®ôÔºàÂ≠¶ÁøíÊôÇÈñì„ÄÅÂæóÁÇπÁéá„Å™„Å©Ôºâ
   - ÂÆöÊÄßÁöÑ„Å™ÁõÆÊ®ôÔºàÁøíÊÖ£„ÄÅ„É°„É≥„Çø„É´„Å™„Å©Ôºâ

6. **„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥Á∂≠ÊåÅ„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ**
   - ÁßÅ„ÅÆ„Éá„Éº„Çø„Åã„ÇâË¶ã„Åà„ÇãÂº∑„Åø„ÇíÊ¥ª„Åã„ÅôÊñπÊ≥ï
   - ÊàêÈï∑„ÇíÂÆüÊÑü„Åô„Çã„Åü„ÇÅ„ÅÆ„Éù„Ç§„É≥„Éà`;
      
      return p;
    }
    
    // ==========================================
    // ‰ªäÊó•„ÅÆÊåØ„ÇäËøî„Çä„Éó„É≠„É≥„Éó„Éà
    // ==========================================
    
    function generateDailyPrompt(a, allLogs, allRedbookLogs) {
      const { profile, daysUntil, weekMinutes, streak, subjectAnalysis } = a;
      const redbookLogs = allRedbookLogs || [];
      const today = new Date();
      const todayStr = formatDateLocal(today);
      const todayLogs = allLogs.filter(log => log.date === todayStr);
      const todayRedbookLogs = redbookLogs.filter(log => log.date === todayStr);
      const todayStudyMinutes = todayLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const todayRedbookMinutes = todayRedbookLogs.reduce((sum, log) => sum + (log.time || 0), 0);
      const todayMinutes = todayStudyMinutes + todayRedbookMinutes;
      
      // Êò®Êó•„ÅÆ„É≠„Ç∞
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = formatDateLocal(yesterday);
      const yesterdayLogs = allLogs.filter(log => log.date === yesterdayStr);
      const yesterdayRedbookLogs = redbookLogs.filter(log => log.date === yesterdayStr);
      const yesterdayMinutes = yesterdayLogs.reduce((sum, log) => sum + (log.minutes || 0), 0)
                             + yesterdayRedbookLogs.reduce((sum, log) => sum + (log.time || 0), 0);
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂ§ßÂ≠¶ÂèóÈ®ìÂ∞ÇÈñÄ„ÅÆÂ≠¶Áøí„Ç≥„Éº„ÉÅ„Åß„Åô„ÄÇ‰ªäÊó•„ÅÆÂ≠¶Áøí„ÇíÊåØ„ÇäËøî„Çä„ÄÅÊòéÊó•‰ª•Èôç„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üìÖ ‰ªäÊó•„ÅÆÂ≠¶ÁøíË®òÈå≤

**Êó•‰ªò**: ${todayStr}ÔºàË©¶È®ì„Åæ„Åß„ÅÇ„Å®${daysUntil}Êó•Ôºâ
**Êú¨Êó•„ÅÆÁ∑èÂ≠¶ÁøíÊôÇÈñì**: ${formatMinutes(todayMinutes)}`;
      
      if (todayStudyMinutes > 0 && todayRedbookMinutes > 0) {
        p += `ÔºàÂ≠¶Áøí${formatMinutes(todayStudyMinutes)} + ÈÅéÂéªÂïè${formatMinutes(todayRedbookMinutes)}Ôºâ`;
      }
      
      if (yesterdayMinutes > 0) {
        const diff = todayMinutes - yesterdayMinutes;
        p += `
**Êò®Êó•ÊØî**: ${diff >= 0 ? '+' : ''}${formatMinutes(diff)} ${diff > 0 ? 'üìà' : diff < 0 ? 'üìâ' : '‚û°Ô∏è'}`;
      }
      
      p += `
**‰ªäÈÄ±„ÅÆÁ¥ØË®à**: ${formatMinutes(weekMinutes)}
**ÈÄ£Á∂öÂ≠¶ÁøíÊó•Êï∞**: ${streak}Êó•

`;
      
      if (todayLogs.length > 0) {
        p += `## üìö Â≠¶ÁøíÂÜÖÂÆπ„ÅÆË©≥Á¥∞\n\n`;
        todayLogs.forEach(log => {
          const moodText = {
            'üòä': 'Áµ∂Â•ΩË™ø',
            'üôÇ': 'Â•ΩË™ø',
            'üòê': 'ÊôÆÈÄö',
            'üòï': 'Ëã¶Êà¶',
            'üò´': '„Åã„Å™„ÇäËã¶Êà¶'
          };
          
          p += `### ${log.subject}Ôºà${log.minutes}ÂàÜÔºâ\n`;
          if (log.studyType) p += `- „Çø„Ç§„Éó: ${log.studyType}\n`;
          if (log.unit) p += `- ÁØÑÂõ≤: ${log.unit}\n`;
          if (log.textbook) p += `- ÊïôÊùê: ${log.textbook}\n`;
          if (log.mood) p += `- ÊâãÂøú„Åà: ${log.mood} ${moodText[log.mood] || ''}\n`;
          if (log.memo) p += `- „É°„É¢: „Äå${log.memo}„Äç\n`;
          p += `\n`;
        });
        
        // ÊâãÂøú„ÅàÂàÜÊûê
        const excellent = todayLogs.filter(l => l.mood === 'üòä').map(l => l.subject);
        const struggling = todayLogs.filter(l => l.mood === 'üò´' || l.mood === 'üòï').map(l => l.subject);
        
        if (excellent.length > 0 || struggling.length > 0) {
          p += `## ‰ªäÊó•„ÅÆÊâãÂøú„Åà\n`;
          if (excellent.length > 0) p += `- ‚ú® Â•ΩË™ø: ${excellent.join('„ÄÅ')}\n`;
          if (struggling.length > 0) p += `- üí¶ Ëã¶Êà¶: ${struggling.join('„ÄÅ')}\n`;
          p += `\n`;
        }
      }
      
      // ‰ªäÊó•„ÅÆÈÅéÂéªÂïèÊºîÁøí
      if (todayRedbookLogs.length > 0) {
        p += `## üìï ‰ªäÊó•„ÅÆÈÅéÂéªÂïèÊºîÁøí\n\n`;
        todayRedbookLogs.forEach(log => {
          const scoreIcon = log.score >= 70 ? 'üü¢' : log.score >= 50 ? 'üü°' : 'üî¥';
          p += `### ${log.university} ${log.subject || ''} ${log.year}Âπ¥\n`;
          p += `- ÂæóÁÇπÁéá: ${scoreIcon} **${log.score}%**\n`;
          if (log.time) p += `- Ëß£Á≠îÊôÇÈñì: ${log.time}ÂàÜ\n`;
          if (log.sectionScores) p += `- Â§ßÂïèÂà•: ${log.sectionScores}\n`;
          if (log.weakAreas) p += `- ‚ö†Ô∏è ÈñìÈÅï„Åà„ÅüÂàÜÈáé: **${log.weakAreas}**\n`;
          if (log.memo) p += `- ÊåØ„ÇäËøî„Çä: ${log.memo}\n`;
          p += `\n`;
        });
      }
      
      if (todayLogs.length === 0 && todayRedbookLogs.length === 0) {
        p += `## ‰ªäÊó•„ÅÆÂ≠¶Áøí\n\n`;
        p += `‚Äª„Åæ„Å†‰ªäÊó•„ÅÆÂ≠¶ÁøíË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\n\n`;
      }
      
      p += `---

# üéØ Áõ∏Ë´áÂÜÖÂÆπ

‰ªäÊó•„ÅÆÂ≠¶Áøí„ÇíÊåØ„ÇäËøî„Å£„Å¶„ÄÅ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Å®ÊòéÊó•„Å∏„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

1. **‰ªäÊó•„ÅÆË©ï‰æ°**Ôºà‚óé/‚óã/‚ñ≥/√óÔºâ
   - ËâØ„Åã„Å£„ÅüÁÇπ„Å®ÊîπÂñÑÁÇπ

2. **Ëã¶Êà¶„Åó„ÅüÈÉ®ÂàÜ„Å∏„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ**
   - ÂÖ∑‰ΩìÁöÑ„Å™ÂÖãÊúçÊñπÊ≥ï

3. **ÊòéÊó•„ÅÆÂ≠¶Áøí„Éó„É©„É≥**
   - „Åä„Åô„Åô„ÇÅ„ÅÆÁßëÁõÆ„ÉªÂÜÖÂÆπ„ÉªÊôÇÈñìÈÖçÂàÜ
   - ‰ªäÊó•„ÅÆÁ∂ö„Åç„Åß„ÇÑ„Çã„Åπ„Åç„Åì„Å®

4. **„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥„Çí‰øù„Å§‰∏ÄË®Ä**`;
      
      return p;
    }
    
    // ==========================================
    // Âº±ÁÇπÂàÜÊûê„Éó„É≠„É≥„Éó„Éà
    // ==========================================
    
    function generateWeaknessPrompt(a) {
      const { profile, daysUntil, redbookAnalysis, goalAnalysis, subjectAnalysis, redbookLogs } = a;
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂ§ßÂ≠¶ÂèóÈ®ì„ÅÆ„Éá„Éº„Çø„Ç¢„Éä„É™„Çπ„Éà„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂ≠¶Áøí„Éá„Éº„Çø„Åã„ÇâÂº±ÁÇπ„ÇíÂàÜÊûê„Åó„ÄÅÂäπÁéáÁöÑ„Å™ÂØæÁ≠ñ„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üìã Âü∫Êú¨ÊÉÖÂ†±

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}
**Ë©¶È®ì„Åæ„Åß**: ${daysUntil}Êó•

`;
      
      if (goalAnalysis.length > 0) {
        p += `# üìä ÁõÆÊ®ô„Å®ÁèæÁä∂„ÅÆ„ÇÆ„É£„ÉÉ„Éó\n\n`;
        p += `| ÁßëÁõÆ | ÁèæÁä∂ | ÁõÆÊ®ô | „ÇÆ„É£„ÉÉ„Éó | ÈÅîÊàêË¶ãËæº„Åø |\n`;
        p += `|------|------|------|----------|------------|\n`;
        goalAnalysis.forEach(g => {
          const status = g.feasibility === 'likely' ? 'üü¢ ÈÅîÊàêÂúèÂÜÖ' : 
                         g.feasibility === 'possible' ? 'üü° Âä™ÂäõÊ¨°Á¨¨' : 'üî¥ Ë¶ÅÈõÜ‰∏≠ÂØæÁ≠ñ';
          p += `| ${g.subject} | ${g.current}% | ${g.target}% | +${g.gap}pt | ${status} |\n`;
        });
        p += `\n`;
      }
      
      if (redbookLogs.length > 0) {
        p += `# üìù ÈÅéÂéªÂïè„ÉªÊ®°Ë©¶„ÅÆÂÖ®ÁµêÊûú\n\n`;
        redbookLogs.forEach(log => {
          const scoreIcon = log.score >= 70 ? 'üü¢' : log.score >= 50 ? 'üü°' : 'üî¥';
          p += `## ${log.date} ${log.university} ${log.subject || ''} ${log.year}Âπ¥\n`;
          p += `- ÂæóÁÇπÁéá: ${scoreIcon} **${log.score}%**\n`;
          if (log.time) p += `- Ëß£Á≠îÊôÇÈñì: ${log.time}ÂàÜ\n`;
          if (log.sectionScores) p += `- Â§ßÂïèÂà•: ${log.sectionScores}\n`;
          if (log.weakAreas) p += `- ‚ö†Ô∏è ÈñìÈÅï„Åà„ÅüÂàÜÈáé: **${log.weakAreas}**\n`;
          if (log.memo) p += `- „É°„É¢: ${log.memo}\n`;
          p += `\n`;
        });
      }
      
      if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
        p += `# üî¥ Áπ∞„ÇäËøî„ÅóÈñìÈÅï„Åà„ÇãÂàÜÈáéÔºàË¶ÅÈáçÁÇπÂØæÁ≠ñÔºâ\n\n`;
        const sorted = Object.entries(redbookAnalysis.weakAreasSummary)
          .sort((a, b) => b[1] - a[1]);
        
        p += `| ÂàÜÈáé | Âá∫ÁèæÂõûÊï∞ | Ê∑±ÂàªÂ∫¶ |\n`;
        p += `|------|----------|--------|\n`;
        sorted.forEach(([area, count]) => {
          const severity = count >= 3 ? 'üî¥ È´ò' : count >= 2 ? 'üü° ‰∏≠' : 'üü¢ ‰Ωé';
          p += `| ${area} | ${count}Âõû | ${severity} |\n`;
        });
        p += `\n`;
      }
      
      p += `# üìà ÁßëÁõÆÂà•„ÅÆÂ≠¶ÁøíÁä∂Ê≥Å\n\n`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.totalMinutes > 0) {
          const goodRate = data.sessionCount > 0 
            ? Math.round((data.moodBreakdown.excellent + data.moodBreakdown.good) / data.sessionCount * 100)
            : 0;
          const badRate = data.sessionCount > 0
            ? Math.round((data.moodBreakdown.bad + data.moodBreakdown.terrible) / data.sessionCount * 100)
            : 0;
          
          p += `## ${cat}\n`;
          p += `- Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì: ${formatMinutes(data.totalMinutes)}\n`;
          p += `- Â≠¶ÁøíÂõûÊï∞: ${data.sessionCount}Âõû\n`;
          p += `- ÊâãÂøú„Åà: Â•ΩË™ø${goodRate}% / Ëã¶Êà¶${badRate}%\n`;
          if (redbookAnalysis.scoresBySubject[cat]) {
            p += `- ÈÅéÂéªÂïèÂπ≥Âùá: ${redbookAnalysis.scoresBySubject[cat]}%\n`;
          }
          p += `\n`;
        }
      });
      
      p += `---

# üéØ ÂàÜÊûê„É™„ÇØ„Ç®„Çπ„Éà

‰∏äË®ò„ÅÆ„Éá„Éº„Çø„ÇíË©≥Á¥∞„Å´ÂàÜÊûê„Åó„ÄÅÂº±ÁÇπÂÖãÊúç„ÅÆ„Åü„ÇÅ„ÅÆÊà¶Áï•„ÇíÁ´ã„Å¶„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

1. **Âº±ÁÇπ„ÅÆÂÑ™ÂÖàÈ†Ü‰Ωç‰ªò„Åë**
   - ÊúÄ„ÇÇÂØæÁ≠ñ„ÅåÂøÖË¶Å„Å™ÂàÜÈáéTOP3„Å®„Åù„ÅÆÁêÜÁî±
   - Ë©¶È®ì„Å∏„ÅÆÂΩ±ÈüøÂ∫¶„Å®ÊîπÂñÑ„ÅÆÈõ£ÊòìÂ∫¶

2. **Âº±ÁÇπ„ÅÆÊ†πÊú¨ÂéüÂõ†„ÅÆÂàÜÊûê**
   - „Å™„Åú„Åù„ÅÆÂàÜÈáé„ÅßÈñìÈÅï„ÅÑ„ÅåÂ§ö„ÅÑ„ÅÆ„Åã
   - Áü•Ë≠ò‰∏çË∂≥„Å™„ÅÆ„Åã„ÄÅËß£Ê≥ï„Éë„Çø„Éº„É≥„Å™„ÅÆ„Åã„ÄÅÊôÇÈñìÁÆ°ÁêÜ„Å™„ÅÆ„Åã

3. **ÂÖ∑‰ΩìÁöÑ„Å™ÂØæÁ≠ñ„Éó„É©„É≥**
   - ÂêÑÂº±ÁÇπ„Å´ÂØæ„Åô„ÇãÂÖ∑‰ΩìÁöÑ„Å™ÂãâÂº∑Ê≥ï
   - ‰Ωø„ÅÜ„Åπ„ÅçÊïôÊùê„ÇÑÂèÇËÄÉÊõ∏
   - 1Êó•„ÅÇ„Åü„Çä„ÅÆÁõÆÂÆâÊôÇÈñì

4. **ÊÆã„Çä${daysUntil}Êó•„Åß„ÅÆÁèæÂÆüÁöÑ„Å™ÁõÆÊ®ô**
   - „Å©„Åì„Åæ„ÅßÊîπÂñÑ„Åß„Åç„Åù„ÅÜ„Åã
   - ÂÑ™ÂÖà„Åó„Å¶Êç®„Å¶„Çã„Åπ„ÅçÂàÜÈáé„Åå„ÅÇ„Çå„Å∞

5. **Â≠¶ÁøíÂäπÁéá„Çí‰∏ä„Åí„Çã„Ç≥„ÉÑ**
   - Âêå„Åò„Éü„Çπ„ÇíÁπ∞„ÇäËøî„Åï„Å™„ÅÑ„Åü„ÇÅ„ÅÆÊñπÊ≥ï`;
      
      return p;
    }
    
    // ==========================================
    // ÁßëÁõÆÂà•Áõ∏Ë´á„Éó„É≠„É≥„Éó„Éà
    // ==========================================
    
    function generateSubjectPrompt(a) {
      const selectedSubject = document.getElementById('aiSubjectSelect').value;
      if (!selectedSubject) {
        return '‚Üë‰∏ä„ÅÆ„ÄåÁõ∏Ë´á„Åó„Åü„ÅÑÁßëÁõÆ„Äç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      }
      
      const { profile, daysUntil, subjectAnalysis, redbookAnalysis, goalAnalysis, redbookLogs, weekLogs } = a;
      const subjectData = subjectAnalysis[selectedSubject] || {};
      const subjectGoal = goalAnalysis.find(g => g.subject === selectedSubject);
      const subjectRedbook = redbookLogs.filter(l => categorizeSubject(l.subject) === selectedSubject);
      const subjectWeekLogs = weekLogs.filter(l => categorizeSubject(l.subject) === selectedSubject);
      
      // ÁßëÁõÆÂà•„ÅÆËã¶ÊâãÂàÜÈáé
      const weakAreas = {};
      subjectRedbook.forEach(log => {
        if (log.weakAreas) {
          log.weakAreas.split(/[,„ÄÅ]/).forEach(area => {
            const trimmed = area.trim();
            if (trimmed) weakAreas[trimmed] = (weakAreas[trimmed] || 0) + 1;
          });
        }
      });
      
      let p = `„ÅÇ„Å™„Åü„ÅØ${selectedSubject}Â∞ÇÈñÄ„ÅÆÂèóÈ®ì„Ç≥„Éº„ÉÅ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Éá„Éº„Çø„ÇíÂàÜÊûê„Åó„ÄÅ${selectedSubject}„ÅÆÊàêÁ∏æÂêë‰∏ä„ÅÆ„Åü„ÇÅ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üìã Âü∫Êú¨ÊÉÖÂ†±

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}
**Ë©¶È®ì„Åæ„Åß**: ${daysUntil}Êó•
**Áõ∏Ë´áÁßëÁõÆ**: ${selectedSubject}

`;
      
      if (subjectGoal) {
        p += `# üéØ ÁõÆÊ®ôË®≠ÂÆö\n\n`;
        p += `- **ÁèæÁä∂**: ${subjectGoal.current}%\n`;
        p += `- **ÁõÆÊ®ô**: ${subjectGoal.target}%Ôºà+${subjectGoal.gap}ptÂøÖË¶ÅÔºâ\n`;
        p += `- **ÊúÄ‰Ωé„É©„Ç§„É≥**: ${subjectGoal.must}%\n`;
        p += `- **ÈÅîÊàêË¶ãËæº„Åø**: ${subjectGoal.feasibility === 'likely' ? 'üü¢ ÈÅîÊàêÂúèÂÜÖ' : subjectGoal.feasibility === 'possible' ? 'üü° Âä™ÂäõÊ¨°Á¨¨' : 'üî¥ Ë¶ÅÈõÜ‰∏≠ÂØæÁ≠ñ'}\n\n`;
      }
      
      p += `# üìä Â≠¶Áøí„Éá„Éº„Çø\n\n`;
      p += `**Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì**: ${formatMinutes(subjectData.totalMinutes || 0)}\n`;
      p += `**‰ªäÈÄ±„ÅÆÂ≠¶ÁøíÊôÇÈñì**: ${formatMinutes(subjectData.weekMinutes || 0)}\n`;
      p += `**Â≠¶ÁøíÂõûÊï∞**: ${subjectData.sessionCount || 0}Âõû\n`;
      p += `**ÂÇæÂêë**: ${subjectData.trend === 'increasing' ? 'üìà Â¢óÂä†‰∏≠' : subjectData.trend === 'decreasing' ? 'üìâ Ê∏õÂ∞ë‰∏≠' : '‚û°Ô∏è ÂÆâÂÆö'}\n\n`;
      
      if (Object.keys(subjectData.typeBreakdown || {}).length > 0) {
        p += `## Â≠¶Áøí„Çø„Ç§„Éó„ÅÆÂÜÖË®≥\n`;
        Object.entries(subjectData.typeBreakdown).forEach(([type, min]) => {
          p += `- ${type}: ${formatMinutes(min)}\n`;
        });
        p += `\n`;
      }
      
      if (Object.keys(subjectData.textbooks || {}).length > 0) {
        p += `## ‰ΩøÁî®ÊïôÊùê\n`;
        Object.entries(subjectData.textbooks)
          .sort((a, b) => b[1] - a[1])
          .forEach(([book, min]) => {
            p += `- ${book}: ${formatMinutes(min)}\n`;
          });
        p += `\n`;
      }
      
      if (subjectWeekLogs.length > 0) {
        p += `## ‰ªäÈÄ±„ÅÆÂ≠¶ÁøíÂÜÖÂÆπ\n`;
        subjectWeekLogs.forEach(log => {
          p += `- ${log.date}: ${log.subject} ${log.minutes}ÂàÜ`;
          if (log.mood) p += ` ${log.mood}`;
          if (log.unit) p += ` [${log.unit}]`;
          if (log.memo) p += ` ‚Üí ${log.memo}`;
          p += `\n`;
        });
        p += `\n`;
      }
      
      if (subjectRedbook.length > 0) {
        p += `## ÈÅéÂéªÂïèÊºîÁøíÁµêÊûú\n\n`;
        subjectRedbook.forEach(log => {
          p += `### ${log.university} ${log.year}Âπ¥Ôºà${log.date}Ôºâ\n`;
          p += `- ÂæóÁÇπÁéá: **${log.score}%**\n`;
          if (log.time) p += `- Ëß£Á≠îÊôÇÈñì: ${log.time}ÂàÜ\n`;
          if (log.sectionScores) p += `- Â§ßÂïèÂà•: ${log.sectionScores}\n`;
          if (log.weakAreas) p += `- ÈñìÈÅï„Åà„ÅüÂàÜÈáé: ${log.weakAreas}\n`;
          if (log.memo) p += `- ÊåØ„ÇäËøî„Çä: ${log.memo}\n`;
          p += `\n`;
        });
      }
      
      if (Object.keys(weakAreas).length > 0) {
        p += `## ‚ö†Ô∏è „Çà„ÅèÈñìÈÅï„Åà„ÇãÂàÜÈáé\n`;
        Object.entries(weakAreas)
          .sort((a, b) => b[1] - a[1])
          .forEach(([area, count]) => {
            p += `- **${area}**: ${count}Âõû\n`;
          });
        p += `\n`;
      }
      
      // ÊâãÂøú„ÅàÂàÜÊûê
      if (subjectData.moodBreakdown) {
        const mb = subjectData.moodBreakdown;
        const total = mb.excellent + mb.good + mb.neutral + mb.bad + mb.terrible;
        if (total > 0) {
          p += `## ÊâãÂøú„Åà„ÅÆÂÇæÂêë\n`;
          p += `- üòä Áµ∂Â•ΩË™ø: ${mb.excellent}Âõû\n`;
          p += `- üôÇ Â•ΩË™ø: ${mb.good}Âõû\n`;
          p += `- üòê ÊôÆÈÄö: ${mb.neutral}Âõû\n`;
          p += `- üòï Ëã¶Êà¶: ${mb.bad}Âõû\n`;
          p += `- üò´ „Åã„Å™„ÇäËã¶Êà¶: ${mb.terrible}Âõû\n\n`;
        }
      }
      
      p += `---

# üéØ Áõ∏Ë´áÂÜÖÂÆπ

${selectedSubject}„ÅÆÊàêÁ∏æ„ÇíÂäπÁéáÁöÑ„Å´‰∏ä„Åí„Çã„Åü„ÇÅ„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

1. **ÁèæÁä∂Ë®∫Êñ≠**
   - „Éá„Éº„Çø„Åã„ÇâË¶ã„Åà„ÇãÁßÅ„ÅÆ${selectedSubject}„ÅÆÁâπÂæ¥
   - Âº∑„Åø„Å®Âº±„Åø„ÅÆÂàÜÊûê

2. **ÈáçÁÇπÂØæÁ≠ñÂàÜÈáé**Ôºà3„Å§Ôºâ
   - ÂÑ™ÂÖàÂ∫¶„ÅÆÈ´ò„ÅÑÈ†Ü„Å´
   - „Å™„Åú„Åù„ÅÆÂàÜÈáé„ÇíÈáçË¶ñ„Åô„Åπ„Åç„Åã

3. **ÂÖ∑‰ΩìÁöÑ„Å™Â≠¶Áøí„Éó„É©„É≥**
   - 1Êó•„ÅÆ${selectedSubject}Â≠¶Áøí„É°„Éã„É•„Éº‰æã
   - 1ÈÄ±Èñì„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´Ê°à

4. **ÊïôÊùê„ÉªÂãâÂº∑Ê≥ï„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ**
   - ÁèæÂú®‰ΩøÁî®‰∏≠„ÅÆÊïôÊùê„Å∏„ÅÆË©ï‰æ°
   - ËøΩÂä†„Åß‰Ωø„ÅÜ„Åπ„ÅçÊïôÊùê„Åå„ÅÇ„Çå„Å∞

5. **ÁõÆÊ®ôÈÅîÊàê„Å∏„ÅÆÈÅìÁ≠ã**
   - ÊÆã„Çä${daysUntil}Êó•„Åß${subjectGoal ? `+${subjectGoal.gap}pt` : 'ÁõÆÊ®ô'}ÈÅîÊàê„Åô„Çã„Åü„ÇÅ„Å´`;
      
      return p;
    }
    
    // ==========================================
    // Áõ¥ÂâçÊúüÂØæÁ≠ñ„Éó„É≠„É≥„Éó„Éà
    // ==========================================
    
    function generateLastSpurtPrompt(a) {
      const { profile, daysUntil, weekMinutes, totalMinutes, streak, studyDays,
              redbookAnalysis, goalAnalysis, risks, subjectAnalysis } = a;
      
      const avgDailyMinutes = studyDays > 0 ? Math.round(totalMinutes / studyDays) : 0;
      const remainingStudyTime = avgDailyMinutes * daysUntil;
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂ§ßÂ≠¶ÂèóÈ®ì„ÅÆÁõ¥ÂâçÊúüÂØæÁ≠ñ„ÅÆ„Çπ„Éö„Ç∑„É£„É™„Çπ„Éà„Åß„Åô„ÄÇÊÆã„ÇäÊó•Êï∞„ÇíËÄÉÊÖÆ„Åó„ÅüÁèæÂÆüÁöÑ„Å™ÂØæÁ≠ñ„Éó„É©„É≥„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# ‚è∞ ÊÆã„ÇäÊôÇÈñì

**Ë©¶È®ì„Åæ„Åß**: ‚ö†Ô∏è **${daysUntil}Êó•**ÔºàÁ¥Ñ${Math.ceil(daysUntil / 7)}ÈÄ±ÈñìÔºâ
**Êé®ÂÆöÂèØËÉΩÂ≠¶ÁøíÊôÇÈñì**: Á¥Ñ${formatMinutes(remainingStudyTime)}
Ôºà1Êó•Âπ≥Âùá${formatMinutes(avgDailyMinutes)}„ÅßË®àÁÆóÔºâ

---

# üìã ÂèóÈ®ìÁîü„ÅÆÁä∂Ê≥Å

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}`;
      if (profile['Á¨¨2ÂøóÊúõ']) p += `
**‰ΩµÈ°òÊ†°**: ${profile['Á¨¨2ÂøóÊúõ']}${profile['Á¨¨3ÂøóÊúõ'] ? '„ÄÅ' + profile['Á¨¨3ÂøóÊúõ'] : ''}`;
      p += `

**„Åì„Çå„Åæ„Åß„ÅÆÂÆüÁ∏æ**:
- Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì: ${formatMinutes(totalMinutes)}
- Â≠¶ÁøíÊó•Êï∞: ${studyDays}Êó•
- ÈÄ£Á∂öÂ≠¶Áøí: ${streak}Êó•
- Áõ¥Ëøë1ÈÄ±Èñì: ${formatMinutes(weekMinutes)}

`;
      
      if (goalAnalysis.length > 0) {
        p += `# üéØ ÁõÆÊ®ô„Å®ÁèæÁä∂\n\n`;
        p += `| ÁßëÁõÆ | ÁèæÁä∂ | ÁõÆÊ®ô | ÂøÖË¶Å„Å™‰º∏„Å≥ | ÈÅîÊàêÈõ£ÊòìÂ∫¶ |\n`;
        p += `|------|------|------|------------|------------|\n`;
        goalAnalysis.forEach(g => {
          const difficulty = g.feasibility === 'likely' ? '‚òÖ‚òÜ‚òÜ' : 
                            g.feasibility === 'possible' ? '‚òÖ‚òÖ‚òÜ' : '‚òÖ‚òÖ‚òÖ';
          p += `| ${g.subject} | ${g.current}% | ${g.target}% | +${g.gap}pt | ${difficulty} |\n`;
        });
        p += `\n`;
      }
      
      if (redbookAnalysis.totalAttempts > 0) {
        p += `# üìù ÈÅéÂéªÂïèÊºîÁøí„ÅÆÁèæÁä∂\n\n`;
        p += `- ÊºîÁøíÂõûÊï∞: ${redbookAnalysis.totalAttempts}Âõû\n`;
        p += `- Âπ≥ÂùáÂæóÁÇπÁéá: **${redbookAnalysis.avgScore}%**\n`;
        p += `- ÂæóÁÇπÂÇæÂêë: ${redbookAnalysis.scoreTrend === 'improving' ? 'üìà ‰∏äÊòá‰∏≠ÔºàËâØ„ÅÑÂÇæÂêëÔºâ' : redbookAnalysis.scoreTrend === 'declining' ? 'üìâ ‰∏ãÈôçÊ∞óÂë≥ÔºàË¶ÅÂØæÁ≠ñÔºâ' : '‚û°Ô∏è ÂÆâÂÆö'}\n\n`;
        
        if (Object.keys(redbookAnalysis.scoresBySubject).length > 0) {
          p += `**ÁßëÁõÆÂà•Âπ≥Âùá**:\n`;
          Object.entries(redbookAnalysis.scoresBySubject).forEach(([cat, score]) => {
            const icon = score >= 70 ? 'üü¢' : score >= 50 ? 'üü°' : 'üî¥';
            p += `- ${cat}: ${icon} ${score}%\n`;
          });
          p += `\n`;
        }
        
        if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
          p += `**Áπ∞„ÇäËøî„ÅóÈñìÈÅï„Åà„ÇãÂàÜÈáéÔºàÁõ¥ÂâçÊúü„ÅßÂøÖ„ÅöÂØæÁ≠ñÔºâ**:\n`;
          Object.entries(redbookAnalysis.weakAreasSummary)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .forEach(([area, count]) => {
              p += `- üî¥ ${area}Ôºà${count}ÂõûÔºâ\n`;
            });
          p += `\n`;
        }
      }
      
      if (risks.length > 0) {
        p += `# ‚ö†Ô∏è ÁèæÂú®„ÅÆ„É™„Çπ„ÇØË¶ÅÂõ†\n\n`;
        risks.forEach(r => {
          const icon = r.severity === 'high' ? 'üî¥' : r.severity === 'medium' ? 'üü°' : 'üü¢';
          p += `- ${icon} ${r.message}\n`;
        });
        p += `\n`;
      }
      
      p += `# üìä ÁßëÁõÆÂà•„ÅÆ‰ªï‰∏ä„Åå„ÇäÂ∫¶\n\n`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.totalMinutes > 0) {
          const score = redbookAnalysis.scoresBySubject[cat] || 'Êú™Ê∏¨ÂÆö';
          const goalData = goalAnalysis.find(g => g.subject === cat);
          const status = typeof score === 'number' 
            ? (goalData && score >= goalData.target ? 'üü¢ ÁõÆÊ®ôÂúèÂÜÖ' : score >= 50 ? 'üü° „ÇÇ„ÅÜ‰∏ÄÊÅØ' : 'üî¥ Ë¶ÅÂº∑Âåñ')
            : '‚ö™ Ë¶ÅÊºîÁøí';
          p += `- **${cat}**: ${status}ÔºàÈÅéÂéªÂïèÂπ≥Âùá: ${score}${typeof score === 'number' ? '%' : ''}Ôºâ\n`;
        }
      });
      
      p += `
---

# üéØ Áõ∏Ë´áÂÜÖÂÆπ

ÊÆã„Çä${daysUntil}Êó•„ÅßÂêàÊ†º„ÇíÂãù„Å°Âèñ„Çã„Åü„ÇÅ„ÅÆ**Áõ¥ÂâçÊúüÂØæÁ≠ñ„Éó„É©„É≥**„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

1. **„ÇÑ„Çã„Åì„Å®„Éª„ÇÑ„Çâ„Å™„ÅÑ„Åì„Å®„ÅÆÂà§Êñ≠**
   - ÊÆã„ÇäÊôÇÈñì„ÅßÂÑ™ÂÖà„Åô„Åπ„Åç„Åì„Å®
   - ÊÄù„ÅÑÂàá„Å£„Å¶Êç®„Å¶„Çã„Åπ„Åç„Åì„Å®

2. **Áõ¥ÂâçÊúü„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´**
   - „Äú1ÈÄ±ÈñìÂâç: „ÇÑ„Çã„Åπ„Åç„Åì„Å®
   - Áõ¥Ââç3Êó•Èñì: „ÇÑ„Çã„Åπ„Åç„Åì„Å®
   - ÂâçÊó•: „ÇÑ„Çã„Åπ„Åç„Åì„Å®

3. **ÁßëÁõÆÂà•„ÅÆÊôÇÈñìÈÖçÂàÜ**
   - 1Êó•„ÅÇ„Åü„Çä„ÅÆÁêÜÊÉ≥ÁöÑ„Å™ÈÖçÂàÜ

4. **Âº±ÁÇπ„Å∏„ÅÆÂØæÂá¶Ê≥ï**
   - ‰ªä„Åã„ÇâÈñì„Å´Âêà„ÅÜÂØæÁ≠ñ
   - Êú¨Áï™„ÅßÈÅø„Åë„Çã„Åπ„ÅçÂïèÈ°å

5. **Ë©¶È®ìÊú¨Áï™„ÅÆÊà¶Áï•**
   - ÊôÇÈñìÈÖçÂàÜ
   - Ëß£„ÅèÈ†ÜÁï™
   - „Éë„Éã„ÉÉ„ÇØÊôÇ„ÅÆÂØæÂá¶Ê≥ï

6. **„É°„É≥„Çø„É´ÁÆ°ÁêÜ**
   - ‰∏çÂÆâ„Å®„ÅÆ‰ªò„ÅçÂêà„ÅÑÊñπ
   - Áõ¥ÂâçÊúü„ÅÆ„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥Á∂≠ÊåÅ`;
      
      return p;
    }
    
    // ==========================================
    // „É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥„Éó„É≠„É≥„Éó„Éà
    // ==========================================
    
    function generateMotivationPrompt(a) {
      const { profile, daysUntil, totalMinutes, studyDays, streak, weekMinutes,
              subjectAnalysis, strengths, redbookAnalysis } = a;
      
      const totalHours = Math.floor(totalMinutes / 60);
      
      // „Éù„Ç∏„ÉÜ„Ç£„Éñ„Å™ÂÆüÁ∏æ„ÇíÊäΩÂá∫
      const achievements = [];
      if (streak >= 3) achievements.push(`${streak}Êó•ÈÄ£Á∂ö„ÅßÂ≠¶Áøí„ÇíÁ∂ôÁ∂ö`);
      if (totalHours >= 50) achievements.push(`Á¥ØË®à${totalHours}ÊôÇÈñì‰ª•‰∏ä„ÅÆÂ≠¶Áøí`);
      if (studyDays >= 14) achievements.push(`${studyDays}Êó•Èñì„Ç≥„ÉÑ„Ç≥„ÉÑÂä™Âäõ`);
      if (redbookAnalysis.scoreTrend === 'improving') achievements.push('ÈÅéÂéªÂïè„ÅÆÂæóÁÇπ„Åå‰∏äÊòáÂÇæÂêë');
      
      // Ëã¶Êà¶„Åó„Å¶„ÅÑ„ÇãÈÉ®ÂàÜ
      const struggles = [];
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        const badRate = data.sessionCount > 0
          ? (data.moodBreakdown.bad + data.moodBreakdown.terrible) / data.sessionCount
          : 0;
        if (badRate > 0.4) struggles.push(`${cat}„ÅßËã¶Êà¶„Åô„Çã„Åì„Å®„ÅåÂ§ö„ÅÑ`);
      });
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂèóÈ®ìÁîü„ÅÆ„É°„É≥„Çø„É´„Çµ„Éù„Éº„Éà„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇÊ∏©„Åã„Åè„ÄÅ„Åß„ÇÇÁèæÂÆüÁöÑ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ„ÅßÁßÅ„ÇíÂä±„Åæ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üë§ ÁßÅ„Å´„Å§„ÅÑ„Å¶

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}
**Ë©¶È®ì„Åæ„Åß**: „ÅÇ„Å®${daysUntil}Êó•

---

# üìä „Åì„Çå„Åæ„Åß„ÅÆÂä™Âäõ

**Êï∞Â≠ó„ÅßË¶ã„ÇãÁßÅ„ÅÆÈ†ëÂºµ„Çä**:
- üïê Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì: **${totalHours}ÊôÇÈñì${totalMinutes % 60}ÂàÜ**
- üìÖ Â≠¶Áøí„Åó„ÅüÊó•Êï∞: **${studyDays}Êó•**
- üî• ÈÄ£Á∂öÂ≠¶ÁøíÊó•Êï∞: **${streak}Êó•**
- üìà Áõ¥Ëøë1ÈÄ±Èñì: ${formatMinutes(weekMinutes)}

`;
      
      if (achievements.length > 0) {
        p += `**ÁßÅ„ÅÆÂÆüÁ∏æ**:\n`;
        achievements.forEach(a => p += `- ‚ú® ${a}\n`);
        p += `\n`;
      }
      
      if (strengths.length > 0) {
        p += `**Âº∑„Åø**:\n`;
        strengths.forEach(s => p += `- üí™ ${s.message}\n`);
        p += `\n`;
      }
      
      p += `---

# üòî ‰ªä„ÅÆÊ∞óÊåÅ„Å°

Ê≠£Áõ¥„Å´Ë®Ä„ÅÜ„Å®„ÄÅÊúÄËøë„Åì„Çì„Å™Ê∞óÊåÅ„Å°„Åå„ÅÇ„Çä„Åæ„ÅôÔºö

- Ë©¶È®ì„ÅåËøë„Å•„ÅÑ„Å¶„Åç„Å¶„ÄÅÊº†ÁÑ∂„Å®„Åó„Åü‰∏çÂÆâ„Åå„ÅÇ„Çã
- Êú¨ÂΩì„Å´Ëá™ÂàÜ„ÅåÂêàÊ†º„Åß„Åç„Çã„ÅÆ„ÅãËá™‰ø°„ÅåÊåÅ„Å¶„Å™„ÅÑ
- Âë®„Çä„ÅÆÂèóÈ®ìÁîü„Å®ÊØî„Åπ„Å¶ÁÑ¶„Å£„Å¶„Åó„Åæ„ÅÜ„Åì„Å®„Åå„ÅÇ„Çã
- ÂãâÂº∑„Åó„Å¶„ÇÇÊàêÊûú„ÅåË¶ã„Åà„Å´„Åè„Åè„Å¶„ÄÅ„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥„Åå‰∏ã„Åå„ÇãÊôÇ„Åå„ÅÇ„Çã
`;
      
      if (struggles.length > 0) {
        p += `- ${struggles.join('\n- ')}\n`;
      }
      
      p += `
„Åß„ÇÇ„ÄÅ${profile['Á¨¨1ÂøóÊúõ'] || 'ÂøóÊúõÊ†°'}„Å´Áµ∂ÂØæ„Å´ÂêàÊ†º„Åó„Åü„ÅÑ„Å®„ÅÑ„ÅÜÊ∞óÊåÅ„Å°„ÅØÂ§â„Çè„Çä„Åæ„Åõ„Çì„ÄÇ

---

# üéØ „ÅäÈ°ò„ÅÑ

‰ªä„Åæ„Åß„ÅÆÂä™Âäõ„ÇíË™ç„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åß„Åô„ÄÇ„Åù„Åó„Å¶„ÄÅÊÆã„Çä${daysUntil}Êó•„Çí‰πó„ÇäÂàá„Çã„Åü„ÇÅ„ÅÆÂäõ„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

1. **ÁßÅ„ÅÆÂä™Âäõ„Å∏„ÅÆË©ï‰æ°**
   - ${totalHours}ÊôÇÈñì„Å®„ÅÑ„ÅÜÊï∞Â≠ó„ÅÆÊÑèÂë≥
   - ${streak}Êó•ÈÄ£Á∂ö„Å®„ÅÑ„ÅÜÁ∂ôÁ∂ö„ÅÆ‰æ°ÂÄ§
   - ÂÖ∑‰ΩìÁöÑ„Å´Ë§í„ÇÅ„Å¶„Åª„Åó„ÅÑ

2. **Ê∏©„Åã„ÅÑÂä±„Åæ„Åó„ÅÆË®ÄËëâ**
   - ‰∏çÂÆâ„ÇíÂíå„Çâ„Åí„ÇãË®ÄËëâ
   - Ëá™‰ø°„ÇíÊåÅ„Å¶„Çã„Çà„ÅÜ„Å™Ë®ÄËëâ

3. **‰∏çÂÆâ„Å®„ÅÆÂêë„ÅçÂêà„ÅÑÊñπ**
   - ÂèóÈ®ìÁîü„Å™„ÇâË™∞„ÇÇ„ÅåÊÑü„Åò„Çã‰∏çÂÆâ„Åß„ÅÇ„Çã„Åì„Å®
   - ÂÖ∑‰ΩìÁöÑ„Å™„É°„É≥„Çø„É´ÁÆ°ÁêÜ„ÅÆ„Ç≥„ÉÑ

4. **ÊÆã„Çä${daysUntil}Êó•„ÅÆÈÅé„Åî„ÅóÊñπ**
   - ÁÑ°ÁêÜ„Å™„ÅèÁ∂ö„Åë„Çâ„Çå„Çã„Ç¢„Éâ„Éê„Ç§„Çπ
   - ÁÑ¶„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÅÆËÄÉ„ÅàÊñπ

5. **ÂêàÊ†º„Åó„ÅüÊú™Êù•„ÅÆ„Ç§„É°„Éº„Ç∏**
   - ÂøóÊúõÊ†°„Å´ÈÄö„ÅÜËá™ÂàÜ„ÇíÊÉ≥ÂÉè„Åï„Åõ„Å¶„Åª„Åó„ÅÑ
   - ÊúÄÂæå„Å´„ÄÅÂäõÂº∑„ÅÑÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏„Çí`;
      
      return p;
    }
    
    // ==========================================
    // ÂæóÁÇπ‰∫àÊ∏¨„Éó„É≠„É≥„Éó„Éà
    // ==========================================
    
    function generatePredictionPrompt(a) {
      const { profile, daysUntil, totalMinutes, studyDays, weekMinutes,
              subjectAnalysis, redbookAnalysis, goalAnalysis, redbookLogs } = a;
      
      // ÁßëÁõÆÂà•„ÅÆÈÅéÂéªÂïè„Éá„Éº„Çø„ÇíÊï¥ÁêÜ
      const subjectScoreHistory = {};
      redbookLogs.forEach(log => {
        const cat = categorizeSubject(log.subject);
        if (!subjectScoreHistory[cat]) {
          subjectScoreHistory[cat] = [];
        }
        subjectScoreHistory[cat].push({
          date: log.date,
          university: log.university,
          year: log.year,
          score: log.score,
          weakAreas: log.weakAreas
        });
      });
      
      // ÂêÑÁßëÁõÆ„ÅÆÊàêÈï∑Áéá„ÇíË®àÁÆó
      const growthAnalysis = {};
      Object.entries(subjectScoreHistory).forEach(([cat, scores]) => {
        if (scores.length >= 2) {
          // ÊôÇÁ≥ªÂàóÈ†Ü„Å´„ÇΩ„Éº„ÉàÔºàÂè§„ÅÑÈ†ÜÔºâ
          const sorted = [...scores].sort((a, b) => new Date(a.date) - new Date(b.date));
          const firstHalf = sorted.slice(0, Math.ceil(sorted.length / 2));
          const secondHalf = sorted.slice(Math.ceil(sorted.length / 2));
          
          const firstAvg = firstHalf.reduce((s, l) => s + l.score, 0) / firstHalf.length;
          const secondAvg = secondHalf.reduce((s, l) => s + l.score, 0) / secondHalf.length;
          const growth = secondAvg - firstAvg;
          
          growthAnalysis[cat] = {
            firstAvg: Math.round(firstAvg),
            secondAvg: Math.round(secondAvg),
            growth: Math.round(growth),
            trend: growth > 3 ? 'improving' : growth < -3 ? 'declining' : 'stable',
            sampleSize: scores.length
          };
        }
      });
      
      // Â≠¶ÁøíÊôÇÈñì„Å®ÁßëÁõÆ„ÅÆÈñ¢‰øÇ
      const studyTimeBySubject = {};
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        studyTimeBySubject[cat] = {
          total: data.totalMinutes,
          weekly: data.weekMinutes,
          sessionCount: data.sessionCount
        };
      });
      
      // ÂÖ±ÈÄö„ÉÜ„Çπ„Éà„ÅÆÈÖçÁÇπ„ÇíÊÉ≥ÂÆöÔºà‰∏ÄËà¨ÁöÑ„Å™ÊñáÁ≥ª„ÅÆÂ†¥ÂêàÔºâ
      const commonTestStructure = {
        'Ëã±Ë™û': { reading: 100, listening: 100, total: 200 },
        'Êï∞Â≠¶': { math1A: 100, math2B: 100, total: 200 },
        'ÂõΩË™û': { modern: 110, classic: 90, total: 200 },
        'ÁêÜÁßë': { total: 100 },
        'Á§æ‰ºö': { total: 100 }
      };
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂ§ßÂ≠¶ÂèóÈ®ì„ÅÆ„Éá„Éº„Çø„Çµ„Ç§„Ç®„É≥„ÉÜ„Ç£„Çπ„Éà„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂ≠¶Áøí„Éá„Éº„Çø„ÇíÁµ±Ë®àÁöÑ„Å´ÂàÜÊûê„Åó„ÄÅÂÖ±ÈÄö„ÉÜ„Çπ„Éà„Åß„ÅÆÂæóÁÇπ„ÇíÂÆ¢Ë¶≥ÁöÑ„Å´‰∫àÊ∏¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

‚ö†Ô∏è **ÈáçË¶Å**: ‰∫àÊ∏¨„ÅØÊ•ΩË¶≥ÁöÑ„Å´„Å™„Çä„Åô„Åé„Åö„ÄÅ„Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„ÅüÁèæÂÆüÁöÑ„Å™Êï∞ÂÄ§„ÇíÊèêÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂèóÈ®ìÁîü„ÅÆ‰ªäÂæå„ÅÆÂ≠¶ÁøíË®àÁîª„Å´ÂΩ±Èüø„Åô„Çã„Åü„ÇÅ„ÄÅÊ†πÊã†„ÅÆ„Å™„ÅÑÂ∏åÊúõÁöÑË¶≥Ê∏¨„ÅØÈÅø„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üìã Âü∫Êú¨ÊÉÖÂ†±

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}
**Ë©¶È®ì„Åæ„Åß**: ${daysUntil}Êó•
**Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì**: ${formatMinutes(totalMinutes)}
**Â≠¶ÁøíÊó•Êï∞**: ${studyDays}Êó•
**Áõ¥Ëøë1ÈÄ±Èñì**: ${formatMinutes(weekMinutes)}

`;
      
      if (goalAnalysis.length > 0) {
        p += `# üéØ ÁõÆÊ®ôË®≠ÂÆö\n\n`;
        p += `| ÁßëÁõÆ | ÁèæÁä∂ÔºàËá™Â∑±Ë©ï‰æ°Ôºâ | ÁõÆÊ®ô | ÊúÄ‰Ωé„É©„Ç§„É≥ |\n`;
        p += `|------|------------------|------|------------|\n`;
        goalAnalysis.forEach(g => {
          p += `| ${g.subject} | ${g.current}% | ${g.target}% | ${g.must}% |\n`;
        });
        p += `\n`;
      }
      
      p += `# üìä ÈÅéÂéªÂïè„ÉªÊ®°Ë©¶„ÅÆÂÖ®Ë®òÈå≤\n\n`;
      
      if (redbookLogs.length === 0) {
        p += `‚ÄªÈÅéÂéªÂïè„ÉªÊ®°Ë©¶„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ‰∫àÊ∏¨„ÅÆÁ≤æÂ∫¶„Åå‰Ωé„Åè„Å™„Çä„Åæ„Åô„ÄÇ\n\n`;
      } else {
        // ÁßëÁõÆÂà•„Å´Êï¥ÁêÜ„Åó„Å¶Ë°®Á§∫
        Object.entries(subjectScoreHistory).forEach(([cat, scores]) => {
          if (scores.length > 0) {
            p += `## ${cat}\n\n`;
            p += `| Êó•‰ªò | Â§ßÂ≠¶/Ê®°Ë©¶ | Âπ¥Â∫¶ | ÂæóÁÇπÁéá | ÈñìÈÅï„Åà„ÅüÂàÜÈáé |\n`;
            p += `|------|-----------|------|--------|-------------|\n`;
            scores.forEach(s => {
              p += `| ${s.date} | ${s.university} | ${s.year} | **${s.score}%** | ${s.weakAreas || '-'} |\n`;
            });
            
            // Áµ±Ë®à„Çµ„Éû„É™„Éº
            const avg = Math.round(scores.reduce((sum, s) => sum + s.score, 0) / scores.length);
            const max = Math.max(...scores.map(s => s.score));
            const min = Math.min(...scores.map(s => s.score));
            const latest = scores[0].score;
            
            p += `\n**Áµ±Ë®à**: Âπ≥Âùá${avg}% / ÊúÄÈ´ò${max}% / ÊúÄ‰Ωé${min}% / Áõ¥Ëøë${latest}%\n`;
            
            if (growthAnalysis[cat]) {
              const ga = growthAnalysis[cat];
              const trendIcon = ga.trend === 'improving' ? 'üìà' : ga.trend === 'declining' ? 'üìâ' : '‚û°Ô∏è';
              p += `**ÊàêÈï∑**: ÂâçÂçäÂπ≥Âùá${ga.firstAvg}% ‚Üí ÂæåÂçäÂπ≥Âùá${ga.secondAvg}%Ôºà${ga.growth >= 0 ? '+' : ''}${ga.growth}ptÔºâ${trendIcon}\n`;
            }
            p += `\n`;
          }
        });
        
        // ÂÖ®‰ΩìÁµ±Ë®à
        p += `## ÂÖ®ÁßëÁõÆÁ∑èÂêà\n\n`;
        p += `- ÊºîÁøíÂõûÊï∞: ${redbookAnalysis.totalAttempts}Âõû\n`;
        p += `- ÂÖ®‰ΩìÂπ≥Âùá: **${redbookAnalysis.avgScore}%**\n`;
        p += `- ÂæóÁÇπÂÇæÂêë: ${redbookAnalysis.scoreTrend === 'improving' ? 'üìà ‰∏äÊòáÂÇæÂêë' : redbookAnalysis.scoreTrend === 'declining' ? 'üìâ ‰∏ãÈôçÂÇæÂêë' : '‚û°Ô∏è Ê®™„Å∞„ÅÑ'}\n\n`;
      }
      
      p += `# üìö Â≠¶ÁøíÊôÇÈñì„Éá„Éº„Çø\n\n`;
      p += `| ÁßëÁõÆ | Á¥ØË®àÊôÇÈñì | ‰ªäÈÄ± | Â≠¶ÁøíÂõûÊï∞ |\n`;
      p += `|------|----------|------|----------|\n`;
      Object.entries(studyTimeBySubject).forEach(([cat, data]) => {
        if (data.total > 0) {
          p += `| ${cat} | ${formatMinutes(data.total)} | ${formatMinutes(data.weekly)} | ${data.sessionCount}Âõû |\n`;
        }
      });
      
      if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
        p += `\n# ‚ö†Ô∏è Áπ∞„ÇäËøî„ÅóÈñìÈÅï„Åà„ÇãÂàÜÈáé\n\n`;
        const sorted = Object.entries(redbookAnalysis.weakAreasSummary)
          .sort((a, b) => b[1] - a[1]);
        p += `| ÂàÜÈáé | Âá∫ÁèæÂõûÊï∞ | Ê∑±ÂàªÂ∫¶ |\n`;
        p += `|------|----------|--------|\n`;
        sorted.forEach(([area, count]) => {
          const severity = count >= 3 ? 'üî¥ È´ò' : count >= 2 ? 'üü° ‰∏≠' : 'üü¢ ‰Ωé';
          p += `| ${area} | ${count}Âõû | ${severity} |\n`;
        });
        p += `\n`;
      }
      
      p += `# üìà ÊÆã„ÇäÊúüÈñì„Åß„ÅÆ‰º∏„Å≥„Åó„ÇçË¶ÅÂõ†\n\n`;
      p += `**„Éó„É©„ÇπË¶ÅÂõ†**:\n`;
      if (daysUntil >= 30) p += `- ÊÆã„Çä${daysUntil}Êó•„ÅÇ„Çä„ÄÅÂØæÁ≠ñ„ÅÆÊôÇÈñì„Åå„ÅÇ„Çã\n`;
      if (redbookAnalysis.scoreTrend === 'improving') p += `- ÂæóÁÇπ„Åå‰∏äÊòáÂÇæÂêë„Å´„ÅÇ„Çã\n`;
      if (weekMinutes >= 1200) p += `- ÈÄ±20ÊôÇÈñì‰ª•‰∏ä„ÅÆÂ≠¶ÁøíÈáè„ÇíÁ¢∫‰øù\n`;
      
      p += `\n**„Éû„Ç§„Éä„ÇπË¶ÅÂõ†**:\n`;
      if (daysUntil < 30) p += `- ÊÆã„Çä${daysUntil}Êó•„Å®ÊôÇÈñì„ÅåÈôê„Çâ„Çå„Å¶„ÅÑ„Çã\n`;
      if (redbookAnalysis.scoreTrend === 'declining') p += `- ÂæóÁÇπ„Åå‰∏ãÈôçÂÇæÂêë„Å´„ÅÇ„Çã\n`;
      if (Object.keys(redbookAnalysis.weakAreasSummary).length >= 5) p += `- Ëã¶ÊâãÂàÜÈáé„ÅåË§áÊï∞„ÅÇ„Çã\n`;
      if (weekMinutes < 600) p += `- ÈÄ±„ÅÆÂ≠¶ÁøíÊôÇÈñì„Åå10ÊôÇÈñìÊú™Ê∫Ä\n`;
      
      p += `
---

# üéØ ‰∫àÊ∏¨„É™„ÇØ„Ç®„Çπ„Éà

‰∏äË®ò„ÅÆ„Éá„Éº„Çø„ÇíÂàÜÊûê„Åó„ÄÅ**ÂÖ±ÈÄö„ÉÜ„Çπ„ÉàÊú¨Áï™„Åß„ÅÆÂæóÁÇπÁéá**„Çí‰∫àÊ∏¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠îÂΩ¢Âºè

### 1. ÁßëÁõÆÂà•„ÅÆÂæóÁÇπ‰∫àÊ∏¨

ÂêÑÁßëÁõÆ„Å´„Å§„ÅÑ„Å¶„ÄÅ‰ª•‰∏ã„ÅÆ3„Éë„Çø„Éº„É≥„Åß‰∫àÊ∏¨„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

| ÁßëÁõÆ | ÊÇ≤Ë¶≥ÁöÑ | ÁèæÂÆüÁöÑ | Ê•ΩË¶≥ÁöÑ | ‰∫àÊ∏¨Ê†πÊã† |
|------|--------|--------|--------|----------|
| Ëã±Ë™û | ‚óã‚óã% | ‚óã‚óã% | ‚óã‚óã% | ... |
| Êï∞Â≠¶ | ‚óã‚óã% | ‚óã‚óã% | ‚óã‚óã% | ... |
| ÂõΩË™û | ‚óã‚óã% | ‚óã‚óã% | ‚óã‚óã% | ... |
| ... | ... | ... | ... | ... |

- **ÊÇ≤Ë¶≥ÁöÑ**: Ëã¶ÊâãÂàÜÈáé„ÅåÂá∫È°å„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ‰ΩìË™ø‰∏çËâØ„ÅÆÂ†¥Âêà„Å™„Å©
- **ÁèæÂÆüÁöÑ**: ÁèæÂú®„ÅÆÂÆüÂäõ„Åå„Åù„ÅÆ„Åæ„ÅæÁô∫ÊèÆ„Åï„Çå„ÅüÂ†¥Âêà
- **Ê•ΩË¶≥ÁöÑ**: ÂæóÊÑèÂàÜÈáé„ÅåÂá∫È°å„Åï„Çå„ÄÅÂÆüÂäõ‰ª•‰∏ä„ÇíÁô∫ÊèÆ„Åó„ÅüÂ†¥Âêà

### 2. Á∑èÂêàÂæóÁÇπ„ÅÆ‰∫àÊ∏¨

- ÊÇ≤Ë¶≥ÁöÑ„Ç∑„Éä„É™„Ç™: ‚óã‚óã‚óãÁÇπ / ‚óã‚óã‚óãÁÇπÔºà‚óã‚óã%Ôºâ
- ÁèæÂÆüÁöÑ„Ç∑„Éä„É™„Ç™: ‚óã‚óã‚óãÁÇπ / ‚óã‚óã‚óãÁÇπÔºà‚óã‚óã%Ôºâ
- Ê•ΩË¶≥ÁöÑ„Ç∑„Éä„É™„Ç™: ‚óã‚óã‚óãÁÇπ / ‚óã‚óã‚óãÁÇπÔºà‚óã‚óã%Ôºâ

### 3. ‰∫àÊ∏¨„ÅÆÊ†πÊã†

- „Éá„Éº„Çø„Åã„ÇâË™≠„ÅøÂèñ„Çå„ÇãÂÇæÂêë
- ÊÆã„Çä${daysUntil}Êó•„Åß„ÅÆ‰º∏„Å≥„Åó„Çç„ÅÆÊé®ÂÆö
- ‰∫àÊ∏¨„ÅÆ‰ø°È†ºÂ∫¶Ôºà„Éá„Éº„ÇøÈáè„Å´Âü∫„Å•„ÅèÔºâ

### 4. ÁõÆÊ®ôÈÅîÊàê„ÅÆÂèØËÉΩÊÄß

- ÁõÆÊ®ôÂæóÁÇπÁéá„Å∏„ÅÆÂà∞ÈÅîÂèØËÉΩÊÄßÔºà%Ôºâ
- ÊúÄ‰Ωé„É©„Ç§„É≥Á™ÅÁ†¥„ÅÆÂèØËÉΩÊÄßÔºà%Ôºâ
- ÈÅîÊàê„Å´ÂøÖË¶Å„Å™Êù°‰ª∂

### 5. ‰∏äÊåØ„Çå„Éª‰∏ãÊåØ„ÇåË¶ÅÂõ†

**‰∏äÊåØ„Çå„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„ÇãÂ†¥Âêà**:
- ...

**‰∏ãÊåØ„Çå„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„ÇãÂ†¥Âêà**:
- ...

### 6. ÊÆã„Çä${daysUntil}Êó•„ÅßÁÇπÊï∞„Çí‰∏ä„Åí„Çã„Åü„ÇÅ„ÅÆÊèêÊ°à

ÂÑ™ÂÖàÂ∫¶„ÅÆÈ´ò„ÅÑÈ†Ü„Å´„ÄÅÂÖ∑‰ΩìÁöÑ„Å™ÂØæÁ≠ñ„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
      
      return p;
    }
    
    // ==========================================
    // ÈÅéÂéªÂïèÊà¶Áï•„Éó„É≠„É≥„Éó„ÉàÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ
    // ==========================================
    
    function generateRedbookPrompt(a) {
      const { profile, daysUntil, redbookAnalysis, redbookLogs, goalAnalysis } = a;
      
      if (redbookLogs.length === 0) {
        return `ÈÅéÂéªÂïèÊºîÁøí„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ

„Åæ„ÅöÈÅéÂéªÂïè„ÇíËß£„ÅÑ„Å¶Ë®òÈå≤„Çí„Å§„Åë„Å¶„Åã„Çâ„ÄÅ„Åì„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ

ÈÅéÂéªÂïèÊºîÁøí„ÇíË®òÈå≤„Åô„ÇãÈöõ„ÅØÔºö
1. Â§ßÂ≠¶Âêç„ÉªÁßëÁõÆ„ÉªÂπ¥Â∫¶
2. ÂæóÁÇπ„Å®ÈÖçÁÇπ
3. Ëß£Á≠îÊôÇÈñì
4. Â§ßÂïè„Åî„Å®„ÅÆÂæóÁÇπ
5. ÈñìÈÅï„Åà„ÅüÂàÜÈáé

„Åì„Çå„Çâ„ÇíË®òÈå≤„Åó„Å¶„Åä„Åè„Å®„ÄÅ„Çà„ÇäÁ≤æÂ∫¶„ÅÆÈ´ò„ÅÑÊà¶Áï•„ÇíÁ´ã„Å¶„Çâ„Çå„Åæ„Åô„ÄÇ`;
      }
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂ§ßÂ≠¶ÂèóÈ®ì„ÅÆÈÅéÂéªÂïèÂàÜÊûê„ÅÆ„Ç®„Ç≠„Çπ„Éë„Éº„Éà„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÈÅéÂéªÂïèÊºîÁøí„Éá„Éº„Çø„ÇíË©≥Á¥∞„Å´ÂàÜÊûê„Åó„ÄÅÊú¨Áï™„ÅßÊúÄÂ§ßÈôê„ÅÆÂæóÁÇπ„ÇíÂèñ„Çã„Åü„ÇÅ„ÅÆÊà¶Áï•„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üìã Âü∫Êú¨ÊÉÖÂ†±

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}
**Ë©¶È®ì„Åæ„Åß**: ${daysUntil}Êó•
**ÈÅéÂéªÂïèÊºîÁøíÂõûÊï∞**: ${redbookAnalysis.totalAttempts}Âõû
**Á∑èÊºîÁøíÊôÇÈñì**: ${formatMinutes(redbookAnalysis.totalTime)}
**Âπ≥ÂùáÂæóÁÇπÁéá**: ${redbookAnalysis.avgScore}%

---

# üìä ÈÅéÂéªÂïèÊºîÁøí„ÅÆÂÖ®Ë®òÈå≤

`;
      
      // Êó•‰ªòÈ†Ü„Å´Ë©≥Á¥∞„ÇíË°®Á§∫
      const sortedLogs = [...redbookLogs].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sortedLogs.forEach((log, index) => {
        const scoreIcon = log.score >= 70 ? 'üü¢' : log.score >= 50 ? 'üü°' : 'üî¥';
        p += `## ${index + 1}. ${log.university} ${log.subject || ''} ${log.year}Âπ¥Ôºà${log.date}Ôºâ\n\n`;
        p += `- ÂæóÁÇπÁéá: ${scoreIcon} **${log.score}%**\n`;
        if (log.time) p += `- Ëß£Á≠îÊôÇÈñì: **${log.time}ÂàÜ**\n`;
        if (log.sectionScores) {
          p += `- Â§ßÂïèÂà•ÂæóÁÇπ:\n`;
          log.sectionScores.split(',').forEach(section => {
            const match = section.trim().match(/(.+?):(\d+)\/(\d+)(?:\((\d+)ÂàÜ\))?/);
            if (match) {
              const [, name, got, max, time] = match;
              const rate = max > 0 ? Math.round((parseInt(got) / parseInt(max)) * 100) : 0;
              const rateIcon = rate >= 70 ? 'üü¢' : rate >= 50 ? 'üü°' : 'üî¥';
              p += `  - ${name}: ${got}/${max}ÁÇπÔºà${rate}%Ôºâ${rateIcon}`;
              if (time) p += ` [${time}ÂàÜ]`;
              p += `\n`;
            }
          });
        }
        if (log.weakAreas) p += `- ‚ö†Ô∏è ÈñìÈÅï„Åà„ÅüÂàÜÈáé: **${log.weakAreas}**\n`;
        if (log.memo) p += `- ÊåØ„ÇäËøî„Çä: ${log.memo}\n`;
        p += `\n`;
      });
      
      // Â§ßÂïèÂà•ÂàÜÊûê
      if (Object.keys(redbookAnalysis.sectionAnalysis).length > 0) {
        p += `# üìù Â§ßÂïèÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂàÜÊûê\n\n`;
        p += `| Â§ßÂïè | Âπ≥ÂùáÂæóÁÇπÁéá | ÊºîÁøíÂõûÊï∞ | Âπ≥ÂùáÊôÇÈñì |\n`;
        p += `|------|-----------|----------|----------|\n`;
        
        const sortedSections = Object.entries(redbookAnalysis.sectionAnalysis)
          .sort((a, b) => a[1].avgScore - b[1].avgScore);
        
        sortedSections.forEach(([name, data]) => {
          const icon = data.avgScore >= 70 ? 'üü¢' : data.avgScore >= 50 ? 'üü°' : 'üî¥';
          const timeStr = data.avgTime ? `${data.avgTime}ÂàÜ` : '-';
          p += `| ${name} | ${icon} ${data.avgScore}% | ${data.attempts}Âõû | ${timeStr} |\n`;
        });
        
        // Ëã¶ÊâãÂ§ßÂïè„ÅÆÁâπÂÆö
        const weakSections = sortedSections.filter(([, d]) => d.avgScore < 50);
        if (weakSections.length > 0) {
          p += `\n**‚ö†Ô∏è Ë¶ÅÂØæÁ≠ñ„ÅÆÂ§ßÂïè**: ${weakSections.map(([n]) => n).join('„ÄÅ')}\n`;
        }
        p += `\n`;
      }
      
      // Â§ßÂ≠¶Âà•ÂàÜÊûê
      if (Object.keys(redbookAnalysis.universityAnalysis).length > 0) {
        p += `# üè´ Â§ßÂ≠¶Âà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ\n\n`;
        
        Object.entries(redbookAnalysis.universityAnalysis).forEach(([uni, data]) => {
          const trendIcon = data.trend === 'improving' ? 'üìà' : data.trend === 'declining' ? 'üìâ' : '‚û°Ô∏è';
          p += `## ${uni} ${trendIcon}\n\n`;
          p += `- ÊºîÁøíÂõûÊï∞: ${data.attempts}Âõû\n`;
          p += `- Âπ≥ÂùáÂæóÁÇπÁéá: **${data.avgScore}%**ÔºàÊúÄÈ´ò${data.highScore}% / ÊúÄ‰Ωé${data.lowScore}%Ôºâ\n`;
          if (data.avgTime) p += `- Âπ≥ÂùáËß£Á≠îÊôÇÈñì: ${data.avgTime}ÂàÜ\n`;
          
          // ÁßëÁõÆÂà•
          if (Object.keys(data.bySubject).length > 0) {
            p += `- ÁßëÁõÆÂà•:\n`;
            Object.entries(data.bySubject).forEach(([subj, subjData]) => {
              p += `  - ${subj}: ${subjData.avgScore}%Ôºà${subjData.attempts}ÂõûÔºâ`;
              if (subjData.weakAreas.length > 0) {
                p += ` ‚Üê Ëã¶Êâã: ${subjData.weakAreas.slice(0, 3).join('„ÄÅ')}`;
              }
              p += `\n`;
            });
          }
          p += `\n`;
        });
      }
      
      // Ëã¶ÊâãÂàÜÈáé„É©„É≥„Ç≠„É≥„Ç∞
      if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
        p += `# üî¥ Áπ∞„ÇäËøî„ÅóÈñìÈÅï„Åà„ÇãÂàÜÈáéÔºàÊ∑±ÂàªÂ∫¶È†ÜÔºâ\n\n`;
        
        const sorted = Object.entries(redbookAnalysis.weakAreasSummary)
          .sort((a, b) => b[1] - a[1]);
        
        sorted.forEach(([area, count], index) => {
          const severity = count >= 3 ? 'üî¥ ÊúÄÂÑ™ÂÖà' : count >= 2 ? 'üü° Ë¶ÅÂØæÁ≠ñ' : 'üü¢ Ê≥®ÊÑè';
          p += `${index + 1}. **${area}**Ôºà${count}ÂõûÔºâ- ${severity}\n`;
        });
        p += `\n`;
      }
      
      // ÊúàÂà•ÈÄ≤Êçó
      if (Object.keys(redbookAnalysis.monthlyProgress).length > 1) {
        p += `# üìà ÊúàÂà•ÊºîÁøíÁä∂Ê≥Å\n\n`;
        p += `| Êúà | ÊºîÁøíÂõûÊï∞ | Âπ≥ÂùáÂæóÁÇπÁéá | ÊºîÁøíÊôÇÈñì |\n`;
        p += `|-----|---------|-----------|----------|\n`;
        
        Object.entries(redbookAnalysis.monthlyProgress)
          .sort((a, b) => a[0].localeCompare(b[0]))
          .forEach(([month, data]) => {
            p += `| ${month} | ${data.attempts}Âõû | ${data.avgScore}% | ${formatMinutes(data.totalTime)} |\n`;
          });
        p += `\n`;
      }
      
      p += `---

# üéØ ÂàÜÊûê„É™„ÇØ„Ç®„Çπ„Éà

‰∏äË®ò„ÅÆÈÅéÂéªÂïèÊºîÁøí„Éá„Éº„Çø„ÇíÂàÜÊûê„Åó„ÄÅÊú¨Áï™„ÅßÊúÄÂ§ßÈôê„ÅÆÂæóÁÇπ„ÇíÂèñ„Çã„Åü„ÇÅ„ÅÆÊà¶Áï•„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

### 1. ÁèæÁä∂„ÅÆÁ∑èÂêàË©ï‰æ°

- ÈÅéÂéªÂïèÊºîÁøí„ÅÆÈáè„ÅØÂçÅÂàÜ„Åã
- ÂæóÁÇπÂÇæÂêë„Åã„ÇâË¶ã„Åà„ÇãÂº∑„Åø„ÉªÂº±„Åø
- ÊôÇÈñìÈÖçÂàÜ„ÅÆÂÇæÂêë

### 2. Â§ßÂïèÂà•„ÅÆÊà¶Áï•

ÂêÑÂ§ßÂïè„Å´„Å§„ÅÑ„Å¶Ôºö
- ÂæóÁÇπ„Çí‰º∏„Å∞„Åó„ÇÑ„Åô„ÅÑÂ§ßÂïèÔºàÈõÜ‰∏≠ÂØæÁ≠ñ„Åô„Åπ„ÅçÔºâ
- ÁèæÁä∂Á∂≠ÊåÅ„ÅßOK„ÅÆÂ§ßÂïè
- ÊÄù„ÅÑÂàá„Å£„Å¶Êç®„Å¶„Çã„Åì„Å®„ÇíÊ§úË®é„Åô„Åπ„ÅçÂ§ßÂïè

### 3. ÊôÇÈñìÈÖçÂàÜ„ÅÆÊèêÊ°à

- ÂêÑÂ§ßÂïè„Å∏„ÅÆÊé®Â•®ÊôÇÈñìÈÖçÂàÜ
- Ëß£„ÅèÈ†ÜÁï™„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ
- Ë¶ãÁõ¥„ÅóÊôÇÈñì„ÅÆÁ¢∫‰øùÊñπÊ≥ï

### 4. Ëã¶ÊâãÂàÜÈáé„ÅÆÂÖãÊúç„Éó„É©„É≥

ÂÑ™ÂÖàÂ∫¶„ÅÆÈ´ò„ÅÑÈ†Ü„Å´Ôºö
- ÂÖ∑‰ΩìÁöÑ„Å™ÂØæÁ≠ñÊñπÊ≥ï
- ‰Ωø„ÅÜ„Åπ„ÅçÊïôÊùê
- ÂøÖË¶Å„Å™Â≠¶ÁøíÊôÇÈñì„ÅÆÁõÆÂÆâ

### 5. ÊÆã„Çä${daysUntil}Êó•„ÅÆÈÅéÂéªÂïèÊºîÁøíË®àÁîª

- ‰ΩïÂπ¥ÂàÜ„Çí„Å©„ÅÆÈ†ÜÁï™„ÅßËß£„Åè„Åπ„Åç„Åã
- Âæ©Áøí„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞
- Áõ¥ÂâçÊúü„ÅÆ‰ªï‰∏ä„ÅíÊñπ`;
      
      return p;
    }
    
    // ==========================================
    // Â§ßÂ≠¶Âà•ÂØæÁ≠ñ„Éó„É≠„É≥„Éó„ÉàÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ
    // ==========================================
    
    function generateUniversityPrompt(a) {
      const selectedUniversity = document.getElementById('aiUniversitySelect').value;
      if (!selectedUniversity) {
        return '‚Üë‰∏ä„ÅÆ„ÄåÂØæÁ≠ñ„Åó„Åü„ÅÑÂ§ßÂ≠¶„Äç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\nÈÅéÂéªÂïèÊºîÁøí„ÅÆË®òÈå≤„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Åæ„ÅöÈÅéÂéªÂïè„ÇíËß£„ÅÑ„Å¶Ë®òÈå≤„Çí„Å§„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      }
      
      const { profile, daysUntil, redbookAnalysis, redbookLogs, subjectAnalysis, goalAnalysis } = a;
      const uniData = redbookAnalysis.universityAnalysis[selectedUniversity];
      
      if (!uniData) {
        return `„Äå${selectedUniversity}„Äç„ÅÆÈÅéÂéªÂïèÊºîÁøíË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\n\n„Åæ„ÅöÈÅéÂéªÂïè„ÇíËß£„ÅÑ„Å¶Ë®òÈå≤„Çí„Å§„Åë„Å¶„Åã„Çâ„ÄÅ„Åì„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ`;
      }
      
      const uniLogs = redbookLogs.filter(l => l.university === selectedUniversity);
      const sortedLogs = [...uniLogs].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      let p = `„ÅÇ„Å™„Åü„ÅØ„Äå${selectedUniversity}„Äç„ÅÆÂÖ•Ë©¶ÂØæÁ≠ñ„Å´Á≤æÈÄö„Åó„ÅüÂèóÈ®ì„Ç≥„Éº„ÉÅ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Éá„Éº„Çø„ÇíÂàÜÊûê„Åó„ÄÅ„Åì„ÅÆÂ§ßÂ≠¶„Å´ÂêàÊ†º„Åô„Çã„Åü„ÇÅ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™Êà¶Áï•„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üìã Âü∫Êú¨ÊÉÖÂ†±

**ÂØæË±°Â§ßÂ≠¶**: ${selectedUniversity}
**ÂøóÊúõÈ†Ü‰Ωç**: ${profile['Á¨¨1ÂøóÊúõ'] === selectedUniversity ? 'Á¨¨1ÂøóÊúõ ‚≠ê' : profile['Á¨¨2ÂøóÊúõ'] === selectedUniversity ? 'Á¨¨2ÂøóÊúõ' : profile['Á¨¨3ÂøóÊúõ'] === selectedUniversity ? 'Á¨¨3ÂøóÊúõ' : 'ÂøóÊúõÊ†°'}
**Ë©¶È®ì„Åæ„Åß**: ${daysUntil}Êó•

---

# üìä ${selectedUniversity}„ÅÆÊºîÁøíÊàêÁ∏æ

**ÊºîÁøíÂõûÊï∞**: ${uniData.attempts}Âõû
**Âπ≥ÂùáÂæóÁÇπÁéá**: ${uniData.avgScore}%
**ÊúÄÈ´òÂæóÁÇπ**: ${uniData.highScore}%
**ÊúÄ‰ΩéÂæóÁÇπ**: ${uniData.lowScore}%
**ÂÇæÂêë**: ${uniData.trend === 'improving' ? 'üìà ‰∏äÊòá‰∏≠ÔºàËâØ„ÅÑÂÇæÂêëÔºâ' : uniData.trend === 'declining' ? 'üìâ ‰∏ãÈôçÊ∞óÂë≥ÔºàË¶ÅÊ≥®ÊÑèÔºâ' : '‚û°Ô∏è ÂÆâÂÆö'}
${uniData.avgTime ? `**Âπ≥ÂùáËß£Á≠îÊôÇÈñì**: ${uniData.avgTime}ÂàÜ` : ''}

`;
      
      // ÁßëÁõÆÂà•ÊàêÁ∏æ
      if (Object.keys(uniData.bySubject).length > 0) {
        p += `## ÁßëÁõÆÂà•ÊàêÁ∏æ\n\n`;
        p += `| ÁßëÁõÆ | Âπ≥ÂùáÂæóÁÇπÁéá | ÊºîÁøíÂõûÊï∞ | Ëã¶ÊâãÂàÜÈáé |\n`;
        p += `|------|-----------|----------|----------|\n`;
        
        Object.entries(uniData.bySubject).forEach(([subj, data]) => {
          const icon = data.avgScore >= 70 ? 'üü¢' : data.avgScore >= 50 ? 'üü°' : 'üî¥';
          const weakStr = data.weakAreas.length > 0 ? data.weakAreas.slice(0, 2).join('„ÄÅ') : '-';
          p += `| ${subj} | ${icon} ${data.avgScore}% | ${data.attempts}Âõû | ${weakStr} |\n`;
        });
        p += `\n`;
      }
      
      // ÂÖ®ÊºîÁøíË®òÈå≤
      p += `## ÊºîÁøíÂ±•Ê≠¥ÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ\n\n`;
      
      sortedLogs.forEach((log, index) => {
        const scoreIcon = log.score >= 70 ? 'üü¢' : log.score >= 50 ? 'üü°' : 'üî¥';
        p += `### ${index + 1}. ${log.subject || 'Á∑èÂêà'} ${log.year}Âπ¥Ôºà${log.date}Ôºâ\n\n`;
        p += `- ÂæóÁÇπÁéá: ${scoreIcon} **${log.score}%**\n`;
        if (log.time) p += `- Ëß£Á≠îÊôÇÈñì: ${log.time}ÂàÜ\n`;
        
        if (log.sectionScores) {
          p += `- Â§ßÂïèÂà•:\n`;
          log.sectionScores.split(',').forEach(section => {
            const match = section.trim().match(/(.+?):(\d+)\/(\d+)(?:\((\d+)ÂàÜ\))?/);
            if (match) {
              const [, name, got, max, time] = match;
              const rate = max > 0 ? Math.round((parseInt(got) / parseInt(max)) * 100) : 0;
              const rateIcon = rate >= 70 ? 'üü¢' : rate >= 50 ? 'üü°' : 'üî¥';
              p += `  - ${name}: ${got}/${max}Ôºà${rate}%Ôºâ${rateIcon}`;
              if (time) p += ` [${time}ÂàÜ]`;
              p += `\n`;
            }
          });
        }
        
        if (log.weakAreas) p += `- ‚ö†Ô∏è ÈñìÈÅï„Åà„ÅüÂàÜÈáé: ${log.weakAreas}\n`;
        if (log.memo) p += `- „É°„É¢: ${log.memo}\n`;
        p += `\n`;
      });
      
      // Ëã¶ÊâãÂàÜÈáéÈõÜË®à
      const uniWeakAreas = {};
      uniLogs.forEach(log => {
        if (log.weakAreas) {
          log.weakAreas.split(/[,„ÄÅ]/).forEach(area => {
            const trimmed = area.trim();
            if (trimmed) {
              uniWeakAreas[trimmed] = (uniWeakAreas[trimmed] || 0) + 1;
            }
          });
        }
      });
      
      if (Object.keys(uniWeakAreas).length > 0) {
        p += `## ‚ö†Ô∏è „Åì„ÅÆÂ§ßÂ≠¶„Åß„Çà„ÅèÈñìÈÅï„Åà„ÇãÂàÜÈáé\n\n`;
        
        Object.entries(uniWeakAreas)
          .sort((a, b) => b[1] - a[1])
          .forEach(([area, count]) => {
            const severity = count >= 2 ? 'üî¥ ÊúÄÂÑ™ÂÖà' : 'üü° Ë¶ÅÂØæÁ≠ñ';
            p += `- **${area}**Ôºà${count}ÂõûÔºâ- ${severity}\n`;
          });
        p += `\n`;
      }
      
      // Èñ¢ÈÄ£„Åô„ÇãÂ≠¶Áøí„Éá„Éº„Çø
      p += `## üìö Èñ¢ÈÄ£„Åô„ÇãÂ≠¶ÁøíÁä∂Ê≥Å\n\n`;
      
      Object.keys(uniData.bySubject).forEach(subj => {
        const cat = categorizeSubject(subj);
        const studyData = subjectAnalysis[cat];
        if (studyData) {
          p += `### ${cat}\n`;
          p += `- Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì: ${formatMinutes(studyData.totalMinutes)}\n`;
          p += `- ‰ªäÈÄ±„ÅÆÂ≠¶ÁøíÊôÇÈñì: ${formatMinutes(studyData.weekMinutes)}\n`;
          p += `- Â≠¶ÁøíÂõûÊï∞: ${studyData.sessionCount}Âõû\n\n`;
        }
      });
      
      // ÁõÆÊ®ô„Å®„ÅÆÊØîËºÉ
      const relevantGoal = goalAnalysis.find(g => 
        Object.keys(uniData.bySubject).some(s => categorizeSubject(s) === g.subject)
      );
      
      if (relevantGoal || goalAnalysis.length > 0) {
        p += `## üéØ ÁõÆÊ®ôË®≠ÂÆö\n\n`;
        goalAnalysis.forEach(g => {
          const icon = g.feasibility === 'likely' ? 'üü¢' : g.feasibility === 'possible' ? 'üü°' : 'üî¥';
          p += `- ${g.subject}: ÁèæÁä∂${g.current}% ‚Üí ÁõÆÊ®ô${g.target}%Ôºà+${g.gap}ptÂøÖË¶ÅÔºâ${icon}\n`;
        });
        p += `\n`;
      }
      
      p += `---

# üéØ ÂàÜÊûê„É™„ÇØ„Ç®„Çπ„Éà

„Äå${selectedUniversity}„Äç„Å´ÂêàÊ†º„Åô„Çã„Åü„ÇÅ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™Êà¶Áï•„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

### 1. ÁèæÁä∂„ÅÆÂêàÊ†ºÂèØËÉΩÊÄß

- ÁèæÂú®„ÅÆÊºîÁøíÊàêÁ∏æ„Åã„ÇâË¶ã„ÅüÂêàÊ†ºÂèØËÉΩÊÄß
- ‰º∏„Å≥„Åó„Çç„ÅÆ„ÅÇ„ÇãÁßëÁõÆ„ÉªÂàÜÈáé
- Âç±Èô∫‰ø°Âè∑„ÅåÂá∫„Å¶„ÅÑ„ÇãÁÇπ

### 2. ${selectedUniversity}„ÅÆÂÖ•Ë©¶ÂÇæÂêëÂàÜÊûê

- Âá∫È°åÂÇæÂêë„ÅÆÁâπÂæ¥Ôºà„Çè„Åã„ÇãÁØÑÂõ≤„ÅßÔºâ
- ÈÖçÁÇπ„ÅÆÈáç„Åø
- ÂêàÊ†ºÊúÄ‰ΩéÁÇπ„ÅÆÁõÆÂÆâ

### 3. ÁßëÁõÆÂà•„ÅÆÂØæÁ≠ñÊñπÈáù

ÂêÑÁßëÁõÆ„Å´„Å§„ÅÑ„Å¶Ôºö
- ÁõÆÊ®ôÂæóÁÇπÁéá
- ÂÑ™ÂÖà„Åó„Å¶ÂØæÁ≠ñ„Åô„Åπ„ÅçÂàÜÈáé
- ÂäπÊûúÁöÑ„Å™Â≠¶ÁøíÊñπÊ≥ï

### 4. ÊôÇÈñìÈÖçÂàÜ„ÉªËß£Á≠îÊà¶Áï•

- Êé®Â•®„Åô„ÇãËß£Á≠îÈ†ÜÂ∫è
- ÂêÑÂ§ßÂïè„Å∏„ÅÆÊôÇÈñìÈÖçÂàÜ
- Âèñ„Çã„Åπ„ÅçÂïèÈ°å„ÉªÊç®„Å¶„ÇãÂïèÈ°å„ÅÆÂà§Êñ≠Âü∫Ê∫ñ

### 5. ÊÆã„Çä${daysUntil}Êó•„ÅÆÂØæÁ≠ñ„Éó„É©„É≥

- ÈÄ±„Åî„Å®„ÅÆ„Éû„Ç§„É´„Çπ„Éà„Éº„É≥
- „ÇÑ„Çã„Åπ„Åç„Åì„Å®„ÅÆÂÑ™ÂÖàÈ†Ü‰Ωç
- Áõ¥ÂâçÊúü„ÅÆ‰ªï‰∏ä„ÅíÊñπ

### 6. ÂΩìÊó•„ÅÆ„É°„É≥„Çø„É´„ÉªÊà¶Áï•„Ç¢„Éâ„Éê„Ç§„Çπ

- Ë©¶È®ìÂΩìÊó•„ÅÆÂøÉÊßã„Åà
- ÊÉ≥ÂÆöÂ§ñ„ÅÆ‰∫ãÊÖã„Å∏„ÅÆÂØæÂá¶Ê≥ï`;
      
      return p;
    }
    
    // ==========================================
    // Â§ßÂïèÂà•ÊîªÁï•„Éó„É≠„É≥„Éó„Éà
    // ==========================================
    
    function generateSectionPrompt(a) {
      const { profile, daysUntil, redbookLogs, redbookAnalysis } = a;
      
      // Â§ßÂïèÂà•„ÅÆ„Éá„Éº„Çø„ÇíËß£Êûê
      const sectionData = {};
      
      redbookLogs.forEach(log => {
        if (!log.sectionScores) return;
        
        const subject = log.subject || '‰∏çÊòé';
        if (!sectionData[subject]) {
          sectionData[subject] = {};
        }
        
        // Â§ßÂïèÂà•„Çπ„Ç≥„Ç¢„Çí„Éë„Éº„ÇπÔºà‰æã: "Â§ßÂïè1:15/20(10ÂàÜ), Â§ßÂïè2:20/30(15ÂàÜ)"Ôºâ
        const sections = log.sectionScores.split(/[,„ÄÅ]/).map(s => s.trim());
        sections.forEach(section => {
          const match = section.match(/(.+?):(\d+)\/(\d+)(?:\((\d+)ÂàÜ?\))?/);
          if (match) {
            const [, name, got, max, time] = match;
            if (!sectionData[subject][name]) {
              sectionData[subject][name] = { scores: [], times: [], maxScores: [] };
            }
            const rate = Math.round((parseInt(got) / parseInt(max)) * 100);
            sectionData[subject][name].scores.push(rate);
            sectionData[subject][name].maxScores.push(parseInt(max));
            if (time) sectionData[subject][name].times.push(parseInt(time));
          }
        });
      });
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂ§ßÂ≠¶ÂÖ•Ë©¶ÂïèÈ°å„ÅÆÂàÜÊûê„Ç®„Ç≠„Çπ„Éë„Éº„Éà„Åß„Åô„ÄÇÂ§ßÂïè„Åî„Å®„ÅÆÂÇæÂêë„ÇíÂàÜÊûê„Åó„ÄÅÊîªÁï•Ê≥ï„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üìã Âü∫Êú¨ÊÉÖÂ†±

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}
**Ë©¶È®ì„Åæ„Åß**: ${daysUntil}Êó•
**ÈÅéÂéªÂïèÊºîÁøíÂõûÊï∞**: ${redbookAnalysis.totalAttempts}Âõû

---

# üß© Â§ßÂïèÂà•„ÅÆÂæóÁÇπÂàÜÊûê

`;
      
      if (Object.keys(sectionData).length === 0) {
        p += `‚ÄªÂ§ßÂïèÂà•„ÅÆ„Éá„Éº„Çø„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇËµ§Êú¨„Éï„Ç©„Éº„É†„ÅßÂ§ßÂïè„Åî„Å®„ÅÆÂæóÁÇπ„ÇíÂÖ•Âäõ„Åô„Çã„Å®„ÄÅË©≥Á¥∞„Å™ÂàÜÊûê„Åå„Åß„Åç„Åæ„Åô„ÄÇ\n\n`;
      } else {
        Object.entries(sectionData).forEach(([subject, sections]) => {
          p += `## ${subject}\n\n`;
          p += `| Â§ßÂïè | Âπ≥ÂùáÂæóÁÇπÁéá | ÈÖçÁÇπÁõÆÂÆâ | Âπ≥ÂùáÊôÇÈñì | ÂÆâÂÆöÂ∫¶ | Âà§ÂÆö |\n`;
          p += `|------|------------|----------|----------|--------|------|\n`;
          
          const sectionAnalysis = [];
          Object.entries(sections).forEach(([name, data]) => {
            const avgScore = Math.round(data.scores.reduce((a, b) => a + b, 0) / data.scores.length);
            const avgMax = Math.round(data.maxScores.reduce((a, b) => a + b, 0) / data.maxScores.length);
            const avgTime = data.times.length > 0 
              ? Math.round(data.times.reduce((a, b) => a + b, 0) / data.times.length) + 'ÂàÜ'
              : '-';
            
            const variance = data.scores.length > 1
              ? data.scores.reduce((sum, s) => sum + Math.pow(s - avgScore, 2), 0) / data.scores.length
              : 0;
            const stability = variance < 100 ? 'ÂÆâÂÆö' : variance < 400 ? '„ÇÑ„ÇÑ‰∏çÂÆâÂÆö' : '‰∏çÂÆâÂÆö';
            
            const icon = avgScore >= 70 ? 'üü¢ ÂæóÊÑè' : avgScore >= 50 ? 'üü° ÊôÆÈÄö' : 'üî¥ Ëã¶Êâã';
            
            p += `| ${name} | ${avgScore}% | ${avgMax}ÁÇπ | ${avgTime} | ${stability} | ${icon} |\n`;
            
            sectionAnalysis.push({
              name,
              avgScore,
              category: avgScore >= 70 ? 'strong' : avgScore >= 50 ? 'normal' : 'weak'
            });
          });
          
          const strong = sectionAnalysis.filter(s => s.category === 'strong');
          const weak = sectionAnalysis.filter(s => s.category === 'weak');
          
          if (strong.length > 0 || weak.length > 0) {
            p += `\n**Êà¶Áï•„Éù„Ç§„É≥„Éà**:\n`;
            if (strong.length > 0) p += `- ‚úÖ ÂæóÁÇπÊ∫ê: ${strong.map(s => s.name).join('„ÄÅ')}\n`;
            if (weak.length > 0) p += `- ‚ö†Ô∏è Ë¶ÅÂº∑Âåñ: ${weak.map(s => s.name).join('„ÄÅ')}\n`;
          }
          p += `\n`;
        });
      }
      
      if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
        p += `## ‚ö†Ô∏è „Çà„ÅèÈñìÈÅï„Åà„ÇãÂàÜÈáé\n\n`;
        Object.entries(redbookAnalysis.weakAreasSummary)
          .sort((a, b) => b[1] - a[1])
          .forEach(([area, count]) => {
            p += `- **${area}**: ${count}Âõû\n`;
          });
        p += `\n`;
      }
      
      p += `---

# üéØ Áõ∏Ë´áÂÜÖÂÆπ

Â§ßÂïè„Åî„Å®„ÅÆÊîªÁï•Êà¶Áï•„ÇíÁ´ã„Å¶„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

1. **Â§ßÂïèÂà•„ÅÆÂÑ™ÂÖàÈ†Ü‰Ωç** - „Å©„ÅÆÂ§ßÂïè„Åã„ÇâËß£„Åè„Åπ„Åç„Åã„ÄÅÊôÇÈñìÈÖçÂàÜ„ÅÆÁõÆÂÆâ
2. **ÂæóÊÑè„Å™Â§ßÂïè„ÅÆÊ¥ªÁî®Ê≥ï** - Á¢∫ÂÆü„Å´ÂæóÁÇπ„Åô„Çã„Éù„Ç§„É≥„Éà
3. **Ëã¶Êâã„Å™Â§ßÂïè„Å∏„ÅÆÂØæÁ≠ñ** - ÂÖ∑‰ΩìÁöÑ„Å™Â≠¶ÁøíÊñπÊ≥ï„ÄÅÊç®„Å¶Âïè„ÅÆÂà§Êñ≠Âü∫Ê∫ñ
4. **ÊôÇÈñìÁÆ°ÁêÜÊà¶Áï•** - ÂêÑÂ§ßÂïè„ÅÆÁõÆÊ®ôËß£Á≠îÊôÇÈñì
5. **Ë©¶È®ìÂΩìÊó•„ÅÆËß£Á≠îÈ†ÜÂ∫è** - ÊúÄÈÅ©„Å™È†ÜÂ∫è„ÅÆÊèêÊ°à`;
      
      return p;
    }
    
    // ==========================================
    // ÊôÇÈñìÂäπÁéáÂàÜÊûê„Éó„É≠„É≥„Éó„Éà
    // ==========================================
    
    function generateEfficiencyPrompt(a) {
      const { profile, daysUntil, totalMinutes, studyDays,
              subjectAnalysis, redbookLogs } = a;
      
      const efficiencyData = {};
      
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        const studyTime = data.totalMinutes;
        const catLogs = redbookLogs
          .filter(l => categorizeSubject(l.subject) === cat)
          .sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if (studyTime > 0 && catLogs.length >= 2) {
          const firstScore = catLogs[0].score;
          const lastScore = catLogs[catLogs.length - 1].score;
          const growth = lastScore - firstScore;
          const hoursSpent = studyTime / 60;
          const efficiency = growth / hoursSpent;
          
          efficiencyData[cat] = {
            studyTime, hoursSpent, firstScore, lastScore, growth, efficiency,
            attempts: catLogs.length
          };
        } else if (studyTime > 0) {
          efficiencyData[cat] = {
            studyTime, hoursSpent: studyTime / 60,
            firstScore: null, lastScore: catLogs[0]?.score || null,
            growth: null, efficiency: null, attempts: catLogs.length
          };
        }
      });
      
      const typeAnalysis = {};
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        Object.entries(data.typeBreakdown || {}).forEach(([type, minutes]) => {
          if (!typeAnalysis[type]) typeAnalysis[type] = { totalMinutes: 0 };
          typeAnalysis[type].totalMinutes += minutes;
        });
      });
      
      const efficiencyRanking = Object.entries(efficiencyData)
        .filter(([, data]) => data.efficiency !== null)
        .sort((a, b) => b[1].efficiency - a[1].efficiency);
      
      let p = `„ÅÇ„Å™„Åü„ÅØÂ≠¶ÁøíÂäπÁéá„ÅÆÂàÜÊûê„Ç®„Ç≠„Çπ„Éë„Éº„Éà„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Éá„Éº„Çø„Åã„ÇâÊôÇÈñìÂØæÂäπÊûú„ÇíÂàÜÊûê„Åó„ÄÅÂ≠¶ÁøíÂäπÁéá„Çí‰∏ä„Åí„Çã„Ç¢„Éâ„Éê„Ç§„Çπ„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ

---

# üìã Âü∫Êú¨ÊÉÖÂ†±

**ÂøóÊúõÊ†°**: ${profile['Á¨¨1ÂøóÊúõ'] || 'Êú™Ë®≠ÂÆö'}
**Ë©¶È®ì„Åæ„Åß**: ${daysUntil}Êó•
**Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì**: ${formatMinutes(totalMinutes)}ÔºàÁ¥Ñ${Math.round(totalMinutes / 60)}ÊôÇÈñìÔºâ
**Â≠¶ÁøíÊó•Êï∞**: ${studyDays}Êó•
**1Êó•Âπ≥Âùá**: ${studyDays > 0 ? Math.round(totalMinutes / studyDays) : 0}ÂàÜ

---

# ‚è±Ô∏è ÊôÇÈñìÂØæÂäπÊûú„ÅÆÂàÜÊûê

`;
      
      if (efficiencyRanking.length > 0) {
        p += `## ÁßëÁõÆÂà•„ÅÆÂ≠¶ÁøíÂäπÁéá\n\n`;
        p += `| ÁßëÁõÆ | Â≠¶ÁøíÊôÇÈñì | ÊàêÈï∑ | ÂäπÁéá | Âà§ÂÆö |\n`;
        p += `|------|----------|------|------|------|\n`;
        
        efficiencyRanking.forEach(([cat, data]) => {
          const growthStr = data.growth >= 0 ? `+${data.growth}pt` : `${data.growth}pt`;
          const effStr = data.efficiency.toFixed(2) + 'pt/h';
          const rating = data.efficiency > 1 ? 'üü¢ È´òÂäπÁéá' : data.efficiency > 0.3 ? 'üü° ÊôÆÈÄö' : 'üî¥ Ë¶ÅÊîπÂñÑ';
          p += `| ${cat} | ${formatMinutes(data.studyTime)} | ${data.firstScore}%‚Üí${data.lastScore}%Ôºà${growthStr}Ôºâ | ${effStr} | ${rating} |\n`;
        });
        p += `\n`;
        
        if (efficiencyRanking.length >= 2) {
          const best = efficiencyRanking[0];
          const worst = efficiencyRanking[efficiencyRanking.length - 1];
          p += `**ÂäπÁéáÂàÜÊûê„Çµ„Éû„É™„Éº**:\n`;
          p += `- üèÜ ÊúÄ„ÇÇÂäπÁéá„ÅåËâØ„ÅÑ: **${best[0]}**Ôºà${best[1].efficiency.toFixed(2)}pt/ÊôÇÈñìÔºâ\n`;
          p += `- ‚ö†Ô∏è ÂäπÁéáÊîπÂñÑ„ÅåÂøÖË¶Å: **${worst[0]}**Ôºà${worst[1].efficiency.toFixed(2)}pt/ÊôÇÈñìÔºâ\n\n`;
        }
      } else {
        p += `‚ÄªÈÅéÂéªÂïè„ÇíË§áÊï∞ÂõûËß£„Åè„Å®„ÄÅÁßëÁõÆÂà•„ÅÆÂ≠¶ÁøíÂäπÁéá„ÅåÂàÜÊûê„Åß„Åç„Åæ„Åô„ÄÇ\n\n`;
      }
      
      const noDataSubjects = Object.entries(efficiencyData)
        .filter(([, data]) => data.efficiency === null && data.studyTime > 60);
      
      if (noDataSubjects.length > 0) {
        p += `## ‚ö†Ô∏è ÂäπÁéáÊ∏¨ÂÆö„Åß„Åç„Å¶„ÅÑ„Å™„ÅÑÁßëÁõÆ\n\n`;
        noDataSubjects.forEach(([cat, data]) => {
          p += `- **${cat}**: ${formatMinutes(data.studyTime)}Â≠¶ÁøíÊ∏à„Åø ‚Üí ÈÅéÂéªÂïè„ÅßÊàêÊûú„ÇíÊ∏¨ÂÆö„Åó„Åæ„Åó„Çá„ÅÜ\n`;
        });
        p += `\n`;
      }
      
      if (Object.keys(typeAnalysis).length > 0) {
        p += `## üìä Â≠¶Áøí„Çø„Ç§„ÉóÂà•„ÅÆÊôÇÈñìÈÖçÂàÜ\n\n`;
        const sortedTypes = Object.entries(typeAnalysis).sort((a, b) => b[1].totalMinutes - a[1].totalMinutes);
        const totalTypeMinutes = sortedTypes.reduce((sum, [, data]) => sum + data.totalMinutes, 0);
        
        sortedTypes.forEach(([type, data]) => {
          const pct = totalTypeMinutes > 0 ? Math.round((data.totalMinutes / totalTypeMinutes) * 100) : 0;
          const bar = '‚ñà'.repeat(Math.round(pct / 10)) + '‚ñë'.repeat(10 - Math.round(pct / 10));
          p += `- **${type}**: ${bar} ${pct}%Ôºà${formatMinutes(data.totalMinutes)}Ôºâ\n`;
        });
        p += `\n`;
      }
      
      p += `---

# üéØ Áõ∏Ë´áÂÜÖÂÆπ

Â≠¶ÁøíÂäπÁéá„Çí‰∏ä„Åí„Çã„Åü„ÇÅ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ

## ÂõûÁ≠î„Å´Âê´„ÇÅ„Å¶„Åª„Åó„ÅÑ„Åì„Å®

1. **ÁèæÂú®„ÅÆÂ≠¶ÁøíÂäπÁéá„ÅÆË©ï‰æ°** - ÁßëÁõÆ„Åî„Å®„ÅÆÂäπÁéá„ÅØÈÅ©Âàá„Åã
2. **ÂäπÁéá„ÅåÊÇ™„ÅÑÁßëÁõÆ„ÅÆÊîπÂñÑÁ≠ñ** - „Å™„ÅúÂäπÁéá„ÅåÊÇ™„ÅÑ„ÅÆ„Åã„ÄÅ„Å©„ÅÜÊîπÂñÑ„Åô„Åπ„Åç„Åã
3. **Â≠¶Áøí„Çø„Ç§„Éó„ÅÆ„Éê„É©„É≥„Çπ** - „Ç§„É≥„Éó„ÉÉ„Éà„Å®„Ç¢„Ç¶„Éà„Éó„ÉÉ„Éà„ÅÆÊØîÁéá„ÅØÈÅ©Âàá„Åã
4. **ÊôÇÈñìÈÖçÂàÜ„ÅÆÊúÄÈÅ©Âåñ** - ÂêÑÁßëÁõÆ„Å´Ââ≤„Åè„Åπ„ÅçÊôÇÈñì„ÅÆÁõÆÂÆâ
5. **ÊÆã„Çä${daysUntil}Êó•„ÅßÂäπÁéá„ÇíÊúÄÂ§ßÂåñ„Åô„Çã„Ç≥„ÉÑ**`;
      
      return p;
    }
    
    async function copyPrompt() {
      const prompt = document.getElementById('promptPreview').textContent;
      
      try {
        await navigator.clipboard.writeText(prompt);
        showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅAI„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ');
        closeAIModal();
      } catch {
        const textarea = document.createElement('textarea');
        textarea.value = prompt;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
        closeAIModal();
      }
    }
    
    function formatMinutes(minutes) {
      if (minutes < 60) return `${minutes}ÂàÜ`;
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}ÊôÇÈñì${mins}ÂàÜ` : `${hours}ÊôÇÈñì`;
    }
    
    function formatDateShort(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }
    
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }
    
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
