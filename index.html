<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Tracker</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --black: #0a0a0a;
      --gray-900: #171717;
      --gray-800: #262626;
      --gray-700: #404040;
      --gray-600: #525252;
      --gray-500: #737373;
      --gray-400: #a3a3a3;
      --gray-300: #d4d4d4;
      --gray-200: #e5e5e5;
      --gray-100: #f5f5f5;
      --gray-50: #fafafa;
      --white: #ffffff;
      --primary: #5E81AC;
      --primary-dark: #4C6A8E;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 15px;
    }

    body {
      font-family: 'DM Sans', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--white);
      color: var(--gray-900);
      min-height: 100vh;
      line-height: 1.5;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--gray-100);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.125rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--black);
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      font-family: inherit;
      letter-spacing: -0.01em;
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray-600);
    }

    .btn-ghost:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .btn-primary {
      background: var(--black);
      color: var(--white);
    }

    .btn-primary:hover {
      background: var(--gray-800);
    }

    .btn-outline {
      background: var(--white);
      color: var(--gray-900);
      border: 1px solid var(--gray-200);
    }

    .btn-outline:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    /* Main */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.5rem 2rem 6rem;
    }

    /* Hero Section - Simplified */
    .hero {
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .hero-title {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      line-height: 1.2;
      color: var(--black);
      margin-bottom: 0.5rem;
    }

    .hero-subtitle {
      font-size: 0.9375rem;
      color: var(--gray-500);
    }

    @media (max-width: 640px) {
      .hero {
        margin-bottom: 1.25rem;
      }
      .hero-title {
        font-size: 1.5rem;
      }
    }

    /* Stats Row - Redesigned */
    .stats-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 2.5rem;
    }

    .stat-hero {
      background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-800) 100%);
      border-radius: 16px;
      padding: 1.75rem;
      color: var(--white);
      text-align: center;
    }

    .stat-hero .stat-value {
      font-size: 3.5rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      color: var(--white);
      line-height: 1;
      margin-bottom: 0.5rem;
    }

    .stat-hero .stat-label {
      font-size: 0.875rem;
      color: var(--gray-400);
      font-weight: 500;
    }

    .stat-hero .stat-sub {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 0.5rem;
    }

    .stat-actions {
      display: flex;
      gap: 0.625rem;
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid var(--gray-700);
      justify-content: center;
    }

    .stat-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.625rem 1rem;
      background: var(--white);
      color: var(--gray-900);
      border: none;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .stat-action-btn:hover {
      background: var(--gray-100);
      transform: translateY(-1px);
    }

    .stat-action-btn:active {
      transform: translateY(0);
    }

    @media (max-width: 640px) {
      .stat-actions {
        flex-direction: row;
      }
      .stat-action-btn {
        flex: 1;
        justify-content: center;
        padding: 0.75rem 0.875rem;
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    .stats-grid.stats-grid-5 {
      grid-template-columns: repeat(5, 1fr);
    }

    .stat-item {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all 0.2s ease;
    }

    .stat-item:hover {
      border-color: var(--gray-300);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--black);
      margin-bottom: 0.125rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    @media (max-width: 640px) {
      .stat-hero .stat-value {
        font-size: 3rem;
      }
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
      }
      .stats-grid.stats-grid-5 {
        grid-template-columns: repeat(5, 1fr);
      }
      .stat-item {
        padding: 0.75rem 0.5rem;
      }
      .stat-value {
        font-size: 1.25rem;
      }
      .stats-grid.stats-grid-5 .stat-value {
        font-size: 1rem;
      }
      .stats-grid.stats-grid-5 .stat-label {
        font-size: 0.625rem;
      }
    }

    /* Week Overview - Calendar + Chart */
    .week-overview {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .week-calendar-card,
    .week-chart-card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 16px;
      padding: 1.25rem;
    }

    .week-card-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 1rem;
    }

    .week-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .week-day {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.375rem;
    }

    .week-day-label {
      font-size: 0.625rem;
      font-weight: 500;
      color: var(--gray-400);
      text-transform: uppercase;
    }

    .week-day-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--gray-100);
      color: var(--gray-400);
      transition: all 0.2s ease;
    }

    .week-day-circle.studied {
      background: var(--primary);
      color: var(--white);
    }

    .week-day-circle.today {
      border: 2px solid var(--primary);
    }

    .week-day-circle.today.studied {
      border-color: var(--primary-dark);
    }

    .week-day-minutes {
      font-size: 0.625rem;
      color: var(--gray-500);
    }

    .week-chart-container {
      height: 140px;
    }

    @media (max-width: 768px) {
      .week-overview {
        grid-template-columns: 1fr;
      }
      .week-chart-container {
        height: 120px;
      }
    }

    /* Progress Section - Card Style */
    .progress-section {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 2.5rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.875rem;
    }

    .section-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title-icon {
      font-size: 1.125rem;
    }

    .section-value {
      font-size: 0.875rem;
      color: var(--gray-600);
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .progress-track {
      height: 8px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #A3BE8C, #8FBCBB);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Card Title - Enhanced */
    .card-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-title-icon {
      font-size: 1rem;
      opacity: 0.8;
    }

    /* Grid Layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* Card */
    .card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.5rem;
    }

    /* Chart */
    .chart-container {
      position: relative;
      height: 240px;
    }

    /* Goals */
    .goals-list {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .goal-item {
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
    }

    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .goal-name {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--gray-900);
    }

    .goal-values {
      font-size: 0.8125rem;
      color: var(--gray-500);
      font-variant-numeric: tabular-nums;
    }

    .goal-bar {
      height: 6px;
      background: var(--gray-100);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .goal-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .goal-fill.kokugo { background: #EBCB8B; }
    .goal-fill.sugaku { background: #A3BE8C; }
    .goal-fill.joho { background: #B48EAD; }
    .goal-fill.eigo { background: #5E81AC; }

    /* Records - Card Style */
    .records-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .record-item {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      padding: 0.875rem;
      background: var(--gray-50);
      border-radius: 10px;
      transition: background 0.15s ease;
    }

    .record-item:hover {
      background: var(--gray-100);
    }

    .record-main {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
    }

    .record-details {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed var(--gray-200);
    }

    .record-sub-info {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.75rem;
    }

    .record-textbook {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-memo {
      font-size: 0.8125rem;
      color: var(--gray-700);
      background: #FFFBEB;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      border-left: 3px solid #F59E0B;
      line-height: 1.45;
    }

    .record-date {
      font-size: 0.75rem;
      color: var(--gray-400);
      min-width: 50px;
      font-variant-numeric: tabular-nums;
    }

    .record-subject {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--gray-800);
      padding: 0.25rem 0.625rem;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
    }

    .record-type {
      font-size: 0.6875rem;
      color: var(--gray-500);
      padding: 0.125rem 0.5rem;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 3px;
    }

    .record-time {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .record-mood {
      font-size: 1rem;
      opacity: 0.8;
    }

    .record-unit {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    /* Empty State - Enhanced */
    .empty-state {
      padding: 2rem 1.5rem;
      text-align: center;
      background: var(--gray-50);
      border-radius: 12px;
      border: 1px dashed var(--gray-200);
    }

    .empty-state-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.7;
    }

    .empty-state-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.375rem;
    }

    .empty-state-desc {
      font-size: 0.8125rem;
      color: var(--gray-500);
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .empty-state-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.625rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      background: var(--white);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }

    .empty-state-btn:hover {
      border-color: var(--black);
      background: var(--gray-100);
    }

    .empty-state-simple {
      padding: 1.5rem 1rem;
      text-align: center;
      color: var(--gray-400);
      font-size: 0.8125rem;
      background: var(--gray-50);
    }

    /* å¿…é ˆãƒãƒ¼ã‚¯ */
    .required::after {
      content: ' *';
      color: #BF616A;
    }

    /* ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢ */
    .manager-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.875rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      background: var(--white);
    }

    .manager-item:hover {
      background: var(--gray-50);
    }

    .manager-item-info {
      flex: 1;
      min-width: 0;
    }

    .manager-item-main {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      font-size: 0.875rem;
    }

    .manager-item-date {
      color: var(--gray-500);
      font-size: 0.75rem;
    }

    .manager-item-subject {
      font-weight: 600;
      color: var(--gray-700);
    }

    .manager-item-detail {
      color: var(--gray-500);
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    .manager-delete-btn {
      flex-shrink: 0;
      width: 36px;
      height: 36px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      background: var(--white);
      color: var(--gray-400);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      margin-left: 0.75rem;
    }

    .manager-delete-btn:hover {
      background: #fef2f2;
      border-color: #fecaca;
      color: #BF616A;
    }

    .manager-empty {
      text-align: center;
      padding: 2rem;
      color: var(--gray-400);
    }

    /* ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ */
    .chat-header-btn {
      position: relative;
      font-size: 1.25rem;
      padding: 0.5rem 0.75rem;
    }

    .chat-header-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #BF616A;
      color: white;
      font-size: 0.625rem;
      font-weight: 600;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    /* ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« - Enhanced */
    .chat-modal .modal {
      max-width: 480px;
      height: 70vh;
      max-height: 600px;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 640px) {
      .chat-modal .modal {
        width: 100%;
        max-width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
      }
    }

    .chat-modal .modal-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--gray-100);
      flex-shrink: 0;
    }

    .chat-modal .modal-body {
      flex: 1;
      padding: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: var(--gray-50);
    }

    .chat-message {
      max-width: 85%;
      padding: 0.625rem 0.875rem;
      border-radius: 16px;
      font-size: 0.9375rem;
      line-height: 1.45;
      word-wrap: break-word;
    }

    .chat-message.student {
      align-self: flex-end;
      background: var(--black);
      color: var(--white);
      border-bottom-right-radius: 4px;
    }

    .chat-message.admin {
      align-self: flex-start;
      background: var(--white);
      color: var(--gray-800);
      border: 1px solid var(--gray-200);
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    .chat-message-time {
      font-size: 0.6875rem;
      color: var(--gray-400);
      margin-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chat-message.student .chat-message-time {
      color: rgba(255, 255, 255, 0.6);
      justify-content: flex-end;
    }

    .chat-read-status {
      font-size: 0.625rem;
      opacity: 0.8;
    }

    .chat-input-area {
      padding: 0.75rem 1rem;
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 0.5rem;
      background: var(--white);
      flex-shrink: 0;
    }

    .chat-input {
      flex: 1;
      padding: 0.625rem 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 20px;
      font-size: 0.9375rem;
      resize: none;
      max-height: 80px;
      font-family: inherit;
      background: var(--gray-50);
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--gray-400);
      background: var(--white);
    }

    .chat-send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--black);
      color: var(--white);
      border: none;
      font-size: 1.125rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .chat-send-btn:hover {
      background: var(--gray-700);
      transform: scale(1.05);
    }

    .chat-send-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      transform: none;
    }

    .chat-empty {
      text-align: center;
      color: var(--gray-400);
      padding: 3rem 1.5rem;
      font-size: 0.875rem;
    }

    .chat-empty-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.6;
    }

    .chat-date-divider {
      text-align: center;
      font-size: 0.6875rem;
      color: var(--gray-400);
      padding: 0.75rem 0 0.25rem;
      font-weight: 500;
    }

    /* å¿œæ´ãƒãƒŠãƒ¼ - Softer Design */
    .cheer-banner {
      background: var(--gray-900);
      color: white;
      padding: 0.75rem 1rem;
      margin-bottom: 1.25rem;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      animation: bannerFadeIn 0.4s ease;
    }

    @keyframes bannerFadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .cheer-banner-content {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 0.625rem;
    }

    .cheer-banner-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    .cheer-banner-text {
      flex: 1;
      min-width: 0;
    }

    .cheer-banner-message {
      font-size: 0.875rem;
      font-weight: 500;
      line-height: 1.4;
    }

    .cheer-banner-close {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
      flex-shrink: 0;
    }

    .cheer-banner-close:hover {
      background: rgba(255,255,255,0.25);
    }

    /* Insights Section */
    .insights-section {
      margin-bottom: 1.5rem;
    }

    .insights-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .insights-grid {
        grid-template-columns: 1fr;
      }
    }

    .insight-card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1rem;
    }

    .insight-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray-100);
    }

    .insight-icon {
      font-size: 1.125rem;
    }

    .insight-title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--gray-700);
    }

    .insight-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .insight-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.8125rem;
      line-height: 1.4;
      color: var(--gray-700);
      padding: 0.375rem 0;
    }

    .insight-item-icon {
      flex-shrink: 0;
      width: 1.25rem;
      text-align: center;
    }

    .insight-item.positive { color: #059669; }
    .insight-item.warning { color: #D97706; }
    .insight-item.info { color: #2563EB; }

    .recommendation-card {
      background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
      border-color: #86EFAC;
    }

    .recommendation-section {
      margin-bottom: 1.5rem;
    }

    .recommendation-card-solo {
      background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
      border: 1px solid #86EFAC;
      border-radius: 12px;
      padding: 1rem;
    }

    .recommendation-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(34, 197, 94, 0.2);
    }

    .recommendation-header-icon {
      font-size: 1.125rem;
    }

    .recommendation-header-title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--gray-700);
    }

    .recommendation-list {
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
    }

    .recommendation-item {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.625rem 0.75rem;
      background: var(--white);
      border-radius: 8px;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }

    .recommendation-item:hover {
      border-color: #22C55E;
      transform: translateX(2px);
    }

    .recommendation-item-icon {
      font-size: 1rem;
    }

    .recommendation-item-text {
      flex: 1;
      color: var(--gray-700);
    }

    .recommendation-item-reason {
      font-size: 0.6875rem;
      color: var(--gray-500);
    }

    .recommendation-item-arrow {
      color: var(--gray-400);
      font-size: 0.75rem;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      padding: 1rem;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--white);
      border-radius: 16px;
      width: 100%;
      max-width: 440px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px) scale(0.98);
      transition: all 0.2s ease;
    }

    .modal-overlay.active .modal {
      transform: translateY(0) scale(1);
    }

    .modal-header {
      padding: 1.5rem 1.5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--gray-100);
      color: var(--gray-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      font-size: 1rem;
    }

    .modal-close:hover {
      background: var(--gray-200);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 0 1.5rem 1.5rem;
      display: flex;
      gap: 0.75rem;
    }

    .modal-footer .btn {
      flex: 1;
      padding: 0.75rem;
    }

    /* Form */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.9375rem;
      font-family: inherit;
      transition: all 0.15s ease;
      background: var(--white);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--gray-400);
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23737373'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Button Group */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .btn-option {
      padding: 0.5rem 0.875rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      background: var(--white);
      font-size: 0.8125rem;
      font-family: inherit;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-option:hover {
      border-color: var(--gray-300);
      background: var(--gray-50);
    }

    .btn-option.active {
      border-color: var(--black);
      background: var(--black);
      color: var(--white);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transform: scale(1.02);
    }

    /* Mood Buttons */
    .mood-group {
      display: flex;
      gap: 0.5rem;
    }

    .mood-btn {
      width: 44px;
      height: 44px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: var(--white);
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .mood-btn:hover {
      border-color: var(--gray-300);
      transform: scale(1.05);
    }

    .mood-btn.active {
      border-color: var(--black);
      border-width: 2px;
      background: var(--gray-100);
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .version-info {
      text-align: center;
      padding-top: 1rem;
      margin-top: 1rem;
      border-top: 1px solid var(--gray-200);
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    /* Tab Menu - Bottom Nav on Mobile */
    .tab-menu {
      display: flex;
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 60px;
      z-index: 100;
      padding: 0 1rem;
    }

    @media (max-width: 640px) {
      .tab-menu {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        border-bottom: none;
        border-top: 1px solid var(--gray-200);
        padding: 0;
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
    }

    .tab-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.75rem 0.5rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    @media (max-width: 640px) {
      .tab-btn {
        border-bottom: none;
        padding: 0.625rem 0.5rem;
      }
      .tab-btn.active {
        color: var(--black);
        background: var(--gray-50);
      }
    }

    .tab-btn:hover {
      color: var(--gray-700);
      background: var(--gray-50);
    }

    .tab-btn.active {
      color: var(--black);
      border-bottom-color: var(--black);
    }

    .tab-icon {
      font-size: 1.25rem;
    }

    @media (max-width: 640px) {
      .tab-icon {
        font-size: 1.375rem;
      }
    }

    .tab-label {
      font-size: 0.75rem;
      font-weight: 500;
    }

    @media (max-width: 640px) {
      .tab-label {
        font-size: 0.625rem;
      }
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Analysis Header */
    .analysis-header {
      text-align: center;
      padding: 1.5rem 0;
    }

    .analysis-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .analysis-subtitle {
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    /* Four column stats (for analysis tabs) */
    .stats-row.four-cols {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }

    .stats-row.four-cols .stat-item {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
    }

    @media (max-width: 600px) {
      .stats-row.four-cols {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Breakdown List */
    .breakdown-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .breakdown-item {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .breakdown-label {
      min-width: 80px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .breakdown-bar-container {
      flex: 1;
      height: 24px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .breakdown-bar {
      height: 100%;
      background: var(--gray-800);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .breakdown-value {
      min-width: 70px;
      text-align: right;
      font-size: 0.875rem;
      font-weight: 600;
    }

    /* Filter Row */
    .filter-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .filter-select {
      flex: 1;
      max-width: 200px;
    }

    /* Full Height Records */
    .records-list.full-height {
      max-height: 400px;
      overflow-y: auto;
    }

    /* Mood Grid */
    .mood-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.75rem;
    }

    .mood-item {
      text-align: center;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 8px;
    }

    .mood-emoji {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }

    .mood-count {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .mood-percent {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    @media (max-width: 600px) {
      .mood-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Loading */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--gray-200);
      border-top-color: var(--black);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 6rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 4000;
    }

    .toast {
      padding: 0.75rem 1.25rem;
      background: var(--gray-900);
      color: var(--white);
      border-radius: 8px;
      font-size: 0.875rem;
      animation: fadeUp 0.2s ease;
    }

    .toast.error {
      background: var(--danger);
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 640px) {
      html {
        font-size: 14px;
      }

      .header-content {
        padding: 0.875rem 1rem;
      }

      .main {
        padding: 1.5rem 1rem calc(5rem + env(safe-area-inset-bottom));
      }

      .grid-2 {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
      .modal {
        width: 100%;
        max-width: 100%;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
        margin: 0;
      }

      .modal-body {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
        padding-bottom: 100px;
      }

      .modal-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--white);
        border-top: 1px solid var(--gray-200);
        padding: 1rem;
        z-index: 10;
      }

      /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
      .btn-group {
        gap: 0.5rem;
      }

      .btn-option {
        padding: 0.625rem 0.75rem;
        font-size: 0.75rem;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">ğŸ“š Study Tracker</div>
      <div class="header-actions">
        <button class="btn btn-ghost chat-header-btn" onclick="openChat()" id="chatHeaderBtn" style="display: none;">
          ğŸ’¬
          <span class="chat-header-badge" id="chatHeaderBadge" style="display: none;">0</span>
        </button>
        <button class="btn btn-ghost" onclick="openSettingsModal()">è¨­å®š</button>
        <button class="btn btn-ghost" onclick="refreshData()">æ›´æ–°</button>
      </div>
    </div>
  </header>

  <!-- Tab Menu -->
  <nav class="tab-menu">
    <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">
      <span class="tab-icon">ğŸ“Š</span>
      <span class="tab-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
    </button>
    <button class="tab-btn" data-tab="study" onclick="switchTab('study')">
      <span class="tab-icon">ğŸ“š</span>
      <span class="tab-label">å­¦ç¿’åˆ†æ</span>
    </button>
  </nav>

  <!-- Main -->
  <main class="main">
    <!-- ==================== Dashboard Tab ==================== -->
    <div class="tab-content active" id="tab-dashboard">
    
    <!-- å¿œæ´ãƒãƒŠãƒ¼ -->
    <div id="cheerBanner" style="display: none;"></div>
    
    <!-- Hero -->
    <section class="hero">
      <h1 class="hero-title">ç¶™ç¶šã¯åŠ›ãªã‚Š</h1>
      <p class="hero-subtitle">æ¯æ—¥ã‚³ãƒ„ã‚³ãƒ„å­¦ç¿’ã‚’è¨˜éŒ²ã—ã‚ˆã†</p>
    </section>

    <!-- Stats - Redesigned -->
    <section class="stats-row">
      <div class="stat-hero">
        <div class="stat-value" id="todayMinutes">0åˆ†</div>
        <div class="stat-label">ä»Šæ—¥ã®å­¦ç¿’æ™‚é–“</div>
        <div class="stat-sub" id="todayGoalStatus">ç›®æ¨™ã¾ã§ã‚ã¨ --åˆ†</div>
        <div class="stat-actions">
          <button class="stat-action-btn" onclick="openStudyModal()">
            <span class="stat-action-icon">ğŸ“–</span>
            <span>å­¦ç¿’ã‚’è¨˜éŒ²</span>
          </button>
        </div>
      </div>
      <div class="stats-grid stats-grid-5">
        <div class="stat-item">
          <div class="stat-value" id="weekMinutes">0h</div>
          <div class="stat-label">ä»Šé€±</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalHours">0h</div>
          <div class="stat-label">ç´¯è¨ˆ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="avgMinutes">0åˆ†</div>
          <div class="stat-label">å¹³å‡/æ—¥</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="streakDays">0</div>
          <div class="stat-label">é€£ç¶šæ—¥æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalSessions">0</div>
          <div class="stat-label">å­¦ç¿’å›æ•°</div>
        </div>
      </div>
    </section>

    <!-- A: Weekly Calendar + B: Daily Chart -->
    <section class="week-overview">
      <div class="week-calendar-card">
        <h4 class="week-card-title">ğŸ“… ä»Šé€±ã®å­¦ç¿’</h4>
        <div class="week-calendar" id="weekCalendar">
          <!-- Rendered by JS -->
        </div>
      </div>
      <div class="week-chart-card">
        <h4 class="week-card-title">ğŸ“Š æ—¥åˆ¥å­¦ç¿’æ™‚é–“</h4>
        <div class="week-chart-container">
          <canvas id="dashDailyChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Recommendations Only -->
    <section class="recommendation-section" id="recommendationSection" style="display: none;">
      <div class="recommendation-card-solo">
        <div class="recommendation-header">
          <span class="recommendation-header-icon">ğŸ’ª</span>
          <span class="recommendation-header-title">ä»Šæ—¥ã®ãŠã™ã™ã‚</span>
        </div>
        <div class="recommendation-list" id="recommendationList">
          <!-- Rendered by JS -->
        </div>
      </div>
    </section>

    <!-- Progress -->
    <section class="progress-section" id="progressSection">
      <div class="section-header">
        <span class="section-title"><span class="section-title-icon">ğŸ¯</span> é€±é–“ç›®æ¨™</span>
        <span class="section-value" id="progressValue">0 / 1800 åˆ†</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div id="progressCelebration"></div>
    </section>

    <!-- Goals -->
    <section class="card" style="margin-bottom: 1.5rem;">
      <h3 class="card-title"><span class="card-title-icon">ğŸ†</span> ç›®æ¨™é€²æ—</h3>
      <div class="goals-list" id="goalsSection">
        <!-- Goals rendered here -->
      </div>
    </section>

    <!-- Records -->
    <section class="grid-2">
      <div class="card">
        <h3 class="card-title"><span class="card-title-icon">ğŸ“–</span> æœ€è¿‘ã®å­¦ç¿’è¨˜éŒ²</h3>
        <div class="records-list" id="studyRecordsList">
          <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title"><span class="card-title-icon">ğŸ“ˆ</span> ç§‘ç›®åˆ¥å­¦ç¿’æ™‚é–“</h3>
        <div class="chart-container">
          <canvas id="subjectChart"></canvas>
        </div>
      </div>
    </section>
    </div><!-- End Dashboard Tab -->

    <!-- ==================== Study Analysis Tab ==================== -->
    <div class="tab-content" id="tab-study">
      <section class="analysis-header">
        <h2 class="analysis-title">ğŸ“š å­¦ç¿’åˆ†æ</h2>
        <p class="analysis-subtitle">å­¦ç¿’è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°åˆ†æ</p>
      </section>

      <!-- Study Stats -->
      <section class="stats-row four-cols">
        <div class="stat-item">
          <div class="stat-value" id="studyTotalHours">0</div>
          <div class="stat-label">ç´¯è¨ˆï¼ˆæ™‚é–“ï¼‰</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="studyAvgDaily">0</div>
          <div class="stat-label">1æ—¥å¹³å‡ï¼ˆåˆ†ï¼‰</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="studyTotalDays">0</div>
          <div class="stat-label">å­¦ç¿’æ—¥æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="studyMaxStreak">0</div>
          <div class="stat-label">æœ€é•·é€£ç¶š</div>
        </div>
      </section>

      <!-- Insights (moved from dashboard) -->
      <section class="card" id="insightsCard" style="display: none;">
        <h3 class="card-title"><span class="card-title-icon">ğŸ’¡</span> ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h3>
        <div class="insight-list" id="insightsListStudy">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Weekly Charts -->
      <section class="grid-2">
        <div class="card">
          <h3 class="card-title"><span class="card-title-icon">ğŸ“ˆ</span> æ—¥åˆ¥å­¦ç¿’æ™‚é–“</h3>
          <div class="chart-container">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title"><span class="card-title-icon">ğŸ“Š</span> ç§‘ç›®åˆ¥å‰²åˆ</h3>
          <div class="chart-container">
            <canvas id="subjectChartAnalysis"></canvas>
          </div>
        </div>
      </section>

      <!-- Subject Breakdown -->
      <section class="card">
        <h3 class="card-title">ç§‘ç›®åˆ¥å­¦ç¿’æ™‚é–“</h3>
        <div id="subjectBreakdown" class="breakdown-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Day of Week Analysis -->
      <section class="card">
        <h3 class="card-title">æ›œæ—¥åˆ¥å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
        <div class="chart-container">
          <canvas id="dayOfWeekChart"></canvas>
        </div>
      </section>

      <!-- Study Type Analysis -->
      <section class="card">
        <h3 class="card-title">å­¦ç¿’ã‚¿ã‚¤ãƒ—åˆ¥å‰²åˆ</h3>
        <div id="studyTypeBreakdown" class="breakdown-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Mood Analysis -->
      <section class="card">
        <h3 class="card-title">æ‰‹å¿œãˆåˆ†æ</h3>
        <div id="moodAnalysis" class="mood-grid">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- All Study Records -->
      <section class="card">
        <h3 class="card-title">å…¨å­¦ç¿’è¨˜éŒ²</h3>
        <div class="filter-row">
          <select class="form-input form-select filter-select" id="studyFilterSubject" onchange="filterStudyRecords()">
            <option value="">å…¨ç§‘ç›®</option>
          </select>
          <select class="form-input form-select filter-select" id="studyFilterPeriod" onchange="filterStudyRecords()">
            <option value="all">å…¨æœŸé–“</option>
            <option value="7">éå»7æ—¥</option>
            <option value="30">éå»30æ—¥</option>
            <option value="90">éå»90æ—¥</option>
          </select>
        </div>
        <div class="records-list full-height" id="allStudyRecords">
          <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </section>
    </div><!-- End Study Tab -->
  </main>

  <!-- Study Log Modal -->
  <div class="modal-overlay" id="studyModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">å­¦ç¿’è¨˜éŒ²ã‚’è¿½åŠ </h2>
        <button class="modal-close" onclick="closeStudyModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="studyDate">
        </div>
        <div class="form-group">
          <label class="form-label required">ç§‘ç›®</label>
          <div class="btn-group" id="subjectButtons">
            <button class="btn-option" data-value="å›½èª">å›½èª</button>
            <button class="btn-option" data-value="æ•°å­¦">æ•°å­¦</button>
            <button class="btn-option" data-value="æƒ…å ±">æƒ…å ±</button>
            <button class="btn-option" data-value="è‹±èª">è‹±èª</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ¯ å­¦ç¿’ã‚¿ã‚¤ãƒ—</label>
          <div class="btn-group" id="studyTypeButtons">
            <button class="btn-option" data-value="æ–°è¦">æ–°è¦</button>
            <button class="btn-option" data-value="å¾©ç¿’">å¾©ç¿’</button>
            <button class="btn-option" data-value="æ¼”ç¿’">æ¼”ç¿’</button>
            <button class="btn-option" data-value="æš—è¨˜">æš—è¨˜</button>
            <button class="btn-option" data-value="ã‚¹ãƒˆãƒ¬ã‚¤ãƒ«">ã‚¹ãƒˆãƒ¬ã‚¤ãƒ«</button>
            <button class="btn-option" data-value="èª²é¡Œ">èª²é¡Œ</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label required">å­¦ç¿’æ™‚é–“</label>
          <div class="btn-group" id="timeButtons">
            <button class="btn-option" data-value="15">15åˆ†</button>
            <button class="btn-option" data-value="30">30åˆ†</button>
            <button class="btn-option" data-value="45">45åˆ†</button>
            <button class="btn-option" data-value="50">50åˆ†</button>
            <button class="btn-option" data-value="60">1æ™‚é–“</button>
            <button class="btn-option" data-value="90">1.5æ™‚é–“</button>
            <button class="btn-option" data-value="120">2æ™‚é–“</button>
            <button class="btn-option" data-value="150">2æ™‚é–“è¶…</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">æ‰‹å¿œãˆ</label>
          <div class="mood-group" id="moodButtons">
            <button class="mood-btn" data-value="ğŸ˜«">ğŸ˜«</button>
            <button class="mood-btn" data-value="ğŸ˜•">ğŸ˜•</button>
            <button class="mood-btn" data-value="ğŸ˜">ğŸ˜</button>
            <button class="mood-btn" data-value="ğŸ™‚">ğŸ™‚</button>
            <button class="mood-btn" data-value="ğŸ˜Š">ğŸ˜Š</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“š å˜å…ƒãƒ»ç« ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="studyUnit" placeholder="ä¾‹: ç¬¬3ç«  äºŒæ¬¡é–¢æ•°ã€Unit15-16">
        </div>
        <div class="form-group">
          <label class="form-label">å‚è€ƒæ›¸åï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="studyTextbook" placeholder="ä¾‹: é€Ÿèª­è‹±å˜èª">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea class="form-input form-textarea" id="studyMemo" placeholder="å­¦ç¿’å†…å®¹ã‚„æ°—ã¥ããªã©"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeStudyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="submitStudyLog()">è¨˜éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">è¨­å®š</h2>
        <button class="modal-close" onclick="closeSettingsModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Apps Script URL</label>
          <input type="text" class="form-input" id="settingsApiUrl" placeholder="https://script.google.com/...">
        </div>
        <div class="form-group">
          <label class="form-label">é€±é–“ç›®æ¨™ï¼ˆåˆ†ï¼‰</label>
          <input type="number" class="form-input" id="settingsWeeklyGoal" value="1800" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒãƒ£ãƒƒãƒˆURLï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="settingsChatUrl" placeholder="https://script.google.com/...">
          <p style="font-size: 0.75rem; color: var(--gray-400); margin-top: 0.25rem;">
            ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã¾ã™
          </p>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
          <label class="form-label">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</label>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-outline" onclick="openDataManager('study')" style="flex: 1; min-width: 120px;">
              ğŸ“– å­¦ç¿’è¨˜éŒ²
            </button>
          </div>
          <p style="font-size: 0.75rem; color: var(--gray-400); margin-top: 0.5rem;">
            è¨˜éŒ²ã®ç¢ºèªãƒ»å‰Šé™¤ãŒã§ãã¾ã™
          </p>
        </div>
        
        <div class="version-info">
          <span id="appVersionDisplay">v2.1.0</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="dataManagerModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="dataManagerTitle">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
        <button class="modal-close" onclick="closeDataManager()">Ã—</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div id="dataManagerContent">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeDataManager()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay chat-modal" id="chatModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>
        <button class="modal-close" onclick="closeChat()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="chat-empty">
              <div class="chat-empty-icon">ğŸ’¬</div>
              ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“
            </div>
          </div>
          <div class="chat-input-area">
            <textarea class="chat-input" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
            <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">â¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† & ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    // ==========================================
    const APP_VERSION = '2.1.1';
    const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbygSI6dft0E2d_D0isU4lAlWuuQgWRMlizHOdMTDqt8w1Igpud6nvpvN1Gy1t2AyLGpBw/exec';
    const DEFAULT_CHAT_URL = 'https://script.google.com/macros/s/AKfycbxppU_VWeV9IwVl-5tY7o0vuMCqRURoH0fltq_mo7JSegCv5VI-X1QjG7khcATLlj7vGQ/exec';
    
    // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚åˆ»ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã‚’å›é¿ï¼‰
    function formatDateLocal(date) {
      const d = date instanceof Date ? date : new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    function getTodayStr() {
      return formatDateLocal(new Date());
    }
    
    (function checkVersion() {
      const storedVersion = localStorage.getItem('appVersion');
      
      if (storedVersion !== APP_VERSION) {
        console.log(`App updated: ${storedVersion || 'none'} â†’ ${APP_VERSION}`);
        
        // URLã‚’æœ€æ–°ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æ›´æ–°
        localStorage.setItem('apiUrl', DEFAULT_API_URL);
        localStorage.setItem('chatUrl', DEFAULT_CHAT_URL);
        
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿å­˜
        localStorage.setItem('appVersion', APP_VERSION);
        
        // æ›´æ–°é€šçŸ¥ï¼ˆåˆå›ä»¥å¤–ï¼‰
        if (storedVersion) {
          setTimeout(() => {
            showToast(`ã‚¢ãƒ—ãƒªãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ (v${APP_VERSION})`, 'success');
          }, 1000);
        }
      }
    })();
    
    // ==========================================
    // ãƒ¡ã‚¤ãƒ³
    // ==========================================
    let API_URL = localStorage.getItem('apiUrl') || DEFAULT_API_URL;
    let CHAT_URL = localStorage.getItem('chatUrl') || DEFAULT_CHAT_URL;
    let appData = {
      studyLogs: [],
      redbookLogs: [], // äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼ˆç©ºé…åˆ—ï¼‰
      goals: [],
      profile: {},
      settings: { weeklyGoalMinutes: 1800 }
    };
    
    let selectedSubject = '';
    let selectedTime = 0;
    let selectedMood = '';
    let selectedStudyType = '';
    
    let dailyChart = null;
    let subjectChart = null;
    let subjectChartAnalysis = null;
    let dayOfWeekChart = null;
    
    document.addEventListener('DOMContentLoaded', () => {
      initializeDateInputs();
      initializeButtonGroups();
      loadSettingsFromStorage();
      initChat(); // ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–
      
      if (API_URL) {
        refreshData();
        loadCheerMessages(); // å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿
      } else {
        hideLoading();
      }
    });
    
    // ==========================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    // ==========================================
    function switchTab(tabName) {
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      
      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
      });
      
      // åˆ†æã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      if (tabName === 'study') {
        renderStudyAnalysis();
      }
    }
    
    function initializeDateInputs() {
      const today = getTodayStr();
      document.getElementById('studyDate').value = today;
    }
    
    function initializeButtonGroups() {
      document.querySelectorAll('#subjectButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#subjectButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedSubject = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#timeButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#timeButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedTime = parseInt(btn.dataset.value);
        });
      });
      
      document.querySelectorAll('#moodButtons .mood-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#moodButtons .mood-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedMood = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#studyTypeButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#studyTypeButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedStudyType = btn.dataset.value;
        });
      });
    }
    
    function loadSettingsFromStorage() {
      const apiUrl = localStorage.getItem('apiUrl');
      const weeklyGoal = localStorage.getItem('weeklyGoal');
      
      if (apiUrl) {
        API_URL = apiUrl;
        document.getElementById('settingsApiUrl').value = apiUrl;
      }
      if (weeklyGoal) {
        appData.settings.weeklyGoalMinutes = parseInt(weeklyGoal);
        document.getElementById('settingsWeeklyGoal').value = weeklyGoal;
      }
    }
    
    async function fetchData() {
      if (!API_URL) throw new Error('API URL not set');
      
      console.log('Fetching from:', API_URL);
      
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = (data) => {
          console.log('JSONP callback received:', data);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          resolve(data);
        };
        
        const fullUrl = `${API_URL}?action=getData&callback=${callbackName}`;
        console.log('Full URL:', fullUrl);
        script.src = fullUrl;
        
        script.onerror = (e) => {
          console.error('Script load error:', e);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            console.error('JSONP timeout - callback not called');
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€‚Apps ScriptãŒæ­£ã—ãå¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚'));
          }
        }, 15000);
      });
    }
    
    async function postData(data) {
      if (!API_URL) throw new Error('API URL not set');
      
      console.log('Posting data:', data);
      
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpPostCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = (response) => {
          console.log('POST callback received:', response);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          if (response.error) {
            reject(new Error(response.error));
          } else {
            resolve(response);
          }
        };
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        const params = new URLSearchParams();
        params.append('action', data.action);
        params.append('data', JSON.stringify(data));
        params.append('callback', callbackName);
        
        const fullUrl = `${API_URL}?${params.toString()}`;
        console.log('POST URL:', fullUrl);
        script.src = fullUrl;
        
        script.onerror = (e) => {
          console.error('POST script error:', e);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
          }
        }, 15000);
      });
    }
    
    async function refreshData() {
      showLoading();
      try {
        const data = await fetchData();
        if (data.error) throw new Error(data.error);
        appData = data;
        renderDashboard();
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('Error:', error);
        showToast(error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function renderDashboard() {
      renderCheerBanner();
      renderStats();
      renderProgress();
      renderCharts();
      renderGoals();
      renderStudyRecords();
    }
    
    // ==========================================
    // å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    // ==========================================
    let cheerMessages = [];
    let cheerDismissed = {};
    
    async function loadCheerMessages() {
      try {
        const response = await fetch(`${API_URL}?action=getActiveCheerMessages&callback=?`);
        const text = await response.text();
        const json = text.replace(/^\?\(/, '').replace(/\);?$/, '');
        const data = JSON.parse(json);
        
        if (data.messages) {
          cheerMessages = data.messages;
          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰éè¡¨ç¤ºæ¸ˆã¿ã‚’å–å¾—
          const dismissed = localStorage.getItem('cheerDismissed');
          if (dismissed) {
            cheerDismissed = JSON.parse(dismissed);
          }
          renderCheerBanner();
        }
      } catch (error) {
        console.log('Cheer messages not available');
      }
    }
    
    function renderCheerBanner() {
      const container = document.getElementById('cheerBanner');
      if (!container) return;
      
      // è¡¨ç¤ºå¯èƒ½ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚£ãƒ«ã‚¿
      const now = new Date();
      const activeMessages = cheerMessages.filter(msg => {
        // éè¡¨ç¤ºæ¸ˆã¿ãƒã‚§ãƒƒã‚¯
        if (cheerDismissed[msg.id]) return false;
        
        const start = new Date(msg.startTime);
        const end = new Date(msg.endTime);
        return now >= start && now <= end;
      });
      
      if (activeMessages.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸æŠï¼ˆã¾ãŸã¯æœ€æ–°ã®ã‚‚ã®ï¼‰
      const msg = activeMessages[0];
      
      container.style.display = 'block';
      container.innerHTML = `
        <div class="cheer-banner">
          <button class="cheer-banner-close" onclick="dismissCheer('${msg.id}')" title="é–‰ã˜ã‚‹">Ã—</button>
          <div class="cheer-banner-content">
            <span class="cheer-banner-icon">ğŸ“£</span>
            <div class="cheer-banner-text">
              <div class="cheer-banner-message">${escapeHtml(msg.message)}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    function dismissCheer(id) {
      cheerDismissed[id] = true;
      localStorage.setItem('cheerDismissed', JSON.stringify(cheerDismissed));
      renderCheerBanner();
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }
    
    function renderStats() {
      const logs = appData.studyLogs || [];
      const today = getTodayStr();
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      // å­¦ç¿’è¨˜éŒ²ã®æ™‚é–“ã®ã¿
      const studyTodayMinutes = logs
        .filter(log => log.date === today)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      const todayMinutes = studyTodayMinutes;
      
      // ä»Šæ—¥ã®å­¦ç¿’æ™‚é–“ã‚’æ™‚é–“/åˆ†ã§è¡¨ç¤º
      if (todayMinutes >= 60) {
        const hours = Math.floor(todayMinutes / 60);
        const mins = todayMinutes % 60;
        document.getElementById('todayMinutes').textContent = mins > 0 ? `${hours}æ™‚é–“${mins}åˆ†` : `${hours}æ™‚é–“`;
      } else {
        document.getElementById('todayMinutes').textContent = todayMinutes + 'åˆ†';
      }
      
      // ä»Šæ—¥ã®ç›®æ¨™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ1æ—¥ã®ç›®æ¨™ã‚’é€±é–“ç›®æ¨™Ã·7ã§è¨ˆç®—ï¼‰
      const weeklyGoal = appData.settings?.weeklyGoal || 1800;
      const dailyGoal = Math.round(weeklyGoal / 7);
      const todayGoalStatus = document.getElementById('todayGoalStatus');
      if (todayGoalStatus) {
        if (todayMinutes >= dailyGoal) {
          todayGoalStatus.textContent = 'ğŸ‰ ä»Šæ—¥ã®ç›®æ¨™é”æˆï¼';
          todayGoalStatus.style.color = '#A3BE8C';
        } else {
          const remaining = dailyGoal - todayMinutes;
          todayGoalStatus.textContent = `ç›®æ¨™ã¾ã§ã‚ã¨ ${remaining}åˆ†`;
          todayGoalStatus.style.color = '';
        }
      }
      
      // é€±é–“ã®å­¦ç¿’æ™‚é–“
      const studyWeekMinutes = logs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      const weekMinutes = studyWeekMinutes;
      const weekHours = Math.round(weekMinutes / 60);
      document.getElementById('weekMinutes').textContent = weekHours + 'h';
      
      // é€£ç¶šæ—¥æ•°ï¼ˆå­¦ç¿’è¨˜éŒ²ã®ã¿ï¼‰
      const allDates = logs.map(log => log.date);
      const streakDays = calculateStreak({ dates: allDates });
      document.getElementById('streakDays').textContent = streakDays;
      
      // å­¦ç¿’å›æ•°ï¼ˆå­¦ç¿’è¨˜éŒ²ã®ã¿ï¼‰
      const monthStudySessions = logs.filter(log => new Date(log.date) >= monthAgo).length;
      document.getElementById('totalSessions').textContent = monthStudySessions;
      
      // C: ç´¯è¨ˆå­¦ç¿’æ™‚é–“
      const totalStudyMinutes = logs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const totalMinutes = totalStudyMinutes;
      const totalHours = Math.round(totalMinutes / 60);
      document.getElementById('totalHours').textContent = totalHours + 'h';
      
      // C: å¹³å‡å­¦ç¿’æ™‚é–“ï¼ˆå­¦ç¿’æ—¥ã®ã¿ï¼‰
      const allDatesSet = new Set(logs.map(log => log.date));
      const studyDays = allDatesSet.size || 1;
      const avgMinutes = Math.round(totalMinutes / studyDays);
      document.getElementById('avgMinutes').textContent = avgMinutes + 'åˆ†';
      
      // A: é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
      renderWeekCalendar(logs);
      
      // B: æ—¥åˆ¥ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
      renderDashDailyChart(logs);
      
      // ãŠã™ã™ã‚ã‚’è¡¨ç¤º
      renderInsights();
    }
    
    // A: é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
    function renderWeekCalendar(logs) {
      const container = document.getElementById('weekCalendar');
      if (!container) return;
      
      const today = new Date();
      const dayOfWeek = today.getDay(); // 0=æ—¥, 1=æœˆ...
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - dayOfWeek); // é€±ã®å§‹ã¾ã‚Šï¼ˆæ—¥æ›œï¼‰
      
      const dayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      let html = '';
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        const isToday = dateStr === getTodayStr();
        
        // ãã®æ—¥ã®å­¦ç¿’æ™‚é–“ã‚’è¨ˆç®—
        const studyMins = logs.filter(l => l.date === dateStr).reduce((sum, l) => sum + (l.minutes || 0), 0);
        const totalMins = studyMins;
        const studied = totalMins > 0;
        
        html += `
          <div class="week-day">
            <span class="week-day-label">${dayLabels[i]}</span>
            <div class="week-day-circle ${studied ? 'studied' : ''} ${isToday ? 'today' : ''}">
              ${date.getDate()}
            </div>
            <span class="week-day-minutes">${totalMins > 0 ? totalMins + 'åˆ†' : '-'}</span>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    // B: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ—¥åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
    let dashDailyChartInstance = null;
    
    function renderDashDailyChart(logs) {
      const canvas = document.getElementById('dashDailyChart');
      if (!canvas) return;
      
      const today = new Date();
      const dayOfWeek = today.getDay();
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - dayOfWeek);
      
      const labels = [];
      const data = [];
      const dayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        
        const studyMins = logs.filter(l => l.date === dateStr).reduce((sum, l) => sum + (l.minutes || 0), 0);
        
        labels.push(dayLabels[i]);
        data.push(studyMins);
      }
      
      if (dashDailyChartInstance) {
        dashDailyChartInstance.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      dashDailyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: data.map((v, i) => {
              const date = new Date(startOfWeek);
              date.setDate(startOfWeek.getDate() + i);
              const isToday = date.toISOString().split('T')[0] === getTodayStr();
              return isToday ? '#5E81AC' : 'rgba(94, 129, 172, 0.5)';
            }),
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => ctx.parsed.y + 'åˆ†'
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { size: 11 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: {
                callback: v => v + 'åˆ†',
                font: { size: 10 }
              }
            }
          }
        }
      });
    }
    
    // ==========================================
    // ã‚¤ãƒ³ã‚µã‚¤ãƒˆ & ãŠã™ã™ã‚å­¦ç¿’
    // ==========================================
    
    function renderInsights() {
      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãŠã™ã™ã‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      const recSection = document.getElementById('recommendationSection');
      const recommendationList = document.getElementById('recommendationList');
      
      // å­¦ç¿’åˆ†æã‚¿ãƒ–ã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚«ãƒ¼ãƒ‰
      const insightsCard = document.getElementById('insightsCard');
      const insightsListStudy = document.getElementById('insightsListStudy');
      
      const studyLogs = appData.studyLogs || [];
      
      const insights = generateInsights(studyLogs);
      const recommendations = generateRecommendations(studyLogs);
      
      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: ãŠã™ã™ã‚è¡¨ç¤º
      if (recommendations.length > 0) {
        recommendationList.innerHTML = recommendations.slice(0, 3).map(rec => `
          <div class="recommendation-item" onclick="${rec.action}">
            <span class="recommendation-item-icon">${rec.icon}</span>
            <div class="recommendation-item-text">
              <div>${rec.text}</div>
              <div class="recommendation-item-reason">${rec.reason}</div>
            </div>
            <span class="recommendation-item-arrow">â†’</span>
          </div>
        `).join('');
        recSection.style.display = 'block';
      } else {
        recSection.style.display = 'none';
      }
      
      // å­¦ç¿’åˆ†æã‚¿ãƒ–: ã‚¤ãƒ³ã‚µã‚¤ãƒˆè¡¨ç¤º
      if (insights.length > 0) {
        insightsListStudy.innerHTML = insights.slice(0, 5).map(insight => `
          <div class="insight-item ${insight.type}">
            <span class="insight-item-icon">${insight.icon}</span>
            <span>${insight.text}</span>
          </div>
        `).join('');
        insightsCard.style.display = 'block';
      } else {
        insightsCard.style.display = 'none';
      }
    }
    
    function generateInsights(studyLogs) {
      const insights = [];
      const today = new Date();
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      const twoWeeksAgo = new Date(today);
      twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
      
      // ä»Šé€±ã¨å…ˆé€±ã®ãƒ‡ãƒ¼ã‚¿
      const thisWeekStudy = studyLogs.filter(l => new Date(l.date) >= weekAgo);
      const lastWeekStudy = studyLogs.filter(l => new Date(l.date) >= twoWeeksAgo && new Date(l.date) < weekAgo);
      
      // 1. ç§‘ç›®åˆ¥ã®å­¦ç¿’æ™‚é–“å¤‰åŒ–
      const thisWeekBySubject = {};
      const lastWeekBySubject = {};
      
      thisWeekStudy.forEach(l => {
        const subj = l.subject || 'ãã®ä»–';
        thisWeekBySubject[subj] = (thisWeekBySubject[subj] || 0) + (l.minutes || 0);
      });
      
      lastWeekStudy.forEach(l => {
        const subj = l.subject || 'ãã®ä»–';
        lastWeekBySubject[subj] = (lastWeekBySubject[subj] || 0) + (l.minutes || 0);
      });
      
      // å¤§å¹…ã«å¢—ãˆãŸç§‘ç›®
      Object.keys(thisWeekBySubject).forEach(subj => {
        const thisWeek = thisWeekBySubject[subj] || 0;
        const lastWeek = lastWeekBySubject[subj] || 0;
        if (lastWeek > 0 && thisWeek > lastWeek * 1.3 && thisWeek - lastWeek >= 60) {
          const increase = Math.round((thisWeek / lastWeek - 1) * 100);
          insights.push({
            type: 'positive',
            icon: 'ğŸ“ˆ',
            text: `${subj}ã®å­¦ç¿’æ™‚é–“ãŒå…ˆé€±æ¯” +${increase}%`
          });
        }
      });
      
      // 2. è§¦ã‚Œã¦ã„ãªã„ç§‘ç›®
      const allSubjects = [...new Set(studyLogs.map(l => l.subject || 'ãã®ä»–'))];
      const threeDaysAgo = new Date(today);
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      
      allSubjects.forEach(subj => {
        const recentLogs = studyLogs.filter(l => 
          l.subject === subj && new Date(l.date) >= threeDaysAgo
        );
        if (recentLogs.length === 0) {
          const lastLog = studyLogs
            .filter(l => l.subject === subj)
            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
          if (lastLog) {
            const daysSince = Math.floor((today - new Date(lastLog.date)) / (1000 * 60 * 60 * 24));
            if (daysSince >= 3) {
              insights.push({
                type: 'warning',
                icon: 'âš ï¸',
                text: `${subj}ã¯${daysSince}æ—¥é–“è§¦ã‚Œã¦ã„ã¾ã›ã‚“`
              });
            }
          }
        }
      });
      
      return insights;
    }
    
    function generateRecommendations(studyLogs) {
      const recommendations = [];
      const today = new Date();
      const todayStr = getTodayStr();
      
      // ä»Šæ—¥ã‚„ã£ãŸç§‘ç›®
      const todaySubjects = new Set(
        studyLogs.filter(l => l.date === todayStr).map(l => l.subject || 'ãã®ä»–')
      );
      
      // 1. è§¦ã‚Œã¦ã„ãªã„ç§‘ç›®ã‚’ãŠã™ã™ã‚
      const allSubjects = [...new Set(studyLogs.map(l => l.subject || 'ãã®ä»–'))];
      const subjectLastDate = {};
      
      studyLogs.forEach(l => {
        const subj = l.subject || 'ãã®ä»–';
        if (!subjectLastDate[subj] || l.date > subjectLastDate[subj]) {
          subjectLastDate[subj] = l.date;
        }
      });
      
      allSubjects
        .filter(subj => !todaySubjects.has(subj))
        .sort((a, b) => (subjectLastDate[a] || '') < (subjectLastDate[b] || '') ? -1 : 1)
        .slice(0, 3)
        .forEach(subj => {
          const lastDate = subjectLastDate[subj];
          const daysSince = lastDate ? Math.floor((today - new Date(lastDate)) / (1000 * 60 * 60 * 24)) : 999;
          if (daysSince >= 1) {
            recommendations.push({
              icon: 'ğŸ“–',
              text: subj,
              reason: `${daysSince}æ—¥é–“ã‚„ã£ã¦ã„ã¾ã›ã‚“`,
              action: `openStudyModal()`
            });
          }
        });
      
      return recommendations;
    }
    
    function calculateStreak(input) {
      // é…åˆ—ã¾ãŸã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã«å¯¾å¿œ
      let dates;
      if (Array.isArray(input)) {
        dates = [...new Set(input.map(log => log.date))].sort().reverse();
      } else if (input.dates) {
        dates = [...new Set(input.dates)].filter(Boolean).sort().reverse();
      } else {
        return 0;
      }
      
      if (dates.length === 0) return 0;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let streak = 0;
      let currentDate = new Date(today);
      
      const todayStr = formatDateLocal(today);
      if (!dates.includes(todayStr)) {
        currentDate.setDate(currentDate.getDate() - 1);
      }
      
      for (let i = 0; i < 365; i++) {
        const dateStr = formatDateLocal(currentDate);
        if (dates.includes(dateStr)) {
          streak++;
          currentDate.setDate(currentDate.getDate() - 1);
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    function renderProgress() {
      const logs = appData.studyLogs || [];
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      
      // å­¦ç¿’è¨˜éŒ²ã®é€±é–“æ™‚é–“
      const studyWeekMinutes = logs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      const weekMinutes = studyWeekMinutes;
      
      const goal = appData.settings?.weeklyGoalMinutes || 1800;
      const percent = Math.min(100, Math.round((weekMinutes / goal) * 100));
      
      document.getElementById('progressValue').textContent = `${weekMinutes} / ${goal} åˆ†`;
      document.getElementById('progressFill').style.width = `${percent}%`;
      
      // ç›®æ¨™é”æˆæ™‚ã®ãŠç¥ã„è¡¨ç¤º
      const progressSection = document.getElementById('progressSection');
      const celebration = document.getElementById('progressCelebration');
      
      if (percent >= 100) {
        progressSection.classList.add('achieved');
        celebration.innerHTML = `
          <div class="progress-celebration">
            ğŸ‰ é€±é–“ç›®æ¨™é”æˆï¼ãŠã‚ã§ã¨ã†ï¼
          </div>
        `;
      } else if (percent >= 80) {
        progressSection.classList.remove('achieved');
        celebration.innerHTML = `
          <div class="progress-celebration" style="background: #fffbeb; border-color: #fde68a; color: #d97706;">
            ğŸ’ª ã‚ã¨å°‘ã—ï¼æ®‹ã‚Š ${goal - weekMinutes} åˆ†
          </div>
        `;
      } else {
        progressSection.classList.remove('achieved');
        celebration.innerHTML = '';
      }
    }
    
    function renderCharts() {
      renderDailyChart();
      renderSubjectChart();
    }
    
    function renderDailyChart() {
      const ctx = document.getElementById('dailyChart');
      if (!ctx) return;
      
      const logs = appData.studyLogs || [];
      
      const days = [];
      const subjectData = {};
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = formatDateLocal(date);
        const dayLabel = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
        days.push(dayLabel);
        
        // å­¦ç¿’è¨˜éŒ²
        const dayLogs = logs.filter(log => log.date === dateStr);
        dayLogs.forEach(log => {
          const subject = log.subject || 'ãã®ä»–';
          if (!subjectData[subject]) {
            subjectData[subject] = Array(7).fill(0);
          }
          subjectData[subject][6 - i] += log.minutes || 0;
        });
      }
      
      // ç§‘ç›®åˆ¥ã‚«ãƒ©ãƒ¼
      const colors = {
        'å›½èª': '#EBCB8B',
        'æ•°å­¦': '#A3BE8C',
        'æƒ…å ±': '#B48EAD',
        'è‹±èª': '#5E81AC',
        'ãã®ä»–': '#4C566A'
      };
      
      const datasets = Object.entries(subjectData).map(([subject, data]) => ({
        label: subject,
        data: data,
        backgroundColor: colors[subject] || '#d4d4d4',
        borderRadius: 2,
        barThickness: 16
      }));
      
      if (dailyChart) dailyChart.destroy();
      
      const ctxDraw = ctx.getContext('2d');
      dailyChart = new Chart(ctxDraw, {
        type: 'bar',
        data: { labels: days, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              stacked: true,
              grid: { display: false },
              border: { display: false },
              ticks: { color: '#a3a3a3', font: { size: 11 } }
            },
            y: { 
              stacked: true,
              beginAtZero: true,
              grid: { color: '#f5f5f5' },
              border: { display: false },
              ticks: { color: '#a3a3a3', font: { size: 11 } }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 16,
                color: '#525252',
                font: { size: 11 }
              }
            }
          }
        }
      });
    }
    
    function renderSubjectChart() {
      const ctx = document.getElementById('subjectChart');
      if (!ctx) return;
      
      const logs = appData.studyLogs || [];
      
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      const subjectMinutes = {};
      
      // å­¦ç¿’è¨˜éŒ²
      logs
        .filter(log => new Date(log.date) >= monthAgo)
        .forEach(log => {
          const subject = log.subject || 'ãã®ä»–';
          subjectMinutes[subject] = (subjectMinutes[subject] || 0) + (log.minutes || 0);
        });
      
      const sortedSubjects = Object.entries(subjectMinutes).sort((a, b) => b[1] - a[1]);
      
      // ç§‘ç›®ã”ã¨ã«å›ºå®šè‰²ã‚’å‰²ã‚Šå½“ã¦
      const subjectColors = {
        'å›½èª': '#EBCB8B',
        'æ•°å­¦': '#A3BE8C',
        'æƒ…å ±': '#B48EAD',
        'è‹±èª': '#5E81AC',
        'ãã®ä»–': '#4C566A'
      };
      
      // è‰²ã®é…åˆ—ã‚’ç”Ÿæˆ
      const defaultColors = ['#5E81AC', '#A3BE8C', '#EBCB8B', '#B48EAD', '#D08770', '#88C0D0', '#81A1C1'];
      const chartColors = sortedSubjects.map((s, i) => subjectColors[s[0]] || defaultColors[i % defaultColors.length]);
      
      if (subjectChart) subjectChart.destroy();
      
      const ctxDraw = ctx.getContext('2d');
      subjectChart = new Chart(ctxDraw, {
        type: 'doughnut',
        data: {
          labels: sortedSubjects.map(s => s[0]),
          datasets: [{
            data: sortedSubjects.map(s => s[1]),
            backgroundColor: chartColors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 12,
                color: '#525252',
                font: { size: 11 }
              }
            }
          },
          cutout: '65%'
        }
      });
    }
    
    function renderGoals() {
      const section = document.getElementById('goalsSection');
      const goals = appData.goals || [];
      
      if (goals.length === 0) {
        section.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¯</div>
            <div class="empty-state-title">ç›®æ¨™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
            <div class="empty-state-desc">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œç›®æ¨™ã€ã‚·ãƒ¼ãƒˆã§<br>ç§‘ç›®ã”ã¨ã®ç›®æ¨™ã‚’è¨­å®šã§ãã¾ã™</div>
          </div>
        `;
        return;
      }
      
      const classes = { 'å›½èª': 'kokugo', 'æ•°å­¦': 'sugaku', 'æƒ…å ±': 'joho', 'è‹±èª': 'eigo' };
      
      section.innerHTML = goals.map(goal => {
        const progress = Math.min(100, Math.round(((goal.current) / (goal.target)) * 100));
        const cls = classes[goal.subject] || 'kokugo';
        const isAchieved = goal.current >= goal.target;
        
        return `
          <div class="goal-item">
            <div class="goal-header">
              <span class="goal-name">${escapeHtml(goal.subject || '')}${isAchieved ? '<span class="goal-achieved">ğŸ† é”æˆï¼</span>' : ''}</span>
              <span class="goal-values">${goal.current}% â†’ ${goal.target}%</span>
            </div>
            <div class="goal-bar">
              <div class="goal-fill ${cls}" style="width: ${progress}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderStudyRecords() {
      const container = document.getElementById('studyRecordsList');
      const logs = (appData.studyLogs || []).slice(0, 8);
      
      if (logs.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“–</div>
            <div class="empty-state-title">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
            <div class="empty-state-desc">å­¦ç¿’ã‚’è¨˜éŒ²ã—ã¦ã€<br>æ¯æ—¥ã®é ‘å¼µã‚Šã‚’è¦‹ãˆã‚‹åŒ–ã—ã‚ˆã†ï¼</div>
            <button class="empty-state-btn" onclick="openStudyModal()">
              ï¼‹ æœ€åˆã®è¨˜éŒ²ã‚’ã¤ã‘ã‚‹
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = logs.map((log, index) => {
        const hasSubDetails = log.textbook || log.unit;
        return `
        <div class="record-item">
          <div class="record-main">
            <span class="record-date">${formatDateShort(log.date)}</span>
            <span class="record-subject">${escapeHtml(log.subject || '')}</span>
            ${log.studyType ? `<span class="record-type">${escapeHtml(log.studyType)}</span>` : ''}
            <span class="record-time">${log.minutes}åˆ†</span>
            <span class="record-mood">${escapeHtml(log.mood || '')}</span>
          </div>
          ${log.memo || hasSubDetails ? `
            <div class="record-details">
              ${hasSubDetails ? `
                <div class="record-sub-info">
                  ${log.unit ? `<span class="record-unit">ğŸ“– ${escapeHtml(log.unit)}</span>` : ''}
                  ${log.textbook ? `<span class="record-textbook">ğŸ“š ${escapeHtml(log.textbook)}</span>` : ''}
                </div>
              ` : ''}
              ${log.memo ? `<div class="record-memo">ğŸ“ ${escapeHtml(log.memo)}</div>` : ''}
            </div>
          ` : ''}
        </div>
      `}).join('');
    }
    
    function openStudyModal() {
      resetStudyForm();
      document.getElementById('studyModal').classList.add('active');
    }
    
    function closeStudyModal() {
      document.getElementById('studyModal').classList.remove('active');
    }
    
    function resetStudyForm() {
      document.getElementById('studyDate').value = getTodayStr();
      document.querySelectorAll('#subjectButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#studyTypeButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#timeButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#moodButtons .mood-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('studyUnit').value = '';
      document.getElementById('studyTextbook').value = '';
      document.getElementById('studyMemo').value = '';
      selectedSubject = '';
      selectedStudyType = '';
      selectedTime = 0;
      selectedMood = '';
    }
    
    // ==========================================
    // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
    // ==========================================
    let currentManagerType = '';
    
    function openDataManager(type) {
      currentManagerType = type;
      const modal = document.getElementById('dataManagerModal');
      const title = document.getElementById('dataManagerTitle');
      
      if (type === 'study') {
        title.textContent = 'ğŸ“– å­¦ç¿’è¨˜éŒ²ã®ç®¡ç†';
        renderStudyManager();
      }
      
      modal.classList.add('active');
    }
    
    function closeDataManager() {
      document.getElementById('dataManagerModal').classList.remove('active');
      currentManagerType = '';
    }
    
    function renderStudyManager() {
      const container = document.getElementById('dataManagerContent');
      const logs = appData.studyLogs || [];
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="manager-empty">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = logs.map((log, index) => `
        <div class="manager-item">
          <div class="manager-item-info">
            <div class="manager-item-main">
              <span class="manager-item-date">${formatDateShort(log.date)}</span>
              <span class="manager-item-subject">${escapeHtml(log.subject || '')}</span>
              <span>${log.minutes}åˆ†</span>
              <span>${escapeHtml(log.mood || '')}</span>
            </div>
            ${log.studyType || log.unit || log.memo ? `
              <div class="manager-item-detail">
                ${log.studyType ? escapeHtml(log.studyType) : ''}
                ${log.unit ? ' / ' + escapeHtml(log.unit) : ''}
                ${log.memo ? ' / ' + escapeHtml(log.memo) : ''}
              </div>
            ` : ''}
          </div>
          <button class="manager-delete-btn" onclick="deleteStudyLog(${index})" title="å‰Šé™¤">ğŸ—‘</button>
        </div>
      `).join('');
    }
    
    // è¨˜éŒ²å‰Šé™¤
    async function deleteStudyLog(index) {
      if (!confirm('ã“ã®å­¦ç¿’è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      showLoading();
      try {
        await postData({
          action: 'deleteStudyLog',
          index: index
        });
        showToast('è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        await refreshData();
        // ç®¡ç†ç”»é¢ãŒé–‹ã„ã¦ã„ãŸã‚‰å†æç”»
        if (currentManagerType === 'study') {
          renderStudyManager();
        }
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    function openSettingsModal() {
      document.getElementById('settingsApiUrl').value = API_URL;
      document.getElementById('settingsWeeklyGoal').value = appData.settings?.weeklyGoalMinutes || 1800;
      document.getElementById('settingsChatUrl').value = CHAT_URL;
      document.getElementById('appVersionDisplay').textContent = `v${APP_VERSION}`;
      document.getElementById('settingsModal').classList.add('active');
    }
    
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('active');
    }
    
    async function submitStudyLog() {
      if (!selectedSubject) { showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!selectedTime) { showToast('å­¦ç¿’æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      
      showLoading();
      
      try {
        await postData({
          action: 'addStudyLog',
          date: document.getElementById('studyDate').value,
          subject: selectedSubject,
          studyType: selectedStudyType,
          minutes: selectedTime,
          mood: selectedMood,
          unit: document.getElementById('studyUnit').value,
          textbook: document.getElementById('studyTextbook').value,
          memo: document.getElementById('studyMemo').value
        });
        
        closeStudyModal();
        showToast('å­¦ç¿’è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        setTimeout(() => refreshData(), 1500);
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    // ==========================================
    // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
    // ==========================================
    let chatMessages = [];
    
    function initChat() {
      if (CHAT_URL) {
        document.getElementById('chatHeaderBtn').style.display = 'flex';
        loadChatMessages();
        // 30ç§’ã”ã¨ã«æ–°ç€ãƒã‚§ãƒƒã‚¯
        setInterval(checkNewMessages, 30000);
      } else {
        document.getElementById('chatHeaderBtn').style.display = 'none';
      }
    }
    
    // ãƒãƒ£ãƒƒãƒˆç”¨JSONPé–¢æ•°
    function chatJsonp(url) {
      return new Promise((resolve, reject) => {
        const callbackName = 'chatCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        
        script.onerror = function() {
          delete window[callbackName];
          document.body.removeChild(script);
          reject(new Error('JSONP request failed'));
        };
        
        const separator = url.includes('?') ? '&' : '?';
        script.src = `${url}${separator}callback=${callbackName}`;
        document.body.appendChild(script);
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script.parentNode) document.body.removeChild(script);
            reject(new Error('JSONP timeout'));
          }
        }, 10000);
      });
    }
    
    async function loadChatMessages() {
      if (!CHAT_URL) return;
      
      try {
        const data = await chatJsonp(`${CHAT_URL}?action=getMessages`);
        
        if (data.error) throw new Error(data.error);
        
        chatMessages = data.messages || [];
        renderChatMessages();
        updateChatBadge();
        
      } catch (error) {
        console.error('Chat load error:', error);
      }
    }
    
    async function checkNewMessages() {
      if (!CHAT_URL) return;
      
      try {
        const data = await chatJsonp(`${CHAT_URL}?action=getMessages`);
        
        if (data.messages) {
          chatMessages = data.messages;
          renderChatMessages();
        }
        updateChatBadge();
      } catch (error) {
        console.error('Chat check error:', error);
      }
    }
    
    async function markChatAsRead() {
      if (!CHAT_URL) return;
      
      // æœªèª­ã®adminãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®IDã‚’åé›†
      const unreadIds = chatMessages
        .filter(m => m.sender === 'admin' && !m.readByStudent)
        .map(m => m.id);
      
      if (unreadIds.length === 0) return;
      
      try {
        await chatJsonp(`${CHAT_URL}?action=markAsRead&role=student&ids=${unreadIds.join(',')}`);
        // ãƒ­ãƒ¼ã‚«ãƒ«ã®æ—¢èª­çŠ¶æ…‹ã‚‚æ›´æ–°
        chatMessages.forEach(m => {
          if (m.sender === 'admin') m.readByStudent = true;
        });
        renderChatMessages();
        updateChatBadge();
      } catch (error) {
        console.error('Mark as read error:', error);
      }
    }
    
    function updateChatBadge() {
      const badge = document.getElementById('chatHeaderBadge');
      
      // æœªèª­ã®adminãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆreadByStudent === falseï¼‰
      const unreadCount = chatMessages.filter(m => 
        m.sender === 'admin' && !m.readByStudent
      ).length;
      
      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      
      if (chatMessages.length === 0) {
        container.innerHTML = '<div class="chat-empty"><div class="chat-empty-icon">ğŸ’¬</div>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      let lastDate = '';
      container.innerHTML = chatMessages.map(msg => {
        const date = new Date(msg.timestamp);
        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
        const timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        let dateDivider = '';
        if (dateStr !== lastDate) {
          dateDivider = `<div class="chat-date-divider">${dateStr}</div>`;
          lastDate = dateStr;
        }
        
        // è‡ªåˆ†ï¼ˆstudentï¼‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç›¸æ‰‹ï¼ˆadminï¼‰ã«èª­ã¾ã‚ŒãŸã‹
        let readStatus = '';
        if (msg.sender === 'student' && msg.readByAdmin) {
          readStatus = '<span class="chat-read-status">æ—¢èª­</span>';
        }
        
        return `
          ${dateDivider}
          <div class="chat-message ${msg.sender}">
            <div>${escapeHtml(msg.message)}</div>
            <div class="chat-message-time">${timeStr}${readStatus}</div>
          </div>
        `;
      }).join('');
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã¸
      container.scrollTop = container.scrollHeight;
    }
    
    function openChat() {
      document.getElementById('chatModal').classList.add('active');
      document.getElementById('chatHeaderBadge').style.display = 'none';
      loadChatMessages();
      
      // æ—¢èª­ãƒãƒ¼ã‚¯ã‚’é€ä¿¡
      markChatAsRead();
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã¸
      setTimeout(() => {
        const container = document.getElementById('chatMessages');
        container.scrollTop = container.scrollHeight;
      }, 100);
    }
    
    function closeChat() {
      document.getElementById('chatModal').classList.remove('active');
    }
    
    function handleChatKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
      }
    }
    
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || !CHAT_URL) return;
      
      const sendBtn = document.getElementById('chatSendBtn');
      sendBtn.disabled = true;
      
      try {
        // JSONPã‚’ä½¿ç”¨ï¼ˆCORSå›é¿ï¼‰
        const params = new URLSearchParams({
          action: 'sendMessage',
          sender: 'student',
          message: message
        });
        
        const data = await chatJsonp(`${CHAT_URL}?${params.toString()}`);
        
        if (data.error) throw new Error(data.error);
        
        input.value = '';
        await loadChatMessages();
        
      } catch (error) {
        showToast('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      } finally {
        sendBtn.disabled = false;
      }
    }
    
    function saveSettings() {
      const apiUrl = document.getElementById('settingsApiUrl').value.trim();
      const weeklyGoal = document.getElementById('settingsWeeklyGoal').value;
      const chatUrl = document.getElementById('settingsChatUrl').value.trim();
      
      localStorage.setItem('apiUrl', apiUrl);
      localStorage.setItem('weeklyGoal', weeklyGoal);
      localStorage.setItem('chatUrl', chatUrl);
      
      API_URL = apiUrl;
      CHAT_URL = chatUrl;
      appData.settings.weeklyGoalMinutes = parseInt(weeklyGoal);
      
      closeSettingsModal();
      showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      
      initChat();
      if (apiUrl) refreshData();
    }
    
    // ==========================================
    // å­¦ç¿’åˆ†æã‚¿ãƒ–
    // ==========================================
    
    function renderStudyAnalysis() {
      const logs = appData.studyLogs || [];
      if (logs.length === 0) return;
      
      // åŸºæœ¬çµ±è¨ˆ
      const totalMinutes = logs.reduce((sum, l) => sum + (l.minutes || 0), 0);
      const studyDates = [...new Set(logs.map(l => l.date))];
      const avgDaily = Math.round(totalMinutes / studyDates.length);
      
      document.getElementById('studyTotalHours').textContent = Math.round(totalMinutes / 60);
      document.getElementById('studyAvgDaily').textContent = avgDaily;
      document.getElementById('studyTotalDays').textContent = studyDates.length;
      
      // æœ€é•·é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—
      const sortedDates = studyDates.sort();
      let maxStreak = 1, currentStreak = 1;
      for (let i = 1; i < sortedDates.length; i++) {
        const prev = new Date(sortedDates[i-1]);
        const curr = new Date(sortedDates[i]);
        const diff = (curr - prev) / (1000 * 60 * 60 * 24);
        if (diff === 1) {
          currentStreak++;
          maxStreak = Math.max(maxStreak, currentStreak);
        } else {
          currentStreak = 1;
        }
      }
      document.getElementById('studyMaxStreak').textContent = maxStreak;
      
      // ç§‘ç›®åˆ¥å­¦ç¿’æ™‚é–“
      const subjectTotals = {};
      logs.forEach(l => {
        const subject = l.subject || 'ãã®ä»–';
        subjectTotals[subject] = (subjectTotals[subject] || 0) + (l.minutes || 0);
      });
      
      const maxSubjectTime = Math.max(...Object.values(subjectTotals));
      const subjectBreakdown = document.getElementById('subjectBreakdown');
      subjectBreakdown.innerHTML = Object.entries(subjectTotals)
        .sort((a, b) => b[1] - a[1])
        .map(([subject, minutes]) => `
          <div class="breakdown-item">
            <span class="breakdown-label">${subject}</span>
            <div class="breakdown-bar-container">
              <div class="breakdown-bar" style="width: ${(minutes / maxSubjectTime) * 100}%"></div>
            </div>
            <span class="breakdown-value">${Math.round(minutes / 60)}æ™‚é–“</span>
          </div>
        `).join('');
      
      // æ›œæ—¥åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
      renderDayOfWeekChart(logs);
      
      // å­¦ç¿’ã‚¿ã‚¤ãƒ—åˆ¥
      const typeTotals = {};
      logs.forEach(l => {
        const type = l.studyType || 'æœªåˆ†é¡';
        typeTotals[type] = (typeTotals[type] || 0) + (l.minutes || 0);
      });
      
      const maxTypeTime = Math.max(...Object.values(typeTotals));
      const typeBreakdown = document.getElementById('studyTypeBreakdown');
      typeBreakdown.innerHTML = Object.entries(typeTotals)
        .sort((a, b) => b[1] - a[1])
        .map(([type, minutes]) => {
          const percent = Math.round((minutes / totalMinutes) * 100);
          return `
            <div class="breakdown-item">
              <span class="breakdown-label">${type}</span>
              <div class="breakdown-bar-container">
                <div class="breakdown-bar" style="width: ${(minutes / maxTypeTime) * 100}%"></div>
              </div>
              <span class="breakdown-value">${percent}%</span>
            </div>
          `;
        }).join('');
      
      // æ‰‹å¿œãˆåˆ†æ
      const moodCounts = {};
      const moods = ['ğŸ˜Š', 'ğŸ™‚', 'ğŸ˜', 'ğŸ˜•', 'ğŸ˜«'];
      moods.forEach(m => moodCounts[m] = 0);
      logs.forEach(l => {
        if (l.mood && moodCounts.hasOwnProperty(l.mood)) {
          moodCounts[l.mood]++;
        }
      });
      
      const totalMoods = Object.values(moodCounts).reduce((a, b) => a + b, 0);
      const moodAnalysis = document.getElementById('moodAnalysis');
      moodAnalysis.innerHTML = moods.map(mood => {
        const count = moodCounts[mood];
        const percent = totalMoods > 0 ? Math.round((count / totalMoods) * 100) : 0;
        return `
          <div class="mood-item">
            <div class="mood-emoji">${mood}</div>
            <div class="mood-count">${count}</div>
            <div class="mood-percent">${percent}%</div>
          </div>
        `;
      }).join('');
      
      // ç§‘ç›®åˆ¥åˆ†æãƒãƒ£ãƒ¼ãƒˆ
      renderSubjectChartAnalysis(logs, totalMinutes);
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
      updateStudyFilterOptions();
      
      // å…¨è¨˜éŒ²è¡¨ç¤º
      filterStudyRecords();
    }
    
    function renderDayOfWeekChart(logs) {
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const dayTotals = [0, 0, 0, 0, 0, 0, 0];
      const dayCounts = [0, 0, 0, 0, 0, 0, 0];
      
      logs.forEach(l => {
        const date = new Date(l.date);
        const day = date.getDay();
        dayTotals[day] += l.minutes || 0;
        dayCounts[day]++;
      });
      
      const dayAvgs = dayTotals.map((total, i) => dayCounts[i] > 0 ? Math.round(total / dayCounts[i]) : 0);
      
      const ctx = document.getElementById('dayOfWeekChart');
      if (!ctx) return;
      
      if (dayOfWeekChart) dayOfWeekChart.destroy();
      
      dayOfWeekChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dayNames,
          datasets: [{
            label: 'å¹³å‡å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰',
            data: dayAvgs,
            backgroundColor: '#5E81AC'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
    
    function renderSubjectChartAnalysis(logs, totalMinutes) {
      const ctx = document.getElementById('subjectChartAnalysis');
      if (!ctx) return;
      
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      const subjectMinutes = {};
      
      logs
        .filter(log => new Date(log.date) >= monthAgo)
        .forEach(log => {
          const subject = log.subject || 'ãã®ä»–';
          subjectMinutes[subject] = (subjectMinutes[subject] || 0) + (log.minutes || 0);
        });
      
      const sortedSubjects = Object.entries(subjectMinutes).sort((a, b) => b[1] - a[1]);
      
      // ç§‘ç›®ã”ã¨ã«å›ºå®šè‰²ã‚’å‰²ã‚Šå½“ã¦
      const subjectColors = {
        'å›½èª': '#EBCB8B',
        'æ•°å­¦': '#A3BE8C',
        'æƒ…å ±': '#B48EAD',
        'è‹±èª': '#5E81AC',
        'ãã®ä»–': '#4C566A'
      };
      
      const defaultColors = ['#5E81AC', '#A3BE8C', '#EBCB8B', '#B48EAD', '#D08770', '#88C0D0', '#81A1C1'];
      const chartColors = sortedSubjects.map((s, i) => subjectColors[s[0]] || defaultColors[i % defaultColors.length]);
      
      if (subjectChartAnalysis) subjectChartAnalysis.destroy();
      
      const ctxDraw = ctx.getContext('2d');
      subjectChartAnalysis = new Chart(ctxDraw, {
        type: 'doughnut',
        data: {
          labels: sortedSubjects.map(s => s[0]),
          datasets: [{
            data: sortedSubjects.map(s => s[1]),
            backgroundColor: chartColors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 12,
                color: '#525252',
                font: { size: 11 }
              }
            }
          },
          cutout: '65%'
        }
      });
    }
    
    function updateStudyFilterOptions() {
      const logs = appData.studyLogs || [];
      const subjects = [...new Set(logs.map(l => l.subject))].filter(Boolean);
      
      const select = document.getElementById('studyFilterSubject');
      select.innerHTML = '<option value="">å…¨ç§‘ç›®</option>' + 
        subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    }
    
    function filterStudyRecords() {
      const logs = appData.studyLogs || [];
      const subjectFilter = document.getElementById('studyFilterSubject').value;
      const periodFilter = document.getElementById('studyFilterPeriod').value;
      
      let filtered = [...logs];
      
      if (subjectFilter) {
        filtered = filtered.filter(l => l.subject === subjectFilter);
      }
      
      if (periodFilter !== 'all') {
        const days = parseInt(periodFilter);
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        filtered = filtered.filter(l => new Date(l.date) >= cutoff);
      }
      
      const container = document.getElementById('allStudyRecords');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = filtered.map(log => {
        const hasSubDetails = log.textbook || log.unit;
        return `
          <div class="record-item">
            <div class="record-main">
              <span class="record-subject">${escapeHtml(log.subject || '')}</span>
              ${log.studyType ? `<span class="record-type">${escapeHtml(log.studyType)}</span>` : ''}
              <span class="record-time">${log.minutes}åˆ†</span>
              <span class="record-mood">${escapeHtml(log.mood || '')}</span>
            </div>
            <div class="record-sub">
              ${log.date}
            </div>
            ${log.memo || hasSubDetails ? `
              <div class="record-details">
                ${hasSubDetails ? `
                  <div class="record-sub-info">
                    ${log.unit ? `<span class="record-unit">ğŸ“– ${escapeHtml(log.unit)}</span>` : ''}
                    ${log.textbook ? `<span class="record-textbook">ğŸ“š ${escapeHtml(log.textbook)}</span>` : ''}
                  </div>
                ` : ''}
                ${log.memo ? `<div class="record-memo">ğŸ“ ${escapeHtml(log.memo)}</div>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function formatMinutes(minutes) {
      if (minutes < 60) return `${minutes}åˆ†`;
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}æ™‚é–“${mins}åˆ†` : `${hours}æ™‚é–“`;
    }
    
    function formatDateShort(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }
    
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }
    
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
